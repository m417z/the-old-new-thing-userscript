<html>
<head>
<title>How can I extend the deadline for responding to the PBT_APMSUSPEND message?</title>
<link rel="stylesheet" href="page.css">
</head><body>
<div class="titlediv"><h2>How can I extend the deadline for responding to the PBT_APMSUSPEND message?</h2></div>
<div class="hdrdiv"><table class="hdrtable" cellspacing="0" cellpadding="0">
<tr><td><b>Date:</b></td><td>November 24, 2011 / year-entry #281</td></tr>
<tr><td><b>Tags:</b></td><td>code</td></tr>
<tr><td><b>Orig Link:</b></td><td>https://blogs.msdn.microsoft.com/oldnewthing/20111124-00/?p=9043</td></tr>

<tr><td><b>Comments:&nbsp;&nbsp;&nbsp;&nbsp;</b></td><td>33</td></tr>
<tr><td valign="top"><b>Summary:</b></td><td valign="top">A customer observed that starting in Windows Vista, the deadline for responding to the PBT_APMSUSPEND message was reduced from twenty seconds to two seconds. Their program needs more than two seconds to prepare for a suspend and they wanted to know how they could extend the deadline. The program communicates with a device, and if...</td></tr>
</table></div>
<hr/>
<table class="contenttable" cellspacing="0" cellpadding="0"><tr><td><div class="contentdiv">
<!-- CONTENT START -->
<p>A customer observed that starting in Windows Vista, <a href="http://msdn.microsoft.com/library/aa372721.aspx"> the deadline for responding to the <code>PBT_APMSUSPEND</code> message was reduced from twenty seconds to two seconds</a>. Their program needs more than two seconds to prepare for a suspend and they wanted to know how they could extend the deadline. The program communicates with a device, and if they don't properly prepare the device for suspend, it has problems when the system resumes.</p>
<p> No, you cannot extend the deadline for responding to the <code>PBT_APMSUSPEND</code> message. The two second deadline is hard-coded; it is not configurable. </p>
<p> The whole point of reducing the deadline from twenty to two seconds is to ensure that when users press the Sleep button on their computers, the computer actually goes to sleep reasonably promptly. If there were a way to extend the deadline, then you're just reintroducing the bad situation in Windows&nbsp;XP where the user hits the Sleep button on the laptop, but the laptop just sits there taunting you. Meanwhile, the flight attendant is standing there getting angrier at you for not putting your laptop away. (Or worse: You tell the laptop to Sleep and toss it into your bag, and then when you reach your destination, you discover that your laptop is really warm, and the battery is dead.) </p>
<p> Besides, imagine if ten apps did this. Your app asks for ten extra seconds, another app asks for another twenty seconds, next thing you know all the deadline extensions add up to five minutes. </p>
<p> The real solution is to fix the driver for this device so it can prepare the device properly when it is told that the machine is about to go into a low power state. (The two-second limit applies to applications but not drivers. At least not yet.) </p>
<!-- CONTENT END -->
</div></td></tr></table>
<hr/>
<table class="commenttable" cellspacing="0" cellpadding="0"><tr><td><div class="commentdiv"><div class="commentdivhdr">
<!-- COMMENTS START -->
Comments (33)	</div>

	
			<div class="navigation pagination clear-both">
					</div>

		<ol class="comment-list">
					<li class="comment even thread-even depth-1" id="comment-949373">
				<div id="div-comment-949373" class="comment-body">
				<div class="comment-author vcard">
						<cite class="fn">Karellen</cite> <span class="says">says:</span>		</div>
		
		<div class="comment-meta commentmetadata"><a href="https://blogs.msdn.microsoft.com/oldnewthing/20111124-00/?p=9043#comment-949373">
			November 24, 2011 at 7:20 am</a>		</div>

		<p>Huh? The real WTF is &quot;Why the heck is the device depending on a userspace program to properly prepare it for suspend?!?&quot;</p>
<p>To parapharase Charles Babbage, I am not able rightly to apprehend the kind of confusion of ideas that could provoke such a situation.</p>

		
				</div>
		</li><!-- #comment-## -->
		<li class="comment odd alt thread-odd thread-alt depth-1" id="comment-949383">
				<div id="div-comment-949383" class="comment-body">
				<div class="comment-author vcard">
						<cite class="fn">Karellen</cite> <span class="says">says:</span>		</div>
		
		<div class="comment-meta commentmetadata"><a href="https://blogs.msdn.microsoft.com/oldnewthing/20111124-00/?p=9043#comment-949383">
			November 24, 2011 at 7:26 am</a>		</div>

		<p>Ah, re-reading your last paragraph, I realise I read it as &quot;&#8230;so it can prepare the device properly when it is told [by the userspace program in question] that the machine is about&#8230;&quot;, whereas you probably acutally meant &quot;&#8230;when it is told [by the kernel] that&#8230;&quot; &#8211; which I then needlessly restated.</p>
<p>Next time: think twice, post once.</p>

		
				</div>
		</li><!-- #comment-## -->
		<li class="comment even thread-even depth-1" id="comment-949403">
				<div id="div-comment-949403" class="comment-body">
				<div class="comment-author vcard">
						<cite class="fn">Cesar</cite> <span class="says">says:</span>		</div>
		
		<div class="comment-meta commentmetadata"><a href="https://blogs.msdn.microsoft.com/oldnewthing/20111124-00/?p=9043#comment-949403">
			November 24, 2011 at 9:42 am</a>		</div>

		<p>&quot;Your app asks for ten extra seconds, another app asks for another twenty seconds, next thing you know all the deadline extensions add up to five minutes.&quot;</p>
<p>Wouldn&#39;t the deadline extensions apply in parallel? The end result would be the longest deadline extension, not the sum of all them. You could even have a limit for the deadline extension (&quot;the default is 2 seconds, but they can extend to up to 20 seconds&quot;).</p>
<p>&quot;The real solution is to fix the driver for this device so it can prepare the device properly when it is told that the machine is about to go into a low power state. (The two-second limit applies to applications but not drivers. At least not yet.)&quot;</p>
<p>Not all hardware has its own device driver. It could be a serial dongle. It could be using a common USB driver (for instance, a common USB-to-serial converter like a FTDI), so they cannot change the driver (else it would affect all USB-to-serial converters of the same brand). It could be based off a external bus like CAN or RS-485, where the driver is for the bus and not the device. And so on.</p>

		
				</div>
		</li><!-- #comment-## -->
		<li class="comment odd alt thread-odd thread-alt depth-1" id="comment-949413">
				<div id="div-comment-949413" class="comment-body">
				<div class="comment-author vcard">
						<cite class="fn">Joshua</cite> <span class="says">says:</span>		</div>
		
		<div class="comment-meta commentmetadata"><a href="https://blogs.msdn.microsoft.com/oldnewthing/20111124-00/?p=9043#comment-949413">
			November 24, 2011 at 10:20 am</a>		</div>

		<p>Remind me to not use Windows for life-critical software.</p>

		
				</div>
		</li><!-- #comment-## -->
		<li class="comment even thread-even depth-1" id="comment-949423">
				<div id="div-comment-949423" class="comment-body">
				<div class="comment-author vcard">
						<cite class="fn">Ken Hagan</cite> <span class="says">says:</span>		</div>
		
		<div class="comment-meta commentmetadata"><a href="https://blogs.msdn.microsoft.com/oldnewthing/20111124-00/?p=9043#comment-949423">
			November 24, 2011 at 10:54 am</a>		</div>

		<p>&quot;Remind me to not use Windows for life-critical software.&quot;</p>
<p>No need. It&#39;s already in the EULA?</p>

		
				</div>
		</li><!-- #comment-## -->
		<li class="comment odd alt thread-odd thread-alt depth-1" id="comment-949443">
				<div id="div-comment-949443" class="comment-body">
				<div class="comment-author vcard">
						<cite class="fn">Klimax</cite> <span class="says">says:</span>		</div>
		
		<div class="comment-meta commentmetadata"><a href="https://blogs.msdn.microsoft.com/oldnewthing/20111124-00/?p=9043#comment-949443">
			November 24, 2011 at 10:54 am</a>		</div>

		<p>@Joshua: You would be so far away from supported territory you wouldn&#39;t see even Mt. Everest should have it been there&#8230;</p>
<p>(You would need there realtime system anyway, which Windows are not.)</p>

		
				</div>
		</li><!-- #comment-## -->
		<li class="comment even thread-even depth-1" id="comment-949453">
				<div id="div-comment-949453" class="comment-body">
				<div class="comment-author vcard">
						<cite class="fn">jmthomas</cite> <span class="says">says:</span>		</div>
		
		<div class="comment-meta commentmetadata"><a href="https://blogs.msdn.microsoft.com/oldnewthing/20111124-00/?p=9043#comment-949453">
			November 24, 2011 at 11:17 am</a>		</div>

		<p>Not that you (Raymond) have any influence in the matter, but I gotta vent.</p>
<p>Two second is pretty harsh. &nbsp;</p>
<p>Did the decision makers consider that there may be mechanical action, not just electronic action, required? &nbsp;Sorry, didn&#39;t get time to part the heads.</p>
<p>Also, with poor response time being tolerated by so many (Why does my windoze machine that ran OK out of the box now take forever?), plus the cost reduction and bloat in microcode (often written by EEs, not SEs), even &quot;all electronic&quot; devices may not normally respond in 2 seconds.</p>
<p>Opps, didn&#39;t get enough time to write the whole 2G buffer to this slow flash memory chip inside me. Sorry, I&#39;ll need a hard reset by human hand before I will work again. &nbsp;But you&#39;ll not know until you diagnose why I stopped working correctly after the restart&#8230;</p>
<p>Then there&#39;s network connected devices that will have to put out messages to stop their attachments at 300 baud&#8230;</p>
<p>And hard coding a critical constant in windows????? &nbsp; Raymond&#39;s time machine must exist! &nbsp;Old things are being brought back from the past!</p>

		
				</div>
		</li><!-- #comment-## -->
		<li class="comment odd alt thread-odd thread-alt depth-1" id="comment-949463">
				<div id="div-comment-949463" class="comment-body">
				<div class="comment-author vcard">
						<cite class="fn">jmthomas</cite> <span class="says">says:</span>		</div>
		
		<div class="comment-meta commentmetadata"><a href="https://blogs.msdn.microsoft.com/oldnewthing/20111124-00/?p=9043#comment-949463">
			November 24, 2011 at 11:24 am</a>		</div>

		<p>The argument about curing the problem where a laptop hastily shoved into a bag which never goes to sleep is bogus.</p>
<p>This problem is not about the timeout, it is about ending processing. &nbsp;If the 20 second timeout really worked, the laptop would remain powered up in the bag for only 20 seconds. &nbsp;Not a problem. &nbsp;The most this new timeout change would do is cut 18 seconds of battery use.</p>
<p>But the laptop is taking forever to turn off. &nbsp;Something is hanging, and the timeout is not recovering from the hang. &nbsp;Doesn&#39;t matter if the hang is in the device, the driver, the kernel, wherever. &nbsp;The watchdog timer is working to force a shutdown. &nbsp;Doesn&#39;t matter if the watchdog is set for 2 or 20 seconds, it isn&#39;t barking or biting viciously enough.</p>

		
				</div>
		</li><!-- #comment-## -->
		<li class="comment even thread-even depth-1" id="comment-949473">
				<div id="div-comment-949473" class="comment-body">
				<div class="comment-author vcard">
						<cite class="fn">Adam Rosenfield</cite> <span class="says">says:</span>		</div>
		
		<div class="comment-meta commentmetadata"><a href="https://blogs.msdn.microsoft.com/oldnewthing/20111124-00/?p=9043#comment-949473">
			November 24, 2011 at 11:38 am</a>		</div>

		<p>@HiTechHiTouch: I think Raymond is using the term &quot;hard-coded&quot; here in a slightly different sense than you may be used to. &nbsp;He doesn&#39;t mean it&#39;s hard-coded into the source code, where you have a magic number floating around in source without a cogent variable name; rather, he&#39;s referring to the fact that it&#39;s not configurable—there is no INI setting, registry key, or system call than can be used to change the limit. &nbsp;It&#39;s hard-coded into the compiled binary of Windows and cannot be changed at runtime.</p>

		
				</div>
		</li><!-- #comment-## -->
		<li class="comment odd alt thread-odd thread-alt depth-1" id="comment-949483">
				<div id="div-comment-949483" class="comment-body">
				<div class="comment-author vcard">
						<cite class="fn">xpclient</cite> <span class="says">says:</span>		</div>
		
		<div class="comment-meta commentmetadata"><a href="https://blogs.msdn.microsoft.com/oldnewthing/20111124-00/?p=9043#comment-949483">
			November 24, 2011 at 11:41 am</a>		</div>

		<p>One of my pet peeves with Vista/7/8 IS that PBT_APMQuerySuspend event is not broadcast to apps so they cannot return Broadcast_Query_Deny to deny the sleep or hibernation transition. Only automatic sleep or hibernation can be prevented by resetting the idle timer using the SetThreadExecutionState function. In Windows XP, both automatic and manual sleep and hibernation could be blocked. Due to the Vista design, it also means, for example, if some mischevious app simply calls shutdown.exe /h the system will hibernate without confirmation.</p>
<p>Or another disastrous decision to remove the hibernation progress bar in Vista/7/8 and just turn the screen off and it becomes a nightmarish experience when you just want to shove the thing in the bag and be confident that it hibernated successfully and wasn&#39;t hung.</p>

		
				</div>
		</li><!-- #comment-## -->
		<li class="comment even thread-even depth-1" id="comment-949493">
				<div id="div-comment-949493" class="comment-body">
				<div class="comment-author vcard">
						<cite class="fn">Leo</cite> <span class="says">says:</span>		</div>
		
		<div class="comment-meta commentmetadata"><a href="https://blogs.msdn.microsoft.com/oldnewthing/20111124-00/?p=9043#comment-949493">
			November 24, 2011 at 11:43 am</a>		</div>

		<p>As an end user, I love the stringent 2 second limit. It would be even better if this also applied to device drivers. My Win7 laptop is sometimes bad about going to sleep when it&#39;s docked, saying a device is in use, despite the only devices attached to it being the monitor, the ethernet cable, and headphones.</p>
<p>On XP, my cell phone&#39;s tethering software would actively block me from putting my laptop to sleep, putting up an absurd dialog box. This was a horrible user experience. I&#39;m not sure if they still do it on 7.</p>

		
				</div>
		</li><!-- #comment-## -->
		<li class="comment odd alt thread-odd thread-alt depth-1" id="comment-949503">
				<div id="div-comment-949503" class="comment-body">
				<div class="comment-author vcard">
						<cite class="fn"><a href='http://blogs.msdn.com/billy.oneal_4000_gmail.com/ProfileUrlRedirect.ashx' rel='external nofollow' class='url'>billy.oneal@gmail.com</a></cite> <span class="says">says:</span>		</div>
		
		<div class="comment-meta commentmetadata"><a href="https://blogs.msdn.microsoft.com/oldnewthing/20111124-00/?p=9043#comment-949503">
			November 24, 2011 at 3:31 pm</a>		</div>

		<p>What @Leo said. As a user mode app you are a guest on the system. Breaking Windows features because you&#39;re not willing to pay your taxes is a problem.</p>

		
				</div>
		</li><!-- #comment-## -->
		<li class="comment even thread-even depth-1" id="comment-949393">
				<div id="div-comment-949393" class="comment-body">
				<div class="comment-author vcard">
						<cite class="fn">bcs</cite> <span class="says">says:</span>		</div>
		
		<div class="comment-meta commentmetadata"><a href="https://blogs.msdn.microsoft.com/oldnewthing/20111124-00/?p=9043#comment-949393">
			November 24, 2011 at 7:49 am</a>		</div>

		<p>Nice back door for when the *hardware* can&#39;t sleep in 2 seconds no matter what the software does. </p>

		
				</div>
		</li><!-- #comment-## -->
		<li class="comment odd alt thread-odd thread-alt depth-1" id="comment-949513">
				<div id="div-comment-949513" class="comment-body">
				<div class="comment-author vcard">
						<cite class="fn">krinndnz</cite> <span class="says">says:</span>		</div>
		
		<div class="comment-meta commentmetadata"><a href="https://blogs.msdn.microsoft.com/oldnewthing/20111124-00/?p=9043#comment-949513">
			November 24, 2011 at 4:13 pm</a>		</div>

		<p>XPClient at 11:41 AM &#8211; Raymond has covered this before. <a rel="nofollow" target="_new" href="http://blogs.msdn.com/b/oldnewthing/archive/2006/02/16/533250.aspx" rel="nofollow">blogs.msdn.com/&#8230;/533250.aspx</a></p>
<p>This post can probably be taken to append to the old one, &quot;&#8230; and five years later the problem still exists, and Microsoft is trying to limit the extent to which the user&#39;s day can be ruined, even if haste-oriented developers are inconvenienced in the process.&quot;</p>

		
				</div>
		</li><!-- #comment-## -->
		<li class="comment even thread-even depth-1" id="comment-949523">
				<div id="div-comment-949523" class="comment-body">
				<div class="comment-author vcard">
						<cite class="fn">640k</cite> <span class="says">says:</span>		</div>
		
		<div class="comment-meta commentmetadata"><a href="https://blogs.msdn.microsoft.com/oldnewthing/20111124-00/?p=9043#comment-949523">
			November 24, 2011 at 4:36 pm</a>		</div>

		<p>I would like it to be 0.2 seconds. Why should I accept bloated software/hardware junk? xp was far to nice to crappy software/hardware. I just want it to do what i tell it to. Turn off -&gt; turn off NOW! Not in 20 seconds, that&#39;s bullshit. If windows accept crappy drivers, guess what users gonna blame?</p>

		
				</div>
		</li><!-- #comment-## -->
		<li class="comment odd alt thread-odd thread-alt depth-1" id="comment-949533">
				<div id="div-comment-949533" class="comment-body">
				<div class="comment-author vcard">
						<cite class="fn">saveddijon</cite> <span class="says">says:</span>		</div>
		
		<div class="comment-meta commentmetadata"><a href="https://blogs.msdn.microsoft.com/oldnewthing/20111124-00/?p=9043#comment-949533">
			November 24, 2011 at 4:49 pm</a>		</div>

		<p>Only 2 seconds?</p>
<p>On most Windows machines I&#39;ve used it will take more than 2 seconds just for my application to page back in&#8230;</p>

		
				</div>
		</li><!-- #comment-## -->
		<li class="comment byuser comment-author-cheong even thread-even depth-1" id="comment-949543">
				<div id="div-comment-949543" class="comment-body">
				<div class="comment-author vcard">
						<cite class="fn"><a href='https://social.msdn.microsoft.com/profile/cheong00' rel='external nofollow' class='url'>cheong00</a></cite> <span class="says">says:</span>		</div>
		
		<div class="comment-meta commentmetadata"><a href="https://blogs.msdn.microsoft.com/oldnewthing/20111124-00/?p=9043#comment-949543">
			November 24, 2011 at 5:45 pm</a>		</div>

		<p>@HiTechHiTouch: Think about it: Windows hibernation file is usually 2GB+ yet it can meet the 2 second limit. Yet for device cannot write 2GB data to internal flash which should be way faster than harddisk. Do that make sense?</p>
<p>If you device can&#39;t write within time limit, you&#39;d better write operation data on flash at the same time as you write them in memory on board.</p>

		
				</div>
		</li><!-- #comment-## -->
		<li class="comment odd alt thread-odd thread-alt depth-1" id="comment-949433">
				<div id="div-comment-949433" class="comment-body">
				<div class="comment-author vcard">
						<cite class="fn">Nawak</cite> <span class="says">says:</span>		</div>
		
		<div class="comment-meta commentmetadata"><a href="https://blogs.msdn.microsoft.com/oldnewthing/20111124-00/?p=9043#comment-949433">
			November 24, 2011 at 10:54 am</a>		</div>

		<p>@Joshua: Ok, let&#39;s do it now before I forget: don&#39;t use Windows for life-critical software, *you* would end up in jail as you would have put people&#39;s lives at risk by not choosing a piece of software validated for these scenarii.</p>
<p>By the way, what kind of life-critical software do you develop that is able to sleep/hibernate?</p>

		
				</div>
		</li><!-- #comment-## -->
		<li class="comment even thread-even depth-1" id="comment-949553">
				<div id="div-comment-949553" class="comment-body">
				<div class="comment-author vcard">
						<cite class="fn">It's Friday</cite> <span class="says">says:</span>		</div>
		
		<div class="comment-meta commentmetadata"><a href="https://blogs.msdn.microsoft.com/oldnewthing/20111124-00/?p=9043#comment-949553">
			November 24, 2011 at 9:35 pm</a>		</div>

		<p>Couldn&#39;t mechanical action be solved with capacitors for most Windows-type hardware? Or a wood-fired steam engine?</p>
<p>Also, even worse than a warm laptop is Swissair 111 &nbsp;(not that a laptop had anything to do with that incident).</p>

		
				</div>
		</li><!-- #comment-## -->
		<li class="comment odd alt thread-odd thread-alt depth-1" id="comment-949563">
				<div id="div-comment-949563" class="comment-body">
				<div class="comment-author vcard">
						<cite class="fn">jmthomas</cite> <span class="says">says:</span>		</div>
		
		<div class="comment-meta commentmetadata"><a href="https://blogs.msdn.microsoft.com/oldnewthing/20111124-00/?p=9043#comment-949563">
			November 24, 2011 at 10:41 pm</a>		</div>

		<p>@Adam Rosenfield &#8212; Net&#39;s the same if you use #define or 0x02 or whatever way you want to instruct the compiler. &nbsp;</p>
<p>Personally, I&#39;d expect this magic number to be set up (or a initialized value replaced by something from the registry) at the beginning of device setup. &nbsp;(I&#39;ve no idea internals really works, but experience says there&#39;s almost certainly a way).</p>
<p>@cheong00 &#8212; You haven&#39;t seen cheap flash pushed hard. &nbsp;Cache overflow, the reuse tracking algorithm overhead, bad lines to relocate (flash doesn&#39;t last forever, flaky ones with lots of manufacturing defects grow new defects fast), and some just won&#39;t let you write more than a few consecutive cycles. &nbsp;</p>
<p>If someone wants to make a high volume consumer item, they will gladly choose the worst performing chip when it saves them any money. &nbsp;$.25 x 50,000 is $12,500, all gravy. &nbsp;Consumers will wait 30 seconds for a device to turn on, so performance is not a design consideration.</p>
<p>I&#39;ve got a older French 2G thumb-drive that will only accept large amounts of data at 110 MBS. &nbsp;My internet connection is faster!</p>
<p>@It&#39;s Friday. &#8212; FWIW, hard drives used to use circuitry (with caps) to park the heads. &nbsp;Then someone observed that software was cheaper than hardware&#8230;</p>
<p>PS: Our development group briefly considered a wood-fired steam engine, but it made things too hot for the hamster! (grin)</p>

		
				</div>
		</li><!-- #comment-## -->
		<li class="comment byuser comment-author-cheong even thread-even depth-1" id="comment-949583">
				<div id="div-comment-949583" class="comment-body">
				<div class="comment-author vcard">
						<cite class="fn"><a href='https://social.msdn.microsoft.com/profile/cheong00' rel='external nofollow' class='url'>cheong00</a></cite> <span class="says">says:</span>		</div>
		
		<div class="comment-meta commentmetadata"><a href="https://blogs.msdn.microsoft.com/oldnewthing/20111124-00/?p=9043#comment-949583">
			November 24, 2011 at 11:55 pm</a>		</div>

		<p>@xpclient: The idea is that most applications (that do not interfere with hardware directly) have no reason to delay sleep. Since we have hybrid sleep on Vista and above, the applications shouldn&#39;t worry about not able to save data to harddisk on time.</p>

		
				</div>
		</li><!-- #comment-## -->
		<li class="comment odd alt thread-odd thread-alt depth-1" id="comment-949573">
				<div id="div-comment-949573" class="comment-body">
				<div class="comment-author vcard">
						<cite class="fn">xpclient</cite> <span class="says">says:</span>		</div>
		
		<div class="comment-meta commentmetadata"><a href="https://blogs.msdn.microsoft.com/oldnewthing/20111124-00/?p=9043#comment-949573">
			November 24, 2011 at 11:05 pm</a>		</div>

		<p>I think in this case a user checkbox on whether to enforce the time limit or not should have been the perfect solution. For those who just want sleep to occur without any interruption, XP was too liberal to allow programs to deny or delay standby/hibernate and for those who don&#39;t want Windows to lose their non-resumable download or burnt DVD because they accidentally hit the sleep button, Vista/7/8 is too restrictive because *it has no option NOT to force it*. And you can still delay log off/restart/shutdown in Vista/7/8, why not sleep?</p>

		
				</div>
		</li><!-- #comment-## -->
		<li class="comment even thread-even depth-1" id="comment-949593">
				<div id="div-comment-949593" class="comment-body">
				<div class="comment-author vcard">
						<cite class="fn">Axel</cite> <span class="says">says:</span>		</div>
		
		<div class="comment-meta commentmetadata"><a href="https://blogs.msdn.microsoft.com/oldnewthing/20111124-00/?p=9043#comment-949593">
			November 25, 2011 at 1:03 am</a>		</div>

		<p>If I&#39;m not mistaken it&#39;s 2 seconds for *each* application to respond and the device should be prepared by the *driver* to hibernate, not user space software, where this limit does not apply.</p>
<p>For user space 2 seconds should be plenty.</p>

		
				</div>
		</li><!-- #comment-## -->
		<li class="comment odd alt thread-odd thread-alt depth-1" id="comment-949643">
				<div id="div-comment-949643" class="comment-body">
				<div class="comment-author vcard">
						<cite class="fn">Ooh</cite> <span class="says">says:</span>		</div>
		
		<div class="comment-meta commentmetadata"><a href="https://blogs.msdn.microsoft.com/oldnewthing/20111124-00/?p=9043#comment-949643">
			November 25, 2011 at 9:17 am</a>		</div>

		<p>@xpclient: Ah, you refer to Raymond&#39;s &quot;The checkbox: The mating call of the loser&quot;</p>
<p><a rel="nofollow" target="_new" href="http://blogs.msdn.com/b/oldnewthing/archive/2009/02/13/9416485.aspx" rel="nofollow">blogs.msdn.com/&#8230;/9416485.aspx</a></p>
<div class="post">[<i>It&#39;s worse than that. Once you let the value be configured by the user, you it becomes possible for an application to configure it programmatically, and then you&#39;re back where you started. -Raymond</i>]</div>

		
				</div>
		</li><!-- #comment-## -->
		<li class="comment even thread-even depth-1" id="comment-949683">
				<div id="div-comment-949683" class="comment-body">
				<div class="comment-author vcard">
						<cite class="fn">voo</cite> <span class="says">says:</span>		</div>
		
		<div class="comment-meta commentmetadata"><a href="https://blogs.msdn.microsoft.com/oldnewthing/20111124-00/?p=9043#comment-949683">
			November 25, 2011 at 9:54 am</a>		</div>

		<p>@xpclient You&#39;re aware that as soon as there is a user configurable feature you also make it MUCH more likely for applications to programmatically set it?</p>
<p>If you really constantly hit sleep accidentally, then a popup dialog asking &quot;Are you sure?&quot; would be a much more sensible solution than this feature from the past. But then I just don&#39;t see this as a major concern for lots of people so -100 and so on.</p>

		
				</div>
		</li><!-- #comment-## -->
		<li class="comment odd alt thread-odd thread-alt depth-1" id="comment-949743">
				<div id="div-comment-949743" class="comment-body">
				<div class="comment-author vcard">
						<cite class="fn">Horst Kiehl</cite> <span class="says">says:</span>		</div>
		
		<div class="comment-meta commentmetadata"><a href="https://blogs.msdn.microsoft.com/oldnewthing/20111124-00/?p=9043#comment-949743">
			November 25, 2011 at 1:42 pm</a>		</div>

		<p>@xpclient: If it&#39;s really a concern that the user &quot;accidentally hit the sleep button&quot;, you can configure the sleep button to do nothing &#8211; or cover it with a molly-guard. It&#39;s much simpler, and closer to the problem, than to still allow &quot;awesome&quot; programs to tell the OS &quot;don&#39;t do what the user told you, let me continue&quot;.</p>
<p>It&#39;s similar to what Raymond has explained before, that you shouldn&#39;t make global changes to solve a local problem: <a rel="nofollow" target="_new" href="http://blogs.msdn.com/b/oldnewthing/archive/2008/12/11/9193695.aspx" rel="nofollow">blogs.msdn.com/&#8230;/9193695.aspx</a></p>
<p>By the way, this reminds me of this post: <a rel="nofollow" target="_new" href="http://blogs.msdn.com/b/oldnewthing/archive/2007/10/16/5465592.aspx" rel="nofollow">blogs.msdn.com/&#8230;/5465592.aspx</a></p>

		
				</div>
		</li><!-- #comment-## -->
		<li class="comment even thread-even depth-1" id="comment-949753">
				<div id="div-comment-949753" class="comment-body">
				<div class="comment-author vcard">
						<cite class="fn">xpclient</cite> <span class="says">says:</span>		</div>
		
		<div class="comment-meta commentmetadata"><a href="https://blogs.msdn.microsoft.com/oldnewthing/20111124-00/?p=9043#comment-949753">
			November 26, 2011 at 3:00 am</a>		</div>

		<p>Anything that can cause data loss and which cannot be blocked by the user is flawed by design. For example, there is no way in Windows to block any of the shutdown functions if initiated using shutdown.exe. Malware can simply run a &#39;shutdown -l&#39; at startup to keep the computer in a log off loop as soon as it logs on. There is no UAC requirement either for shutdown.exe. None of the APIs to intercept shutdown work against shutdown.exe.</p>

		
				</div>
		</li><!-- #comment-## -->
		<li class="comment odd alt thread-odd thread-alt depth-1" id="comment-949763">
				<div id="div-comment-949763" class="comment-body">
				<div class="comment-author vcard">
						<cite class="fn">Joshua</cite> <span class="says">says:</span>		</div>
		
		<div class="comment-meta commentmetadata"><a href="https://blogs.msdn.microsoft.com/oldnewthing/20111124-00/?p=9043#comment-949763">
			November 26, 2011 at 9:12 am</a>		</div>

		<p>@Nawak: you don&#39;t support sleep/hibernate. The code that I was imagining would block it by extending the deadline to infinity.</p>

		
				</div>
		</li><!-- #comment-## -->
		<li class="comment even thread-even depth-1" id="comment-949773">
				<div id="div-comment-949773" class="comment-body">
				<div class="comment-author vcard">
						<cite class="fn">NB</cite> <span class="says">says:</span>		</div>
		
		<div class="comment-meta commentmetadata"><a href="https://blogs.msdn.microsoft.com/oldnewthing/20111124-00/?p=9043#comment-949773">
			November 26, 2011 at 9:18 am</a>		</div>

		<p>@xpclient: If you have malware only calling shutdown.exe at startup you&#39;re very lucky! Otherwise it might have decided to snoop your passwords and credit card numbers instead ;)</p>

		
				</div>
		</li><!-- #comment-## -->
		<li class="comment odd alt thread-odd thread-alt depth-1" id="comment-949813">
				<div id="div-comment-949813" class="comment-body">
				<div class="comment-author vcard">
						<cite class="fn">Crescens2k</cite> <span class="says">says:</span>		</div>
		
		<div class="comment-meta commentmetadata"><a href="https://blogs.msdn.microsoft.com/oldnewthing/20111124-00/?p=9043#comment-949813">
			November 27, 2011 at 6:02 am</a>		</div>

		<p>xpclient:</p>
<p>Adding a UAC requirement to shutdown.exe makes no sense since standard users are allowed to do all operations that it performs by default on client versions of Windows. It also would block shutdown.exe being used in scripts (and I have a few of them) so it isn&#39;t a good idea.</p>
<p>Also, while it may be possible to remove the fangs from shutdown.exe, it would still be rather trivial to write a program which is just as bad by using the ExitWindowsEx function and forcing the actions with that.</p>
<p>I would also have to double check, but shutdown.exe has a /f parameter that causes the shutdown/logoff to be forced, so that would imply that it doesn&#39;t force (and thus make it unblockable) unless you add the /f parameter. So this would mean that regular use of shutdown could be blocked.</p>
<p>But anyway, blocking user logoff is a bad idea and should never be undertaken unless it results in nuclear meltdown or people getting killed. Would you feel happy if you shut down your system and went out, only to come home hours later to find that your shutdown had been blocked because your web browser is asking if you want to save your tabs? That is potentially data loss after all. Most of these &quot;data loss&quot; situations are a result of bad programming. If an application requires more than 2 seconds to save its state then it is likely that it is just keeping too much unsaved data around, or it is a server process for something and would be better as a service. If a logoff also results in data loss then it is also very likely that the application wasn&#39;t written robustly, since it would pretty much mean that there would be data loss if the application crashed (or the user clicked End Process in task manager).</p>
<p>If an application is trying to write to a slow medium (like a WebDAV share) and the user logs off (maybe they forgot that they were writing to it) then again, that isn&#39;t a good reason to block logoff. What you would do in that situation is make sure your temporary files are properly up to date and then cancel the write and somehow set a flag so that the next time you start that application it tells the user that they logged of before the write was complete.</p>
<p>To be honest though, this would end up (for me at least) in a situation where either a badly written application may lose data, or will lose data. I have a funny habit of just clicking on the force button if I logoff or shutdown my system and an application is taking too long. If it does it too often then I would most likely investigate, look for a solution or at worst just uninstall it. I have low tolerance for bad applications after all. Another thing to remember, on a laptop the battery is low and Windows starts the emergency hibernation, should it be allowed to block in this case? (Another example of a choice between possible data loss and definite data loss).</p>

		
				</div>
		</li><!-- #comment-## -->
		<li class="comment even thread-even depth-1" id="comment-949833">
				<div id="div-comment-949833" class="comment-body">
				<div class="comment-author vcard">
						<cite class="fn">xpclient</cite> <span class="says">says:</span>		</div>
		
		<div class="comment-meta commentmetadata"><a href="https://blogs.msdn.microsoft.com/oldnewthing/20111124-00/?p=9043#comment-949833">
			November 28, 2011 at 6:57 am</a>		</div>

		<p>@Crescens2k, the app I use, ShutdownGuard blocks most automatic shutdowns, restarts and logoffs by default and lives in the tray. This way no installer or Windows can force a shutdown unless I approve of it. In those rare cases when I have to do scheduled or remote shutdowns or use scripts, a single click on the ShutdownGuard tray icon &quot;unlocks&quot; automated shutdowns so it won&#39;t be blocked any more. Unfortunately, there isn&#39;t a way for it to circumvent shutdown.exe&#39;s -f (force) switch. I have also added a UAC requirement to shutdown.exe using App Compat Toolkit. Note that this just blocks those shutdowns which are initiated programmatically/without user approval. I can still force a shutdown any time. But I guess for regular users, this would be an overkill of shutdown protection.</p>

		
				</div>
		</li><!-- #comment-## -->
		<li class="comment odd alt thread-odd thread-alt depth-1" id="comment-949943">
				<div id="div-comment-949943" class="comment-body">
				<div class="comment-author vcard">
						<cite class="fn">Nick</cite> <span class="says">says:</span>		</div>
		
		<div class="comment-meta commentmetadata"><a href="https://blogs.msdn.microsoft.com/oldnewthing/20111124-00/?p=9043#comment-949943">
			November 28, 2011 at 12:42 pm</a>		</div>

		<p>&quot;Unfortunately, there isn&#39;t a way for it to circumvent shutdown.exe&#39;s -f (force) switch.&quot;</p>
<p>That sounds like it&#39;s working as intended, then. &nbsp;Users should have control over their computer, and that means they should be able to shut down if they want to. &nbsp;Imagine if the force option was cancellable &#8212; what then? &nbsp;Should the computer be held hostage by a poorly written or broken program? &nbsp;Or maybe Microsoft should add a &#8211;ok-im-serious-really-force option?</p>

		
				</div>
		</li><!-- #comment-## -->
		<li class="comment even thread-even depth-1" id="comment-950143">
				<div id="div-comment-950143" class="comment-body">
				<div class="comment-author vcard">
						<cite class="fn">xpclient</cite> <span class="says">says:</span>		</div>
		
		<div class="comment-meta commentmetadata"><a href="https://blogs.msdn.microsoft.com/oldnewthing/20111124-00/?p=9043#comment-950143">
			November 29, 2011 at 8:14 am</a>		</div>

		<p>@Nick, but that same switch can be called by any app or update installer that think it&#39;s cool to restart without warning. Windows cannot differentiate between automated and user-initiated shutdown, that&#39;s the problem. I have lost data many times over the years before I started using ShutdownGuard.</p>

		
				</div>
		</li><!-- #comment-## -->
		</ol><!-- .comment-list -->

		<div class="navigation pagination">
					</div>

	
			<p class="no-comments">Comments are closed.</p>
<!-- COMMENTS END -->
</div></td></tr></table>

</body>
</html>
<br/><div class="disclaimer">
*DISCLAIMER: I DO NOT OWN THIS CONTENT. If you are the owner and would like it removed, please
<a target="_blank" href="/contact.htm">contact me</a>.
The content herein is an archived reproduction of entries from
Raymond Chen's "Old New Thing" Blog (most recent link is <a target="_blank" href="https://devblogs.microsoft.com/oldnewthing/">here</a>).
It may have slight formatting modifications for consistency and to improve readability.
<br/><br/>
WHY DID I DUPLICATE THIS CONTENT HERE?
Let me first say this site has never had anything to sell and has never shown ads of any kind. I have nothing monetarily to gain by duplicating content here.
Because I had made my own local copy of this content throughout the years, for ease of using tools like grep, I decided to put it online after I discovered
some of the original content previously and publicly available, had disappeared approximately early to mid 2019.
At the same time, I present the content in an easily accessible theme-agnostic way.
<br/><br/>
The information provided by Raymond's blog is, for all practical purposes, more authoritative on Windows Development than Microsoft's
own MSDN documentation and should be considered supplemental reading to that documentation. The wealth of missing details
provided by this blog that Microsoft could not or did not document about Windows over the years is vital enough, many would agree an online "backup" of these details
is a necessary endeavor. Specifics include:<br/>
<ul>
    <li>
        A "redesign" after 2019 erased thousands of user's comments from previous years. As many have stated, the comments are nearly as important as the postings themselves.
        The archived copies of the postings contained here retain the original comments.
    </li>
    <li>
        The blog has changed domains many times and the urls have otherwise been under constant change since 2003.
        Even when proper redirection has been set up for those links, redirection only works for a limited period of time.
        For example, all of the internal blog links that were valid in early 2019, were broken by 2020 without proper redirection.
    </li>
    <li>
        The blog has been under constant re-design and re-theming since its inception.
        It is downright irritating to deal with a bogged-down site experience as the result of the latest visual themes designed for cell-phone browsers.
        As of this writing, it is cumbersome to navigate titles with only 10 entries per page.
        While it is nice that the official site has a search feature, searching using this index (with all titles on a single page) is much quicker (CTRL-F in most browsers).
    </li>
</ul>
</div><br/>
&lt;-- Back to <a href="index.htm">Old New Thing Archive Index</a>

