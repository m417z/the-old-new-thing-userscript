<html>
<head>
<title>Use GFlags to catch the silent killer (silent but deadly)</title>
<link rel="stylesheet" href="page.css">
</head><body>
<div class="titlediv"><h2>Use GFlags to catch the silent killer (silent but deadly)</h2></div>
<div class="hdrdiv"><table class="hdrtable" cellspacing="0" cellpadding="0">
<tr><td><b>Date:</b></td><td>February 6, 2015 / year-entry #28</td></tr>
<tr><td><b>Tags:</b></td><td>code</td></tr>
<tr><td><b>Orig Link:</b></td><td>https://blogs.msdn.microsoft.com/oldnewthing/20150206-00/?p=44733</td></tr>

<tr><td><b>Comments:&nbsp;&nbsp;&nbsp;&nbsp;</b></td><td>22</td></tr>
<tr><td valign="top"><b>Summary:</b></td><td valign="top">Suppose you have some process that is mysteriously dying and you can't figure out why. You think that some other process is doing a Terminate­Process but heck if you can figure out who that is. Starting in Windows 7 and Windows Server 2008 R2, the GFlags tool will let you catch these miscreants. On the Silent Process...</td></tr>
</table></div>
<hr/>
<table class="contenttable" cellspacing="0" cellpadding="0"><tr><td><div class="contentdiv">
<!-- CONTENT START -->
<p>Suppose you have some process that is mysteriously dying and you can't figure out why. You think that some other process is doing a <code>Terminate&shy;Process</code> but heck if you can figure out who that is.</p>
<p> Starting in Windows&nbsp;7 and Windows Server 2008&nbsp;R2, the GFlags tool will let you catch these miscreants. </p>
<p> <a href="http://bugslasher.net/2011/04/17/who-the-hell-killed-my-process/"> On the <i>Silent Process Exit</i> tab</a>, you enter the program you want to keep an extra eye on and check the box <i>Enable Silent Process Exit Monitoring</i> and select what you want to happen when one of these mysterious exits occurs. You can ask for an entry in the event log that identifies the killer, and you can ask for debugging minidumps to be created of both the killer and the victim. </p>
<!-- CONTENT END -->
</div></td></tr></table>
<hr/>
<table class="commenttable" cellspacing="0" cellpadding="0"><tr><td><div class="commentdiv"><div class="commentdivhdr">
<!-- COMMENTS START -->
Comments (22)	</div>

	
			<div class="navigation pagination clear-both">
					</div>

		<ol class="comment-list">
					<li class="comment even thread-even depth-1" id="comment-1174723">
				<div id="div-comment-1174723" class="comment-body">
				<div class="comment-author vcard">
						<cite class="fn">Joshua</cite> <span class="says">says:</span>		</div>
		
		<div class="comment-meta commentmetadata"><a href="https://blogs.msdn.microsoft.com/oldnewthing/20150206-00/?p=44733#comment-1174723">
			February 6, 2015 at 7:17 am</a>		</div>

		<p>For some reason, got no minidump for this one:</p>
<p> &nbsp; &nbsp;mov RSP, 0x010000</p>
<p> &nbsp; &nbsp;call whatever</p>
<p>Thankfully the debugger was able to handle it.</p>

		
				</div>
		</li><!-- #comment-## -->
		<li class="comment odd alt thread-odd thread-alt depth-1" id="comment-1174733">
				<div id="div-comment-1174733" class="comment-body">
				<div class="comment-author vcard">
						<cite class="fn">NotThisMind</cite> <span class="says">says:</span>		</div>
		
		<div class="comment-meta commentmetadata"><a href="https://blogs.msdn.microsoft.com/oldnewthing/20150206-00/?p=44733#comment-1174733">
			February 6, 2015 at 7:19 am</a>		</div>

		<p>I was hoping for another code example of doing this from you but i guess this would be too complicated to do since it probably requires ring 0 hooks?</p>
<p>Anyway, nice to know a program can do this.</p>

		
				</div>
		</li><!-- #comment-## -->
		<li class="comment even thread-even depth-1" id="comment-1174753">
				<div id="div-comment-1174753" class="comment-body">
				<div class="comment-author vcard">
						<cite class="fn">Cesar</cite> <span class="says">says:</span>		</div>
		
		<div class="comment-meta commentmetadata"><a href="https://blogs.msdn.microsoft.com/oldnewthing/20150206-00/?p=44733#comment-1174753">
			February 6, 2015 at 7:56 am</a>		</div>

		<p>&gt; Starting in Windows 7 and Windows Server 2008 R2, the GFlags tool will let you catch these miscreants.</p>
<p>Unless said miscreant also kills the GFlags tool&#8230;</p>

		
				</div>
		</li><!-- #comment-## -->
		<li class="comment odd alt thread-odd thread-alt depth-1" id="comment-1174783">
				<div id="div-comment-1174783" class="comment-body">
				<div class="comment-author vcard">
						<cite class="fn">Mark</cite> <span class="says">says:</span>		</div>
		
		<div class="comment-meta commentmetadata"><a href="https://blogs.msdn.microsoft.com/oldnewthing/20150206-00/?p=44733#comment-1174783">
			February 6, 2015 at 8:09 am</a>		</div>

		<p>Cesar,</p>
<p>The GFlags tool simply sets a few registry keys, so you could always set those in another way.</p>

		
				</div>
		</li><!-- #comment-## -->
		<li class="comment even thread-even depth-1" id="comment-1174793">
				<div id="div-comment-1174793" class="comment-body">
				<div class="comment-author vcard">
						<cite class="fn">Anonymous Coward</cite> <span class="says">says:</span>		</div>
		
		<div class="comment-meta commentmetadata"><a href="https://blogs.msdn.microsoft.com/oldnewthing/20150206-00/?p=44733#comment-1174793">
			February 6, 2015 at 8:42 am</a>		</div>

		<p>Cesar: As Mark already said, you use the GFlags tool to modify registry keys. After that, GFlags doesn&#39;t need to run anymore. I guess the miscreant could manually remove the registry keys, but that required administrative privileges. If the miscreant has those, you&#39;re screwed anyway.</p>
<p>The functionality that can be configured with GFlags is really, REALLY awesome, not just silent process exit. I have turned on most of the features for every program I&#39;m developing and it helps a lot.</p>

		
				</div>
		</li><!-- #comment-## -->
		<li class="comment byuser comment-author-alegrigoriev odd alt thread-odd thread-alt depth-1" id="comment-1174813">
				<div id="div-comment-1174813" class="comment-body">
				<div class="comment-author vcard">
						<cite class="fn"><a href='https://social.msdn.microsoft.com/profile/alegr1' rel='external nofollow' class='url'>alegr1</a></cite> <span class="says">says:</span>		</div>
		
		<div class="comment-meta commentmetadata"><a href="https://blogs.msdn.microsoft.com/oldnewthing/20150206-00/?p=44733#comment-1174813">
			February 6, 2015 at 10:09 am</a>		</div>

		<p>@Joshua:</p>
<p>Minidump is invoked by the unhandled exception handler in the crashing process. Such handler needs to have a valid stack.</p>

		
				</div>
		</li><!-- #comment-## -->
		<li class="comment even thread-even depth-1" id="comment-1174833">
				<div id="div-comment-1174833" class="comment-body">
				<div class="comment-author vcard">
						<cite class="fn">Myria</cite> <span class="says">says:</span>		</div>
		
		<div class="comment-meta commentmetadata"><a href="https://blogs.msdn.microsoft.com/oldnewthing/20150206-00/?p=44733#comment-1174833">
			February 6, 2015 at 11:45 am</a>		</div>

		<p>Does this work for __fastfail in Windows 8/8.1/10?</p>

		
				</div>
		</li><!-- #comment-## -->
		<li class="comment odd alt thread-odd thread-alt depth-1" id="comment-1174843">
				<div id="div-comment-1174843" class="comment-body">
				<div class="comment-author vcard">
						<cite class="fn">Cesar</cite> <span class="says">says:</span>		</div>
		
		<div class="comment-meta commentmetadata"><a href="https://blogs.msdn.microsoft.com/oldnewthing/20150206-00/?p=44733#comment-1174843">
			February 6, 2015 at 11:47 am</a>		</div>

		<p>@alegr1: do you mean Windows doesn&#39;t have something like sigaltstack?</p>

		
				</div>
		</li><!-- #comment-## -->
		<li class="comment even thread-even depth-1" id="comment-1174853">
				<div id="div-comment-1174853" class="comment-body">
				<div class="comment-author vcard">
						<cite class="fn">Gabe</cite> <span class="says">says:</span>		</div>
		
		<div class="comment-meta commentmetadata"><a href="https://blogs.msdn.microsoft.com/oldnewthing/20150206-00/?p=44733#comment-1174853">
			February 6, 2015 at 1:25 pm</a>		</div>

		<p>I&#39;m curious as to whether this works to catch a double fault. Every so often a program window will disappear, and I tend to attribute it to a double fault, but it would be nice if this could tell me for sure.</p>

		
				</div>
		</li><!-- #comment-## -->
		<li class="comment byuser comment-author-alegrigoriev odd alt thread-odd thread-alt depth-1" id="comment-1174863">
				<div id="div-comment-1174863" class="comment-body">
				<div class="comment-author vcard">
						<cite class="fn"><a href='https://social.msdn.microsoft.com/profile/alegr1' rel='external nofollow' class='url'>alegr1</a></cite> <span class="says">says:</span>		</div>
		
		<div class="comment-meta commentmetadata"><a href="https://blogs.msdn.microsoft.com/oldnewthing/20150206-00/?p=44733#comment-1174863">
			February 6, 2015 at 1:50 pm</a>		</div>

		<p>@Cesar:</p>
<p>An external debugger can handle such faults. Windows doesn&#39;t have signals. A default reserved stack size is 1 MB. Why bother with sigaltstack?</p>

		
				</div>
		</li><!-- #comment-## -->
		<li class="comment even thread-even depth-1" id="comment-1174873">
				<div id="div-comment-1174873" class="comment-body">
				<div class="comment-author vcard">
						<cite class="fn">Cesar</cite> <span class="says">says:</span>		</div>
		
		<div class="comment-meta commentmetadata"><a href="https://blogs.msdn.microsoft.com/oldnewthing/20150206-00/?p=44733#comment-1174873">
			February 6, 2015 at 2:41 pm</a>		</div>

		<p>@alegr1: To be able to do the Windows equivalent of a core dump in case of runaway recursion, which is when the stack is guaranteed to be exhausted?</p>

		
				</div>
		</li><!-- #comment-## -->
		<li class="comment odd alt thread-odd thread-alt depth-1" id="comment-1174883">
				<div id="div-comment-1174883" class="comment-body">
				<div class="comment-author vcard">
						<cite class="fn">Joshua</cite> <span class="says">says:</span>		</div>
		
		<div class="comment-meta commentmetadata"><a href="https://blogs.msdn.microsoft.com/oldnewthing/20150206-00/?p=44733#comment-1174883">
			February 6, 2015 at 5:23 pm</a>		</div>

		<p>Sigstack is for weaklings. Real men put the old IP in the single reserved slot at the top of the stack and jump to the handler with SP still out of bounds.</p>
<p>/sarcasm</p>

		
				</div>
		</li><!-- #comment-## -->
		<li class="comment byuser comment-author-alegrigoriev even thread-even depth-1" id="comment-1174893">
				<div id="div-comment-1174893" class="comment-body">
				<div class="comment-author vcard">
						<cite class="fn"><a href='https://social.msdn.microsoft.com/profile/alegr1' rel='external nofollow' class='url'>alegr1</a></cite> <span class="says">says:</span>		</div>
		
		<div class="comment-meta commentmetadata"><a href="https://blogs.msdn.microsoft.com/oldnewthing/20150206-00/?p=44733#comment-1174893">
			February 6, 2015 at 9:58 pm</a>		</div>

		<p>@Cesar:</p>
<p>Full process dump is done by an external program (DrWatson or its current equivalent).</p>

		
				</div>
		</li><!-- #comment-## -->
		<li class="comment odd alt thread-odd thread-alt depth-1" id="comment-1174903">
				<div id="div-comment-1174903" class="comment-body">
				<div class="comment-author vcard">
						<cite class="fn">Jon</cite> <span class="says">says:</span>		</div>
		
		<div class="comment-meta commentmetadata"><a href="https://blogs.msdn.microsoft.com/oldnewthing/20150206-00/?p=44733#comment-1174903">
			February 6, 2015 at 11:08 pm</a>		</div>

		<p>What are the performance implications of GFlags settings? Is it ok to run them in production?</p>

		
				</div>
		</li><!-- #comment-## -->
		<li class="comment even thread-even depth-1" id="comment-1174913">
				<div id="div-comment-1174913" class="comment-body">
				<div class="comment-author vcard">
						<cite class="fn">Mark</cite> <span class="says">says:</span>		</div>
		
		<div class="comment-meta commentmetadata"><a href="https://blogs.msdn.microsoft.com/oldnewthing/20150206-00/?p=44733#comment-1174913">
			February 7, 2015 at 8:00 am</a>		</div>

		<p>Gabe: almost always stack exhaustion.</p>

		
				</div>
		</li><!-- #comment-## -->
		<li class="comment odd alt thread-odd thread-alt depth-1" id="comment-1174923">
				<div id="div-comment-1174923" class="comment-body">
				<div class="comment-author vcard">
						<cite class="fn">AshleyScirraLtd</cite> <span class="says">says:</span>		</div>
		
		<div class="comment-meta commentmetadata"><a href="https://blogs.msdn.microsoft.com/oldnewthing/20150206-00/?p=44733#comment-1174923">
			February 7, 2015 at 9:26 am</a>		</div>

		<p>Your &#39;suggestion box&#39; doesn&#39;t accept comments any more, so sorry to off topic make a suggestion but:</p>
<p>Regarding <a rel="nofollow" target="_new" href="http://blogs.msdn.com/b/oldnewthing/archive/2007/07/18/3926581.aspx">blogs.msdn.com/&#8230;/3926581.aspx</a>, could the limit of 10,000 window handles per process be increased in 64-bit Windows?</p>

		
				</div>
		</li><!-- #comment-## -->
		<li class="comment even thread-even depth-1" id="comment-1174953">
				<div id="div-comment-1174953" class="comment-body">
				<div class="comment-author vcard">
						<cite class="fn">Kyte</cite> <span class="says">says:</span>		</div>
		
		<div class="comment-meta commentmetadata"><a href="https://blogs.msdn.microsoft.com/oldnewthing/20150206-00/?p=44733#comment-1174953">
			February 7, 2015 at 2:58 pm</a>		</div>

		<p>@AshleyScirraLtd</p>
<p>a) If the Suggestion Box is closed then it means Raymond is not open to suggestions.</p>
<p>b) That&#39;s not something that Raymond has any control over.</p>
<p>c) Why on earth would you need more than 10k window handles.</p>

		
				</div>
		</li><!-- #comment-## -->
		<li class="comment odd alt thread-odd thread-alt depth-1" id="comment-1174963">
				<div id="div-comment-1174963" class="comment-body">
				<div class="comment-author vcard">
						<cite class="fn">Sushanth</cite> <span class="says">says:</span>		</div>
		
		<div class="comment-meta commentmetadata"><a href="https://blogs.msdn.microsoft.com/oldnewthing/20150206-00/?p=44733#comment-1174963">
			February 7, 2015 at 5:31 pm</a>		</div>

		<p>I don&#39;t think this works when the process was killed through a TerminateProcess call instead of a ExitProcessCall. My recollection my be off but a few months ago I had to deal with a process killing my process and all I saw in my process was I am happily executing an innocent instruction and then next instant my process is dead and debugger has no where to go. There was no code executed in my process before its death.</p>

		
				</div>
		</li><!-- #comment-## -->
		<li class="comment even thread-even depth-1" id="comment-1174983">
				<div id="div-comment-1174983" class="comment-body">
				<div class="comment-author vcard">
						<cite class="fn">Gabe</cite> <span class="says">says:</span>		</div>
		
		<div class="comment-meta commentmetadata"><a href="https://blogs.msdn.microsoft.com/oldnewthing/20150206-00/?p=44733#comment-1174983">
			February 7, 2015 at 11:50 pm</a>		</div>

		<p>Sushanth: The whole point of this post is to find out who called TerminateProcess on you!</p>
<p>Mark: Yes, that&#39;s my guess. I&#39;m wondering if this tool will tell me whether I&#39;m right.</p>

		
				</div>
		</li><!-- #comment-## -->
		<li class="comment byuser comment-author-cheong odd alt thread-odd thread-alt depth-1" id="comment-1174993">
				<div id="div-comment-1174993" class="comment-body">
				<div class="comment-author vcard">
						<cite class="fn"><a href='https://social.msdn.microsoft.com/profile/cheong00' rel='external nofollow' class='url'>cheong00</a></cite> <span class="says">says:</span>		</div>
		
		<div class="comment-meta commentmetadata"><a href="https://blogs.msdn.microsoft.com/oldnewthing/20150206-00/?p=44733#comment-1174993">
			February 8, 2015 at 6:20 pm</a>		</div>

		<p>I hope I did learn about this before I leaved one of my ex-company. They have started migrating to Win7 at the time, and has a multithread DCOM server process that sometimes just disappeared silently. The C++ team think probably one of the bugs killed it but have no idea where the bug was.</p>

		
				</div>
		</li><!-- #comment-## -->
		<li class="comment even thread-even depth-1" id="comment-1175003">
				<div id="div-comment-1175003" class="comment-body">
				<div class="comment-author vcard">
						<cite class="fn">ANon</cite> <span class="says">says:</span>		</div>
		
		<div class="comment-meta commentmetadata"><a href="https://blogs.msdn.microsoft.com/oldnewthing/20150206-00/?p=44733#comment-1175003">
			February 9, 2015 at 7:19 am</a>		</div>

		<p>@Kyte</p>
<p>@AshleyScirraLtd</p>
<p>But Raymond already responded to C using his psychic powers:</p>
<p>C) &quot;Programs shouldn&#39;t be creating anywhere near ten thousands window manager objects in the first place.&quot;</p>

		
				</div>
		</li><!-- #comment-## -->
		<li class="comment byuser comment-author-mike-dimmick odd alt thread-odd thread-alt depth-1" id="comment-1175203">
				<div id="div-comment-1175203" class="comment-body">
				<div class="comment-author vcard">
						<cite class="fn"><a href='https://social.msdn.microsoft.com/profile/Mike+Dimmick' rel='external nofollow' class='url'>Mike Dimmick</a></cite> <span class="says">says:</span>		</div>
		
		<div class="comment-meta commentmetadata"><a href="https://blogs.msdn.microsoft.com/oldnewthing/20150206-00/?p=44733#comment-1175203">
			February 11, 2015 at 3:51 am</a>		</div>

		<p>@AshleyScirraLtd: I may be speaking out of turn, but I think that ship has sailed. Win32 is in legacy maintenance mode and will stay that way. Windows Runtime does not use window handles and does not have this problem.</p>
<p>It hasn&#39;t been announced yet, but I fully expect that the major change to the API surface in Windows 10 is that Windows Runtime will be able to create and manage resizable overlapping windows. Welcome to Windows 2.0 ;)</p>

		
				</div>
		</li><!-- #comment-## -->
		</ol><!-- .comment-list -->

		<div class="navigation pagination">
					</div>

	
			<p class="no-comments">Comments are closed.</p>
<!-- COMMENTS END -->
</div></td></tr></table>

</body>
</html>
<br/><div class="disclaimer">
*DISCLAIMER: I DO NOT OWN THIS CONTENT. If you are the owner and would like it removed, please
<a target="_blank" href="/contact.htm">contact me</a>.
The content herein is an archived reproduction of entries from
Raymond Chen's "Old New Thing" Blog (most recent link is <a target="_blank" href="https://devblogs.microsoft.com/oldnewthing/">here</a>).
It may have slight formatting modifications for consistency and to improve readability.
<br/><br/>
WHY DID I DUPLICATE THIS CONTENT HERE?
Let me first say this site has never had anything to sell and has never shown ads of any kind. I have nothing monetarily to gain by duplicating content here.
Because I had made my own local copy of this content throughout the years, for ease of using tools like grep, I decided to put it online after I discovered
some of the original content previously and publicly available, had disappeared approximately early to mid 2019.
At the same time, I present the content in an easily accessible theme-agnostic way.
<br/><br/>
The information provided by Raymond's blog is, for all practical purposes, more authoritative on Windows Development than Microsoft's
own MSDN documentation and should be considered supplemental reading to that documentation. The wealth of missing details
provided by this blog that Microsoft could not or did not document about Windows over the years is vital enough, many would agree an online "backup" of these details
is a necessary endeavor. Specifics include:<br/>
<ul>
    <li>
        A "redesign" after 2019 erased thousands of user's comments from previous years. As many have stated, the comments are nearly as important as the postings themselves.
        The archived copies of the postings contained here retain the original comments.
    </li>
    <li>
        The blog has changed domains many times and the urls have otherwise been under constant change since 2003.
        Even when proper redirection has been set up for those links, redirection only works for a limited period of time.
        For example, all of the internal blog links that were valid in early 2019, were broken by 2020 without proper redirection.
    </li>
    <li>
        The blog has been under constant re-design and re-theming since its inception.
        It is downright irritating to deal with a bogged-down site experience as the result of the latest visual themes designed for cell-phone browsers.
        As of this writing, it is cumbersome to navigate titles with only 10 entries per page.
        While it is nice that the official site has a search feature, searching using this index (with all titles on a single page) is much quicker (CTRL-F in most browsers).
    </li>
</ul>
</div><br/>
&lt;-- Back to <a href="index.htm">Old New Thing Archive Index</a>

