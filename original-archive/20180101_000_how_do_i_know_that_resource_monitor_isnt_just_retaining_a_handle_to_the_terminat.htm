<html>
<head>
<title>How do I know that Resource Monitor isn't just retaining a handle to the terminated process?</title>
<link rel="stylesheet" href="page.css">
</head><body>
<div class="titlediv"><h2>How do I know that Resource Monitor isn&#8217;t just retaining a handle to the terminated process?</h2></div>
<div class="hdrdiv"><table class="hdrtable" cellspacing="0" cellpadding="0">
<tr><td><b>Date:</b></td><td>January 1, 2018 / year-entry #1</td></tr>
<tr><td><b>Tags:</b></td><td>code</td></tr>
<tr><td><b>Orig Link:</b></td><td>https://blogs.msdn.microsoft.com/oldnewthing/20180101-00/?p=97685</td></tr>

<tr><td><b>Comments:&nbsp;&nbsp;&nbsp;&nbsp;</b></td><td>29</td></tr>
<tr><td valign="top"><b>Summary:</b></td><td valign="top">Let's run some more experiments.</td></tr>
</table></div>
<hr/>
<table class="contenttable" cellspacing="0" cellpadding="0"><tr><td><div class="contentdiv">
<!-- CONTENT START -->
<p>
A short time ago, I explained that
Resource Monitor shows information for terminated processes
for a little while, so you can see the results before they
go away.
it's not that Resource Monitor is able to go back in time and
see processes that are already dead.
</p>
<p>
Ben Voigt
makes the accurate observation that
<a HREF="https://blogs.msdn.microsoft.com/oldnewthing/20171228-00/?p=97665#comment-1318967">
it's possible that Resource Monitor is retaining a handle to the
terminated process</a>,
and it's that handle that allows it to keep asking questions
about the process.
A newly-launched Resource Monitor never observed the process
before it terminated, and therefore never had a chance to obtain
a handle to it.
</p>
<p>
Interesting theory. Let's test it.
</p>
<p>
Run Task Manager, Resource Monitor, and Notepad.
Close Notepad.
It vanishes immediately from Task Manager,
which demonstrates that Resource Monitor is not retaining a handle to it.
That's because process objects remain present in the kernel until all
handles are closed;
if the process has terminated, the process object is in a zombie state:
You can use the handle to ask questions about the process
(like get its exit code and CPU statistics).
But as long as the process object exists, it shows up in the Details
page of Task Manager.
</p>
<p>
Notepad disappeared immediately,
which means that its process object is gone for good,
which means no active handles.
</p>
<p>
Okay, but maybe Resource Monitor closes the handle
once it detects that the process has terminated.
</p>
<p>
To test that theory, run Task Manager, Resource Monitor, and Notepad.
Connect a debugger to Resource Monitor and freeze it.
Now close Notepad.
It vanishes immediately from Task Manager,
which shows that Resource Monitor didn't have a handle to it.
</p>
<p>
The question came from a customer who saw that
when their program terminated,
it disappeared immediately from Task Manager
and all the process enumeration APIs,
but their program still appeared in Resource Monitor
like a ghost from beyond the grave,
and they wanted to know what sort of
otherworldly powers Resource Manager has that
lets it see processes that no longer exist.
</p>
<p>
Answer: No otherworldly powers. Just a good memory.</p>
<!-- CONTENT END -->
</div></td></tr></table>
<hr/>
<table class="commenttable" cellspacing="0" cellpadding="0"><tr><td><div class="commentdiv"><div class="commentdivhdr">
<!-- COMMENTS START -->
Comments (29)	</div>

		<div id="respond" class="comment-respond">
		<h3 id="reply-title" class="comment-reply-title"> <small><a rel="nofollow" id="cancel-comment-reply-link" href="/oldnewthing/20180101-00/?p=97685#respond" style="display:none;">Cancel reply</a></small></h3>			<form action="https://blogs.msdn.microsoft.com/oldnewthing/wp-comments-post.php" method="post" id="commentform" class="comment-form">
				<p class="comment-form-comment"><textarea id="comment" name="comment" cols="45" rows="4" aria-required="true"></textarea></p><p class="comment-form-author"><label for="author">Name <span class="required">*</span></label> <input id="author" name="author" type="text" value="" size="30" maxlength="245" aria-required='true' required='required' /></p>
<p class="comment-form-email"><label for="email">Email <span class="required">*</span></label> <input id="email" name="email" type="text" value="" size="30" maxlength="100" aria-describedby="email-notes" aria-required='true' required='required' /></p>
<p class="comment-form-url"><label for="url">Website</label> <input id="url" name="url" type="text" value="" size="30" maxlength="200" /></p>
<p class="form-submit"><input name="submit" type="submit" id="submit" class="submit btn btn-default" value="Post Comment" /> <input type='hidden' name='comment_post_ID' value='97685' id='comment_post_ID' />
<input type='hidden' name='comment_parent' id='comment_parent' value='0' />
</p><p style="display: none;"><input type="hidden" id="akismet_comment_nonce" name="akismet_comment_nonce" value="1021cf845a" /></p><p style="display: none;"><input type="hidden" id="ak_js" name="ak_js" value="140"/></p>			</form>
			</div><!-- #respond -->
	
			<div class="navigation pagination clear-both">
					</div>

		<ol class="comment-list">
					<li class="comment byuser comment-author-iboyd even thread-even depth-1" id="comment-1319135">
				<div id="div-comment-1319135" class="comment-body">
				<div class="comment-author vcard">
						<cite class="fn"><a href='https://social.msdn.microsoft.com/profile/IanBoyd' rel='external nofollow' class='url'>IanBoyd</a></cite> <span class="says">says:</span>		</div>
		
		<div class="comment-meta commentmetadata"><a href="https://blogs.msdn.microsoft.com/oldnewthing/20180101-00/?p=97685#comment-1319135">
			January 1, 2018 at 7:27 am</a>		</div>

		<p>I like this. </p>
<p>Too often there are hand-waving arguments about how something might work. </p>
<p>Or you can use direct experimental evidence.</p>

		<div class="reply"><a rel='nofollow' class='comment-reply-link' href='https://blogs.msdn.microsoft.com/oldnewthing/20180101-00/?p=97685&#038;replytocom=1319135#respond' onclick='return addComment.moveForm( "div-comment-1319135", "1319135", "respond", "97685" )' aria-label='Reply to IanBoyd'>Reply</a></div>
				</div>
		</li><!-- #comment-## -->
		<li class="comment odd alt thread-odd thread-alt depth-1 parent" id="comment-1319145">
				<div id="div-comment-1319145" class="comment-body">
				<div class="comment-author vcard">
						<cite class="fn">henke37</cite> <span class="says">says:</span>		</div>
		
		<div class="comment-meta commentmetadata"><a href="https://blogs.msdn.microsoft.com/oldnewthing/20180101-00/?p=97685#comment-1319145">
			January 1, 2018 at 7:39 am</a>		</div>

		<p>You had this followup planned all this time, didn&#8217;t you?</p>

		<div class="reply"><a rel='nofollow' class='comment-reply-link' href='https://blogs.msdn.microsoft.com/oldnewthing/20180101-00/?p=97685&#038;replytocom=1319145#respond' onclick='return addComment.moveForm( "div-comment-1319145", "1319145", "respond", "97685" )' aria-label='Reply to henke37'>Reply</a></div>
				</div>
		<ol class="children">
		<li class="comment byuser comment-author-alexcohn even depth-2" id="comment-1319487">
				<div id="div-comment-1319487" class="comment-body">
				<div class="comment-author vcard">
						<cite class="fn"><a href='https://social.msdn.microsoft.com/profile/Alex+Cohn' rel='external nofollow' class='url'>Alex Cohn</a></cite> <span class="says">says:</span>		</div>
		
		<div class="comment-meta commentmetadata"><a href="https://blogs.msdn.microsoft.com/oldnewthing/20180101-00/?p=97685#comment-1319487">
			January 2, 2018 at 1:09 pm</a>		</div>

		<p>I am sure it has been planned at least since last year</p>

		<div class="reply"><a rel='nofollow' class='comment-reply-link' href='https://blogs.msdn.microsoft.com/oldnewthing/20180101-00/?p=97685&#038;replytocom=1319487#respond' onclick='return addComment.moveForm( "div-comment-1319487", "1319487", "respond", "97685" )' aria-label='Reply to Alex Cohn'>Reply</a></div>
				</div>
		</li><!-- #comment-## -->
</ol><!-- .children -->
</li><!-- #comment-## -->
		<li class="comment odd alt thread-even depth-1" id="comment-1319155">
				<div id="div-comment-1319155" class="comment-body">
				<div class="comment-author vcard">
						<cite class="fn">Lachlan Picking</cite> <span class="says">says:</span>		</div>
		
		<div class="comment-meta commentmetadata"><a href="https://blogs.msdn.microsoft.com/oldnewthing/20180101-00/?p=97685#comment-1319155">
			January 1, 2018 at 9:11 am</a>		</div>

		<p>Process Explorer does the same thing; when a process closes it is highlighted red for a short period of time before disappearing from the list entirely (which is just one of the many features that keeps me using procexp instead of taskmgr). I never would have imagined it was keeping a handle open to the terminated process, that just doesn&#8217;t seem intuitive or necessary to me.</p>

		<div class="reply"><a rel='nofollow' class='comment-reply-link' href='https://blogs.msdn.microsoft.com/oldnewthing/20180101-00/?p=97685&#038;replytocom=1319155#respond' onclick='return addComment.moveForm( "div-comment-1319155", "1319155", "respond", "97685" )' aria-label='Reply to Lachlan Picking'>Reply</a></div>
				</div>
		</li><!-- #comment-## -->
		<li class="comment byuser comment-author-fleet-command even thread-odd thread-alt depth-1 parent" id="comment-1319165">
				<div id="div-comment-1319165" class="comment-body">
				<div class="comment-author vcard">
						<cite class="fn"><a href='https://social.msdn.microsoft.com/profile/Fleet+Command' rel='external nofollow' class='url'>Fleet Command</a></cite> <span class="says">says:</span>		</div>
		
		<div class="comment-meta commentmetadata"><a href="https://blogs.msdn.microsoft.com/oldnewthing/20180101-00/?p=97685#comment-1319165">
			January 1, 2018 at 9:42 am</a>		</div>

		<p>What IS this contract that entitles the customers to ask these questions? I want one too.</p>

		<div class="reply"><a rel='nofollow' class='comment-reply-link' href='https://blogs.msdn.microsoft.com/oldnewthing/20180101-00/?p=97685&#038;replytocom=1319165#respond' onclick='return addComment.moveForm( "div-comment-1319165", "1319165", "respond", "97685" )' aria-label='Reply to Fleet Command'>Reply</a></div>
				</div>
		<ol class="children">
		<li class="comment odd alt depth-2 parent" id="comment-1319185">
				<div id="div-comment-1319185" class="comment-body">
				<div class="comment-author vcard">
						<cite class="fn">ErikF</cite> <span class="says">says:</span>		</div>
		
		<div class="comment-meta commentmetadata"><a href="https://blogs.msdn.microsoft.com/oldnewthing/20180101-00/?p=97685#comment-1319185">
			January 1, 2018 at 9:50 am</a>		</div>

		<p>You too can ask questions like this by <a href="https://support.microsoft.com/en-us/gp/support-options-for-business?wa=wsignin1.0" rel="nofollow">buying an incident</a> for US$499.  No contract needed! :-)</p>
<p>Whether that&#8217;s a good use of $500 is up to you, of course.</p>

		<div class="reply"><a rel='nofollow' class='comment-reply-link' href='https://blogs.msdn.microsoft.com/oldnewthing/20180101-00/?p=97685&#038;replytocom=1319185#respond' onclick='return addComment.moveForm( "div-comment-1319185", "1319185", "respond", "97685" )' aria-label='Reply to ErikF'>Reply</a></div>
				</div>
		<ol class="children">
		<li class="comment byuser comment-author-fleet-command even depth-3" id="comment-1319225">
				<div id="div-comment-1319225" class="comment-body">
				<div class="comment-author vcard">
						<cite class="fn"><a href='https://social.msdn.microsoft.com/profile/Fleet+Command' rel='external nofollow' class='url'>Fleet Command</a></cite> <span class="says">says:</span>		</div>
		
		<div class="comment-meta commentmetadata"><a href="https://blogs.msdn.microsoft.com/oldnewthing/20180101-00/?p=97685#comment-1319225">
			January 1, 2018 at 11:23 am</a>		</div>

		<p>Oh, those $500 guys always dodge my questions and don&#8217;t try to solve the problem either. Also, I can ask some though questions. Once, Symantec advertised a support package &#8220;get a satisfactory answer or get your money back&#8221;. Long story short, without a full round of conversation, I got my money back.</p>

		<div class="reply"><a rel='nofollow' class='comment-reply-link' href='https://blogs.msdn.microsoft.com/oldnewthing/20180101-00/?p=97685&#038;replytocom=1319225#respond' onclick='return addComment.moveForm( "div-comment-1319225", "1319225", "respond", "97685" )' aria-label='Reply to Fleet Command'>Reply</a></div>
				</div>
		</li><!-- #comment-## -->
		<li class="comment odd alt depth-3 parent" id="comment-1319235">
				<div id="div-comment-1319235" class="comment-body">
				<div class="comment-author vcard">
						<cite class="fn">Anon</cite> <span class="says">says:</span>		</div>
		
		<div class="comment-meta commentmetadata"><a href="https://blogs.msdn.microsoft.com/oldnewthing/20180101-00/?p=97685#comment-1319235">
			January 1, 2018 at 12:50 pm</a>		</div>

		<p>Microsoft have some corporate customers who buy corporate volume licenses for tens of thousands of Windows.</p>
<p>Now in my experience of talking to salespeople when the sales guy comes back the conversation goes like this </p>
<p>Sales Guy : Good news. They signed up for 50,000 licenses. On the other hand the only way I could get them to sign was to agree to [long list of onerous terms generating work for everyone else].</p>

		<div class="reply"><a rel='nofollow' class='comment-reply-link' href='https://blogs.msdn.microsoft.com/oldnewthing/20180101-00/?p=97685&#038;replytocom=1319235#respond' onclick='return addComment.moveForm( "div-comment-1319235", "1319235", "respond", "97685" )' aria-label='Reply to Anon'>Reply</a></div>
				</div>
		<ol class="children">
		<li class="comment even depth-4" id="comment-1319245">
				<div id="div-comment-1319245" class="comment-body">
				<div class="comment-author vcard">
						<cite class="fn">Anon</cite> <span class="says">says:</span>		</div>
		
		<div class="comment-meta commentmetadata"><a href="https://blogs.msdn.microsoft.com/oldnewthing/20180101-00/?p=97685#comment-1319245">
			January 1, 2018 at 1:09 pm</a>		</div>

		<p>BTW, it turns out the MS HQ store has some awesome stuff</p>
<p><a href="https://arstechnica.com/gaming/2018/01/inside-microsofts-weird-wonderful-swag-store/" rel="nofollow">https://arstechnica.com/gaming/2018/01/inside-microsofts-weird-wonderful-swag-store/</a></p>
<p>A cat! Riding a T-Rex! And the T-Rex has gripper arms!</p>
<p><a href="https://cdn.arstechnica.net/wp-content/uploads/2017/12/IMG_1410.jpg" rel="nofollow">https://cdn.arstechnica.net/wp-content/uploads/2017/12/IMG_1410.jpg</a></p>
<p>Kind of awesome.</p>

		<div class="reply"><a rel='nofollow' class='comment-reply-link' href='https://blogs.msdn.microsoft.com/oldnewthing/20180101-00/?p=97685&#038;replytocom=1319245#respond' onclick='return addComment.moveForm( "div-comment-1319245", "1319245", "respond", "97685" )' aria-label='Reply to Anon'>Reply</a></div>
				</div>
		</li><!-- #comment-## -->
</ol><!-- .children -->
</li><!-- #comment-## -->
</ol><!-- .children -->
</li><!-- #comment-## -->
		<li class="comment odd alt depth-2" id="comment-1319295">
				<div id="div-comment-1319295" class="comment-body">
				<div class="comment-author vcard">
						<cite class="fn">Brian</cite> <span class="says">says:</span>		</div>
		
		<div class="comment-meta commentmetadata"><a href="https://blogs.msdn.microsoft.com/oldnewthing/20180101-00/?p=97685#comment-1319295">
			January 2, 2018 at 6:55 am</a>		</div>

		<p>Check out <a href="https://support.microsoft.com/en-us/premier" rel="nofollow">https://support.microsoft.com/en-us/premier</a>.  It&#8217;s a lot more than $499.</p>

		<div class="reply"><a rel='nofollow' class='comment-reply-link' href='https://blogs.msdn.microsoft.com/oldnewthing/20180101-00/?p=97685&#038;replytocom=1319295#respond' onclick='return addComment.moveForm( "div-comment-1319295", "1319295", "respond", "97685" )' aria-label='Reply to Brian'>Reply</a></div>
				</div>
		</li><!-- #comment-## -->
</ol><!-- .children -->
</li><!-- #comment-## -->
		<li class="comment even thread-even depth-1" id="comment-1319175">
				<div id="div-comment-1319175" class="comment-body">
				<div class="comment-author vcard">
						<cite class="fn">Silver</cite> <span class="says">says:</span>		</div>
		
		<div class="comment-meta commentmetadata"><a href="https://blogs.msdn.microsoft.com/oldnewthing/20180101-00/?p=97685#comment-1319175">
			January 1, 2018 at 9:46 am</a>		</div>

		<p>sorry, im pretty much sure you&#8217;re wrong about processes which still have existing kernel mode handles retaining in details tab of task manager.<br />
otherwise tasks which leak processhandles would easily hog the details view of taskmanager.<br />
Simple testcode:<br />
DWORD ProcId = 1234; // SDT::Memory_n::External_n::GetPIdByProcessName(L&#8221;notepad.exe&#8221;); or simply enter procid of notepad here<br />
	printf(&#8220;ProcId: %d\n&#8221;, ProcId);<br />
	if (ProcId)<br />
	{<br />
		HANDLE TempHandle = OpenProcess(PROCESS_ALL_ACCESS, FALSE, ProcId);</p>
<p>		if (TempHandle)<br />
		{<br />
			printf(&#8220;Opened notepad!\n&#8221;);<br />
			system(&#8220;PAUSE&#8221;);<br />
			DWORD ExitCode = 0;<br />
			if (GetExitCodeProcess(TempHandle, &amp;ExitCode))<br />
			{<br />
				printf(&#8220;Handle was still valid &#8211; exit code was: %d\n&#8221;, ExitCode);<br />
			}<br />
			CloseHandle(TempHandle);<br />
		}<br />
	}</p>
<p>open notepad, run code above, close notepad &#8211; it will vanish from details tab in task manager &#8211; press any key to trigger system pause return &#8211; handle will still be valid for requesting exit code.</p>

		<div class="reply"><a rel='nofollow' class='comment-reply-link' href='https://blogs.msdn.microsoft.com/oldnewthing/20180101-00/?p=97685&#038;replytocom=1319175#respond' onclick='return addComment.moveForm( "div-comment-1319175", "1319175", "respond", "97685" )' aria-label='Reply to Silver'>Reply</a></div>
				</div>
		</li><!-- #comment-## -->
		<li class="comment odd alt thread-odd thread-alt depth-1 parent" id="comment-1319195">
				<div id="div-comment-1319195" class="comment-body">
				<div class="comment-author vcard">
						<cite class="fn">Silver</cite> <span class="says">says:</span>		</div>
		
		<div class="comment-meta commentmetadata"><a href="https://blogs.msdn.microsoft.com/oldnewthing/20180101-00/?p=97685#comment-1319195">
			January 1, 2018 at 9:53 am</a>		</div>

		<p>Also follow up question:<br />
how does perfmon exactly work? i took a look with processhacker for open process handles in perfmon.exe &#8211; it doesnt have any?<br />
does it immediately close and reopen them (doubt that) or communicating with some service?</p>

		<div class="reply"><a rel='nofollow' class='comment-reply-link' href='https://blogs.msdn.microsoft.com/oldnewthing/20180101-00/?p=97685&#038;replytocom=1319195#respond' onclick='return addComment.moveForm( "div-comment-1319195", "1319195", "respond", "97685" )' aria-label='Reply to Silver'>Reply</a></div>
				</div>
		<ol class="children">
		<li class="comment even depth-2" id="comment-1319205">
				<div id="div-comment-1319205" class="comment-body">
				<div class="comment-author vcard">
						<cite class="fn">Silver</cite> <span class="says">says:</span>		</div>
		
		<div class="comment-meta commentmetadata"><a href="https://blogs.msdn.microsoft.com/oldnewthing/20180101-00/?p=97685#comment-1319205">
			January 1, 2018 at 10:05 am</a>		</div>

		<p>i&#8217;d guess its using the wmi api &#8211; not sure though if it holds all the info perfmon displays and didnt bother reversing.</p>

		<div class="reply"><a rel='nofollow' class='comment-reply-link' href='https://blogs.msdn.microsoft.com/oldnewthing/20180101-00/?p=97685&#038;replytocom=1319205#respond' onclick='return addComment.moveForm( "div-comment-1319205", "1319205", "respond", "97685" )' aria-label='Reply to Silver'>Reply</a></div>
				</div>
		</li><!-- #comment-## -->
</ol><!-- .children -->
</li><!-- #comment-## -->
		<li class="comment byuser comment-author-wndsks odd alt thread-even depth-1 parent" id="comment-1319215">
				<div id="div-comment-1319215" class="comment-body">
				<div class="comment-author vcard">
						<cite class="fn"><a href='https://social.msdn.microsoft.com/profile/skSdnW' rel='external nofollow' class='url'>skSdnW</a></cite> <span class="says">says:</span>		</div>
		
		<div class="comment-meta commentmetadata"><a href="https://blogs.msdn.microsoft.com/oldnewthing/20180101-00/?p=97685#comment-1319215">
			January 1, 2018 at 10:34 am</a>		</div>

		<p>&#8220;It vanishes immediately from Task Manager, which demonstrates that Resource Monitor is not retaining a handle to it.&#8221; This proves nothing. A process handle is signaled when the process ends and Task Manager might remove the process from the display at that point but other processes might still have a open handle. Process Explorer works the other way, it displays terminated processes for a couple of seconds in its useful highlight feature.</p>

		<div class="reply"><a rel='nofollow' class='comment-reply-link' href='https://blogs.msdn.microsoft.com/oldnewthing/20180101-00/?p=97685&#038;replytocom=1319215#respond' onclick='return addComment.moveForm( "div-comment-1319215", "1319215", "respond", "97685" )' aria-label='Reply to skSdnW'>Reply</a></div>
				</div>
		<ol class="children">
		<li class="comment even depth-2 parent" id="comment-1319255">
				<div id="div-comment-1319255" class="comment-body">
				<div class="comment-author vcard">
						<cite class="fn"><a href='http://www.silverbacknetworks.tech' rel='external nofollow' class='url'>Joshua Bowman</a></cite> <span class="says">says:</span>		</div>
		
		<div class="comment-meta commentmetadata"><a href="https://blogs.msdn.microsoft.com/oldnewthing/20180101-00/?p=97685#comment-1319255">
			January 1, 2018 at 3:27 pm</a>		</div>

		<p>And maybe Task Manager invents fictitious processes when it&#8217;s bored, too. There&#8217;s no end of the crazy things it could do if it was made to, so it&#8217;s good thing it actually works the way Raymond explains to us!</p>

		<div class="reply"><a rel='nofollow' class='comment-reply-link' href='https://blogs.msdn.microsoft.com/oldnewthing/20180101-00/?p=97685&#038;replytocom=1319255#respond' onclick='return addComment.moveForm( "div-comment-1319255", "1319255", "respond", "97685" )' aria-label='Reply to Joshua Bowman'>Reply</a></div>
				</div>
		<ol class="children">
		<li class="comment odd alt depth-3" id="comment-1319485">
				<div id="div-comment-1319485" class="comment-body">
				<div class="comment-author vcard">
						<cite class="fn">Someone</cite> <span class="says">says:</span>		</div>
		
		<div class="comment-meta commentmetadata"><a href="https://blogs.msdn.microsoft.com/oldnewthing/20180101-00/?p=97685#comment-1319485">
			January 2, 2018 at 12:47 pm</a>		</div>

		<p>Hu? Its just that CreateToolhelp32Snapshot() does not include zombies in the snapshot. See <a href="https://msdn.microsoft.com/en-us/library/windows/desktop/ms686701(v=vs.85)" rel="nofollow">https://msdn.microsoft.com/en-us/library/windows/desktop/ms686701(v=vs.85)</a>.aspx for example code.</p>

		<div class="reply"><a rel='nofollow' class='comment-reply-link' href='https://blogs.msdn.microsoft.com/oldnewthing/20180101-00/?p=97685&#038;replytocom=1319485#respond' onclick='return addComment.moveForm( "div-comment-1319485", "1319485", "respond", "97685" )' aria-label='Reply to Someone'>Reply</a></div>
				</div>
		</li><!-- #comment-## -->
</ol><!-- .children -->
</li><!-- #comment-## -->
		<li class="comment byuser comment-author-warrenelven-ca even depth-2 parent" id="comment-1319265">
				<div id="div-comment-1319265" class="comment-body">
				<div class="comment-author vcard">
						<cite class="fn"><a href='https://social.msdn.microsoft.com/profile/warrens' rel='external nofollow' class='url'>warrens</a></cite> <span class="says">says:</span>		</div>
		
		<div class="comment-meta commentmetadata"><a href="https://blogs.msdn.microsoft.com/oldnewthing/20180101-00/?p=97685#comment-1319265">
			January 1, 2018 at 7:22 pm</a>		</div>

		<p>Task Manager displays ended processes that still have open handles.  That&#8217;s how it works.<br />
This includes device drivers, as Raymond discussed, thirteen years ago: <a href="https://blogs.msdn.microsoft.com/oldnewthing/20040723-00/?p=38363" rel="nofollow">https://blogs.msdn.microsoft.com/oldnewthing/20040723-00/?p=38363</a></p>

		<div class="reply"><a rel='nofollow' class='comment-reply-link' href='https://blogs.msdn.microsoft.com/oldnewthing/20180101-00/?p=97685&#038;replytocom=1319265#respond' onclick='return addComment.moveForm( "div-comment-1319265", "1319265", "respond", "97685" )' aria-label='Reply to warrens'>Reply</a></div>
				</div>
		<ol class="children">
		<li class="comment byuser comment-author-wndsks odd alt depth-3 parent" id="comment-1319276">
				<div id="div-comment-1319276" class="comment-body">
				<div class="comment-author vcard">
						<cite class="fn"><a href='https://social.msdn.microsoft.com/profile/skSdnW' rel='external nofollow' class='url'>skSdnW</a></cite> <span class="says">says:</span>		</div>
		
		<div class="comment-meta commentmetadata"><a href="https://blogs.msdn.microsoft.com/oldnewthing/20180101-00/?p=97685#comment-1319276">
			January 1, 2018 at 10:35 pm</a>		</div>

		<p>My point is/was, Task Manager is not the best tool to use to prove something like this because most people outside Microsoft don&#8217;t know how it actually works. Task Manager calls undocumented Nt functions and implementations details related to those controls the list (IIRC). Maybe one day Microsoft decides that it should hide zombie processes by filtering the list it gets from ntdll.</p>

		<div class="reply"><a rel='nofollow' class='comment-reply-link' href='https://blogs.msdn.microsoft.com/oldnewthing/20180101-00/?p=97685&#038;replytocom=1319276#respond' onclick='return addComment.moveForm( "div-comment-1319276", "1319276", "respond", "97685" )' aria-label='Reply to skSdnW'>Reply</a></div>
				</div>
		<ol class="children">
		<li class="comment even depth-4 parent" id="comment-1319305">
				<div id="div-comment-1319305" class="comment-body">
				<div class="comment-author vcard">
						<cite class="fn">laonianren</cite> <span class="says">says:</span>		</div>
		
		<div class="comment-meta commentmetadata"><a href="https://blogs.msdn.microsoft.com/oldnewthing/20180101-00/?p=97685#comment-1319305">
			January 2, 2018 at 7:00 am</a>		</div>

		<p>The whole point of the post is that these are all things you can try yourself.  You don&#8217;t need inside knowledge to observe that Task Manager displays zombie processes.  And I have no doubt that Raymond has observed this.</p>

		<div class="reply"><a rel='nofollow' class='comment-reply-link' href='https://blogs.msdn.microsoft.com/oldnewthing/20180101-00/?p=97685&#038;replytocom=1319305#respond' onclick='return addComment.moveForm( "div-comment-1319305", "1319305", "respond", "97685" )' aria-label='Reply to laonianren'>Reply</a></div>
				</div>
		<ol class="children">
		<li class="comment odd alt depth-5" id="comment-1319385">
				<div id="div-comment-1319385" class="comment-body">
				<div class="comment-author vcard">
						<cite class="fn">Peter Doubleday</cite> <span class="says">says:</span>		</div>
		
		<div class="comment-meta commentmetadata"><a href="https://blogs.msdn.microsoft.com/oldnewthing/20180101-00/?p=97685#comment-1319385">
			January 2, 2018 at 8:09 am</a>		</div>

		<p>Ah, but now you&#8217;re applying Occam&#8217;s Razor to a supposition clearly motivated by the High Paranoid Style.</p>
<p>Do not do this.</p>
<p>It is clearly possible for Microsoft to design Task Manager to filter a list of processes with a handle still open (from any source! Not just from ntdll!) to excise from that list the processes whose open handles exclusively define them as zombies.  I mean, it would take a ridiculous amount of effort.  You&#8217;d have to filter out, not only the processes whose sole remaining open handle belongs to Resource Manager, but also those processes who still have an open handle owned by <b>every other process in the system</b>.  Including <i>other</i> zombie processes, which makes it even more fun.</p>
<p>Since it is clearly possible, and since Microsoft has infinite resources for all practical purposes, it therefore follows that if we wait long enough, Microsoft will do this.</p>
<p>Would it have any benefit to anybody, including to Microsoft? That is the wrong question to ask.  When dealing with the High Paranoid Style, you have to accept the (zombie?) voices in your head.  Trust nobody unless you can eat their brains!</p>

		
				</div>
		</li><!-- #comment-## -->
		<li class="comment even depth-5" id="comment-1319495">
				<div id="div-comment-1319495" class="comment-body">
				<div class="comment-author vcard">
						<cite class="fn">Someone</cite> <span class="says">says:</span>		</div>
		
		<div class="comment-meta commentmetadata"><a href="https://blogs.msdn.microsoft.com/oldnewthing/20180101-00/?p=97685#comment-1319495">
			January 2, 2018 at 1:09 pm</a>		</div>

		<p>@Peter Doubleday: Being terminated is a state; open handles are irrelevant for this, so your theory breaks down. For whatever reason, Task Manager (and the Tool Help family of functions) don&#8217;t report processes in that state.</p>
<p><a href="https://msdn.microsoft.com/en-us/library/windows/desktop/ms686985(v=vs.85)" rel="nofollow">https://msdn.microsoft.com/en-us/library/windows/desktop/ms686985(v=vs.85)</a>.aspx</p>

		
				</div>
		</li><!-- #comment-## -->
</ol><!-- .children -->
</li><!-- #comment-## -->
		<li class="comment odd alt depth-4" id="comment-1319445">
				<div id="div-comment-1319445" class="comment-body">
				<div class="comment-author vcard">
						<cite class="fn">laonianren</cite> <span class="says">says:</span>		</div>
		
		<div class="comment-meta commentmetadata"><a href="https://blogs.msdn.microsoft.com/oldnewthing/20180101-00/?p=97685#comment-1319445">
			January 2, 2018 at 9:29 am</a>		</div>

		<p>My apologies, you were right!  I actually tried it and Task Manager does indeed remove zombies.  I guess the behaviour did change at some point.</p>

		<div class="reply"><a rel='nofollow' class='comment-reply-link' href='https://blogs.msdn.microsoft.com/oldnewthing/20180101-00/?p=97685&#038;replytocom=1319445#respond' onclick='return addComment.moveForm( "div-comment-1319445", "1319445", "respond", "97685" )' aria-label='Reply to laonianren'>Reply</a></div>
				</div>
		</li><!-- #comment-## -->
		<li class="comment even depth-4" id="comment-1319536">
				<div id="div-comment-1319536" class="comment-body">
				<div class="comment-author vcard">
						<cite class="fn">Ian Yates</cite> <span class="says">says:</span>		</div>
		
		<div class="comment-meta commentmetadata"><a href="https://blogs.msdn.microsoft.com/oldnewthing/20180101-00/?p=97685#comment-1319536">
			January 3, 2018 at 12:58 am</a>		</div>

		<p>I had a similar thought.  I wouldn&#8217;t have used Task Manager as my &#8220;proof&#8221; simply because I don&#8217;t know how it enumerates, filters and lists processes.  It sounds like it just asks some kernel function &#8220;give me all of the processes&#8221; and blindly lists them.<br />
However we know it does some filtering &amp; grouping at least on some of its tabs.  On other tabs (details in Win Server 2016 for example) the list is filtered to your own processes if you&#8217;re not an admin, but that&#8217;s more a kernel filter rather than a user-land filter.</p>
<p>Put simply, I would&#8217;ve probably gone for my own &#8220;list available process handles&#8221; function and then do the whole &#8220;pause resource monitor&#8221; thing.</p>
<p>I&#8217;m happy to take Raymond&#8217;s word at face value though, particularly since it&#8217;s holiday time so I don&#8217;t really have the tools available to try any of the above myself anyway :D</p>

		<div class="reply"><a rel='nofollow' class='comment-reply-link' href='https://blogs.msdn.microsoft.com/oldnewthing/20180101-00/?p=97685&#038;replytocom=1319536#respond' onclick='return addComment.moveForm( "div-comment-1319536", "1319536", "respond", "97685" )' aria-label='Reply to Ian Yates'>Reply</a></div>
				</div>
		</li><!-- #comment-## -->
</ol><!-- .children -->
</li><!-- #comment-## -->
</ol><!-- .children -->
</li><!-- #comment-## -->
</ol><!-- .children -->
</li><!-- #comment-## -->
		<li class="comment odd alt thread-odd thread-alt depth-1" id="comment-1319275">
				<div id="div-comment-1319275" class="comment-body">
				<div class="comment-author vcard">
						<cite class="fn">Pavel</cite> <span class="says">says:</span>		</div>
		
		<div class="comment-meta commentmetadata"><a href="https://blogs.msdn.microsoft.com/oldnewthing/20180101-00/?p=97685#comment-1319275">
			January 1, 2018 at 10:25 pm</a>		</div>

		<p>I disagree. Task Manager shows processes that are truly alive. If a process is terminated and handles to it remain, it won&#8217;t show in the Details pane.<br />
Quick demo:</p>
<p>	WCHAR name[] = L&#8221;Notepad&#8221;;</p>
<p>	STARTUPINFO si = { sizeof(si) };<br />
	PROCESS_INFORMATION pi;<br />
	::CreateProcess(nullptr, name, nullptr, nullptr, FALSE, 0, nullptr, nullptr, &amp;si, &amp;pi);<br />
	::Sleep(INFINITE);</p>
<p>Once you close notepad, it&#8217;s gone from Task Manager while the handle to it is still open</p>

		<div class="reply"><a rel='nofollow' class='comment-reply-link' href='https://blogs.msdn.microsoft.com/oldnewthing/20180101-00/?p=97685&#038;replytocom=1319275#respond' onclick='return addComment.moveForm( "div-comment-1319275", "1319275", "respond", "97685" )' aria-label='Reply to Pavel'>Reply</a></div>
				</div>
		</li><!-- #comment-## -->
		<li class="comment even thread-even depth-1" id="comment-1319365">
				<div id="div-comment-1319365" class="comment-body">
				<div class="comment-author vcard">
						<cite class="fn">Ben Voigt</cite> <span class="says">says:</span>		</div>
		
		<div class="comment-meta commentmetadata"><a href="https://blogs.msdn.microsoft.com/oldnewthing/20180101-00/?p=97685#comment-1319365">
			January 2, 2018 at 7:57 am</a>		</div>

		<p>Getting a followup as a blog article is pretty awesome, I had only hoped for a reply comment.  Getting that followup without the two year queue delay&#8230;. most impressive.  Makes me think that henke37 is correct.</p>
<p>On the other hand, it would be nice if my name were correctly spelled&#8230;. pretty please ;)</p>
<p>[<i>My apologies! Fixed. -Raymond</i>]</p>

		<div class="reply"><a rel='nofollow' class='comment-reply-link' href='https://blogs.msdn.microsoft.com/oldnewthing/20180101-00/?p=97685&#038;replytocom=1319365#respond' onclick='return addComment.moveForm( "div-comment-1319365", "1319365", "respond", "97685" )' aria-label='Reply to Ben Voigt'>Reply</a></div>
				</div>
		</li><!-- #comment-## -->
		<li class="comment byuser comment-author-alegrigoriev odd alt thread-odd thread-alt depth-1 parent" id="comment-1319395">
				<div id="div-comment-1319395" class="comment-body">
				<div class="comment-author vcard">
						<cite class="fn"><a href='https://social.msdn.microsoft.com/profile/alegr1' rel='external nofollow' class='url'>alegr1</a></cite> <span class="says">says:</span>		</div>
		
		<div class="comment-meta commentmetadata"><a href="https://blogs.msdn.microsoft.com/oldnewthing/20180101-00/?p=97685#comment-1319395">
			January 2, 2018 at 8:18 am</a>		</div>

		<p>&gt;But as long as the process object exists, it shows up in the Details page of Task Manager.</p>
<p>That&#8217;s not true. Task Manager cannot show a process after its memory space has been destroyed, which happens after all its threads are terminated and cleaned up. Some other process can hold a handle to it, but the process will not show up in TM.</p>
<p>There was a version of Visual Studio which was forgetting to close handles to the build processes. Those zombies were not showing up in Task Manager, but the kernel debugger was showing processes with no threads.</p>

		<div class="reply"><a rel='nofollow' class='comment-reply-link' href='https://blogs.msdn.microsoft.com/oldnewthing/20180101-00/?p=97685&#038;replytocom=1319395#respond' onclick='return addComment.moveForm( "div-comment-1319395", "1319395", "respond", "97685" )' aria-label='Reply to alegr1'>Reply</a></div>
				</div>
		<ol class="children">
		<li class="comment byuser comment-author-alegrigoriev even depth-2 parent" id="comment-1319435">
				<div id="div-comment-1319435" class="comment-body">
				<div class="comment-author vcard">
						<cite class="fn"><a href='https://social.msdn.microsoft.com/profile/alegr1' rel='external nofollow' class='url'>alegr1</a></cite> <span class="says">says:</span>		</div>
		
		<div class="comment-meta commentmetadata"><a href="https://blogs.msdn.microsoft.com/oldnewthing/20180101-00/?p=97685#comment-1319435">
			January 2, 2018 at 8:59 am</a>		</div>

		<p>Just ran an experiment with the kernel debugger.<br />
!stacks was showing a zombie instance of smss.exe with no threads. Task Manager and resource monitor were not showing it.<br />
Broke into the kernel debugger while Resource Monitor was showing Terminated for a process. There was no process object for the PID of the terminated process.</p>

		<div class="reply"><a rel='nofollow' class='comment-reply-link' href='https://blogs.msdn.microsoft.com/oldnewthing/20180101-00/?p=97685&#038;replytocom=1319435#respond' onclick='return addComment.moveForm( "div-comment-1319435", "1319435", "respond", "97685" )' aria-label='Reply to alegr1'>Reply</a></div>
				</div>
		<ol class="children">
		<li class="comment byuser comment-author-alexcohn odd alt depth-3 parent" id="comment-1319505">
				<div id="div-comment-1319505" class="comment-body">
				<div class="comment-author vcard">
						<cite class="fn"><a href='https://social.msdn.microsoft.com/profile/Alex+Cohn' rel='external nofollow' class='url'>Alex Cohn</a></cite> <span class="says">says:</span>		</div>
		
		<div class="comment-meta commentmetadata"><a href="https://blogs.msdn.microsoft.com/oldnewthing/20180101-00/?p=97685#comment-1319505">
			January 2, 2018 at 1:29 pm</a>		</div>

		<p>That&#8217;s a proof, finally!</p>

		<div class="reply"><a rel='nofollow' class='comment-reply-link' href='https://blogs.msdn.microsoft.com/oldnewthing/20180101-00/?p=97685&#038;replytocom=1319505#respond' onclick='return addComment.moveForm( "div-comment-1319505", "1319505", "respond", "97685" )' aria-label='Reply to Alex Cohn'>Reply</a></div>
				</div>
		<ol class="children">
		<li class="comment even depth-4" id="comment-1319545">
				<div id="div-comment-1319545" class="comment-body">
				<div class="comment-author vcard">
						<cite class="fn">Ian Yates</cite> <span class="says">says:</span>		</div>
		
		<div class="comment-meta commentmetadata"><a href="https://blogs.msdn.microsoft.com/oldnewthing/20180101-00/?p=97685#comment-1319545">
			January 3, 2018 at 1:00 am</a>		</div>

		<p>Winning :)<br />
Thanks for the details @alegr1</p>

		<div class="reply"><a rel='nofollow' class='comment-reply-link' href='https://blogs.msdn.microsoft.com/oldnewthing/20180101-00/?p=97685&#038;replytocom=1319545#respond' onclick='return addComment.moveForm( "div-comment-1319545", "1319545", "respond", "97685" )' aria-label='Reply to Ian Yates'>Reply</a></div>
				</div>
		</li><!-- #comment-## -->
</ol><!-- .children -->
</li><!-- #comment-## -->
</ol><!-- .children -->
</li><!-- #comment-## -->
</ol><!-- .children -->
</li><!-- #comment-## -->
		</ol><!-- .comment-list -->

		<div class="navigation pagination">
					</div>
<!-- COMMENTS END -->
</div></td></tr></table>

</body>
</html>
<br/><div class="disclaimer">
*DISCLAIMER: I DO NOT OWN THIS CONTENT. If you are the owner and would like it removed, please
<a target="_blank" href="/contact.htm">contact me</a>.
The content herein is an archived reproduction of entries from
Raymond Chen's "Old New Thing" Blog (most recent link is <a target="_blank" href="https://devblogs.microsoft.com/oldnewthing/">here</a>).
It may have slight formatting modifications for consistency and to improve readability.
<br/><br/>
WHY DID I DUPLICATE THIS CONTENT HERE?
Let me first say this site has never had anything to sell and has never shown ads of any kind. I have nothing monetarily to gain by duplicating content here.
Because I had made my own local copy of this content throughout the years, for ease of using tools like grep, I decided to put it online after I discovered
some of the original content previously and publicly available, had disappeared approximately early to mid 2019.
At the same time, I present the content in an easily accessible theme-agnostic way.
<br/><br/>
The information provided by Raymond's blog is, for all practical purposes, more authoritative on Windows Development than Microsoft's
own MSDN documentation and should be considered supplemental reading to that documentation. The wealth of missing details
provided by this blog that Microsoft could not or did not document about Windows over the years is vital enough, many would agree an online "backup" of these details
is a necessary endeavor. Specifics include:<br/>
<ul>
    <li>
        A "redesign" after 2019 erased thousands of user's comments from previous years. As many have stated, the comments are nearly as important as the postings themselves.
        The archived copies of the postings contained here retain the original comments.
    </li>
    <li>
        The blog has changed domains many times and the urls have otherwise been under constant change since 2003.
        Even when proper redirection has been set up for those links, redirection only works for a limited period of time.
        For example, all of the internal blog links that were valid in early 2019, were broken by 2020 without proper redirection.
    </li>
    <li>
        The blog has been under constant re-design and re-theming since its inception.
        It is downright irritating to deal with a bogged-down site experience as the result of the latest visual themes designed for cell-phone browsers.
        As of this writing, it is cumbersome to navigate titles with only 10 entries per page.
        While it is nice that the official site has a search feature, searching using this index (with all titles on a single page) is much quicker (CTRL-F in most browsers).
    </li>
</ul>
</div><br/>
&lt;-- Back to <a href="index.htm">Old New Thing Archive Index</a>

