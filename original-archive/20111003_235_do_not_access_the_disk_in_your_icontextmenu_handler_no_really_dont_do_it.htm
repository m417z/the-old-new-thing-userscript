<html>
<head>
<title>Do not access the disk in your IContextMenu handler, no really, don't do it</title>
<link rel="stylesheet" href="page.css">
</head><body>
<div class="titlediv"><h2>Do not access the disk in your IContextMenu handler, no really, don&#8217;t do it</h2></div>
<div class="hdrdiv"><table class="hdrtable" cellspacing="0" cellpadding="0">
<tr><td><b>Date:</b></td><td>October 3, 2011 / year-entry #236</td></tr>
<tr><td><b>Tags:</b></td><td>code</td></tr>
<tr><td><b>Orig Link:</b></td><td>https://blogs.msdn.microsoft.com/oldnewthing/20111003-00/?p=9493</td></tr>

<tr><td><b>Comments:&nbsp;&nbsp;&nbsp;&nbsp;</b></td><td>22</td></tr>
<tr><td valign="top"><b>Summary:</b></td><td valign="top">We saw some time ago that the number one cause of crashes in Explorer is malware. It so happens that the number one cause of hangs in Explorer is disk access from context menu handlers (a special case of the more general principle, you can't open the file until the user tells you to open...</td></tr>
</table></div>
<hr/>
<table class="contenttable" cellspacing="0" cellpadding="0"><tr><td><div class="contentdiv">
<!-- CONTENT START -->
<p>
We saw some time ago that
<a HREF="http://blogs.msdn.com/b/oldnewthing/archive/2008/05/21/8525411.aspx">
the number one cause of crashes in Explorer is malware</a>.
</p>
<p>
It so happens that the number one cause of hangs in Explorer
is disk access from context menu handlers
(a special case of the more general principle,
<a HREF="http://blogs.msdn.com/b/oldnewthing/archive/2009/04/15/9549682.aspx">
you can't open the file until the user tells you to open it</a>).
</p>
<p>
That's why I was amused by Memet's claim that
<a HREF="http://blogs.msdn.com/oldnewthing/archive/2009/10/05/9903476.aspx#9904591">
"would hit the disk" is not acceptable for me</a>.
The feedback I see from customers, either directly
from
<a HREF="http://blogs.msdn.com/b/oldnewthing/archive/2009/05/28/9645162.aspx">
large multinational corporations with 500ms ping times</a>
or indirectly
<a HREF="http://blogs.msdn.com/b/oldnewthing/archive/2010/08/04/10045651.aspx">
from individual users who collectively click <i>Send Report</i>
millions of times a day</a>,
is that "would hit the disk" ruins a lot of people's days.
It may not be acceptable to you, but millions of other people
would beg to disagree.
</p>
<p>
The Windows team tries very hard to identify unwanted disk accesses
in Explorer and get rid of them.
<a HREF="http://blogs.msdn.com/b/oldnewthing/archive/2005/01/11/350628.aspx#350903">
We don't get them all</a>, but at least we try.
But if the unwanted disk access is coming from a third-party add-on,
there isn't much that can be done aside from saying,
"Don't do that" and hoping the vendor listens.
</p>
<p>
Every so often, a vendor will come back and ask for advice on avoiding
disk access in their context menu handler.
There's a lot of information packed into that data object that
contains information gathered from when the disk was accessed originally.
You can just retrieve that cached data instead of going off and
hitting the disk again to recalculate it.
</p>
<p>
I'm going to use a boring console application and the clipboard
rather than building a full
<code>IContext&shy;Menu</code>,
since the purpose here is to show how to get data from a data object
without hitting the disk and not to delve into the details of
<code>IContext&shy;Menu</code> implementation.
</p>
<pre>
#define UNICODE
#define <a HREF="http://blogs.msdn.com/b/oldnewthing/archive/2004/02/12/71851.aspx">_UNICODE</a>
#include &lt;windows.h&gt;
#include &lt;ole2.h&gt;
#include &lt;shlobj.h&gt;
#include &lt;propkey.h&gt;
#include &lt;tchar.h&gt;

void ProcessDataObject(IDataObject *pdto)
{
 ... to be written ...
}

int __cdecl _tmain(int argc, PTSTR *argv)
{
 if (SUCCEEDED(OleInitialize(NULL))) {
  IDataObject *pdto;
  if (SUCCEEDED(OleGetClipboard(&amp;pdto))) {
   ProcessDataObject(pdto);
   pdto-&gt;Release();
  }
  OleUninitialize();
 }
}
</pre>
<p>
Okay, let's say that we want to check that all the items
on the clipboard are files and not directories.
The <code>HDROP</code> way of doing this would be to get
the path to each of the items in the data object,
then call <code>Get&shy;File&shy;Attributes</code> on each one to see
if any of them has the
<code>FILE_<wbr>ATTRIBUTE_<wbr>DIRECTORY</code> flag set.
But this hits the disk, which makes baby context menu host sad.
Fortunately, the <code>IShell&shy;Item&shy;Array</code> interface provides
an easy way to check whether any or all the items in a data object
have a particular attribute.
</p>
<pre>
void ProcessDataObject(IDataObject *pdto)
{
 IShellItemArray *psia;
 HRESULT hr;
 hr = SHCreateShellItemArrayFromDataObject(pdto,
                                          IID_PPV_ARGS(&amp;psia));
 if (SUCCEEDED(hr)) {
  SFGAOF sfgaoResult;
  hr = psia-&gt;GetAttributes(SIATTRIBFLAGS_OR, SFGAO_FOLDER,
                                                 &amp;sfgaoResult);
  if (hr == S_OK) {
   _tprintf(TEXT("Contains a folder\n"));
  } else if (hr == S_FALSE) {
   _tprintf(TEXT("Contains no folders\n"));
  }
  psia-&gt;Release();
 }
}
</pre>
<p>
In this case, we want to see if any item
(<code>SI&shy;ATTRIB&shy;FLAGS_<wbr>OR</code>)
in the data object has
the <code>SFGAO_<wbr>FOLDER</code> attribute.
The <code>IShell&shy;Item&shy;Array::<wbr>Get&shy;Attributes</code>
method returns
<code>S_OK</code> if all of the attributes you requested
are present in the result.
Since we asked for only one attribute, and since we asked for
the result to be the logical <i>or</i> of the individual attributes,
this means that it returns <code>S_OK</code> if any item is a folder.
</p>
<p>
Okay, fine, but what if the thing you want to know is not expressible
as a <code>SFGAO</code> flag?
Well, you can dig into each of the individual items.
For example, suppose we want to see the size of each item.
</p>
<pre>
#include &lt;strsafe.h&gt;

void ProcessDroppedObject(IDataObject *pdto)
{
 IShellItemArray *psia;
 HRESULT hr;
 hr = SHCreateShellItemArrayFromDataObject(pdto,
                                          IID_PPV_ARGS(&amp;psia));
 if (SUCCEEDED(hr)) {
  <font COLOR=blue>IEnumShellItems *pesi;
  hr = psia-&gt;EnumItems(&amp;pesi);
  if (SUCCEEDED(hr)) {
   IShellItem *psi;
   while (pesi-&gt;Next(1, &amp;psi, NULL) == S_OK) {
    IShellItem2 *psi2;
    hr = psi-&gt;QueryInterface(IID_PPV_ARGS(&amp;psi2));
    if (SUCCEEDED(hr)) {
     ULONGLONG ullSize;
     hr = psi2-&gt;GetUInt64(PKEY_Size, &amp;ullSize);
     if (SUCCEEDED(hr)) {
      _tprintf(TEXT("Item size is %I64u\n"), ullSize);
     }
     psi2-&gt;Release();
    }
    psi-&gt;Release();
   }
  }</font>
  psia-&gt;Release();
 }
}
</pre>
<p>
I went for <code>IEnum&shy;Shell&shy;Items</code> here,
even though a <code>for</code> loop
with <code>IShell&shy;Item&shy;Array::<wbr>Get&shy;Count</code> and
<code>IShell&shy;Item&shy;Array::<wbr>Get&shy;Item&shy;At</code>
would have worked, too.
</p>
<p>
File system items in data objects cache a bunch of useful pieces
of information, such as the last-modified time, file creation time,
last-access time,
the file size,
the file attributes, and the file name (both long and short).
Of course, all of these properties are subject to file system support.
the shell just takes what's in the <code>WIN32_<wbr>FIND_<wbr>DATA</code>;
if the values are incorrect
(for example, if last-access time tracking is disabled),
then the shell is going to cache the incorrect value.
But don't say, "Well, if the cache is no good, then I won't use it;
I'll just go hit the disk", because if you hit the disk,
the file system is going to give you the same incorrect value anyway!
</p>
<p>
If you just want to order the combo platter, you can ask for
<a HREF="http://msdn.microsoft.com/library/bb760709.aspx">
<code>PKEY_<wbr>Find&shy;Data</code></a>, and out will come a
<code>WIN32_<wbr>FIND_<wbr>DATA</code>.
This might be the easiest way to convert your old-style context menu
that hits the disk into a new-style context menu that doesn't hit the
disk:
Take your calls to
<code>Get&shy;File&shy;Attributes</code> and
<code>Find&shy;First&shy;File</code>
and convert them into calls into the property system,
asking for <code>PKEY_<wbr>File&shy;Attributes</code> or
<code>PKEY_<wbr>Find&shy;Data</code>.
</p>
<p>
Okay, that's the convenient modern way to get information that has
been cached in the data object provided by the shell.
What if you're an old-school programmer?
Then you get to roll up your sleeves and get your hands dirty with
the <code>CFSTR_<wbr>SHELL&shy;ID&shy;LIST</code>
clipboard format.
(And if your target is Windows&nbsp;XP or earlier,
you have to do it this way since the
<code>IShell&shy;Item&shy;Array</code> interface
was not introduced until Windows Vista.)
In fact, the <code>CFSTR_<wbr>SHELL&shy;ID&shy;LIST</code>
clipboard format will get your hands so dirty,
I'm writing a helper class to manage it.
</p>
<p>
First, go back and familiarize yourself with
<a HREF="http://msdn.microsoft.com/library/bb773212.aspx">
the <code>CIDA</code> structure</a>.
</p>
<pre>
// these should look familiar
#define HIDA_GetPIDLFolder(pida) (LPCITEMIDLIST)(((LPBYTE)pida)+(pida)-&gt;aoffset[0])
#define HIDA_GetPIDLItem(pida, i) (LPCITEMIDLIST)(((LPBYTE)pida)+(pida)-&gt;aoffset[i+1])

void ProcessDataObject(IDataObject *pdto)
{
 FORMATETC fmte = {
    (CLIPFORMAT)RegisterClipboardFormat(CFSTR_SHELLIDLIST),
    NULL, DVASPECT_CONTENT, -1, TYMED_HGLOBAL };
 STGMEDIUM stm = { 0 }; // defend against buggy data object
 HRESULT hr = pdto-&gt;GetData(&amp;fmte, &amp;stm);
 if (SUCCEEDED(hr) &amp;&amp; stm.hGlobal != NULL) {
  LPIDA pida = (LPIDA)GlobalLock(stm.hGlobal);
  if (pida != NULL) { // defend against buggy data object
   IShellFolder *psfRoot;
   hr = SHBindToObject(NULL, HIDA_GetPIDLFolder(pida), NULL,
                       IID_PPV_ARGS(&amp;psfRoot));
   if (SUCCEEDED(hr)) {
    for (UINT i = 0; i &lt; pida-&gt;cidl; i++) {
     IShellFolder2 *psf2;
     PCUITEMID_CHILD pidl;
     hr = SHBindToFolderIDListParent(psfRoot,
                HIDA_GetPIDLItem(pida, i),
                IID_PPV_ARGS(&amp;psf2), &amp;pidl);
     if (SUCCEEDED(hr)) {
      VARIANT vt;
      if (SUCCEEDED(psf2-&gt;GetDetailsEx(pidl, &amp;PKEY_Size, &amp;vt))) {
       if (SUCCEEDED(VariantChangeType(&amp;vt, &amp;vt, 0, VT_UI8))) {
         _tprintf(TEXT("Item size is %I64u\n"), vt.ullVal);
       }
       VariantClear(&amp;vt);
      }
      psf2-&gt;Release();
     }
    }
    psfRoot-&gt;Release();
   }
   GlobalUnlock(stm.hGlobal);
  }
  ReleaseStgMedium(&amp;stm);
 }
}
</pre>
<p>
I warned you it was going to be ugly.
</p>
<p>
First, we retrieve the <code>CFSTR_<wbr>SHELL&shy;ID&shy;LIST</code> clipboard
format from the data object.
This format takes the form of an <code>HGLOBAL</code>,
which needs to be <code>Global&shy;Lock</code>'d
like all <code>HGLOBAL</code>s
returned by <code>IData&shy;Object::<wbr>Get&shy;Data</code>.
You may notice two defensive measures here.
First, there is a defense against data objects which return
success when they actually failed.
To detect this case, we zero out the <code>STG&shy;MEDIUM</code> and
make sure they returned something non-<code>NULL</code> in it.
The second defensive measure is against data objects which
put an invalid <code>HGLOBAL</code> in the <code>STG&shy;MEDIUM</code>.
One of the nice things about doing things the
<code>IShell&shy;Item&shy;Array</code> way is that the shell default
implementation of <code>IShell&shy;Item&shy;Array</code> has all these
defensive measures built-in so you don't have to write them yourself.
</p>
<p>
Anyway, once we get the <code>CIDA</code>,
we bind to the folder portion, walk through the items,
and get the size of each item in order to print it.
Same story, different words.
</p>
<p>
<b>Exercise</b>: Why did we need a separate defensive measure
for data objects which returned success but left garbage in the
<code>STG&shy;MEDIUM</code>?
Why doesn't the <code>Global&shy;Lock</code> test cover that case, too?</p>
<!-- CONTENT END -->
</div></td></tr></table>
<hr/>
<table class="commenttable" cellspacing="0" cellpadding="0"><tr><td><div class="commentdiv"><div class="commentdivhdr">
<!-- COMMENTS START -->
Comments (22)	</div>

	
			<div class="navigation pagination clear-both">
					</div>

		<ol class="comment-list">
					<li class="comment byuser comment-author-alegrigoriev even thread-even depth-1" id="comment-938403">
				<div id="div-comment-938403" class="comment-body">
				<div class="comment-author vcard">
						<cite class="fn"><a href='https://social.msdn.microsoft.com/profile/alegr1' rel='external nofollow' class='url'>alegr1</a></cite> <span class="says">says:</span>		</div>
		
		<div class="comment-meta commentmetadata"><a href="https://blogs.msdn.microsoft.com/oldnewthing/20111003-00/?p=9493#comment-938403">
			October 3, 2011 at 8:26 am</a>		</div>

		<p>I wonder what thinking brought us the Explorer&#39;s new stupid behavior in Vista+, when it refuses to calculate and show total size of selected files, if more than 15 selected, which limit was arbitrarily raised (but not removed, regretfully) to 100 in Windows 8.</p>
<p>&quot;It&#39;s too much CPU time to sum those 64-bit numbers and sort those 64 bit FILETIMEs, that we already got in our file list&quot;. And don&#39;t feed me this &quot;offline file&quot; BS. If there are files offline, which Explorer knows already from WIN32_FIND_DATA::dwFileAttributes, THEN explorer can show partial results or change its behavior. But if the directory was read successfully, which happens in 99.999% of cases, Y U NO SHOW TOTAL SIZE?</p>
<div class="post">[<i>I think you&#39;ll find that people are more likely to respond if you don&#39;t insult them. Interestingly, the email next to your comment in my inbox was a spam message titled &quot;How to Deal With Difficult People.&quot; -Raymond</i>]</div>

		
				</div>
		</li><!-- #comment-## -->
		<li class="comment odd alt thread-odd thread-alt depth-1" id="comment-938413">
				<div id="div-comment-938413" class="comment-body">
				<div class="comment-author vcard">
						<cite class="fn">Mordachai</cite> <span class="says">says:</span>		</div>
		
		<div class="comment-meta commentmetadata"><a href="https://blogs.msdn.microsoft.com/oldnewthing/20111003-00/?p=9493#comment-938413">
			October 3, 2011 at 9:12 am</a>		</div>

		<p>Why doesn&#39;t GlobalLock cover garbage in STGMEDIUM? &nbsp;Because you could get unlucky and have the garbage happen to be a valid HGLOBAL?</p>
<p>Unfortunately for us we&#39;re definitely bound to XP interfaces for another year, at least. &nbsp;Although MS is dropping support, too many customers still cling to it. &nbsp;Perhaps in a year, or two. &nbsp;Once Windows 8 is out, it will be much easier to justify &quot;Vista or above&quot; to our customers.</p>
<p>Thanks for the explanation. &nbsp;Bad context handlers are indeed a major source of pain. &nbsp;Is there an easy way to control one&#39;s system to enable/disable IContext handlers as an end user?</p>

		
				</div>
		</li><!-- #comment-## -->
		<li class="comment even thread-even depth-1" id="comment-938423">
				<div id="div-comment-938423" class="comment-body">
				<div class="comment-author vcard">
						<cite class="fn">Ian Boyd</cite> <span class="says">says:</span>		</div>
		
		<div class="comment-meta commentmetadata"><a href="https://blogs.msdn.microsoft.com/oldnewthing/20111003-00/?p=9493#comment-938423">
			October 3, 2011 at 9:22 am</a>		</div>

		<p>My Documents contains a folder called &quot;Torrents&quot;, which is actually a junction to a location on another (large slow) hard drive. This other drive is set to spin down after a few minutes of inactivity.</p>
<p>If your context menu handler accesses the disk when i right-click on my &quot;Torrents&quot; folder, i have to wait 7-10 seconds for the drive platters to spin up.</p>
<p>Similarly, if i open my Documents folder in Thumbnail view, Explorer touches the disk to try to show a preview of file contents in the folder. This causes Explorer to freeze for 5-7 seconds while i hear the platters spin up.</p>

		
				</div>
		</li><!-- #comment-## -->
		<li class="comment odd alt thread-odd thread-alt depth-1" id="comment-938433">
				<div id="div-comment-938433" class="comment-body">
				<div class="comment-author vcard">
						<cite class="fn">Mike Dunn</cite> <span class="says">says:</span>		</div>
		
		<div class="comment-meta commentmetadata"><a href="https://blogs.msdn.microsoft.com/oldnewthing/20111003-00/?p=9493#comment-938433">
			October 3, 2011 at 9:34 am</a>		</div>

		<p>Thanks for providing the XP-friendly way of doing it, but the SHBindToFolderIDListParent API was added in Vista.</p>
<div class="post">[<i>Developing the XP-equivalent version of SHBindToFolderIDListParent is left as an exercise. SHBindToFolderIDListParent does not add any fundamentally new functionality; it&#39;s just a helper function, like StrRetToStr. -Raymond</i>]</div>

		
				</div>
		</li><!-- #comment-## -->
		<li class="comment even thread-even depth-1" id="comment-938443">
				<div id="div-comment-938443" class="comment-body">
				<div class="comment-author vcard">
						<cite class="fn">Alex Grigoriev</cite> <span class="says">says:</span>		</div>
		
		<div class="comment-meta commentmetadata"><a href="https://blogs.msdn.microsoft.com/oldnewthing/20111003-00/?p=9493#comment-938443">
			October 3, 2011 at 10:39 am</a>		</div>

		<p>@Ian Boyd:</p>
<p>Move the junction to a subdirectory of Documents, and put a desktop.ini to that subdirectory to provide the icon without having Explorer to dig deeper.</p>

		
				</div>
		</li><!-- #comment-## -->
		<li class="comment odd alt thread-odd thread-alt depth-1" id="comment-938453">
				<div id="div-comment-938453" class="comment-body">
				<div class="comment-author vcard">
						<cite class="fn">David Walker</cite> <span class="says">says:</span>		</div>
		
		<div class="comment-meta commentmetadata"><a href="https://blogs.msdn.microsoft.com/oldnewthing/20111003-00/?p=9493#comment-938453">
			October 3, 2011 at 10:57 am</a>		</div>

		<p>Yes, the file system is a hierarchical storage system, but that shouldn&#39;t prevent Explorer from getting some information for locally stored files and less information for files stored on tape. &nbsp;</p>
<p>(I asked the SQL Server team about returning certain information from a remote data source, and their answer was that the remote data source might not BE a Microsoft SQL Server database, and the information wouldn&#39;t exist. &nbsp;My response was &quot;but then again, it might be, and when it is, that valuable information can be returned&quot;. &nbsp;I suggested that they think of it as marketing: &nbsp;If the remote data source IS a Microsoft SQL Server database, the user gets more information back. &nbsp;They were not impressed.)</p>

		
				</div>
		</li><!-- #comment-## -->
		<li class="comment even thread-even depth-1" id="comment-938463">
				<div id="div-comment-938463" class="comment-body">
				<div class="comment-author vcard">
						<cite class="fn">Wayne</cite> <span class="says">says:</span>		</div>
		
		<div class="comment-meta commentmetadata"><a href="https://blogs.msdn.microsoft.com/oldnewthing/20111003-00/?p=9493#comment-938463">
			October 3, 2011 at 11:01 am</a>		</div>

		<p>@Mordachai</p>
<p>The autoruns tool from sysinternals gives the ability to turn off individual content menu handlers. &nbsp;I go through that every so often and remove any context menu handlers for any apps I really don&#39;t need context menus for.</p>

		
				</div>
		</li><!-- #comment-## -->
		<li class="comment odd alt thread-odd thread-alt depth-1" id="comment-938473">
				<div id="div-comment-938473" class="comment-body">
				<div class="comment-author vcard">
						<cite class="fn">Anonymous Coward</cite> <span class="says">says:</span>		</div>
		
		<div class="comment-meta commentmetadata"><a href="https://blogs.msdn.microsoft.com/oldnewthing/20111003-00/?p=9493#comment-938473">
			October 3, 2011 at 11:04 am</a>		</div>

		<p>Here&#39;s a summary of the threads and blog posts provoked by Igor, Memet and others, in case you don&#39;t feel like wading through them, which would be understandable because it&#39;s pages and pages of text.</p>
<p>Igor doesn&#39;t want the e-mail resize picture dialogue box to show if its unnecessary. He is not alone. Raymond is immediately convinced of the reason why this is impossible: it would hit the disk. Many people prove that his objection is nonsensical, but Raymond refuses to properly read, let alone understand, their objections and keeps trotting out the same, by now disproven, point. Instead of admitting he&#39;s wrong and posting a correction, in the start of a new blog post he links back to the old ones and completely misrepresents what has been said there in a shameful display of dishonesty. (As well as, one assumes, in the hope that no one would be bothered to read that old material.)</p>
<p>Also, some replies to the old thread. I would have posted them there, but Raymond disabled the comments on that thread. (If you don&#39;t plan on wading through that one, you can stop reading now.)</p>
<p>@Peter: Leo responded to your post, before you even wrote it.</p>
<p>@Lawrence, Raymond: The dialogue should have a better name. Something along the lines of &lsquo;gathering files to send&rsquo;, depending on specifics of course.</p>
<p>@Lawrence: if you have to poke the registry around to do something, it is effectively impossible (for almost everybody).</p>
<div class="post">[<i>I agree that &quot;Gathering files to send&quot; would be a better title than &quot;Please wait while Windows decides whether or not to show you a dialog.&quot; But I thought the request was to show <span style="text-decoration:underline;">no dialog at all</span> unless necessary. We just replaced one mandatory dialog with a different mandatory dialog. -Raymond</i>]</div>

		
				</div>
		</li><!-- #comment-## -->
		<li class="comment even thread-even depth-1" id="comment-938483">
				<div id="div-comment-938483" class="comment-body">
				<div class="comment-author vcard">
						<cite class="fn">Alex Grigoriev</cite> <span class="says">says:</span>		</div>
		
		<div class="comment-meta commentmetadata"><a href="https://blogs.msdn.microsoft.com/oldnewthing/20111003-00/?p=9493#comment-938483">
			October 3, 2011 at 11:08 am</a>		</div>

		<p>&quot;I think you&#39;ll find that people are more likely to respond if you don&#39;t insult them.&quot;</p>
<p>I think the thought sequence for that misfeature was:</p>
<p>&quot;We now show the total playback time for the selected files. If multiple files are selected at once, it takes too much time&quot;</p>
<p>&quot;OK. Let&#39;s not calculate accumulated stats if there are more than N files&quot;</p>
<p>The question that should have been asked:</p>
<p>&quot;Why not show accumulated stats that don&#39;t require additional disk access anyway? Users expect it&quot;</p>
<p>Another question that should have been asked:</p>
<p>&quot;Why don&#39;t we add/subtract full stats as the selection changes by one/a few files?&quot;</p>
<div class="post">[<i>Sorry, you lost me when you wrote &quot;misfeature&quot;. -Raymond</i>]</div>

		
				</div>
		</li><!-- #comment-## -->
		<li class="comment odd alt thread-odd thread-alt depth-1" id="comment-938493">
				<div id="div-comment-938493" class="comment-body">
				<div class="comment-author vcard">
						<cite class="fn">Mordachai</cite> <span class="says">says:</span>		</div>
		
		<div class="comment-meta commentmetadata"><a href="https://blogs.msdn.microsoft.com/oldnewthing/20111003-00/?p=9493#comment-938493">
			October 3, 2011 at 11:40 am</a>		</div>

		<p>In the category of random grumblings, seems like the context handlers should have a user-friendly / easily accessed interface for controlling them built-in-to-windows. &nbsp;Autoruns is a great suggestion for power-users, but not so much for Ma &amp; Pa.</p>
<p>And along those lines, having things like MS Office by default install Groove (or whatever it&#39;s current marketing name is) which has an unwanted context extension that applies to everything is unfriendly. &nbsp;That should be an explicit opt-in, rather than by-default slather everywhere.</p>
<p>However, I note these things here because MS is gargantuan and where else is there that it might be seen by someone of any influence whatsoever? &nbsp;At least there&#39;s a snowball&#39;s chance of progress. &nbsp;But not to rag on our kind benefactor, Raymond.</p>

		
				</div>
		</li><!-- #comment-## -->
		<li class="comment even thread-even depth-1" id="comment-938503">
				<div id="div-comment-938503" class="comment-body">
				<div class="comment-author vcard">
						<cite class="fn">Rick C</cite> <span class="says">says:</span>		</div>
		
		<div class="comment-meta commentmetadata"><a href="https://blogs.msdn.microsoft.com/oldnewthing/20111003-00/?p=9493#comment-938503">
			October 3, 2011 at 12:34 pm</a>		</div>

		<p>&quot;[I agree that &quot;Gathering files to send&quot; would be a better title than &quot;Please wait while Windows decides whether or not to show you a dialog.&quot; But I thought the request was to show no dialog at all unless necessary. We just replaced one mandatory dialog with a different mandatory dialog. -Raymond]&quot;</p>
<p>I think they&#39;re playing a different game than you, Raymond, and theirs is called &quot;Troll Raymond.&quot;</p>

		
				</div>
		</li><!-- #comment-## -->
		<li class="comment odd alt thread-odd thread-alt depth-1" id="comment-938513">
				<div id="div-comment-938513" class="comment-body">
				<div class="comment-author vcard">
						<cite class="fn">David Walker</cite> <span class="says">says:</span>		</div>
		
		<div class="comment-meta commentmetadata"><a href="https://blogs.msdn.microsoft.com/oldnewthing/20111003-00/?p=9493#comment-938513">
			October 3, 2011 at 12:53 pm</a>		</div>

		<p>If there is a way to tell Windows &quot;don&#39;t ask me about resizing files to send by e-mail ever again&quot;, that&#39;s good. &nbsp;If not, that&#39;s not good. &nbsp;I don&#39;t happen to e-mail files in a way that would invoke that dialog anyway, so I don&#39;t know.</p>

		
				</div>
		</li><!-- #comment-## -->
		<li class="comment even thread-even depth-1" id="comment-938523">
				<div id="div-comment-938523" class="comment-body">
				<div class="comment-author vcard">
						<cite class="fn">Leo Davidson</cite> <span class="says">says:</span>		</div>
		
		<div class="comment-meta commentmetadata"><a href="https://blogs.msdn.microsoft.com/oldnewthing/20111003-00/?p=9493#comment-938523">
			October 3, 2011 at 12:59 pm</a>		</div>

		<p>For those asking about tools to manage shell extensions, check out ShellExView from NirSoft, which is also very good.</p>
<p>Autoruns and ShellExView are both great, free tools and each has its own strengths. I use both regularly.</p>

		
				</div>
		</li><!-- #comment-## -->
		<li class="comment byuser comment-author-fredericmagnyf odd alt thread-odd thread-alt depth-1" id="comment-938533">
				<div id="div-comment-938533" class="comment-body">
				<div class="comment-author vcard">
						<cite class="fn"><a href='https://social.msdn.microsoft.com/profile/Medinoc' rel='external nofollow' class='url'>Medinoc</a></cite> <span class="says">says:</span>		</div>
		
		<div class="comment-meta commentmetadata"><a href="https://blogs.msdn.microsoft.com/oldnewthing/20111003-00/?p=9493#comment-938533">
			October 4, 2011 at 12:07 am</a>		</div>

		<p>On the topic of avoiding unwanted disc accesses, whose responsibility is it not to open &quot;slow&quot; files in an icon handler? Will Explorer refrain on its own from calling the icon handler, or does the icon handler need to make the check itself?</p>

		
				</div>
		</li><!-- #comment-## -->
		<li class="comment even thread-even depth-1" id="comment-938543">
				<div id="div-comment-938543" class="comment-body">
				<div class="comment-author vcard">
						<cite class="fn">Ooh</cite> <span class="says">says:</span>		</div>
		
		<div class="comment-meta commentmetadata"><a href="https://blogs.msdn.microsoft.com/oldnewthing/20111003-00/?p=9493#comment-938543">
			October 4, 2011 at 2:39 am</a>		</div>

		<p>@Steve Wolf (and off-topic): Totally agreed on the unnecessary Groove extension. Worst of all that the Office team doesn&#39;t have any official feedback channel I&#39;m aware of. No site on Connect, no User Voice site or anything else, except Windows Error Reporting. But that&#39;s for crashes and hangs, not for feature or change requests&#8230;</p>

		
				</div>
		</li><!-- #comment-## -->
		<li class="comment odd alt thread-odd thread-alt depth-1" id="comment-938563">
				<div id="div-comment-938563" class="comment-body">
				<div class="comment-author vcard">
						<cite class="fn">Random832</cite> <span class="says">says:</span>		</div>
		
		<div class="comment-meta commentmetadata"><a href="https://blogs.msdn.microsoft.com/oldnewthing/20111003-00/?p=9493#comment-938563">
			October 4, 2011 at 8:39 am</a>		</div>

		<p>&quot;I agree that &quot;Gathering files to send&quot; would be a better title than &quot;Please wait while Windows decides whether or not to show you a dialog.&quot; But I thought the request was to show no dialog at all unless necessary. We just replaced one mandatory dialog with a different mandatory dialog.&quot;</p>
<p>I&#39;m not sure if I am correctly following this discussion, but it sounds to me like what&#39;s being suggested is replacing a dialog that always asks a question with a dialog that just has a progress display (requiring no action from the user) until it is determined if the question needs to be asked.</p>
<p>A dialog that requires no action from the user is really more like a monolog.</p>

		
				</div>
		</li><!-- #comment-## -->
		<li class="comment even thread-even depth-1" id="comment-938573">
				<div id="div-comment-938573" class="comment-body">
				<div class="comment-author vcard">
						<cite class="fn">Chris</cite> <span class="says">says:</span>		</div>
		
		<div class="comment-meta commentmetadata"><a href="https://blogs.msdn.microsoft.com/oldnewthing/20111003-00/?p=9493#comment-938573">
			October 4, 2011 at 8:54 am</a>		</div>

		<p>&quot;But this hits the disk, which makes baby context menu host sad.&quot; Should this not be &quot;But this hits the disk, which makes baby context menu host <em>cry</em>.&quot;? I am assuming you are going for the Simpsons &quot;Lies make baby Jesus cry&quot; inferrence.</p>

		
				</div>
		</li><!-- #comment-## -->
		<li class="comment odd alt thread-odd thread-alt depth-1" id="comment-938603">
				<div id="div-comment-938603" class="comment-body">
				<div class="comment-author vcard">
						<cite class="fn">Stefan Kanthak</cite> <span class="says">says:</span>		</div>
		
		<div class="comment-meta commentmetadata"><a href="https://blogs.msdn.microsoft.com/oldnewthing/20111003-00/?p=9493#comment-938603">
			October 4, 2011 at 6:18 pm</a>		</div>

		<p>@Steve Wolf &amp; Leo Davidson:</p>
<p>Neither AUTORUNS.EXE nor ShellExView.exe are &quot;great&quot; tools to manage shell extensions. Both fumble ONLY with the CLSIDs/PROGIDs of shell extensions below [HKLMSoftwareClasses], and need administrative rights for any change.</p>
<p>To give a rough picture&#8230;</p>
<p>More than 12 years ago but (see MSKB article 216384) the following policy was introduced:</p>
<p>[HKLMSoftwareMicrosoftWindowsCurrentVersionPoliciesExplorer]</p>
<p>&quot;EnforceShellExtensionSecurity&quot;=dword:01</p>
<p>The GUIDs of approved shell extensions have to be entered here:</p>
<p>[HKLMSoftwareMicrosoftWindowsCurrentVersionShell ExtensionsApproved]</p>
<p>&quot;{00000000-0000-0000-0000-000000000000}&quot;=&quot;arbitrary text&quot;</p>
<p>The GUIDs of blocked shell extensions can be entered there:</p>
<p>[HKLMSoftwareMicrosoftWindowsCurrentVersionShell ExtensionsBlocked]</p>
<p>&quot;{00000000-0000-0000-0000-000000000000}&quot;=&quot;arbitrary text&quot;</p>
<p>And MSKB article 918165 tells you about</p>
<p>[HKLMSoftwareMicrosoftWindowsCurrentVersionShell ExtensionsCached]</p>
<p>Yes, changes there need administrative rights too (I haven&#39;t checked whether the same registry keys under HKCU are evaluated too).</p>
<p>If a shell extension implements a shell folder its enumeration can be controlled via (see MSKB articles 292504 &amp; 810869):</p>
<p>[HKLMSoftwareMicrosoftWindowsCurrentVersionPoliciesNonEnum]</p>
<p>&quot;{00000000-0000-0000-0000-000000000000}&quot;=dword:00000001</p>
<p>And if a shell extension implements a shell object that lives on the Desktop, in &quot;My Computer&quot; or on network computers, it can be en- or disabled with</p>
<p>[HKCUSoftwareMicrosoftWindowsCurrentVersionExplorerHideDesktopIconsClassicStartMenu]</p>
<p>[HKCUSoftwareMicrosoftWindowsCurrentVersionExplorerHideDesktopIconsNewStartPanel]</p>
<p>[HKCUSoftwareMicrosoftWindowsCurrentVersionExplorerHideMyComputerIcons]</p>
<p>[HKCUSoftwareMicrosoftWindowsCurrentVersionExplorerHideRemoteComputerIcons]</p>
<p>&quot;{00000000-0000-0000-0000-000000000000}&quot;=dword:00000001</p>
<p>or the resp. entries below</p>
<p>[HKLMSoftwareMicrosoftWindowsCurrentVersionExplorerHide&#8230;]</p>
<p>JFTR: Internet Explorer 5.x and later has similar settings (see MSKB article 182569):</p>
<p>[HKLMSoftwareMicrosoftWindowsCurrentVersionInternet SettingsZones#]</p>
<p>&quot;1200&quot;=dword:0001000</p>
<p>&quot;2000&quot;=dword:0001000</p>
<p>[HKLMSoftwarePoliciesMicrosoftWindowsCurrentVersionInternet SettingsAllowedBehaviors]</p>
<p>[HKLMSoftwarePoliciesMicrosoftWindowsCurrentVersionInternet SettingsAllowedControls]</p>
<p>Internet Explorer 6.x and later has &quot;Add-On Manager&quot; (see MSKB articles 555235 &amp; 883256):</p>
<p>[HKLMSoftwareMicrosoftWindowsCurrentVersionPoliciesExt]</p>
<p>&quot;RestrictToList&quot;=dword:01</p>
<p>[HKLMSoftwareMicrosoftWindowsCurrentVersionPoliciesExtCLSID]</p>
<p>&quot;{00000000-0000-0000-0000-000000000000}&quot;=&quot;0&quot; ; or &quot;1&quot; or &quot;2&quot;</p>
<p>Did I miss anything in this glorious distributed mess?</p>
<p>Of course: if you don&#39;t want a BHO to run in Windows Explorer, you have to use:</p>
<p>[HKLMSoftwareMicrosoftWindowsCurrentVersionExplorerBrowser Helper Objects{00000000-0000-0000-0000-000000000000}]</p>
<p>&quot;NoExplorer&quot;=dword:00000001</p>
<p>or</p>
<p>[HKCUSoftwareMicrosoftWindowsCurrentVersionExplorerBrowser Helper Objects{00000000-0000-0000-0000-000000000000}]</p>
<p>&quot;NoExplorer&quot;=dword:00000001</p>

		
				</div>
		</li><!-- #comment-## -->
		<li class="comment even thread-even depth-1" id="comment-938613">
				<div id="div-comment-938613" class="comment-body">
				<div class="comment-author vcard">
						<cite class="fn">r</cite> <span class="says">says:</span>		</div>
		
		<div class="comment-meta commentmetadata"><a href="https://blogs.msdn.microsoft.com/oldnewthing/20111003-00/?p=9493#comment-938613">
			October 4, 2011 at 11:07 pm</a>		</div>

		<p>He wants &quot;instant response UIs&quot;, but doesn&#39;t think you should mind hitting the disk&#8230;</p>

		
				</div>
		</li><!-- #comment-## -->
		<li class="comment odd alt thread-odd thread-alt depth-1" id="comment-938633">
				<div id="div-comment-938633" class="comment-body">
				<div class="comment-author vcard">
						<cite class="fn">Deduplicator</cite> <span class="says">says:</span>		</div>
		
		<div class="comment-meta commentmetadata"><a href="https://blogs.msdn.microsoft.com/oldnewthing/20111003-00/?p=9493#comment-938633">
			October 5, 2011 at 4:50 am</a>		</div>

		<p>Explorer/OpenFileDialog/SaveFileDialog/AnyShellNamespaceDialog/Others freeze: Here the non-existence of a guaranteed non-blocking API giving instant completion or otherwise asynchronous notification jumps into the users face.</p>
<p>If it existed, the core explorer and plugin extensions (namespace/context menu/what have you) could use it to give the best information possible in the short term and improve upon that as fast as the OS can locate the information, while keeping the UI usable throughout.</p>
<p>Anyone wants all those Pluging/Extensions/Utilities made multithreaded, which is the only other way I see? That would open a really huge can of particularly wiggly worms, epecially keeping in mind the truly spectacular, astounding and (those for the epicurean) subtle ways Joe Average Programmer can easily muck up even simple tasks (as evidence the Daily WTF and numerous topics here).</p>
<p>So we get back to the topic of just over a week before. (&quot;Why does my asynchronous I/O complete synchronously?&quot; though perhaps it should be &quot;Why does my asynchronous I/O block?&quot;)</p>

		
				</div>
		</li><!-- #comment-## -->
		<li class="comment even thread-even depth-1" id="comment-938683">
				<div id="div-comment-938683" class="comment-body">
				<div class="comment-author vcard">
						<cite class="fn">Cain T. S. Random</cite> <span class="says">says:</span>		</div>
		
		<div class="comment-meta commentmetadata"><a href="https://blogs.msdn.microsoft.com/oldnewthing/20111003-00/?p=9493#comment-938683">
			October 5, 2011 at 7:58 am</a>		</div>

		<p>The Windows XP code has a problem: SHBindToObject and SHBindToFolderIDListParent are Vista API&#39;s (cf. <a href="http://msdn.microsoft.com/en-us/library/bb762113(VS.85).aspx" target="_new" rel="nofollow">msdn.microsoft.com/&#8230;/bb762113(VS.85).aspx</a>).</p>
<div class="post">[<i><a href="http://blogs.msdn.com/b/oldnewthing/archive/2011/10/03/10218997.aspx#10219218" rel="nofollow">See earlier remark</a>. You can adapt <a href="http://blogs.msdn.com/b/oldnewthing/archive/2011/08/30/10202076.aspx&quot;" rel="nofollow">this function</a>. -Raymond</i>]</div>

		
				</div>
		</li><!-- #comment-## -->
		<li class="comment odd alt thread-odd thread-alt depth-1" id="comment-938903">
				<div id="div-comment-938903" class="comment-body">
				<div class="comment-author vcard">
						<cite class="fn">Sniffnoy</cite> <span class="says">says:</span>		</div>
		
		<div class="comment-meta commentmetadata"><a href="https://blogs.msdn.microsoft.com/oldnewthing/20111003-00/?p=9493#comment-938903">
			October 5, 2011 at 3:46 pm</a>		</div>

		<p>Raymond wrote:</p>
<p>That&#39;s why I was amused by Memet&#39;s claim that &quot;would hit the disk&quot; is not acceptable for me. The feedback I see from customers, either directly from large multinational corporations with 500ms ping times or indirectly from individual users who collectively click Send Report millions of times a day, is that &quot;would hit the disk&quot; ruins a lot of people&#39;s days. It may not be acceptable to you, but millions of other people would beg to disagree.</p>
<p>I&#39;m a bit confused; is there a misnegation here? &nbsp;Currently this seems to say, &quot;You may find hitting the disk unacceptable, but the feedback I get shows that people find hitting the disk unacceptable.&quot;</p>
<div class="post">[<i>There&#39;s a double-negative here. Memet claims that the &quot;would hit the disk&quot; justification is unacceptable. (I.e., that hitting the disk is acceptable.) There are lot of people who consider the &quot;would hit the disk&quot; justification acceptable. -Raymond</i>]</div>

		
				</div>
		</li><!-- #comment-## -->
		</ol><!-- .comment-list -->

		<div class="navigation pagination">
					</div>

	
			<p class="no-comments">Comments are closed.</p>
<!-- COMMENTS END -->
</div></td></tr></table>

</body>
</html>
<br/><div class="disclaimer">
*DISCLAIMER: I DO NOT OWN THIS CONTENT. If you are the owner and would like it removed, please
<a target="_blank" href="/contact.htm">contact me</a>.
The content herein is an archived reproduction of entries from
Raymond Chen's "Old New Thing" Blog (most recent link is <a target="_blank" href="https://devblogs.microsoft.com/oldnewthing/">here</a>).
It may have slight formatting modifications for consistency and to improve readability.
<br/><br/>
WHY DID I DUPLICATE THIS CONTENT HERE?
Let me first say this site has never had anything to sell and has never shown ads of any kind. I have nothing monetarily to gain by duplicating content here.
Because I had made my own local copy of this content throughout the years, for ease of using tools like grep, I decided to put it online after I discovered
some of the original content previously and publicly available, had disappeared approximately early to mid 2019.
At the same time, I present the content in an easily accessible theme-agnostic way.
<br/><br/>
The information provided by Raymond's blog is, for all practical purposes, more authoritative on Windows Development than Microsoft's
own MSDN documentation and should be considered supplemental reading to that documentation. The wealth of missing details
provided by this blog that Microsoft could not or did not document about Windows over the years is vital enough, many would agree an online "backup" of these details
is a necessary endeavor. Specifics include:<br/>
<ul>
    <li>
        A "redesign" after 2019 erased thousands of user's comments from previous years. As many have stated, the comments are nearly as important as the postings themselves.
        The archived copies of the postings contained here retain the original comments.
    </li>
    <li>
        The blog has changed domains many times and the urls have otherwise been under constant change since 2003.
        Even when proper redirection has been set up for those links, redirection only works for a limited period of time.
        For example, all of the internal blog links that were valid in early 2019, were broken by 2020 without proper redirection.
    </li>
    <li>
        The blog has been under constant re-design and re-theming since its inception.
        It is downright irritating to deal with a bogged-down site experience as the result of the latest visual themes designed for cell-phone browsers.
        As of this writing, it is cumbersome to navigate titles with only 10 entries per page.
        While it is nice that the official site has a search feature, searching using this index (with all titles on a single page) is much quicker (CTRL-F in most browsers).
    </li>
</ul>
</div><br/>
&lt;-- Back to <a href="index.htm">Old New Thing Archive Index</a>

