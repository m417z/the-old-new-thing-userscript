<html>
<head>
<title>Now that Windows makes it harder for your program to block shutdown, how do you block shutdown?</title>
<link rel="stylesheet" href="page.css">
</head><body>
<div class="titlediv"><h2>Now that Windows makes it harder for your program to block shutdown, how do you block shutdown?</h2></div>
<div class="hdrdiv"><table class="hdrtable" cellspacing="0" cellpadding="0">
<tr><td><b>Date:</b></td><td>June 14, 2012 / year-entry #138</td></tr>
<tr><td><b>Tags:</b></td><td>code</td></tr>
<tr><td><b>Orig Link:</b></td><td>https://blogs.msdn.microsoft.com/oldnewthing/20120614-00/?p=7373</td></tr>

<tr><td><b>Comments:&nbsp;&nbsp;&nbsp;&nbsp;</b></td><td>62</td></tr>
<tr><td valign="top"><b>Summary:</b></td><td valign="top">Up until Windows XP, applications could intercept the WM_QUERY­END­SESSION message and tell Windows, "No, don't shut down." If they were polite about it, they would also inform the user which application blocked system shutdown and why. And if they were really polite about it, they would even provide a way for the user to say, "I...</td></tr>
</table></div>
<hr/>
<table class="contenttable" cellspacing="0" cellpadding="0"><tr><td><div class="contentdiv">
<!-- CONTENT START -->
<p>Up until Windows&nbsp;XP, applications could intercept the <code>WM_<wbr>QUERY&shy;END&shy;SESSION</wbr></code> message and tell Windows, "No, don't shut down." If they were polite about it, they would also inform the user which application blocked system shutdown and why. And if they were really polite about it, they would even provide a way for the user to say, "I don't care; shut down anyway."</p>
<p> As I noted some time ago, <a href="http://blogs.msdn.com/b/oldnewthing/archive/2007/04/16/2148139.aspx"> Windows Vista made it harder for applications to block shutdown</a>. Applications are given two seconds to clean up, and then it's game over. </p>
<p> Okay, now the game of <a href="http://blogs.msdn.com/b/oldnewthing/archive/2012/01/17/10257351.aspx"> walls and ladders</a> continues. The power management folks created an escape hatch for applications which are doing things like burning a CD or controlling an industrial lathe, where shutting down the machine may not be in the user's best interest. (The user ends up with a coaster or a factory on fire.) But since they created the escape hatch, they get to control the keys to the hatch, too. </p>
<p> The <a href="http://msdn.microsoft.com/en-us/library/aa376877(VS.85).aspx"> <code>Shutdown&shy;Block&shy;Reason&shy;Create</code></a> function lets you register your application window with a custom message that is displayed to the user when they try to shut down the computer. When the danger-time is over, you call <a href="http://msdn.microsoft.com/en-us/library/aa376878(v=VS.85).aspx"> <code>Shutdown&shy;Block&shy;Reason&shy;Destroy</code></a> to say that the coast is clear and shutdown is once again permitted. </p>
<p> Mind you, these blocks are merely advisory. If users really want to create a coaster or burn down their factory, they can click <i>Force shut down</i>. One nice thing about making Windows responsible for the warning message is that if multiple applications want to block shutdown, all of them can be displayed in a single dialog, and the user only needs to click <i>Force shut down</i> once. </p>
<p> Further guidance on system shutdown and the use of these functions can be found in the <a href="http://msdn.microsoft.com/en-us/library/ms700677(VS.85).aspx"> <i>Application Shutdown Changes in Windows Vista</i></a> document, which was the source material for most of this blog entry. </p>
<!-- CONTENT END -->
</div></td></tr></table>
<hr/>
<table class="commenttable" cellspacing="0" cellpadding="0"><tr><td><div class="commentdiv"><div class="commentdivhdr">
<!-- COMMENTS START -->
Comments (62)	</div>

	
			<div class="navigation pagination clear-both">
					</div>

		<ol class="comment-list">
					<li class="comment byuser comment-author-alegrigoriev even thread-even depth-1" id="comment-991393">
				<div id="div-comment-991393" class="comment-body">
				<div class="comment-author vcard">
						<cite class="fn"><a href='https://social.msdn.microsoft.com/profile/alegr1' rel='external nofollow' class='url'>alegr1</a></cite> <span class="says">says:</span>		</div>
		
		<div class="comment-meta commentmetadata"><a href="https://blogs.msdn.microsoft.com/oldnewthing/20120614-00/?p=7373#comment-991393">
			June 14, 2012 at 7:19 am</a>		</div>

		<p>&quot;As I noted some time ago, Windows Vista made it harder for applications to block shutdown. Applications are given two seconds to clean up, and then it&#39;s game over. &quot;</p>
<p>I&#39;d call it: &quot;WIndows Vista made it harder for users to let the applications proceed with shutdown&quot;. If an application (MS Word or Excel) is displaying Save File prompt, the user CAN NOT see and dismiss it. The only option is to cancel shutdown. That&#39;s SO HELPFUL (not exactly).</p>

		
				</div>
		</li><!-- #comment-## -->
		<li class="comment odd alt thread-odd thread-alt depth-1" id="comment-991403">
				<div id="div-comment-991403" class="comment-body">
				<div class="comment-author vcard">
						<cite class="fn"><a href='http://blogs.msdn.com/analisnudesette_4000_hotmail.com/ProfileUrlRedirect.ashx' rel='external nofollow' class='url'>analisnudesette@hotmail.com</a></cite> <span class="says">says:</span>		</div>
		
		<div class="comment-meta commentmetadata"><a href="https://blogs.msdn.microsoft.com/oldnewthing/20120614-00/?p=7373#comment-991403">
			June 14, 2012 at 7:37 am</a>		</div>

		<p>The new way seems much better than the old way to me.</p>
<p>Now you know which process is responsible, it gets a chance to tell you why, and you can choose what happens next.</p>

		
				</div>
		</li><!-- #comment-## -->
		<li class="comment even thread-even depth-1" id="comment-991413">
				<div id="div-comment-991413" class="comment-body">
				<div class="comment-author vcard">
						<cite class="fn">Joshua</cite> <span class="says">says:</span>		</div>
		
		<div class="comment-meta commentmetadata"><a href="https://blogs.msdn.microsoft.com/oldnewthing/20120614-00/?p=7373#comment-991413">
			June 14, 2012 at 8:13 am</a>		</div>

		<p>Taking away a much-needed function that was abused, then making a back door because it turned out to have very necessary uses. End result: completely pointlessly breaking backwards compatibility. If a WM_QUERYENDSESSION keeps saying no, it should have automatically registered ShutdownBlockReasonCreate.</p>
<div class="post">[<i>Um, it does register it automatically: It puts the program name on the list of applications which are blocking shutdown. -Raymond</i>]</div>

		
				</div>
		</li><!-- #comment-## -->
		<li class="comment odd alt thread-odd thread-alt depth-1" id="comment-991423">
				<div id="div-comment-991423" class="comment-body">
				<div class="comment-author vcard">
						<cite class="fn">Joshua</cite> <span class="says">says:</span>		</div>
		
		<div class="comment-meta commentmetadata"><a href="https://blogs.msdn.microsoft.com/oldnewthing/20120614-00/?p=7373#comment-991423">
			June 14, 2012 at 8:22 am</a>		</div>

		<p>[Um, it does register it automatically: It puts the program name on the list of applications which are blocking shutdown. -Raymond]</p>
<p>With a 30 second kill-timeout. CD Burn takes 3 minute. Industrial lathe crazy long. Guess which program&#39;s least likely to be updated.</p>
<div class="post">[<i>Wait, which side are you on? The &quot;We should encourage people to update their program by allowing updated programs to get a better experience&quot; side? Or the &quot;We should remove the incentive to update your program&quot; side? -Raymond</i>]</div>

		
				</div>
		</li><!-- #comment-## -->
		<li class="comment byuser comment-author-lexmitchell even thread-even depth-1" id="comment-991433">
				<div id="div-comment-991433" class="comment-body">
				<div class="comment-author vcard">
						<cite class="fn"><a href='https://social.msdn.microsoft.com/profile/Lex+Mitchell' rel='external nofollow' class='url'>Lex Mitchell</a></cite> <span class="says">says:</span>		</div>
		
		<div class="comment-meta commentmetadata"><a href="https://blogs.msdn.microsoft.com/oldnewthing/20120614-00/?p=7373#comment-991433">
			June 14, 2012 at 8:35 am</a>		</div>

		<p>@Joshua If a user wants a machine shutdown they can just yank the power. The occurrence of somebody doing something critical like CD burning/Lathing and deciding here is the perfect point to shutdown, is probably massively less than people who&#39;s laptop battery died because a program decided it was too important to stop. The user chose to shutdown not Windows.</p>

		
				</div>
		</li><!-- #comment-## -->
		<li class="comment odd alt thread-odd thread-alt depth-1" id="comment-991443">
				<div id="div-comment-991443" class="comment-body">
				<div class="comment-author vcard">
						<cite class="fn">Evan</cite> <span class="says">says:</span>		</div>
		
		<div class="comment-meta commentmetadata"><a href="https://blogs.msdn.microsoft.com/oldnewthing/20120614-00/?p=7373#comment-991443">
			June 14, 2012 at 8:55 am</a>		</div>

		<p>@Lex: &quot;The occurrence of somebody doing something critical like CD burning/Lathing and deciding here is the perfect point to shutdown, is probably massively less than people who&#39;s laptop battery died because a program decided it was too important to stop.&quot;</p>
<p>Of course, those are just an extreme. Something like &quot;I did work on this document and forgot to save it&quot; is much more likely than the latter, at least for me. Considering I think I&#39;ve had my battery die because it didn&#39;t shut down all of.. well, I think never.</p>
<p>Personally, &quot;save?&quot; and similar dialog preventing shutdown/log off is one of those behaviors that I actually much prefer about Windows vs other systems. If we were all in some super-happy world where all apps could easily restore their state things would be a little different, but we&#39;re not there yet.</p>

		
				</div>
		</li><!-- #comment-## -->
		<li class="comment even thread-even depth-1" id="comment-991453">
				<div id="div-comment-991453" class="comment-body">
				<div class="comment-author vcard">
						<cite class="fn">a random passerby</cite> <span class="says">says:</span>		</div>
		
		<div class="comment-meta commentmetadata"><a href="https://blogs.msdn.microsoft.com/oldnewthing/20120614-00/?p=7373#comment-991453">
			June 14, 2012 at 8:59 am</a>		</div>

		<p>@Lex Mitchell: Windows can shut itself down automatically if it&#39;s allowed to auto-apply updates. Or the owner company&#39;s IT department could push out a series of updates which require a restart and give the go-ahead to restart the machines, possibly accidentally including the industrial lathe that then sets the building on fire. Or some other Super Important Application could decide to shut the machine down.</p>
<p>There are lots of reasons that a machine might try to restart, and the local user isn&#39;t directly responsible for all of them. Or even necessarily present.</p>

		
				</div>
		</li><!-- #comment-## -->
		<li class="comment odd alt thread-odd thread-alt depth-1" id="comment-991463">
				<div id="div-comment-991463" class="comment-body">
				<div class="comment-author vcard">
						<cite class="fn">Joshua</cite> <span class="says">says:</span>		</div>
		
		<div class="comment-meta commentmetadata"><a href="https://blogs.msdn.microsoft.com/oldnewthing/20120614-00/?p=7373#comment-991463">
			June 14, 2012 at 9:04 am</a>		</div>

		<p>[Wait, which side are you on?]</p>
<p>If I could pull any arbitrary old version of Windows from the archives, buy license, install and run, I wouldn&#39;t have to care about Mr. Industrial Lathe either as I&#39;d hand him the old Windows and call it good.</p>
<p>The upgrade treadmill is obnoxious.</p>

		
				</div>
		</li><!-- #comment-## -->
		<li class="comment even thread-even depth-1" id="comment-991473">
				<div id="div-comment-991473" class="comment-body">
				<div class="comment-author vcard">
						<cite class="fn">Shuva</cite> <span class="says">says:</span>		</div>
		
		<div class="comment-meta commentmetadata"><a href="https://blogs.msdn.microsoft.com/oldnewthing/20120614-00/?p=7373#comment-991473">
			June 14, 2012 at 9:13 am</a>		</div>

		<p>The API doc says &quot;For Desktop Apps&quot; only. Do we have such back door for services also? One would imagine that an industrial lathe program does not necessarily have to be a Desktop App.</p>

		
				</div>
		</li><!-- #comment-## -->
		<li class="comment odd alt thread-odd thread-alt depth-1" id="comment-991483">
				<div id="div-comment-991483" class="comment-body">
				<div class="comment-author vcard">
						<cite class="fn">640k</cite> <span class="says">says:</span>		</div>
		
		<div class="comment-meta commentmetadata"><a href="https://blogs.msdn.microsoft.com/oldnewthing/20120614-00/?p=7373#comment-991483">
			June 14, 2012 at 9:28 am</a>		</div>

		<p>Vista forced me to developed a program which sends WM_QUERYÂ­ENDÂ­SESSION to each app. And waits. I love it.</p>

		
				</div>
		</li><!-- #comment-## -->
		<li class="comment even thread-even depth-1" id="comment-991493">
				<div id="div-comment-991493" class="comment-body">
				<div class="comment-author vcard">
						<cite class="fn">ajanata</cite> <span class="says">says:</span>		</div>
		
		<div class="comment-meta commentmetadata"><a href="https://blogs.msdn.microsoft.com/oldnewthing/20120614-00/?p=7373#comment-991493">
			June 14, 2012 at 9:45 am</a>		</div>

		<p>A few weeks ago I forgot to close VirtualBox beforel shutting down Windows 7. When I came back the next day, I was presented with a regular &quot;waiting for shutdown&quot; dialog with no particularly special message, and VirtualBox&#39;s normal &quot;what do you want to do&quot; dialog. I haven&#39;t tried to reproduce it, but this seems like the sort of thing that shouldn&#39;t be happening (VirtualBox should auto-save the machine state, not leave my computer on 8 hours overnight).</p>

		
				</div>
		</li><!-- #comment-## -->
		<li class="comment odd alt thread-odd thread-alt depth-1" id="comment-991503">
				<div id="div-comment-991503" class="comment-body">
				<div class="comment-author vcard">
						<cite class="fn">Mason Wheeler</cite> <span class="says">says:</span>		</div>
		
		<div class="comment-meta commentmetadata"><a href="https://blogs.msdn.microsoft.com/oldnewthing/20120614-00/?p=7373#comment-991503">
			June 14, 2012 at 10:18 am</a>		</div>

		<p>It&#39;s very nice that Windows 7 finally gives the user better control over the shutdown process when he&#39;s chosen to shut down. &nbsp;I really like that. &nbsp;But that just makes the years-old behavior of Windows Update look even worse by contrast.</p>
<p>You have no idea how many times I&#39;ve come back from lunch, or from taking a shower, or some other interruption that kept me away from the computer for a moderate ( &gt;15 mins) length of time, only to find that Windows Update has arbitrarily decided to reboot in the interim, and now I&#39;ve lost everything I was working on. &nbsp;(It&#39;s also happened on occasion while playing a fullscreen game, because the warning dialog doesn&#39;t show up.)</p>
<p>This should never happen under any circumstances, particularly if any program has any reason whatsoever to not want to shut down, such as unsaved files. &nbsp;The computer belongs to me, not to Microsoft, and it should reboot when I say so, not when Windows Update does. &nbsp;Period. &nbsp;The notion of &quot;implied consent&quot; does not apply here.</p>
<p>And unlike the behavior of a normal shutdown or reboot, for some bizarre reason, when Windows Update does it (even in Win7,) you can&#39;t cancel it. &nbsp;You don&#39;t get the warning. &nbsp;And you can&#39;t even hit Win-R and type &quot;shutdown -a&quot; to cancel it. (You get a dialog box informing you that this program can&#39;t start because the system is shutting down. &nbsp;Did Microsoft get Joseph Heller to write the shutdown code or something?!?)</p>
<p>Theoretically there&#39;s a registry setting you can tweak that will make Windows Update never reboot the system without your consent. &nbsp;I&#39;ve done it. &nbsp;It still happens. &nbsp;And given the data-destroying nature of this behavior, I&#39;m a bit surprised that it hasn&#39;t prompted a class-action suit yet. &nbsp;You&#39;d think, with a potential class comprising &quot;everyone who has ever lost data to Windows Update,&quot; that Microsoft would have fixed this behavior waaaaaay back in Win98, but it&#39;s still there&#8230;</p>
<p>(Third time trying to post this. &nbsp;Broken blog software is broken.)</p>

		
				</div>
		</li><!-- #comment-## -->
		<li class="comment byuser comment-author-xpclientgmail-com even thread-even depth-1" id="comment-991523">
				<div id="div-comment-991523" class="comment-body">
				<div class="comment-author vcard">
						<cite class="fn"><a href='https://social.msdn.microsoft.com/profile/xpclient' rel='external nofollow' class='url'>xpclient</a></cite> <span class="says">says:</span>		</div>
		
		<div class="comment-meta commentmetadata"><a href="https://blogs.msdn.microsoft.com/oldnewthing/20120614-00/?p=7373#comment-991523">
			June 14, 2012 at 10:21 am</a>		</div>

		<p>Also, why do people complain about Windows Update auto restarting? You can disable the auto restart behavior without turning off automatic updates. Just merge:</p>
<p>Windows Registry Editor Version 5.00</p>
<p>[HKEY_LOCAL_MACHINESOFTWAREPoliciesMicrosoftWindowsWindowsUpdateAU]</p>
<p>&quot;NoAutoRebootWithLoggedOnUsers&quot;=dword:00000001</p>

		
				</div>
		</li><!-- #comment-## -->
		<li class="comment odd alt thread-odd thread-alt depth-1" id="comment-991533">
				<div id="div-comment-991533" class="comment-body">
				<div class="comment-author vcard">
						<cite class="fn">JM</cite> <span class="says">says:</span>		</div>
		
		<div class="comment-meta commentmetadata"><a href="https://blogs.msdn.microsoft.com/oldnewthing/20120614-00/?p=7373#comment-991533">
			June 14, 2012 at 10:36 am</a>		</div>

		<p>I&#39;ve heard the &quot;Windows Update has rebooted against my will&quot; complaint so often that I feel like I&#39;m taking crazy pills. Am I really the only one who knows about &quot;download updates automatically, but let me choose when to install them&quot;?</p>
<p>If you assume that any update will require a reboot right after being installed (which is honestly not far from the truth) then the choice to trigger updates yourself seems obvious. You don&#39;t let Windows Update do the updates itself, because then you&#39;re essentially saying &quot;reboot at will&quot;. Instead of letting the system pull the trigger and then keep running ahead of the bullet, just pull the trigger yourself, when it&#39;s convenient.</p>
<p>(To those people who say &quot;I might forget to click the little shield, my system needs to be kept up to date&quot; &#8212; well, you can&#39;t have your cake and eat it too. You should be happy the system reboots automatically to help you meet this goal, which is lower on my personal list than &quot;don&#39;t throw away my session&quot;.)</p>

		
				</div>
		</li><!-- #comment-## -->
		<li class="comment even thread-even depth-1" id="comment-991543">
				<div id="div-comment-991543" class="comment-body">
				<div class="comment-author vcard">
						<cite class="fn">rs</cite> <span class="says">says:</span>		</div>
		
		<div class="comment-meta commentmetadata"><a href="https://blogs.msdn.microsoft.com/oldnewthing/20120614-00/?p=7373#comment-991543">
			June 14, 2012 at 10:40 am</a>		</div>

		<p>@Mason Wheeler: &quot;This should never happen under any circumstances, particularly if any program has any reason whatsoever to not want to shut down, such as unsaved files.&quot;</p>
<p>Personally I believe programs should start saving a document or file after the user has worked on it for a while. System shutdown is not the best time for saving files.</p>

		
				</div>
		</li><!-- #comment-## -->
		<li class="comment byuser comment-author-aegis03 odd alt thread-odd thread-alt depth-1" id="comment-991573">
				<div id="div-comment-991573" class="comment-body">
				<div class="comment-author vcard">
						<cite class="fn"><a href='https://social.msdn.microsoft.com/profile/dmex' rel='external nofollow' class='url'>dmex</a></cite> <span class="says">says:</span>		</div>
		
		<div class="comment-meta commentmetadata"><a href="https://blogs.msdn.microsoft.com/oldnewthing/20120614-00/?p=7373#comment-991573">
			June 14, 2012 at 11:11 am</a>		</div>

		<p>When Windows made it harder to block shutdown, someone broke the SetConsoleCtrlHandler function&#8230;</p>
<p>Our GUI application creates a console window via AllocConsole and uses the SetConsoleCtrlHandler function to register a HandlerRoutine callback for handling the CTRL_C_EVENT and CTRL_CLOSE_EVENT notifications. When these are signalled we would return TRUE to let Windows know it needed to ignore the signal and just after we would call FreeConsole to close the console window, the purpose was preventing the entire application closing when the user closed the console.</p>
<p>The problem started with Windows 7 when they broke the SetConsoleCtrlHandler function to stop some applications that created a console window from blocking shutdown but by doing so they broke the callback&#8230;. If the user clicks the non-client Close button or right-clicks the Taskbar and clicks Close, Windows ignores the result of the HandlerRoutine callback, closes the console and terminates the entire application &#8211; why they broke something unrelated to the system shutdown is unknown but here&#39;s nothing the user or developer can do to stop it, which is great since it broke so many legacy applications that relied upon the (previous) documented behaviour.</p>
<p>So how do you stop a console created by AllocConsole in a GUI process from killing your application when clicking the non-client Close button or clicking Close from the Taskbar since the SetConsoleCtrlHandler callback result is ignored?</p>

		
				</div>
		</li><!-- #comment-## -->
		<li class="comment even thread-even depth-1" id="comment-991583">
				<div id="div-comment-991583" class="comment-body">
				<div class="comment-author vcard">
						<cite class="fn">Joshua</cite> <span class="says">says:</span>		</div>
		
		<div class="comment-meta commentmetadata"><a href="https://blogs.msdn.microsoft.com/oldnewthing/20120614-00/?p=7373#comment-991583">
			June 14, 2012 at 11:38 am</a>		</div>

		<p>xpclient wrote:</p>
<blockquote><p>
  Btw there is a Group Policy that can be enabled in Vista/7/8: &quot;Turn off automatic termination of applications that block or cancel shutdown.&quot;
</p></blockquote>
<p>Oh good. I withdraw my complaint:</p>
<p>@dmex: Have you tried calling FreeConsole from inside the handler?</p>

		
				</div>
		</li><!-- #comment-## -->
		<li class="comment odd alt thread-odd thread-alt depth-1" id="comment-991593">
				<div id="div-comment-991593" class="comment-body">
				<div class="comment-author vcard">
						<cite class="fn">John</cite> <span class="says">says:</span>		</div>
		
		<div class="comment-meta commentmetadata"><a href="https://blogs.msdn.microsoft.com/oldnewthing/20120614-00/?p=7373#comment-991593">
			June 14, 2012 at 12:03 pm</a>		</div>

		<p>What I want to know is why was the Windows Update dialog nag period in Windows XP set to 11 minutes? &nbsp;Not 10 minutes, not 15 minutes, but 11 minutes. &nbsp;I guess Windows Update goes up to 11? &nbsp;At least the &quot;Reboot Later&quot; button had the focus so you didn&#39;t lose your work when you&#39;re typing and the nag dialog steals focus. &nbsp;Windows 7 experience is much better.</p>

		
				</div>
		</li><!-- #comment-## -->
		<li class="comment even thread-even depth-1" id="comment-991603">
				<div id="div-comment-991603" class="comment-body">
				<div class="comment-author vcard">
						<cite class="fn">Random User 702784</cite> <span class="says">says:</span>		</div>
		
		<div class="comment-meta commentmetadata"><a href="https://blogs.msdn.microsoft.com/oldnewthing/20120614-00/?p=7373#comment-991603">
			June 14, 2012 at 12:15 pm</a>		</div>

		<p>@Mason Wheeler</p>
<p>I don&#39;t know what to tell you. Those settings to disable the auto-reboot has worked fine on all the machines I have ever work with. Although, I usually apply the &quot;NoAutoRebootWithLoggedOnUsers&quot; one through the Group Policy MMC plugin (pointed at Local Computer), rather than directly in the registry. Maybe there is some extra magic that just poking the registry isn&#39;t doing.</p>

		
				</div>
		</li><!-- #comment-## -->
		<li class="comment odd alt thread-odd thread-alt depth-1" id="comment-991613">
				<div id="div-comment-991613" class="comment-body">
				<div class="comment-author vcard">
						<cite class="fn">No One</cite> <span class="says">says:</span>		</div>
		
		<div class="comment-meta commentmetadata"><a href="https://blogs.msdn.microsoft.com/oldnewthing/20120614-00/?p=7373#comment-991613">
			June 14, 2012 at 12:39 pm</a>		</div>

		<p>@JM: When I used that setting inevitably I start an update then do something with my computer. &nbsp;By the time the update is done and wants to reboot I&#39;m in the middle of something important. &nbsp;Then it proceeds to pester me to reboot for the rest of the day while I&#39;m using my computer. &nbsp;It&#39;d be far more convenient to get back to my computer, see that an update was installed and then and there close everything and reboot on my own.</p>
<p>Though now I&#39;ve learned of NoAutoRebootWithLoggedOnUsers &#8212; I&#39;ll try that out tonight.</p>

		
				</div>
		</li><!-- #comment-## -->
		<li class="comment even thread-even depth-1" id="comment-991643">
				<div id="div-comment-991643" class="comment-body">
				<div class="comment-author vcard">
						<cite class="fn">Tud</cite> <span class="says">says:</span>		</div>
		
		<div class="comment-meta commentmetadata"><a href="https://blogs.msdn.microsoft.com/oldnewthing/20120614-00/?p=7373#comment-991643">
			June 14, 2012 at 1:29 pm</a>		</div>

		<p>Maybe industrial lathes shouldn&#39;t have been controlled by Windows in the first place.</p>
<p>Not that I&#39;m saying Windows is bad, but I&#39;m sick of everyone using desktop OSs for everything (we&#39;ve all seen screens on billboards or ATMs with the &quot;you need to update your antivirus&quot; message popping).</p>

		
				</div>
		</li><!-- #comment-## -->
		<li class="comment odd alt thread-odd thread-alt depth-1" id="comment-991653">
				<div id="div-comment-991653" class="comment-body">
				<div class="comment-author vcard">
						<cite class="fn">chentiangemalc</cite> <span class="says">says:</span>		</div>
		
		<div class="comment-meta commentmetadata"><a href="https://blogs.msdn.microsoft.com/oldnewthing/20120614-00/?p=7373#comment-991653">
			June 14, 2012 at 1:30 pm</a>		</div>

		<p>people complaining about apps shutting down system, just remove SeShutdownPrivilevge from the user, problem fixed. windows supported this forever. the current system is not perfect, but vista-&gt;windows 8 provides much better experience than xp &amp; earlier. &nbsp;</p>

		
				</div>
		</li><!-- #comment-## -->
		<li class="comment byuser comment-author-alegrigoriev even thread-even depth-1" id="comment-991663">
				<div id="div-comment-991663" class="comment-body">
				<div class="comment-author vcard">
						<cite class="fn"><a href='https://social.msdn.microsoft.com/profile/alegr1' rel='external nofollow' class='url'>alegr1</a></cite> <span class="says">says:</span>		</div>
		
		<div class="comment-meta commentmetadata"><a href="https://blogs.msdn.microsoft.com/oldnewthing/20120614-00/?p=7373#comment-991663">
			June 14, 2012 at 1:33 pm</a>		</div>

		<blockquote><p>
  What I want to know is why was the Windows Update dialog nag period in Windows XP set to 11 minutes?
</p></blockquote>
<p>It&#39;s one of XP misteries we may never know the answer. Like what was rationale behind &quot;the search puppy&quot;, &quot;desktop cleanup wizard double nag&quot;, and a few other such things.</p>

		
				</div>
		</li><!-- #comment-## -->
		<li class="comment byuser comment-author-aegis03 odd alt thread-odd thread-alt depth-1" id="comment-991673">
				<div id="div-comment-991673" class="comment-body">
				<div class="comment-author vcard">
						<cite class="fn"><a href='https://social.msdn.microsoft.com/profile/dmex' rel='external nofollow' class='url'>dmex</a></cite> <span class="says">says:</span>		</div>
		
		<div class="comment-meta commentmetadata"><a href="https://blogs.msdn.microsoft.com/oldnewthing/20120614-00/?p=7373#comment-991673">
			June 14, 2012 at 1:49 pm</a>		</div>

		<p>[@dmex: Have you tried calling FreeConsole from inside the handler?]</p>
<p>That&#39;s how we&#39;ve always handed the message since ~Win95, the problem is Windows 7 ignoring the result of the callback and terminating the console &amp; application anyway.</p>
<p>This is our callback:</p>
<p>static BOOL ConsoleHandlerRoutine(</p>
<p>&nbsp; &nbsp;__in DWORD dwCtrlType</p>
<p>&nbsp; &nbsp;)</p>
<p>{</p>
<p>&nbsp; &nbsp;switch (dwCtrlType)</p>
<p>&nbsp; &nbsp;{</p>
<p>&nbsp; &nbsp;case CTRL_C_EVENT:</p>
<p>&nbsp; &nbsp;case CTRL_BREAK_EVENT:</p>
<p>&nbsp; &nbsp;case CTRL_CLOSE_EVENT:</p>
<p>&nbsp; &nbsp; &nbsp; &nbsp;{</p>
<p>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;fclose(stdout);</p>
<p>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;fclose(stderr);</p>
<p>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;fclose(stdin);</p>
<p>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;FreeConsole();</p>
<p>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;// We&#39;re still terminated when Close is clicked on the console window&#39;s window menu.</p>
<p>&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;return TRUE;</p>
<p>&nbsp; &nbsp; &nbsp; &nbsp;}</p>
<p>&nbsp; &nbsp;}</p>
<p>&nbsp; &nbsp;return FALSE;</p>
<p>}</p>
<p>It makes sense to prevent applications using the CTRL_SHUTDOWN_EVENT or CTRL_LOGOFF_EVENT from preventing Windows shutdown but &#8211; why did they have to break CTRL_CLOSE_EVENT at the same time when so many applications depend on it?</p>
<p>There was a dialog that showed up but it was removed (or broken?), some others run into the same problem here with no solutions: <a rel="nofollow" target="_new" href="http://stackoverflow.com/questions/3640633/c-setconsolectrlhandler-routine-issue" rel="nofollow">stackoverflow.com/&#8230;/c-setconsolectrlhandler-routine-issue</a></p>

		
				</div>
		</li><!-- #comment-## -->
		<li class="comment even thread-even depth-1" id="comment-991683">
				<div id="div-comment-991683" class="comment-body">
				<div class="comment-author vcard">
						<cite class="fn"><a href='http://blogs.msdn.com/johnstonj_4000_inn_2D00_soft.com/ProfileUrlRedirect.ashx' rel='external nofollow' class='url'>johnstonj@inn-soft.com</a></cite> <span class="says">says:</span>		</div>
		
		<div class="comment-meta commentmetadata"><a href="https://blogs.msdn.microsoft.com/oldnewthing/20120614-00/?p=7373#comment-991683">
			June 14, 2012 at 1:54 pm</a>		</div>

		<p>&quot;we&#39;ve all seen screens on billboards or ATMs with the &quot;you need to update your antivirus&quot; message popping&quot;</p>
<p>What should they use instead? &nbsp;Keep in mind these users/developers probably aren&#39;t specialized embedded developers&#8230; &nbsp;You shouldn&#39;t need to be just to display some simple information.</p>

		
				</div>
		</li><!-- #comment-## -->
		<li class="comment odd alt thread-odd thread-alt depth-1" id="comment-991693">
				<div id="div-comment-991693" class="comment-body">
				<div class="comment-author vcard">
						<cite class="fn">dave</cite> <span class="says">says:</span>		</div>
		
		<div class="comment-meta commentmetadata"><a href="https://blogs.msdn.microsoft.com/oldnewthing/20120614-00/?p=7373#comment-991693">
			June 14, 2012 at 2:29 pm</a>		</div>

		<p>@Mason Wheeler: &quot;This should never happen under any circumstances, particularly if any program has any reason whatsoever to not want to shut down, such as unsaved files.&quot;</p>
<p>The trouble is, too often the program&#39;s main reason is that it was written by an idiot. &nbsp;(It probably also has a splash screen, systray icon, shortcut on the desktop, background process holding DLLs open &#39;to speed up app startup&#39;, and an automatic updater you can&#39;t disable).</p>
<p>The fix is clearly not to run such things, but sometimes it&#39;s unavoidable.</p>

		
				</div>
		</li><!-- #comment-## -->
		<li class="comment even thread-even depth-1" id="comment-991703">
				<div id="div-comment-991703" class="comment-body">
				<div class="comment-author vcard">
						<cite class="fn">Mason Wheeler</cite> <span class="says">says:</span>		</div>
		
		<div class="comment-meta commentmetadata"><a href="https://blogs.msdn.microsoft.com/oldnewthing/20120614-00/?p=7373#comment-991703">
			June 14, 2012 at 2:43 pm</a>		</div>

		<p>@Dave: Why is that a problem? &nbsp;If anything, it will cause the system to err on the side of not rebooting without the user&#39;s explicit consent, which is a good thing.</p>

		
				</div>
		</li><!-- #comment-## -->
		<li class="comment odd alt thread-odd thread-alt depth-1" id="comment-991713">
				<div id="div-comment-991713" class="comment-body">
				<div class="comment-author vcard">
						<cite class="fn">David Walker</cite> <span class="says">says:</span>		</div>
		
		<div class="comment-meta commentmetadata"><a href="https://blogs.msdn.microsoft.com/oldnewthing/20120614-00/?p=7373#comment-991713">
			June 14, 2012 at 2:47 pm</a>		</div>

		<p>@Mason Wheeler: &nbsp;</p>
<p>The other half of the population complains that they shut down their laptop, and then walk away, and return hours later to find the battery dead.</p>
<p>Why? &nbsp;The laptop didn&#39;t shut down, because some app with an open file prompted the user to save the file. &nbsp;The user never answered the prompt, so the laptop never shut down.</p>
<p>When you say &quot;This should never happen under any circumstances, particularly if any program has any reason whatsoever to not want to shut down, such as unsaved files. &nbsp;The computer belongs to me, not to Microsoft, and it should reboot when I say so&quot; there are people who say &quot;Windows should shut down when I ask it; programs should NOT be allowed to block shutdown. &nbsp;It&#39;s my computer, and if I ask it to shut down, it should shut down.&quot;</p>
<p>Maybe there should be a distinction between a shutdown requested by auto-updates, and a shutdown requested by a user, but Microsoft has tried to make both camps happy. &nbsp;And that&#39;s not possible. &nbsp;Note that a partially-updated system is running with a mixture of old code and new code, and the two don&#39;t always agree on what parameters to pass when calling each other, which leads to hard crashes. &nbsp;So it&#39;s in your interest that the system reboots soon after applying updates. &nbsp;I think that the option &quot;Download updates, but let me choose when to install them&quot; is YOUR best choice.</p>

		
				</div>
		</li><!-- #comment-## -->
		<li class="comment even thread-even depth-1" id="comment-991733">
				<div id="div-comment-991733" class="comment-body">
				<div class="comment-author vcard">
						<cite class="fn">Rapheal</cite> <span class="says">says:</span>		</div>
		
		<div class="comment-meta commentmetadata"><a href="https://blogs.msdn.microsoft.com/oldnewthing/20120614-00/?p=7373#comment-991733">
			June 14, 2012 at 3:44 pm</a>		</div>

		<p>&quot;Note that a partially-updated system is running with a mixture of old code and new code&quot;</p>
<p>I&#39;m pretty sure that Windows updates are independent and atomic. If an update requires a reboot, it has not been installed yet, even partially. That would be foolish.</p>

		
				</div>
		</li><!-- #comment-## -->
		<li class="comment odd alt thread-odd thread-alt depth-1" id="comment-991743">
				<div id="div-comment-991743" class="comment-body">
				<div class="comment-author vcard">
						<cite class="fn">fool</cite> <span class="says">says:</span>		</div>
		
		<div class="comment-meta commentmetadata"><a href="https://blogs.msdn.microsoft.com/oldnewthing/20120614-00/?p=7373#comment-991743">
			June 14, 2012 at 4:12 pm</a>		</div>

		<p>Patches that will be installed at next reboot is queued in registry.</p>
<p>It would be foolish to develop any app that is depending on any state of this queue, yes.</p>
<p>Yet, after some months, there&#39;s usually junk files all over the place because of broken installations.</p>

		
				</div>
		</li><!-- #comment-## -->
		<li class="comment even thread-even depth-1" id="comment-991753">
				<div id="div-comment-991753" class="comment-body">
				<div class="comment-author vcard">
						<cite class="fn">Ian Boyd</cite> <span class="says">says:</span>		</div>
		
		<div class="comment-meta commentmetadata"><a href="https://blogs.msdn.microsoft.com/oldnewthing/20120614-00/?p=7373#comment-991753">
			June 14, 2012 at 4:14 pm</a>		</div>

		<blockquote><p>
  &quot;Windows Vista made it harder for users to let the applications proceed with shutdown&quot;
</p></blockquote>
<p>i think of it like making your program &quot;standard user friendly&quot;. The machine is trying to shutdown, yet your program is sitting there displaying a modal dialog. The application needs to be updated to not do that.</p>
<p>Until then, i have a global kill-switch that &quot;fixes&quot; those misbehaving programs until they are fixed (like file and registry virtualization &quot;fixes&quot; those misbehaving programs until they are fixed).</p>

		
				</div>
		</li><!-- #comment-## -->
		<li class="comment odd alt thread-odd thread-alt depth-1" id="comment-991763">
				<div id="div-comment-991763" class="comment-body">
				<div class="comment-author vcard">
						<cite class="fn">640k</cite> <span class="says">says:</span>		</div>
		
		<div class="comment-meta commentmetadata"><a href="https://blogs.msdn.microsoft.com/oldnewthing/20120614-00/?p=7373#comment-991763">
			June 14, 2012 at 4:17 pm</a>		</div>

		<p>Then, why isn&#39;t NOTEPAD.EXE fixed yet?</p>

		
				</div>
		</li><!-- #comment-## -->
		<li class="comment byuser comment-author-kwadwomi even thread-even depth-1" id="comment-991783">
				<div id="div-comment-991783" class="comment-body">
				<div class="comment-author vcard">
						<cite class="fn"><a href='https://social.msdn.microsoft.com/profile/Master+Programmer' rel='external nofollow' class='url'>Master Programmer</a></cite> <span class="says">says:</span>		</div>
		
		<div class="comment-meta commentmetadata"><a href="https://blogs.msdn.microsoft.com/oldnewthing/20120614-00/?p=7373#comment-991783">
			June 14, 2012 at 4:46 pm</a>		</div>

		<p>@alegr1</p>
<p>I think Windows needs a better shutdown experience for older apps. Older apps don&#39;t know about ShutdownBlockReasonCreate and expect to be able to prompt you at shutdown. Right now there&#39;s no way to interact with these applications except canceling shutdown which defeats the purpose. There needs to be a way to temporarily hide the shutdown UI to respond to these applications.</p>
<p>Also the easiest way to configure Windows Updates is though the Group Policy Editor. From there you can configure all aspects of Windows Update. For instance I set Windows Update to automatically install updates but not to automatically restart and to install updates that don&#39;t require restarts immediately.</p>

		
				</div>
		</li><!-- #comment-## -->
		<li class="comment odd alt thread-odd thread-alt depth-1" id="comment-991793">
				<div id="div-comment-991793" class="comment-body">
				<div class="comment-author vcard">
						<cite class="fn">Jack</cite> <span class="says">says:</span>		</div>
		
		<div class="comment-meta commentmetadata"><a href="https://blogs.msdn.microsoft.com/oldnewthing/20120614-00/?p=7373#comment-991793">
			June 14, 2012 at 5:10 pm</a>		</div>

		<p>Why oh why would anyone ever run an industrial lathe on a Windows OS?</p>

		
				</div>
		</li><!-- #comment-## -->
		<li class="comment byuser comment-author-xpclientgmail-com even thread-even depth-1" id="comment-991513">
				<div id="div-comment-991513" class="comment-body">
				<div class="comment-author vcard">
						<cite class="fn"><a href='https://social.msdn.microsoft.com/profile/xpclient' rel='external nofollow' class='url'>xpclient</a></cite> <span class="says">says:</span>		</div>
		
		<div class="comment-meta commentmetadata"><a href="https://blogs.msdn.microsoft.com/oldnewthing/20120614-00/?p=7373#comment-991513">
			June 14, 2012 at 10:19 am</a>		</div>

		<p>I still think that the fact that any program can programmatically call shutdown without user confirmation in Windows is a very bad behavior. Just the other day I had dozens of tabs open in IE, couple of other things open and downloads going on and I added the &quot;Media Center&quot; key to Windows 8 and it restarted without any warning. (I didn&#39;t have ShutdownGuard installed on that fresh Windows 8 installation). Usually, I always use ShutdownGuard which calls the above mentioned ShutdownBlockReasonCreate function. ShutdownGuard even lets the *user* customize the message that is displayed. And with Classic Shell, I can call any custom Shutdown actions on the Start Menu (e.g run a script to silently exit ShutdownGuard first and then call restart or whatever, so shutdown actions from there when I as in the user initiates it are all 1-click. No unnecessary confirmations.</p>
<p>Btw there is a Group Policy that can be enabled in Vista/7/8: &quot;Turn off automatic termination of applications that block or cancel shutdown.&quot;</p>
<p>Evan: &quot;If we were all in some super-happy world where all apps could easily restore their state things would be a little different, but we&#39;re not there yet.&quot;</p>
<p>@Evan: At least Windows beginning with Vista has a &quot;shutdown.exe /g&quot; switch that calls the EWX_RESTARTAPPS flag so apps which registered for application restart all automatically get restored after the restart. Unfortunately, not even all Microsoft apps register for ARR. A core app like Notepad doesn&#39;t! Google Chrome does. I don&#39;t know any other 3rd party apps that register. And sadly their state is not restored necessarily.</p>

		
				</div>
		</li><!-- #comment-## -->
		<li class="comment odd alt thread-odd thread-alt depth-1" id="comment-991803">
				<div id="div-comment-991803" class="comment-body">
				<div class="comment-author vcard">
						<cite class="fn"><a href='http://blogs.msdn.com/arcangelpip_4000_hotmail.com/ProfileUrlRedirect.ashx' rel='external nofollow' class='url'>arcangelpip@hotmail.com</a></cite> <span class="says">says:</span>		</div>
		
		<div class="comment-meta commentmetadata"><a href="https://blogs.msdn.microsoft.com/oldnewthing/20120614-00/?p=7373#comment-991803">
			June 14, 2012 at 5:22 pm</a>		</div>

		<p>@640k</p>
<p>Maybe someone depends on that behaviour? (This is a joke by the way, but it wouldn&#39;t surprise me).</p>
<p>@Miff</p>
<p>Did you read the last link that was in the main post? If it is a non critical shutdown, if an application has a visible top level window and it returns FALSE to the WM_QUERYENDSESSION, then it will block the shutdown regardless. But, the difference here is that the Windows Vista changes means that you get told which application is blocking shutdown, and you have the force shutdown button available which does a critical shutdown.</p>
<p>The reason string is required if an application doesn&#39;t have a top level window and is trying to block shutdown for some reason. So this is useful if a console application, or a hidden application is being used to block shutdown without allowing the user to close it easily.</p>

		
				</div>
		</li><!-- #comment-## -->
		<li class="comment even thread-even depth-1" id="comment-991813">
				<div id="div-comment-991813" class="comment-body">
				<div class="comment-author vcard">
						<cite class="fn">Anonymous Coward</cite> <span class="says">says:</span>		</div>
		
		<div class="comment-meta commentmetadata"><a href="https://blogs.msdn.microsoft.com/oldnewthing/20120614-00/?p=7373#comment-991813">
			June 14, 2012 at 5:40 pm</a>		</div>

		<p>The new shutdown procedure is a cure that&#39;s worse than the problem. On Vista+ every time an application needs to prompt before it can shutdown, I have to cancel the cancel the shutdown. And the application can&#39;t even fix it by doing things the new way since the new way doesn&#39;t allow for prompts. To solve a problem that for most people doesn&#39;t even exist, a change was shoved down users&#39; throats that evidently didn&#39;t undergo even basic usability testing.</p>

		
				</div>
		</li><!-- #comment-## -->
		<li class="comment odd alt thread-odd thread-alt depth-1" id="comment-991553">
				<div id="div-comment-991553" class="comment-body">
				<div class="comment-author vcard">
						<cite class="fn">Mason Wheeler</cite> <span class="says">says:</span>		</div>
		
		<div class="comment-meta commentmetadata"><a href="https://blogs.msdn.microsoft.com/oldnewthing/20120614-00/?p=7373#comment-991553">
			June 14, 2012 at 10:48 am</a>		</div>

		<p>@xpclient: Yes, I&#39;ve done that. &nbsp;It still happens.</p>
<p>@JM: Yes, I&#39;ve done *that* too. IT STILL HAPPENS!</p>

		
				</div>
		</li><!-- #comment-## -->
		<li class="comment even thread-even depth-1" id="comment-991563">
				<div id="div-comment-991563" class="comment-body">
				<div class="comment-author vcard">
						<cite class="fn">Mason Wheeler</cite> <span class="says">says:</span>		</div>
		
		<div class="comment-meta commentmetadata"><a href="https://blogs.msdn.microsoft.com/oldnewthing/20120614-00/?p=7373#comment-991563">
			June 14, 2012 at 10:55 am</a>		</div>

		<p>And my point is that not only should it not happen when you&#39;ve changed the settings, you shouldn&#39;t have to go tweaking settings to make it not happen in the first place. &nbsp;*Not happening should be the default.*</p>
<p>Maybe (maybe!) there should be a way to opt-in to automatic reboots, but even that&#39;s stretching it a little, because most systems that are meant to run unattended are servers, and you definitely don&#39;t want them going down without notice!</p>

		
				</div>
		</li><!-- #comment-## -->
		<li class="comment odd alt thread-odd thread-alt depth-1" id="comment-991823">
				<div id="div-comment-991823" class="comment-body">
				<div class="comment-author vcard">
						<cite class="fn">Raphael</cite> <span class="says">says:</span>		</div>
		
		<div class="comment-meta commentmetadata"><a href="https://blogs.msdn.microsoft.com/oldnewthing/20120614-00/?p=7373#comment-991823">
			June 14, 2012 at 6:12 pm</a>		</div>

		<p>I highly doubt that Microsoft doesn&#39;t do basic usability testing. I believe instead that said usability testing showed that most people close their documents before shutdown, so &quot;Are you sure you want to quit without saving?&quot; dialogs would be rather rare and shutdown would most often be blocked by applications that need to be terminated with extreme prejudice.</p>

		
				</div>
		</li><!-- #comment-## -->
		<li class="comment byuser comment-author-alegrigoriev even thread-even depth-1" id="comment-991833">
				<div id="div-comment-991833" class="comment-body">
				<div class="comment-author vcard">
						<cite class="fn"><a href='https://social.msdn.microsoft.com/profile/alegr1' rel='external nofollow' class='url'>alegr1</a></cite> <span class="says">says:</span>		</div>
		
		<div class="comment-meta commentmetadata"><a href="https://blogs.msdn.microsoft.com/oldnewthing/20120614-00/?p=7373#comment-991833">
			June 14, 2012 at 6:49 pm</a>		</div>

		<p>Raphael:</p>
<p>Are you aware that Excel will prompt to save the document even if you only switched to a different page?</p>

		
				</div>
		</li><!-- #comment-## -->
		<li class="comment odd alt thread-odd thread-alt depth-1" id="comment-991843">
				<div id="div-comment-991843" class="comment-body">
				<div class="comment-author vcard">
						<cite class="fn">Joshua</cite> <span class="says">says:</span>		</div>
		
		<div class="comment-meta commentmetadata"><a href="https://blogs.msdn.microsoft.com/oldnewthing/20120614-00/?p=7373#comment-991843">
			June 14, 2012 at 7:17 pm</a>		</div>

		<p>@Jack: Why did Iran run their uranium enrichment centrifuges on Windows 7?</p>

		
				</div>
		</li><!-- #comment-## -->
		<li class="comment even thread-even depth-1" id="comment-991623">
				<div id="div-comment-991623" class="comment-body">
				<div class="comment-author vcard">
						<cite class="fn">Miff</cite> <span class="says">says:</span>		</div>
		
		<div class="comment-meta commentmetadata"><a href="https://blogs.msdn.microsoft.com/oldnewthing/20120614-00/?p=7373#comment-991623">
			June 14, 2012 at 12:55 pm</a>		</div>

		<p>Where is this so-called &quot;30 second timer&quot; then?</p>
<p>I have a terrible integrated sound card. Sometimes, when I shut down my PC, one of it&#39;s background processes stops responding. More then once, I&#39;ve left my PC thinking it was shut down, only to come back to it hours later discovering that it was still on, waiting for the **Windows not responding dialog**.</p>
<p>If ShutdownBlockReasons are opt in, then how come they apply to a Windows dialog telling you that it had to kill a process anyways?</p>

		
				</div>
		</li><!-- #comment-## -->
		<li class="comment odd alt thread-odd thread-alt depth-1" id="comment-991723">
				<div id="div-comment-991723" class="comment-body">
				<div class="comment-author vcard">
						<cite class="fn">dave</cite> <span class="says">says:</span>		</div>
		
		<div class="comment-meta commentmetadata"><a href="https://blogs.msdn.microsoft.com/oldnewthing/20120614-00/?p=7373#comment-991723">
			June 14, 2012 at 3:29 pm</a>		</div>

		<p>@Mason Wheeler: Why is that a problem? &nbsp;If anything, it will cause the system to err on the side of not rebooting without the user&#39;s explicit consent, which is a good thing.</p>
<p>That suffers from the fallacy that there is always an *** in the seat.</p>

		
				</div>
		</li><!-- #comment-## -->
		<li class="comment even thread-even depth-1" id="comment-991853">
				<div id="div-comment-991853" class="comment-body">
				<div class="comment-author vcard">
						<cite class="fn">stupidity</cite> <span class="says">says:</span>		</div>
		
		<div class="comment-meta commentmetadata"><a href="https://blogs.msdn.microsoft.com/oldnewthing/20120614-00/?p=7373#comment-991853">
			June 15, 2012 at 12:44 am</a>		</div>

		<p>en.wikipedia.org/wiki/Brain_drain#Iran</p>

		
				</div>
		</li><!-- #comment-## -->
		<li class="comment odd alt thread-odd thread-alt depth-1" id="comment-992063">
				<div id="div-comment-992063" class="comment-body">
				<div class="comment-author vcard">
						<cite class="fn">David Walker</cite> <span class="says">says:</span>		</div>
		
		<div class="comment-meta commentmetadata"><a href="https://blogs.msdn.microsoft.com/oldnewthing/20120614-00/?p=7373#comment-992063">
			June 15, 2012 at 8:19 am</a>		</div>

		<p>@Rapheal: I thought that Raymond had a post in the last few months on why a system needs to be rebooted soon after update, but I can&#39;t find it now. &nbsp;</p>
<p>I think the DLLs that are not in use will get replaced during installation of the update; they don&#39;t get &quot;deferred until the reboot&quot;. &nbsp;But if they get called by code that didn&#39;t get replaced yet, things can break.</p>

		
				</div>
		</li><!-- #comment-## -->
		<li class="comment even thread-even depth-1" id="comment-992083">
				<div id="div-comment-992083" class="comment-body">
				<div class="comment-author vcard">
						<cite class="fn">Jon</cite> <span class="says">says:</span>		</div>
		
		<div class="comment-meta commentmetadata"><a href="https://blogs.msdn.microsoft.com/oldnewthing/20120614-00/?p=7373#comment-992083">
			June 15, 2012 at 8:26 am</a>		</div>

		<p>@People thinking running a lathe on Win 7 is stupid</p>
<p>(Sorry if this is a duplicate post, I&#39;m pretty sure my last one got eaten)</p>
<p>There is a lot more to industrial automation than boring boxes with little text-only displays and tiny keypads.</p>
<p>I develop software for controlling industrial equipment. The high-end controllers run Windows Embedded Standard 7, a componentized version of Win 7. It gives us plug-and-play printer support and built-in network share support. Transactional NTFS is great for recovering from power interruptions. There is good touch screen support. Customers understand the Windows application look and feel. We can use VNC and remote desktop.</p>
<p>Linux could do most of this, but not as easily. A lower-level embedded system wouldn&#39;t work.</p>
<p>We don&#39;t enable Windows Update by default, and let our customers and their administrators find the best settings if they want it on. Because we can eliminate all parts of Windows not needed for our application, the attack surface is much smaller. Most updates only affect parts of Windows that aren&#39;t even included with the system.</p>

		
				</div>
		</li><!-- #comment-## -->
		<li class="comment odd alt thread-odd thread-alt depth-1" id="comment-992133">
				<div id="div-comment-992133" class="comment-body">
				<div class="comment-author vcard">
						<cite class="fn">Mike</cite> <span class="says">says:</span>		</div>
		
		<div class="comment-meta commentmetadata"><a href="https://blogs.msdn.microsoft.com/oldnewthing/20120614-00/?p=7373#comment-992133">
			June 15, 2012 at 9:48 am</a>		</div>

		<p>while MS is worrying about legitimate behavior, spyware or viruses are still able to do everything they want to regardless of what the winapi says or does.</p>

		
				</div>
		</li><!-- #comment-## -->
		<li class="comment byuser comment-author-alegrigoriev even thread-even depth-1" id="comment-992203">
				<div id="div-comment-992203" class="comment-body">
				<div class="comment-author vcard">
						<cite class="fn"><a href='https://social.msdn.microsoft.com/profile/alegr1' rel='external nofollow' class='url'>alegr1</a></cite> <span class="says">says:</span>		</div>
		
		<div class="comment-meta commentmetadata"><a href="https://blogs.msdn.microsoft.com/oldnewthing/20120614-00/?p=7373#comment-992203">
			June 15, 2012 at 11:39 am</a>		</div>

		<p>@Mike:</p>
<p>What is it in *x OS that makes it more secure and immune to spyware and viruses than Windows? Explain, please. Or STFU.</p>

		
				</div>
		</li><!-- #comment-## -->
		<li class="comment odd alt thread-odd thread-alt depth-1" id="comment-992213">
				<div id="div-comment-992213" class="comment-body">
				<div class="comment-author vcard">
						<cite class="fn">Diablo 3 player</cite> <span class="says">says:</span>		</div>
		
		<div class="comment-meta commentmetadata"><a href="https://blogs.msdn.microsoft.com/oldnewthing/20120614-00/?p=7373#comment-992213">
			June 15, 2012 at 12:27 pm</a>		</div>

		<p>Windows 7 shutdown my game in the middle of an extended play session without any warnings of any kind.</p>
<p>Damn you for giving a better gaming experience than linux.</p>

		
				</div>
		</li><!-- #comment-## -->
		<li class="comment even thread-even depth-1" id="comment-992223">
				<div id="div-comment-992223" class="comment-body">
				<div class="comment-author vcard">
						<cite class="fn">voo</cite> <span class="says">says:</span>		</div>
		
		<div class="comment-meta commentmetadata"><a href="https://blogs.msdn.microsoft.com/oldnewthing/20120614-00/?p=7373#comment-992223">
			June 15, 2012 at 1:50 pm</a>		</div>

		<p>@Diablo 3 player: Can&#39;t be much of a gamer if even after more than a decade you still didn&#39;t get the memo to turn off automatic reboot. Really just turn it off (i.e. only install when user gives ok whatever) when you get a new PC and that&#39;s it &#8211; also recommended for all people who leave their PCs running unattended.</p>
<p>@Evan You never click &quot;shutdown&quot; on your notebook, then close the lid and put it away? Well ok with sleep working fine for the last few years I haven&#39;t done that either, but it used to be a real problem under XP back in the day</p>

		
				</div>
		</li><!-- #comment-## -->
		<li class="comment odd alt thread-odd thread-alt depth-1" id="comment-992073">
				<div id="div-comment-992073" class="comment-body">
				<div class="comment-author vcard">
						<cite class="fn">Evan</cite> <span class="says">says:</span>		</div>
		
		<div class="comment-meta commentmetadata"><a href="https://blogs.msdn.microsoft.com/oldnewthing/20120614-00/?p=7373#comment-992073">
			June 15, 2012 at 8:22 am</a>		</div>

		<p>Who shuts down their laptop when it&#39;s not plugged in and then walks away from it?! I&#39;m either in a controlled location like my home or office and plugged in, or in an uncontrolled location where I&#39;m not going to leave my laptop unattended. Not saying that MS shouldn&#39;t do anything to appease that half of the population, but maybe something else like &quot;if the system is trying to shut down for more than a couple minutes and it is not plugged in, then hibernate&quot; would be better. But that seems like way too complex of a policy to hard code&#8230;</p>
<p>@dave: &quot;That suffers from the fallacy that there is always an *** in the seat.&quot;</p>
<p>No it doesn&#39;t. Part of the argument is that if there&#39;s *not* someone there, then they didn&#39;t authorize the shutdown and it shouldn&#39;t happen. You may disagree with that, but I think both positions are perfectly reasonable.</p>
<p>@raphael: &quot;I&#39;m pretty sure that Windows updates are independent and atomic. If an update requires a reboot, it has not been installed yet, even partially. That would be foolish.&quot;</p>
<p>The reason that the reboots are required in the first place is so Windows can update files that are in use and locked. How can the system tell if a file is in use before just going for it? My understanding then is that an update may or may not require an update depending on what&#39;s currently running!</p>
<p>(I guess the system could try to grab locks on all the files and only if that succeeds, do the update.)</p>
<p>@algr1: &quot;Are you aware that Excel will prompt to save the document even if you only switched to a different page?&quot;</p>
<p>Um, what Excel? 2007 didn&#39;t in my little test I just did.</p>

		
				</div>
		</li><!-- #comment-## -->
		<li class="comment even thread-even depth-1" id="comment-992273">
				<div id="div-comment-992273" class="comment-body">
				<div class="comment-author vcard">
						<cite class="fn">Evan</cite> <span class="says">says:</span>		</div>
		
		<div class="comment-meta commentmetadata"><a href="https://blogs.msdn.microsoft.com/oldnewthing/20120614-00/?p=7373#comment-992273">
			June 15, 2012 at 8:00 pm</a>		</div>

		<p>@voo: &quot;@Evan You never click &quot;shutdown&quot; on your notebook, then close the lid and put it away? Well ok with sleep working fine for the last few years I haven&#39;t done that either, but it used to be a real problem under XP back in the day &quot;</p>
<p>Ah, I guess I can see that. I basically don&#39;t ever click shutdown, only sleep/hibernate/restart. I&#39;ve realized that in the past, but that fact&#39;s applicability to this situation didn&#39;t occur to me.</p>

		
				</div>
		</li><!-- #comment-## -->
		<li class="comment odd alt thread-odd thread-alt depth-1" id="comment-992283">
				<div id="div-comment-992283" class="comment-body">
				<div class="comment-author vcard">
						<cite class="fn"><a href='http://blogs.msdn.com/jas71_4000_hotmail.com/ProfileUrlRedirect.ashx' rel='external nofollow' class='url'>jas71@hotmail.com</a></cite> <span class="says">says:</span>		</div>
		
		<div class="comment-meta commentmetadata"><a href="https://blogs.msdn.microsoft.com/oldnewthing/20120614-00/?p=7373#comment-992283">
			June 16, 2012 at 2:50 am</a>		</div>

		<p>&quot;The other half of the population complains that they shut down their laptop, and then walk away, and return hours later to find the battery dead.&quot;</p>
<p>I&#39;m firmly in that camp; for a while, I was infuriated by my own (non-Windows) laptop failing to suspend when I shut the lid. It would appear to sleep, go quiet, turn off the screen &#8230; then 20 minutes later, standing on the train home, I wonder why my back is getting uncomfortably hot. (If I remember correctly, the graphics driver was actually crashing during the sleep attempt, livelocking as a result. Not nice. Graphics drivers do seem to be the culprit in far too many problems these days!)</p>
<p>If a Windows shutdown breaks your lathe and burns the building down, is that equipment safe to use at all? How will it handle a plain old system crash (which of course terminates the lathe control program without the slightest warning, let alone the seconds Windows gives), hard drive/power supply/fan failure &#8230;</p>

		
				</div>
		</li><!-- #comment-## -->
		<li class="comment byuser comment-author-xpclientgmail-com even thread-even depth-1" id="comment-992333">
				<div id="div-comment-992333" class="comment-body">
				<div class="comment-author vcard">
						<cite class="fn"><a href='https://social.msdn.microsoft.com/profile/xpclient' rel='external nofollow' class='url'>xpclient</a></cite> <span class="says">says:</span>		</div>
		
		<div class="comment-meta commentmetadata"><a href="https://blogs.msdn.microsoft.com/oldnewthing/20120614-00/?p=7373#comment-992333">
			June 16, 2012 at 7:09 am</a>		</div>

		<p>@jas88, blame Vista/7/8 for it. When hibernating, they don&#39;t show the progress bar. For notebooks that don&#39;t come with any LEDS and have minimal design, it&#39;s hard to tell the OS hibernated fully and powered off. I ranted about it but the Windows team no longer listens as everyone knows: <a rel="nofollow" target="_new" href="http://social.msdn.microsoft.com/Forums/en-US/windowsdeveloperpreviewgeneral/thread/35c0b733-878e-4a13-9a26-6e08bb5e6dc6/" rel="nofollow">social.msdn.microsoft.com/&#8230;/35c0b733-878e-4a13-9a26-6e08bb5e6dc6</a> It takes a while to hibernate systems with 16GB RAM.</p>

		
				</div>
		</li><!-- #comment-## -->
		<li class="comment byuser comment-author-andycadley2 odd alt thread-odd thread-alt depth-1" id="comment-992373">
				<div id="div-comment-992373" class="comment-body">
				<div class="comment-author vcard">
						<cite class="fn"><a href='https://social.msdn.microsoft.com/profile/AndyCadley' rel='external nofollow' class='url'>AndyCadley</a></cite> <span class="says">says:</span>		</div>
		
		<div class="comment-meta commentmetadata"><a href="https://blogs.msdn.microsoft.com/oldnewthing/20120614-00/?p=7373#comment-992373">
			June 17, 2012 at 4:17 am</a>		</div>

		<p>Any application that still prompts for a user to decide whether or not to save work when a shutdown message arrives is, quite simply, doing it wrong. Disk space is cheap. Automatically preserve the current state and resume it when the app is next open. And if your app has been running for more than about two seconds since it last saved state, it&#39;s setting itself up to lose the user&#39;s work anyway.</p>
<p>We really ought to have moved on well beyond these kind of silly trivial issues a long, long time ago.</p>

		
				</div>
		</li><!-- #comment-## -->
		<li class="comment byuser comment-author-andycadley2 even thread-even depth-1" id="comment-992383">
				<div id="div-comment-992383" class="comment-body">
				<div class="comment-author vcard">
						<cite class="fn"><a href='https://social.msdn.microsoft.com/profile/AndyCadley' rel='external nofollow' class='url'>AndyCadley</a></cite> <span class="says">says:</span>		</div>
		
		<div class="comment-meta commentmetadata"><a href="https://blogs.msdn.microsoft.com/oldnewthing/20120614-00/?p=7373#comment-992383">
			June 17, 2012 at 4:21 am</a>		</div>

		<p>@xpclient: A progress bar is pointless. Once the user has initiated a hibernate by closing the lid (or indeed in the UI after reviewing the blocking app dialog), the system should hibernate. Nothing short of a unexpected power failure midway through writing the disk should prevent it. The progress bar is a solution to entirely the wrong problem.</p>

		
				</div>
		</li><!-- #comment-## -->
		<li class="comment odd alt thread-odd thread-alt depth-1" id="comment-992413">
				<div id="div-comment-992413" class="comment-body">
				<div class="comment-author vcard">
						<cite class="fn">Joshua</cite> <span class="says">says:</span>		</div>
		
		<div class="comment-meta commentmetadata"><a href="https://blogs.msdn.microsoft.com/oldnewthing/20120614-00/?p=7373#comment-992413">
			June 17, 2012 at 8:33 am</a>		</div>

		<blockquote><p>
  If a Windows shutdown breaks your lathe&#8230;, is that equipment safe to use at all? How will</p>
<p>  it handle a plain old system crash (which of course terminates the lathe control program</p>
<p>  without the slightest warning, let alone the seconds Windows gives), hard drive/power supply/fan</p>
<p>  failure.
</p></blockquote>
<p>The watchdog turns on the crowbar circuit, causing about $10,000 damage. Now if we actually lost</p>
<p>power, this is a non-issue for the obvious reason.</p>

		
				</div>
		</li><!-- #comment-## -->
		<li class="comment byuser comment-author-gregm even thread-even depth-1" id="comment-992443">
				<div id="div-comment-992443" class="comment-body">
				<div class="comment-author vcard">
						<cite class="fn"><a href='https://social.msdn.microsoft.com/profile/GregM' rel='external nofollow' class='url'>GregM</a></cite> <span class="says">says:</span>		</div>
		
		<div class="comment-meta commentmetadata"><a href="https://blogs.msdn.microsoft.com/oldnewthing/20120614-00/?p=7373#comment-992443">
			June 17, 2012 at 2:23 pm</a>		</div>

		<p>Andy, given a choice between &quot;making it always work&quot; and &quot;showing a progress bar so we know when it&#39;s done&quot;, I&#39;d prefer &quot;making it always work&quot;, but assuming that isn&#39;t possible, I&#39;ll take the progress bar.</p>

		
				</div>
		</li><!-- #comment-## -->
		<li class="comment odd alt thread-odd thread-alt depth-1" id="comment-992473">
				<div id="div-comment-992473" class="comment-body">
				<div class="comment-author vcard">
						<cite class="fn"><a href='http://blogs.msdn.com/johnstonj_4000_inn_2D00_soft.com/ProfileUrlRedirect.ashx' rel='external nofollow' class='url'>johnstonj@inn-soft.com</a></cite> <span class="says">says:</span>		</div>
		
		<div class="comment-meta commentmetadata"><a href="https://blogs.msdn.microsoft.com/oldnewthing/20120614-00/?p=7373#comment-992473">
			June 18, 2012 at 7:40 am</a>		</div>

		<p>@xpclient: &quot;blame Vista/7/8 for it. When hibernating, they don&#39;t show the progress bar.&quot;</p>
<p>I seem to recall reading that the screen is turned off to save power. &nbsp;The justification is that it could be the difference between a successful hibernate and a failed one due to power loss. &nbsp;This is especially likely because hibernate is often triggered as a response to critically low battery levels, so not much power is generally remaining when it&#39;s done. &nbsp;So while you complain about the lack of a progress bar, others would complain that it was using unnecessary power.</p>
<p>My last laptop was a Lenovo with a sleep LED that would blink while it was hibernating. &nbsp;I&#39;d wait until it stopped blink it, then pack the laptop to avoid any shock to the hard drive. &nbsp;Now that I have an SSD, I don&#39;t even worry about that. &nbsp;That&#39;s when I hibernate &#8211; usually I suspend&#8230;</p>

		
				</div>
		</li><!-- #comment-## -->
		<li class="comment even thread-even depth-1" id="comment-992513">
				<div id="div-comment-992513" class="comment-body">
				<div class="comment-author vcard">
						<cite class="fn">Worf</cite> <span class="says">says:</span>		</div>
		
		<div class="comment-meta commentmetadata"><a href="https://blogs.msdn.microsoft.com/oldnewthing/20120614-00/?p=7373#comment-992513">
			June 18, 2012 at 11:06 am</a>		</div>

		<p>Yeah, once the PC I was using was upgraded to an SSD, I turned on safe suspend (sleep+hibernate) and never looked back. Though I could switch to a full hibernate model since resuming from SSD is pretty damn fast. Might not even be measurably slower, either.</p>

		
				</div>
		</li><!-- #comment-## -->
		<li class="comment odd alt thread-odd thread-alt depth-1" id="comment-992673">
				<div id="div-comment-992673" class="comment-body">
				<div class="comment-author vcard">
						<cite class="fn"><a href='http://blogs.msdn.com/johnstonj_4000_inn_2D00_soft.com/ProfileUrlRedirect.ashx' rel='external nofollow' class='url'>johnstonj@inn-soft.com</a></cite> <span class="says">says:</span>		</div>
		
		<div class="comment-meta commentmetadata"><a href="https://blogs.msdn.microsoft.com/oldnewthing/20120614-00/?p=7373#comment-992673">
			June 19, 2012 at 7:33 am</a>		</div>

		<p>&quot;once the PC I was using was upgraded to an SSD, I turned on safe suspend (sleep+hibernate) and never looked back&quot;</p>
<p>My problem with that is I&#39;m dumb and I suspend the computer when I wasn&#39;t ready yet, so I have to immediately turn it back on. &nbsp;That is:</p>
<ol>
<li>&nbsp;I suspend the computer.</li>
<li>
<p>&nbsp;I forgot to &lt;insert important task that only takes 5 seconds to do&gt;, because I&#39;m absent-minded. &nbsp;Probably I remember it while the computer is still suspending.</p>
</li>
<li>
<p>&nbsp;I immediately resume the computer.</p>
</li>
<li>
<p>&nbsp;I do the task.</p>
</li>
<li>
<p>&nbsp;A minute later, I suspend again.</p>
</li>
</ol>
<p>If I did safe/hybrid suspend, wouldn&#39;t I have to wait for the hibernate to finish writing to disk in step #3 before I can resume from suspend? &nbsp;That would annoy me. &nbsp;It would be nice if there was a way to abort the hibernation and just resume right away.</p>

		
				</div>
		</li><!-- #comment-## -->
		</ol><!-- .comment-list -->

		<div class="navigation pagination">
					</div>

	
			<p class="no-comments">Comments are closed.</p>
<!-- COMMENTS END -->
</div></td></tr></table>

</body>
</html>
<br/><div class="disclaimer">
*DISCLAIMER: I DO NOT OWN THIS CONTENT. If you are the owner and would like it removed, please
<a target="_blank" href="/contact.htm">contact me</a>.
The content herein is an archived reproduction of entries from
Raymond Chen's "Old New Thing" Blog (most recent link is <a target="_blank" href="https://devblogs.microsoft.com/oldnewthing/">here</a>).
It may have slight formatting modifications for consistency and to improve readability.
<br/><br/>
WHY DID I DUPLICATE THIS CONTENT HERE?
Let me first say this site has never had anything to sell and has never shown ads of any kind. I have nothing monetarily to gain by duplicating content here.
Because I had made my own local copy of this content throughout the years, for ease of using tools like grep, I decided to put it online after I discovered
some of the original content previously and publicly available, had disappeared approximately early to mid 2019.
At the same time, I present the content in an easily accessible theme-agnostic way.
<br/><br/>
The information provided by Raymond's blog is, for all practical purposes, more authoritative on Windows Development than Microsoft's
own MSDN documentation and should be considered supplemental reading to that documentation. The wealth of missing details
provided by this blog that Microsoft could not or did not document about Windows over the years is vital enough, many would agree an online "backup" of these details
is a necessary endeavor. Specifics include:<br/>
<ul>
    <li>
        A "redesign" after 2019 erased thousands of user's comments from previous years. As many have stated, the comments are nearly as important as the postings themselves.
        The archived copies of the postings contained here retain the original comments.
    </li>
    <li>
        The blog has changed domains many times and the urls have otherwise been under constant change since 2003.
        Even when proper redirection has been set up for those links, redirection only works for a limited period of time.
        For example, all of the internal blog links that were valid in early 2019, were broken by 2020 without proper redirection.
    </li>
    <li>
        The blog has been under constant re-design and re-theming since its inception.
        It is downright irritating to deal with a bogged-down site experience as the result of the latest visual themes designed for cell-phone browsers.
        As of this writing, it is cumbersome to navigate titles with only 10 entries per page.
        While it is nice that the official site has a search feature, searching using this index (with all titles on a single page) is much quicker (CTRL-F in most browsers).
    </li>
</ul>
</div><br/>
&lt;-- Back to <a href="index.htm">Old New Thing Archive Index</a>

