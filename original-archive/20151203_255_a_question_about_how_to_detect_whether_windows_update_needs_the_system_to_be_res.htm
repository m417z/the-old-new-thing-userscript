<html>
<head>
<title>A question about how to detect whether Windows Update needs the system to be restarted turns out to be the wrong question</title>
<link rel="stylesheet" href="page.css">
</head><body>
<div class="titlediv"><h2>A question about how to detect whether Windows Update needs the system to be restarted turns out to be the wrong question</h2></div>
<div class="hdrdiv"><table class="hdrtable" cellspacing="0" cellpadding="0">
<tr><td><b>Date:</b></td><td>December 3, 2015 / year-entry #256</td></tr>
<tr><td><b>Tags:</b></td><td>code</td></tr>
<tr><td><b>Orig Link:</b></td><td>https://blogs.msdn.microsoft.com/oldnewthing/20151203-00/?p=92261</td></tr>

<tr><td><b>Comments:&nbsp;&nbsp;&nbsp;&nbsp;</b></td><td>50</td></tr>
<tr><td valign="top"><b>Summary:</b></td><td valign="top">A customer wanted to know whether there was a way to detect that Windows Update has recently installed an update that requires a reboot. They explained that their computers are running dedicated software, and the customers are not technically-savvy, so they want to display the "You need to reboot" message more prominently, and let the...</td></tr>
</table></div>
<hr/>
<table class="contenttable" cellspacing="0" cellpadding="0"><tr><td><div class="contentdiv">
<!-- CONTENT START -->
<!-- Adrian Bliss (adrianbl) win32prg 7/5/2012 "Reboot flags"; Mark Phaedrus provided most of the information here -->
<p>
A customer wanted to know whether there was a way to detect that
Windows Update has recently installed an update that requires a reboot.
They explained that their computers are running dedicated software,
and the customers are not technically-savvy, so they want to display
the "You need to reboot" message more prominently,
and let the user choose the best time to reboot.
"We have been checking a variety of registry keys,
and we have found that the set of keys to check is quite extensive
and varies depending on the nature of the update that was installed."
</p>
<p>
There is a fairly straightforward way to check
<a href="http://blogs.msdn.com/b/oldnewthing/archive/2015/09/21/10642727.aspx">
whether Windows Update is waiting for the system to reboot</a>,
but we asked for more information about the customer's scenario.
Fortunately, the customer was willing to share.
</p>
<blockquote class="q"><p>
These computers are in a hospital running critical medical software.
The software runs 24/7 and must not reboot without user consent.
</p>
</blockquote>
<p>
If these are critical machines,
then asking whether Windows Update is requesting a reboot is the
wrong question.
By the time you get the answer "Yes", you are already in trouble:
If you reboot the computer as soon as a reboot is required,
you interrupt the machine's critical functioning.
If you postpone the reboot, then you leave the computer in a
nonstandard configuration wherein an update is partially-installed,
and that nonstandard configuration may compromise the machine's
critical function.
</p>
<p>
In this specific case,
the idea would be to change the design from
"Install the update, and then postpone the reboot until a convenient
time" to
"Wait for a convenient time,
then install the update and reboot immediately."
Here's a sketch of how it could work.
(Note: This is a sketch, not a fully-analyzed scenario.
Do not implement this design on your critical medical systems
before independently validating its efficacy to your satisfaction.
In fact, as a general rule,
you should not use blog posts as the sole basis for
software design decisions for critical medical systems.)
</p>
<ul>
<li>Set Automatic Updates so it does not install updates
    immediately. Either disable it, or set it to
    download updates without installing them.
</li>
<li>Ensure that users do not have permission to alter these settings
    or to initiate the installation of updates independently.
</li>
<li>Periodically check whether there are new updates available.
    The
    <a href="http://msdn.microsoft.com/en-us/library/windows/desktop/aa387102(v=vs.85).aspx">
    Searching, Downloading, and Installing Updates</a>
    script on MSDN is an example of how you can use the
    Windows Update Agent API to answer questions like this.
</li>
<li>If there are updates available that do not require a reboot,
    you may choose to install them without interrupting service.
    You can use the
    <a href="http://msdn.microsoft.com/en-us/library/microsoft.updateservices.administration.installationbehavior.rebootbehavior%28v=vs.85%29.aspx">
    <code>Installation&shy;Behavior.<wbr>Reboot&shy;Behavior</wbr></code></a>
    property
    to determine whether a particular update
    guarantees that it can be installed
    without a reboot.
</li>
<li>If there are updates available that may require a reboot,
    inform the user that the computer will be unavailable while
    the updates are installed and let the user choose when to install
    those updates.
</li>
<li>When installing the updates, display a message indicating that
    the computer is unavailable.
</li>
<li>When installation is complete, reboot immediately.
</li>
</ul>
<p>
The important things are that
(1)&nbsp;you treat the installation of the update
and the reboot as a unit, and
(2)&nbsp;you don't start the install+reboot process until the user
confirms that they
are okay with the system being temporarily unavailable.
</p>
<p>
Thanks to my colleague Mark Phaedrus for
providing the raw materials from which this article was constructed.
</p></p>
<!-- CONTENT END -->
</div></td></tr></table>
<hr/>
<table class="commenttable" cellspacing="0" cellpadding="0"><tr><td><div class="commentdiv"><div class="commentdivhdr">
<!-- COMMENTS START -->
Comments (50)	</div>

	
			<div class="navigation pagination clear-both">
					</div>

		<ol class="comment-list">
					<li class="comment even thread-even depth-1" id="comment-1216851">
				<div id="div-comment-1216851" class="comment-body">
				<div class="comment-author vcard">
						<cite class="fn">Joshua</cite> <span class="says">says:</span>		</div>
		
		<div class="comment-meta commentmetadata"><a href="https://blogs.msdn.microsoft.com/oldnewthing/20151203-00/?p=92261#comment-1216851">
			December 3, 2015 at 7:03 am</a>		</div>

		<p>Incidentally such life critical systems do things like preload all their DLLs so the nonstandard state is less dangerous than usual. All the same they will surely take your advice.</p>

		
				</div>
		</li><!-- #comment-## -->
		<li class="comment odd alt thread-odd thread-alt depth-1" id="comment-1216831">
				<div id="div-comment-1216831" class="comment-body">
				<div class="comment-author vcard">
						<cite class="fn">Cesar</cite> <span class="says">says:</span>		</div>
		
		<div class="comment-meta commentmetadata"><a href="https://blogs.msdn.microsoft.com/oldnewthing/20151203-00/?p=92261#comment-1216831">
			December 3, 2015 at 7:28 am</a>		</div>

		<p>I&#39;d expect machines running critical software to be running on an embedded operating system, not on a general-purpose desktop operating system. Is the Windows version they are using certified to be used for such critical software?</p>

		
				</div>
		</li><!-- #comment-## -->
		<li class="comment even thread-even depth-1" id="comment-1216821">
				<div id="div-comment-1216821" class="comment-body">
				<div class="comment-author vcard">
						<cite class="fn">Eric</cite> <span class="says">says:</span>		</div>
		
		<div class="comment-meta commentmetadata"><a href="https://blogs.msdn.microsoft.com/oldnewthing/20151203-00/?p=92261#comment-1216821">
			December 3, 2015 at 7:54 am</a>		</div>

		<p>My first question is why such life critical systems are getting updates through Windows Update in the first place. &nbsp;One would think that a managed solution (e.g., WSUS) would make a lot more sense in that environment.</p>

		
				</div>
		</li><!-- #comment-## -->
		<li class="comment byuser comment-author-alegrigoriev odd alt thread-odd thread-alt depth-1" id="comment-1216811">
				<div id="div-comment-1216811" class="comment-body">
				<div class="comment-author vcard">
						<cite class="fn"><a href='https://social.msdn.microsoft.com/profile/alegr1' rel='external nofollow' class='url'>alegr1</a></cite> <span class="says">says:</span>		</div>
		
		<div class="comment-meta commentmetadata"><a href="https://blogs.msdn.microsoft.com/oldnewthing/20151203-00/?p=92261#comment-1216811">
			December 3, 2015 at 8:04 am</a>		</div>

		<p>Another question is why the life critical system has access to Internet. They should be on an isolated network, if they have to be networked at all.</p>

		
				</div>
		</li><!-- #comment-## -->
		<li class="comment even thread-even depth-1" id="comment-1216801">
				<div id="div-comment-1216801" class="comment-body">
				<div class="comment-author vcard">
						<cite class="fn">BrianVan</cite> <span class="says">says:</span>		</div>
		
		<div class="comment-meta commentmetadata"><a href="https://blogs.msdn.microsoft.com/oldnewthing/20151203-00/?p=92261#comment-1216801">
			December 3, 2015 at 8:13 am</a>		</div>

		<p>Cesar: Generally, Microsoft believes Windows (or at least certain flavors of it) has the ability to be an embedded operating system for critical functions. And while your mother&#39;s friend&#39;s nephew&#39;s college roommate is probably not the person to put together a system meeting critical specs, a master of the OS has all the tools they need to get Windows to behave accordingly. (You see blue screens of death on airport kiosks and digital billboards because the team who did the work&#8230; weren&#39;t masters)</p>
<p>Note, I qualified this all with &quot;generally&quot; and the skepticism is warranted. And I bet even the world&#39;s top system experts who work with Microsoft OS products would probably offer, in most cases, a non-MSFT option with a lower overall cost of operation for critical applications. All this talk about reboots &amp; updates&#8230; that&#39;s a lot of nonsense to include for a package needing to meet a 24/7 requirement. </p>

		
				</div>
		</li><!-- #comment-## -->
		<li class="comment odd alt thread-odd thread-alt depth-1" id="comment-1216791">
				<div id="div-comment-1216791" class="comment-body">
				<div class="comment-author vcard">
						<cite class="fn">Ancient_Hacker</cite> <span class="says">says:</span>		</div>
		
		<div class="comment-meta commentmetadata"><a href="https://blogs.msdn.microsoft.com/oldnewthing/20151203-00/?p=92261#comment-1216791">
			December 3, 2015 at 8:14 am</a>		</div>

		<p>Um, I would be a lot more cautious. &nbsp; Having worked in medical software, I think a LOT more caution is needed, like first testing the software with the system updates. &nbsp;All it would take is some &quot;improvement&quot; in how something in a system API is done, like making it work more quickly, and we&#39;re in Therac-25 territory. &nbsp; </p>
<p>Also, does Windows update still have the charming feature of wanting to download updates to the C: or system drive? &nbsp; &nbsp;Charming. &nbsp;If this is a medical device, filling up the disk with updates could again be a very serious issue. &nbsp; </p>
<p>So I don&#39;t think you want medical devices to be downloading anything, ever. &nbsp;At the medical place releasing new software/system combos involved a whole lot of testing and a careful release process.</p>

		
				</div>
		</li><!-- #comment-## -->
		<li class="comment even thread-even depth-1" id="comment-1216781">
				<div id="div-comment-1216781" class="comment-body">
				<div class="comment-author vcard">
						<cite class="fn">M</cite> <span class="says">says:</span>		</div>
		
		<div class="comment-meta commentmetadata"><a href="https://blogs.msdn.microsoft.com/oldnewthing/20151203-00/?p=92261#comment-1216781">
			December 3, 2015 at 8:29 am</a>		</div>

		<p>@alegr1 I suspect (hope) that &quot;life critical&quot; and &quot;critical medical software&quot; are not interchangeable. Life-support machines are life-critical: the receptionists&#39; PCs or some diagnosis-entry machine might also be considered &quot;critical medical software&quot;.</p>

		
				</div>
		</li><!-- #comment-## -->
		<li class="comment byuser comment-author-bboorman odd alt thread-odd thread-alt depth-1" id="comment-1216771">
				<div id="div-comment-1216771" class="comment-body">
				<div class="comment-author vcard">
						<cite class="fn"><a href='https://social.msdn.microsoft.com/profile/Brian_EE' rel='external nofollow' class='url'>Brian_EE</a></cite> <span class="says">says:</span>		</div>
		
		<div class="comment-meta commentmetadata"><a href="https://blogs.msdn.microsoft.com/oldnewthing/20151203-00/?p=92261#comment-1216771">
			December 3, 2015 at 8:43 am</a>		</div>

		<p>I agree with &quot;M&quot;&#8230;. commenters made the leap from the term &quot;critical&quot; to &quot;life critical&quot; with no evidence.</p>
<p>For all we know, this could be the machine at the nurses&#39; station that monitors and alerts information gathered from the systems in the patient rooms &#8211; so it might not be by itself life-critical, but it is critical in the sense that it can&#39;t be offline without prior planning. That&#39;s just one example I could think of.</p>

		
				</div>
		</li><!-- #comment-## -->
		<li class="comment even thread-even depth-1" id="comment-1216761">
				<div id="div-comment-1216761" class="comment-body">
				<div class="comment-author vcard">
						<cite class="fn">Cesar</cite> <span class="says">says:</span>		</div>
		
		<div class="comment-meta commentmetadata"><a href="https://blogs.msdn.microsoft.com/oldnewthing/20151203-00/?p=92261#comment-1216761">
			December 3, 2015 at 8:58 am</a>		</div>

		<p>@BrianVan: the part about displaying the &quot;you need to reboot&quot; message is what makes me think it&#39;s a normal desktop version of Windows, not one of these stripped-down embedded versions of Windows.</p>
<p>And doctors do some very cringe-worthy things, security-wise. One I&#39;ve witnessed recently: to watch a X-Ray, just put the CD in their desktop and run the viewer (a Windows executable) contained on the CD. By the way, the CD was with the patient, it didn&#39;t come directly from the radiography lab to the doctor&#39;s hands.</p>

		
				</div>
		</li><!-- #comment-## -->
		<li class="comment odd alt thread-odd thread-alt depth-1" id="comment-1216751">
				<div id="div-comment-1216751" class="comment-body">
				<div class="comment-author vcard">
						<cite class="fn">David Ching</cite> <span class="says">says:</span>		</div>
		
		<div class="comment-meta commentmetadata"><a href="https://blogs.msdn.microsoft.com/oldnewthing/20151203-00/?p=92261#comment-1216751">
			December 3, 2015 at 9:19 am</a>		</div>

		<p>One unknown is how long will it take to install the updates and reboot. &nbsp;On one of my older PC&#39;s running Windows 7, sometimes it takes only a few seconds to install the updates, another times it took 40 minutes or so and when rebooted it had to restart twice. &nbsp;What is needed is some sort of &quot;system impact&quot; of each update to know if the update will need to be performed overnight or can wait for the coffee break.</p>

		
				</div>
		</li><!-- #comment-## -->
		<li class="comment even thread-even depth-1" id="comment-1216741">
				<div id="div-comment-1216741" class="comment-body">
				<div class="comment-author vcard">
						<cite class="fn">Mr Cranky</cite> <span class="says">says:</span>		</div>
		
		<div class="comment-meta commentmetadata"><a href="https://blogs.msdn.microsoft.com/oldnewthing/20151203-00/?p=92261#comment-1216741">
			December 3, 2015 at 9:29 am</a>		</div>

		<p>The only question is whether updates are pending. &nbsp;*All* updates are evidently &quot;important&quot;, and *all* updates require a restart. &nbsp;Latest example is KB3102429: &quot;Update that supports Azerbaijani Manat and Georgian Lari currency symbols in Windows&quot;. &nbsp;This one appeared all by itself.</p>
<p>Right.</p>

		
				</div>
		</li><!-- #comment-## -->
		<li class="comment odd alt thread-odd thread-alt depth-1" id="comment-1216731">
				<div id="div-comment-1216731" class="comment-body">
				<div class="comment-author vcard">
						<cite class="fn">Eric</cite> <span class="says">says:</span>		</div>
		
		<div class="comment-meta commentmetadata"><a href="https://blogs.msdn.microsoft.com/oldnewthing/20151203-00/?p=92261#comment-1216731">
			December 3, 2015 at 9:50 am</a>		</div>

		<p>Brian EE &#8212; You are correct that &quot;life critical&quot; was an erroneous term. &nbsp;However, the correcting the description of the &quot;critical medical software&quot; that &quot;runs 24/7 and must not reboot without user consent&quot; doesn&#39;t change the problem or my view one bit.</p>

		
				</div>
		</li><!-- #comment-## -->
		<li class="comment even thread-even depth-1" id="comment-1216721">
				<div id="div-comment-1216721" class="comment-body">
				<div class="comment-author vcard">
						<cite class="fn">HiTechHiTouch</cite> <span class="says">says:</span>		</div>
		
		<div class="comment-meta commentmetadata"><a href="https://blogs.msdn.microsoft.com/oldnewthing/20151203-00/?p=92261#comment-1216721">
			December 3, 2015 at 10:20 am</a>		</div>

		<p>Another gotcha &#8212; sometimes M$ Update wants to update M$ Update itself, which is most difficult to see coming, or to stop. &nbsp;Don&#39;t quote me, but I believe one past iteration required me to reboot.</p>

		
				</div>
		</li><!-- #comment-## -->
		<li class="comment odd alt thread-odd thread-alt depth-1" id="comment-1216711">
				<div id="div-comment-1216711" class="comment-body">
				<div class="comment-author vcard">
						<cite class="fn">Joshua</cite> <span class="says">says:</span>		</div>
		
		<div class="comment-meta commentmetadata"><a href="https://blogs.msdn.microsoft.com/oldnewthing/20151203-00/?p=92261#comment-1216711">
			December 3, 2015 at 10:31 am</a>		</div>

		<p>@Eric: Nor mine</p>
<p>@HiTechHiTouch: At least that one doesn&#39;t push for the reboot but will happily wait as long as necessary (I&#39;ve seen it).</p>

		
				</div>
		</li><!-- #comment-## -->
		<li class="comment even thread-even depth-1" id="comment-1216701">
				<div id="div-comment-1216701" class="comment-body">
				<div class="comment-author vcard">
						<cite class="fn">KB3102429</cite> <span class="says">says:</span>		</div>
		
		<div class="comment-meta commentmetadata"><a href="https://blogs.msdn.microsoft.com/oldnewthing/20151203-00/?p=92261#comment-1216701">
			December 3, 2015 at 12:23 pm</a>		</div>

		<p>@Mr Cranky: according to the KB article the KB3102429 update is categorized Optional. &nbsp;Based on the file information in the article, the update apparently contains a rather surprisingly long list of Windows DLLs, which may help explain requiring a reboot. &nbsp;I can only speculate that it must&#39;ve affected some shared static lib?</p>
<p><a rel="nofollow" target="_new" href="http://support.microsoft.com/en-us/kb/3102429">support.microsoft.com/&#8230;/3102429</a></p>
<p>But yeah, other than Windows Defender definition updates, I can&#39;t remember the last time a Windows Update didn&#39;t require a reboot on my computer. &nbsp;Granted, to expect otherwise is kinda like expecting your auto mechanic be able to safely and properly service your car while you&#39;re still driving it.</p>

		
				</div>
		</li><!-- #comment-## -->
		<li class="comment odd alt thread-odd thread-alt depth-1" id="comment-1216691">
				<div id="div-comment-1216691" class="comment-body">
				<div class="comment-author vcard">
						<cite class="fn">Destroyer</cite> <span class="says">says:</span>		</div>
		
		<div class="comment-meta commentmetadata"><a href="https://blogs.msdn.microsoft.com/oldnewthing/20151203-00/?p=92261#comment-1216691">
			December 3, 2015 at 1:04 pm</a>		</div>

		<p>@alegr1 &#8211; Just because something is critical doesn&#39;t mean it can&#39;t have access to the internet, that is a bit blanket.</p>
<p>@Raymond &#8211; I always assumed that the first phase of updates (i.e. installing them before reboot) does NOT leave the machine in a non-standard configuration, which is why since Windows 8 / Server 2012, it will attempt to install the updates in the background and then will happily sit there on the &quot;the system needs to restart&quot; for days/weeks etc until the user allows it. Granted it is in a semi-installed state though and you&#39;re still past the point of no return because it is going to take longer to restart than normal, but I thought in terms of the running OS, it is still consistent and unchanged. Could you comment on this?</p>
<div class="post">[<em>I wouldn&#39;t be surprised if the update process was improved to be more atomic. But I&#39;m not the subject matter expert, so my thoughts don&#39;t mean much. -Raymond</em>]</div>

		
				</div>
		</li><!-- #comment-## -->
		<li class="comment even thread-even depth-1" id="comment-1216681">
				<div id="div-comment-1216681" class="comment-body">
				<div class="comment-author vcard">
						<cite class="fn">Damit</cite> <span class="says">says:</span>		</div>
		
		<div class="comment-meta commentmetadata"><a href="https://blogs.msdn.microsoft.com/oldnewthing/20151203-00/?p=92261#comment-1216681">
			December 3, 2015 at 1:32 pm</a>		</div>

		<p>De-lurking to answer Destroyer&#39;s question: Since Windows Vista and the move to component-based servicing (CBS), if a file is in use when an update is attempted, the entire operation will be postponed until reboot (hence the &quot;Windows is installing updates&#8230;&quot; at shutdown/restart), the files will be updated in a kernel transaction (KTM) &#8211; one of its properties is that either all files are updated or or none are &#8211; and then the update install will resume after reboot before the login screen. It was much more of a concern on XP where you could have some files updated but others that hadn&#39;t been updated yet.</p>
<p>Joseph Conway&#39;s blog (blogs.technet.com/b/joscon) has had several posts in the past on the changes to the servicing model in Vista, Win7, Win8 and Win8.1.</p>

		
				</div>
		</li><!-- #comment-## -->
		<li class="comment odd alt thread-odd thread-alt depth-1" id="comment-1216671">
				<div id="div-comment-1216671" class="comment-body">
				<div class="comment-author vcard">
						<cite class="fn">Brian</cite> <span class="says">says:</span>		</div>
		
		<div class="comment-meta commentmetadata"><a href="https://blogs.msdn.microsoft.com/oldnewthing/20151203-00/?p=92261#comment-1216671">
			December 3, 2015 at 1:48 pm</a>		</div>

		<p>Unless something has changed in the last several years, once updates (that require an update) have been installed, the system is often in a bit of a &quot;Franken-state&quot; until it is rebooted. &nbsp;Consider the case where an update changes two DLLs, one of which is loaded in a process (and hence requires the reboot) and one isn&#39;t yet loaded into the process, but will be soon. &nbsp;The reboot-requiring DLL won&#39;t be replaced until the update, but the other one may be replaced immediately. &nbsp;Even if much care was taken by Microsoft to try to make everything atomic, you are very to occasionally get into an untested state.</p>
<p>@Ancient_Hacker: It&#39;s very unlikely that anything Microsoft could do to Windows would ever cause it to enter Therac-25 territory. &nbsp;If you look into that system, it was pretty much a hack from start to finish (for example, a hand-hewn &quot;real time OS&quot; that provided no way to synchronize updates to memory). &nbsp;Now, it wouldn&#39;t surprise me to see a Microsoft customer write a Therac-25-class bad application on Windows&#8230;</p>
<p>@Everybody: &nbsp;Consider a system like one that automates/supervises a blood-analysis device. &nbsp;The device generally operates 24 hours a day in the lab, and its supervisory computer must be actively working unless the device is in a stand-by state. &nbsp;However, it would not be unreasonable to have a 30-60 minute monthly maintenance period as part of its working schedule. &nbsp;That is likely similar to what the customer meant by &quot;in a hospital running critical medical software [that] runs 24/7 and must not reboot without user consent&quot;</p>

		
				</div>
		</li><!-- #comment-## -->
		<li class="comment even thread-even depth-1" id="comment-1216661">
				<div id="div-comment-1216661" class="comment-body">
				<div class="comment-author vcard">
						<cite class="fn">Joshua Bowman</cite> <span class="says">says:</span>		</div>
		
		<div class="comment-meta commentmetadata"><a href="https://blogs.msdn.microsoft.com/oldnewthing/20151203-00/?p=92261#comment-1216661">
			December 3, 2015 at 1:57 pm</a>		</div>

		<p>@David Ching</p>
<p>In general you can assume that any .Net update will take minutes, and any core OS non-.Net update will take seconds. 40 minutes and multiple reboots would likely indicate that an update failed, was backed out, and reapplied after another reboot, which isn&#39;t something you can really predict.</p>
<p>@Ancient_Hacker</p>
<p>Of course you always test beforehand. You go through these steps after testing, once you&#39;ve pushed the update out. There are many organizations with hundreds or thousands of &quot;critical&quot; systems like this set up similarly, they don&#39;t all need to be individually walked through the update by IT.</p>

		
				</div>
		</li><!-- #comment-## -->
		<li class="comment odd alt thread-odd thread-alt depth-1" id="comment-1216651">
				<div id="div-comment-1216651" class="comment-body">
				<div class="comment-author vcard">
						<cite class="fn">Joshua</cite> <span class="says">says:</span>		</div>
		
		<div class="comment-meta commentmetadata"><a href="https://blogs.msdn.microsoft.com/oldnewthing/20151203-00/?p=92261#comment-1216651">
			December 3, 2015 at 3:20 pm</a>		</div>

		<p>@Brian: If somebody wrote the Therac-25 control software in user-mode Windows, it&#39;s in a nasty bug territory before even looking at the source code or development model. This is not a general dig at Windows, but there is a specific thing here.</p>
<p>Windows cannot provide hard realtime CPU and IO no matter what. The last version of Windows that could was Windows 3.1. The fundamental problem is Windows can decide to page your EXE out, and if you block that, it can decide to page out parts of its own internal DLLs, even if swap is completely disabled. Hard realtime + paged out code = bad news.</p>
<p>Thankfully these kinds of applications are rare.</p>

		
				</div>
		</li><!-- #comment-## -->
		<li class="comment even thread-even depth-1" id="comment-1216641">
				<div id="div-comment-1216641" class="comment-body">
				<div class="comment-author vcard">
						<cite class="fn">Brian</cite> <span class="says">says:</span>		</div>
		
		<div class="comment-meta commentmetadata"><a href="https://blogs.msdn.microsoft.com/oldnewthing/20151203-00/?p=92261#comment-1216641">
			December 3, 2015 at 4:32 pm</a>		</div>

		<p>@Joshua: I don&#39;t doubt that if the guy who wrote the Therac-25 (it was one person, no supervision, no design or code review) had written that system on the NT platform, it still would have been a basket of lethal bugs. &nbsp;My argument is that this statement is pushing it: &quot;All it would take is some &quot;improvement&quot; in how something in a system API is done, like making it work more quickly, and we&#39;re in Therac-25 territory.&quot;</p>
<p>Yeah, in a real system (something like the Therac-25, but one without the lethal after-effects), the manufacturer should be verifying every Windows Update release and letting its customers know when to apply any updates. &nbsp;However, it&#39;s unlikely that a Windows Update fix would result in a severe radiation over-dosing à la Therac.</p>

		
				</div>
		</li><!-- #comment-## -->
		<li class="comment byuser comment-author-aadsso-1live-com000300008794c744 odd alt thread-odd thread-alt depth-1" id="comment-1216631">
				<div id="div-comment-1216631" class="comment-body">
				<div class="comment-author vcard">
						<cite class="fn"><a href='https://social.msdn.microsoft.com/profile/Wisefaq' rel='external nofollow' class='url'>Wisefaq</a></cite> <span class="says">says:</span>		</div>
		
		<div class="comment-meta commentmetadata"><a href="https://blogs.msdn.microsoft.com/oldnewthing/20151203-00/?p=92261#comment-1216631">
			December 3, 2015 at 5:30 pm</a>		</div>

		<p>Gawd, I hope they&#39;re in a managed environment, running Group Policy to manage those settings. &nbsp;The only time I&#39;ve ever not been allowed to patch a &quot;health industry&quot; PC is Windows PCs running process control software for a pharmaceutical company. &nbsp;Those PCs were certified to perform their particular function. &nbsp;Real PITA, but they were on their own segmented network.</p>
<p>The only downfall of Raymond&#39;s guidance is that you get a class of user who never patches and reboots. &nbsp;What I&#39;ve done for those folks is implement an extremely long shutdown timer (&quot;your PC is going to reboot in 30 days&quot;).</p>
<p>For Raymond&#39;s customer example, you could quite easily substitute &quot;Executives who run Powerpoint presentations&quot; or &quot;Training PCs only brought out from storage every 30 days&quot;.</p>

		
				</div>
		</li><!-- #comment-## -->
		<li class="comment even thread-even depth-1" id="comment-1216871">
				<div id="div-comment-1216871" class="comment-body">
				<div class="comment-author vcard">
						<cite class="fn">Harry Johnston</cite> <span class="says">says:</span>		</div>
		
		<div class="comment-meta commentmetadata"><a href="https://blogs.msdn.microsoft.com/oldnewthing/20151203-00/?p=92261#comment-1216871">
			December 3, 2015 at 6:30 pm</a>		</div>

		<p>What I want to know is why Windows 10 seems to have gotten rid of the &quot;the system needs to restart&quot; notification altogether. &nbsp;We&#39;ve been experimenting with Windows 10 at my workplace, and it doesn&#39;t seem to tell you about pending updates unless you explicitly navigate to the WU control panel. &nbsp;Has anybody gotten this to work as expected?</p>

		
				</div>
		</li><!-- #comment-## -->
		<li class="comment odd alt thread-odd thread-alt depth-1" id="comment-1217281">
				<div id="div-comment-1217281" class="comment-body">
				<div class="comment-author vcard">
						<cite class="fn">Darran Rowe</cite> <span class="says">says:</span>		</div>
		
		<div class="comment-meta commentmetadata"><a href="https://blogs.msdn.microsoft.com/oldnewthing/20151203-00/?p=92261#comment-1217281">
			December 3, 2015 at 9:33 pm</a>		</div>

		<p>@Harry Johnston:</p>
<p>Under the advanced options for Windows update, there is the &quot;Choose how updates are installed&quot; option. You can set this to &quot;Notify to schedule restart&quot;. This should then prompt you to choose the restart time manually rather than it automatically choosing a time.</p>

		
				</div>
		</li><!-- #comment-## -->
		<li class="comment even thread-even depth-1" id="comment-1217271">
				<div id="div-comment-1217271" class="comment-body">
				<div class="comment-author vcard">
						<cite class="fn">ender</cite> <span class="says">says:</span>		</div>
		
		<div class="comment-meta commentmetadata"><a href="https://blogs.msdn.microsoft.com/oldnewthing/20151203-00/?p=92261#comment-1217271">
			December 4, 2015 at 4:27 am</a>		</div>

		<p>@Darran: the notification only works if you happen to be at the computer when it&#39;s displayed (it&#39;s shown for less than 30 seconds). If you miss it, well, hope you didn&#39;t leave any long running task overnight, because hey, 3:30 seems like a good time to kill everything that&#39;s running and force a restart.</p>

		
				</div>
		</li><!-- #comment-## -->
		<li class="comment odd alt thread-odd thread-alt depth-1" id="comment-1217261">
				<div id="div-comment-1217261" class="comment-body">
				<div class="comment-author vcard">
						<cite class="fn">bv1</cite> <span class="says">says:</span>		</div>
		
		<div class="comment-meta commentmetadata"><a href="https://blogs.msdn.microsoft.com/oldnewthing/20151203-00/?p=92261#comment-1217261">
			December 4, 2015 at 5:27 am</a>		</div>

		<p>I work at a hospital &#8211; embedded PC&#39;s and life critical are on their own networked and handle differently. &nbsp;Imagine a nurses station where the nurse is talking to a doctor they paged about a patient, he is asking questions about notes, meds, readings, &nbsp;etc. that are in the EHR(Electronic health record) and her PC reboots. Neither the doc on the phone or the nurse is happy and will let the CEO know this is not acceptable.</p>
<p>To the original question, it is possible with both reviewing patch documentation, using testing machines prior to deploying all updates, that we in IT do not know if a particular PC will reboot or not when patch is applied. &nbsp;This has to do with the nature of patches that we get from microsoft. In one case, if the PC had silverlight on it or not caused it to reboot. Silverlight was not mandated (or core) as it was a web tech. at first. &nbsp;All the test machines had silverlight and did not reboot. &nbsp;The monthly patch came through, machines without silverlight rebooted. We since have added silverlight as a core item and it will be installed on all PC&#39;s.</p>
<p>If we had an ability to know a reboot is going to occur that could be added to the scripts it would help. (Notify user, email IT, etc.)</p>
<p>The second problem class with reboot updates &#8211; &nbsp;For full fun, have users who poweroff the PC because it was taking longer than normal to reboot.</p>

		
				</div>
		</li><!-- #comment-## -->
		<li class="comment even thread-even depth-1" id="comment-1217211">
				<div id="div-comment-1217211" class="comment-body">
				<div class="comment-author vcard">
						<cite class="fn">Anon</cite> <span class="says">says:</span>		</div>
		
		<div class="comment-meta commentmetadata"><a href="https://blogs.msdn.microsoft.com/oldnewthing/20151203-00/?p=92261#comment-1217211">
			December 4, 2015 at 8:44 am</a>		</div>

		<p>@ender</p>
<p>Agreed wholeheartedly. I&#39;m all for forcing end-users to restart once running applications are properly shut down, but I don&#39;t want my machine terminating Visual Studio with unsaved code open. Which has happened. Repeatedly.</p>

		
				</div>
		</li><!-- #comment-## -->
		<li class="comment byuser comment-author-entegygmail-com odd alt thread-odd thread-alt depth-1" id="comment-1217201">
				<div id="div-comment-1217201" class="comment-body">
				<div class="comment-author vcard">
						<cite class="fn"><a href='https://social.msdn.microsoft.com/profile/Entegy' rel='external nofollow' class='url'>Entegy</a></cite> <span class="says">says:</span>		</div>
		
		<div class="comment-meta commentmetadata"><a href="https://blogs.msdn.microsoft.com/oldnewthing/20151203-00/?p=92261#comment-1217201">
			December 4, 2015 at 8:52 am</a>		</div>

		<p>@Ender Do you guys not look at the action centre for missed notifications? </p>

		
				</div>
		</li><!-- #comment-## -->
		<li class="comment even thread-even depth-1" id="comment-1217181">
				<div id="div-comment-1217181" class="comment-body">
				<div class="comment-author vcard">
						<cite class="fn">DWalker</cite> <span class="says">says:</span>		</div>
		
		<div class="comment-meta commentmetadata"><a href="https://blogs.msdn.microsoft.com/oldnewthing/20151203-00/?p=92261#comment-1217181">
			December 4, 2015 at 10:19 am</a>		</div>

		<p>It seems, from a pure &quot;computer science&quot; standpoint, that an operating system &quot;could&quot; apply updates without rebooting.</p>
<p>Consider the state of the system, including the layouts of DLLs in memory, process memory, and files on disk (including the pagefile), etc. before applying the updates.</p>
<p>Now consider the state of the system after applying the updates and rebooting.</p>
<p>Now consider an algorithm that could map the first state to the second state &#8212; things in memory need to be moved around, and things on disk need to be moved around. &nbsp;This movement could happen all at once (with a slight delay to all other processes which are suspended, to let the update service move everything around atomically) but it could take less time than rebooting.</p>
<p>Surely this is *doable* without a reboot; such an algorithm should be create-able. &nbsp;Although the complexity might be overwhelming.</p>
<div class="post">[<em>You underestimate the complexity of this. Suppose a structure grows by 4 bytes. Every instance of this structure needs to be identified, and possibly relocated if the four bytes immediately after the structure are being used for something else. Now you need to update all references to the relocated structure. Some of those references may be in other processes (hiding behind an RPC connection); other references may be in encoded pointers (so a straight memory scan won&#39;t find them); you have false positives if an integer in memory just happens to be equal to the old address by coincidence. To do this properly, you need cooperation from the compiler so it can tell you at any time &quot;Please tell me where all pointers can be found&quot;, which could be quite nonobvious after optimization; plus you need cooperation from RPC, debuggers, anybody who uses ReadProcessMemory&#8230; -Raymond</em>]</div>

		
				</div>
		</li><!-- #comment-## -->
		<li class="comment odd alt thread-odd thread-alt depth-1" id="comment-1217141">
				<div id="div-comment-1217141" class="comment-body">
				<div class="comment-author vcard">
						<cite class="fn">Richard</cite> <span class="says">says:</span>		</div>
		
		<div class="comment-meta commentmetadata"><a href="https://blogs.msdn.microsoft.com/oldnewthing/20151203-00/?p=92261#comment-1217141">
			December 4, 2015 at 11:01 am</a>		</div>

		<p>@DWalker:</p>
<p>Microsoft calls this Hotpatching: &nbsp;<a rel="nofollow" target="_new" href="https://technet.microsoft.com/en-us/library/cc787843%28v=ws.10%29.aspx">technet.microsoft.com/&#8230;/cc787843%28v=ws.10%29.aspx</a></p>

		
				</div>
		</li><!-- #comment-## -->
		<li class="comment even thread-even depth-1" id="comment-1217121">
				<div id="div-comment-1217121" class="comment-body">
				<div class="comment-author vcard">
						<cite class="fn">ch</cite> <span class="says">says:</span>		</div>
		
		<div class="comment-meta commentmetadata"><a href="https://blogs.msdn.microsoft.com/oldnewthing/20151203-00/?p=92261#comment-1217121">
			December 4, 2015 at 11:36 am</a>		</div>

		<p>@DWalker:</p>
<p>It&#39;s impossble in theory. Some of the relevant state may be unreachable by the update process (e.g. something has switched from using protocol X version N to protocol X version N+1 or to protocol Y and before the update there&#39;s a connection open to a remote server).</p>
<p>Even in cases where it&#39;s all local, the change can be impossibly complex. Consider a library which switches from reading a file a chunk at a time to mapping it into memory. If it is partway through the operation there may be a mapping between the states, but it would be overwhelmingly difficult to apply it. What if the file currently open is too big to map? If the updated code had been run maybe the file would have been opened before the address space got to fragmented to have space for it, so to map the state you need to do garbage-collection like operation which can move objects around even though the code was not written to support this. Or maybe the updated code would have rejected the file as being too big, so to reach the mapped state you need to go back in time to pretend the file was never opened, find and modify all the logging servers which currently record that the file open succeeded and change those records to show that it failed.</p>

		
				</div>
		</li><!-- #comment-## -->
		<li class="comment byuser comment-author-mngoldeneagle odd alt thread-odd thread-alt depth-1" id="comment-1217111">
				<div id="div-comment-1217111" class="comment-body">
				<div class="comment-author vcard">
						<cite class="fn"><a href='https://social.msdn.microsoft.com/profile/MNGoldenEagle' rel='external nofollow' class='url'>MNGoldenEagle</a></cite> <span class="says">says:</span>		</div>
		
		<div class="comment-meta commentmetadata"><a href="https://blogs.msdn.microsoft.com/oldnewthing/20151203-00/?p=92261#comment-1217111">
			December 4, 2015 at 1:25 pm</a>		</div>

		<p>@DWalker: You could do this inside the kernel itself, sure, as long as device drivers aren&#39;t impacted by the update (or alternatively, the affected device drivers are taken offline and then brought back online once the hotpatch is applied). &nbsp;Basically as long as you can take any affected processes, shut them down, apply the patch, and bring them back online, then you can avoid a full system reboot. &nbsp;You could even feasibly make this smart enough to identify which update will impact which processes/services/drivers/whatever. &nbsp;It&#39;s of questionable benefit, though, since the odds that you can keep your program running while critical libraries are updated is pretty unlikely.</p>
<p>I am curious how much of this impacts Linux-land; I know they have kernel-hotpatching, but honestly the kernel&#39;s the least interesting piece compared to the servers and daemons that need to be kept up-to-date. If an update only impacts some running services and not any user applications, is Windows Update smart enough to shut down the service and restart it, thus avoiding a reboot?</p>
<div class="post">[<em>But what if a user application tries to communicate with the service while it is temporarily shut down? &quot;Shortcuts will not track properly for the next 5 minutes while we update the link tracking service. <a href="http://blogs.msdn.com/b/oldnewthing/archive/2009/10/08/9904647.aspx">Mahalo</a>.&quot; -Raymond</em>]</div>

		
				</div>
		</li><!-- #comment-## -->
		<li class="comment even thread-even depth-1" id="comment-1217101">
				<div id="div-comment-1217101" class="comment-body">
				<div class="comment-author vcard">
						<cite class="fn">Joshua</cite> <span class="says">says:</span>		</div>
		
		<div class="comment-meta commentmetadata"><a href="https://blogs.msdn.microsoft.com/oldnewthing/20151203-00/?p=92261#comment-1217101">
			December 4, 2015 at 4:23 pm</a>		</div>

		<p>[You underestimate the complexity of this&#8230;.]</p>
<p>I only want to do it for security updates. Security updates rarely change data structures. On a high reliability device non-security updates aren&#39;t going to be applied at all. A good effort should yield 90-99% patched w/o reboot (the ones that didn&#39;t change data structures) and that&#39;s good enough.</p>
<p>@MNGoldenEagle: Most Linux services (X not included) can be restarted while they are running, and all of them can have their backing binaries replaced before they are restarted. If we&#39;re willing to use SO_REUSEADDR than we change half of those to &quot;services that can be restarted before they are stopped&quot;. So, it&#39;s more like &quot;Shortcuts will not track properly for the next 5 milliseconds while we update the link tracking service. Mahalo.&quot;</p>
<p>@Brian: My claim is far stronger. In fact I can only pull off the hard-realtime on a Linux box by accident (because they implemented ramfs for completely unrelated reasons). I can avoid the paging system libraries by static linking, something Windows does not provide. Flash-restart critical processes to apply security updates is hard but not impossible (sysvinit does it). The hard realtime program would have to wait for idle time, safe the hardware, then reset itself.</p>

		
				</div>
		</li><!-- #comment-## -->
		<li class="comment byuser comment-author-fleet-command odd alt thread-odd thread-alt depth-1" id="comment-1217041">
				<div id="div-comment-1217041" class="comment-body">
				<div class="comment-author vcard">
						<cite class="fn"><a href='https://social.msdn.microsoft.com/profile/Fleet+Command' rel='external nofollow' class='url'>Fleet Command</a></cite> <span class="says">says:</span>		</div>
		
		<div class="comment-meta commentmetadata"><a href="https://blogs.msdn.microsoft.com/oldnewthing/20151203-00/?p=92261#comment-1217041">
			December 4, 2015 at 10:33 pm</a>		</div>

		<p>&quot;If you postpone the reboot, then you leave the computer in a nonstandard configuration wherein an update is partially-installed, and that nonstandard configuration may compromise the machine&#39;s critical function.&quot;</p>
<p>That is incorrect on Windows Vista and later. </p>

		
				</div>
		</li><!-- #comment-## -->
		<li class="comment even thread-even depth-1" id="comment-1216971">
				<div id="div-comment-1216971" class="comment-body">
				<div class="comment-author vcard">
						<cite class="fn">Erkin Alp G&#252;ney</cite> <span class="says">says:</span>		</div>
		
		<div class="comment-meta commentmetadata"><a href="https://blogs.msdn.microsoft.com/oldnewthing/20151203-00/?p=92261#comment-1216971">
			December 6, 2015 at 2:49 am</a>		</div>

		<p>&gt; But what if a user application tries to communicate with the service while it is temporarily shut down? &quot;Shortcuts will not track properly for the next 5 minutes while we update the link tracking service. Mahalo.&quot;</p>
<p>@Raymond: Block on the call if a component is going to be added or replaced, fail immediately if said component or API is removed.</p>

		
				</div>
		</li><!-- #comment-## -->
		<li class="comment odd alt thread-odd thread-alt depth-1" id="comment-1216961">
				<div id="div-comment-1216961" class="comment-body">
				<div class="comment-author vcard">
						<cite class="fn">640k</cite> <span class="says">says:</span>		</div>
		
		<div class="comment-meta commentmetadata"><a href="https://blogs.msdn.microsoft.com/oldnewthing/20151203-00/?p=92261#comment-1216961">
			December 6, 2015 at 10:17 am</a>		</div>

		<p>@Raymond: &quot;You underestimate the complexity of this&#8230;&quot;</p>
<p>It&#39;s complicated, but it&#39;s not impossible. You have to set restrictions of what can be patched in-memory, not all imaginable software can be patched. Before Chrome, people assumed it was impossible to patch web browsers in-memory. IE/edge still doesn&#39;t support it. Why?</p>
<p>@Raymond: &quot;To do this properly, you need cooperation from the compiler&quot;</p>
<p>Yes, you need to cooperate with your visual studio coworkers. That might actually be the biggest hurdle. But I assume it would be more easy to patch your customers to death than to solve this.</p>

		
				</div>
		</li><!-- #comment-## -->
		<li class="comment even thread-even depth-1" id="comment-1217511">
				<div id="div-comment-1217511" class="comment-body">
				<div class="comment-author vcard">
						<cite class="fn">ender</cite> <span class="says">says:</span>		</div>
		
		<div class="comment-meta commentmetadata"><a href="https://blogs.msdn.microsoft.com/oldnewthing/20151203-00/?p=92261#comment-1217511">
			December 7, 2015 at 1:15 am</a>		</div>

		<p>@Entegy: how can I look at the action centre if I&#39;m not at the machine? Also, in Windows 7, Explorer could fairly reliably detect when I was not at the computer, and left the balloons shown until I returned (specifically, &quot;Updates are ready for your computer&quot; would greet me when I unlocked my workstation, regardless of when it detected new updates &#8211; why doesn&#39;t this happen any more, or at least why doesn&#39;t action centre pop up automatically if there are unread notifications instead of expecting me to click it every time I get back to the machine?).</p>

		
				</div>
		</li><!-- #comment-## -->
		<li class="comment odd alt thread-odd thread-alt depth-1" id="comment-1217501">
				<div id="div-comment-1217501" class="comment-body">
				<div class="comment-author vcard">
						<cite class="fn">Viila</cite> <span class="says">says:</span>		</div>
		
		<div class="comment-meta commentmetadata"><a href="https://blogs.msdn.microsoft.com/oldnewthing/20151203-00/?p=92261#comment-1217501">
			December 7, 2015 at 2:03 am</a>		</div>

		<p>@Erkin Alp Güney: &quot;fail immediately if said component or API is removed.&quot;</p>
<p>What if the API can not signal failure? Or explicitly can not fail in ordinary circumstances so no program checks the return value?</p>

		
				</div>
		</li><!-- #comment-## -->
		<li class="comment even thread-even depth-1" id="comment-1217481">
				<div id="div-comment-1217481" class="comment-body">
				<div class="comment-author vcard">
						<cite class="fn">Joshua</cite> <span class="says">says:</span>		</div>
		
		<div class="comment-meta commentmetadata"><a href="https://blogs.msdn.microsoft.com/oldnewthing/20151203-00/?p=92261#comment-1217481">
			December 7, 2015 at 8:13 am</a>		</div>

		<p>@Viila: Than the update violates the rules whether it&#39;s installed by hotpatch or not.</p>

		
				</div>
		</li><!-- #comment-## -->
		<li class="comment odd alt thread-odd thread-alt depth-1" id="comment-1217451">
				<div id="div-comment-1217451" class="comment-body">
				<div class="comment-author vcard">
						<cite class="fn">Max</cite> <span class="says">says:</span>		</div>
		
		<div class="comment-meta commentmetadata"><a href="https://blogs.msdn.microsoft.com/oldnewthing/20151203-00/?p=92261#comment-1217451">
			December 7, 2015 at 8:55 am</a>		</div>

		<p>One thing to keep in mind when talking about updates is the sheer age of the architecture. Windows NT was built in the era before downloading updates from the internet anytime was a commonplace thing. In those days, you bought a service pack on a set of floppy disks, instead of pulling down dozens or hundreds of megabytes of updates every month via your always-connected broadband internet. Windows Update was a sad, sorry show in the 90s. Of course, Linux is old as well, but different architectural decisions made long ago led to an OS that turned out to be much more suited to updating without interruption due to its modularity and such. </p>
<p>It&#39;s not really a matter of smart decisions vs dumb decisions; the Windows model made perfect sense at the time, and I don&#39;t think too many programmers of that era could have conceived of the cheap-and-easy update culture modern-day computing has developed. It&#39;s just the nature of being hamstrung by decisions that were made twenty years ago &#8211; sometimes it turns out well, sometimes it doesn&#39;t.</p>

		
				</div>
		</li><!-- #comment-## -->
		<li class="comment even thread-even depth-1" id="comment-1217441">
				<div id="div-comment-1217441" class="comment-body">
				<div class="comment-author vcard">
						<cite class="fn">Mark Phaedrus</cite> <span class="says">says:</span>		</div>
		
		<div class="comment-meta commentmetadata"><a href="https://blogs.msdn.microsoft.com/oldnewthing/20151203-00/?p=92261#comment-1217441">
			December 7, 2015 at 8:59 am</a>		</div>

		<p>My thanks to the esteemed Raymond Chen for the brief moment of MSDN fame.</p>
<p>Let me answer a question that several folks have raised (both in the comments and offline): &#39;Hasn&#39;t the problem of updates being partially installed until the next reboot already been solved by changes in Windows?&#39;</p>
<p>This is, to a large extent, true. Modern versions of Windows use Component-Based Servicing (CBS). This technology makes sure that new Windows components, and new versions of existing components, are installed atomically. In other words, if it is possible to install or update a component without a reboot, CBS does so. If it is not possible (because one or more files are in use, or because the component requires more complicated setup), then the entire installation of the component is automatically suspended until the next reboot.</p>
<p>So this means that the problem described in this blog post is gone, right? Absolutely not, for at least two reasons, which I&#39;ll have to give in a second comment due to space limitations.</p>

		
				</div>
		</li><!-- #comment-## -->
		<li class="comment odd alt thread-odd thread-alt depth-1 parent" id="comment-1217431">
				<div id="div-comment-1217431" class="comment-body">
				<div class="comment-author vcard">
						<cite class="fn">Mark Phaedrus</cite> <span class="says">says:</span>		</div>
		
		<div class="comment-meta commentmetadata"><a href="https://blogs.msdn.microsoft.com/oldnewthing/20151203-00/?p=92261#comment-1217431">
			December 7, 2015 at 8:59 am</a>		</div>

		<p>First, not all updates distributed through Windows Update/Microsoft Update are purely CBS-based. There are a variety of different types of updates (drivers, Office updates, etc.), each of which may have different installation behaviors. For example, there are still a few troublesome drivers that do not behave normally until the next reboot. And from the Windows Update perspective, there is a class of updates called &quot;command-line updates&quot; &#8212; updates that have unusual needs, and so cannot be published in the usual standardized formats. Command-line updates can still work in whatever way they want, just like the good old days of UPDATE.EXE. And that means that command-line updates may still be subject to the problem.</p>
<p>To summarize: Most updates no longer create an unusual machine state that requires a reboot to resolve. There are still a few that do. In an ordinary consumer environment, the remaining problem is small enough to be ignored (or at least small enough that there are lots of other things to concentrate on fixing first). But in an environment where The Machine Simply Must Work, it&#39;s still an unacceptable risk. And so the best practice for these environments is still assuming that any update that requires a reboot to complete should have that reboot performed as soon as possible.</p>
<p>Second, even setting the &quot;does the update do the right thing before the reboot?&quot; problem aside, CBS itself creates another problem in this scenario. Since many Windows updates wind up getting their processing delayed until the reboot, that reboot itself can take longer (since all those pending operations then get performed). And in an environment where The Machine Simply Must Work, this means that the consequences of an accidental/unplanned reboot can be even worse. So again, in this environment, it&#39;s important to ensure that Windows Update never initiates a reboot on its own. And since Windows Update will sometimes initiate reboots on its own when it&#39;s set to install updates automatically, this means that the best practice for these environments is still the practice described in the blog &#8212; set Automatic Updates to not install updates automatically, and use your own code to install updates and reboot at the correct times and with the proper user notification.</p>

		
				</div>
		<ol class="children">
		<li class="comment byuser comment-author-yuhong-bao even depth-2" id="comment-1217571">
				<div id="div-comment-1217571" class="comment-body">
				<div class="comment-author vcard">
						<cite class="fn"><a href='https://social.msdn.microsoft.com/profile/Yuhong+Bao' rel='external nofollow' class='url'>Yuhong Bao</a></cite> <span class="says">says:</span>		</div>
		
		<div class="comment-meta commentmetadata"><a href="https://blogs.msdn.microsoft.com/oldnewthing/20151203-00/?p=92261#comment-1217571">
			December 7, 2015 at 9:46 pm</a>		</div>

		<p>I think one case even made it into the news: <a href="http://arstechnica.com/business/2015/03/german-pro-basketball-team-relegated-to-lower-division-due-to-windows-update/" rel="nofollow">http://arstechnica.com/business/2015/03/german-pro-basketball-team-relegated-to-lower-division-due-to-windows-update/</a></p>

		
				</div>
		</li><!-- #comment-## -->
</ol><!-- .children -->
</li><!-- #comment-## -->
		<li class="comment odd alt thread-even depth-1" id="comment-1217361">
				<div id="div-comment-1217361" class="comment-body">
				<div class="comment-author vcard">
						<cite class="fn">Mark Phaedrus (WU)</cite> <span class="says">says:</span>		</div>
		
		<div class="comment-meta commentmetadata"><a href="https://blogs.msdn.microsoft.com/oldnewthing/20151203-00/?p=92261#comment-1217361">
			December 7, 2015 at 11:48 am</a>		</div>

		<p>To reiterate earlier caveats, when I talk about situations where The Machine Simply Must Work, I naturally presume you&#39;re not talking about life-critical medical applications, because Windows is not for life-critical applications, as the esteemed attorneys who hand-crafted the Windows EULA from artisanal Unicode characters will happily point out.</p>
<p>To give my own favorite example of a non-medical situation where The Machine Simply Must Work, as well as one of the more uncomfortable moments of my Microsoft career: There was an internal developer conference going on at the Microsoft Executive Briefing Center, a very nice building filled with conference rooms normally used by the grand poohbahs of the Microsoft organization, and occasionally used for gatherings like this one. Throughout the building there are large displays helpfully pointing out which meetings are going on in which rooms at which times. And on this occasion, with numerous grand poohbahs on hand as well as large portions of the Windows Update team, all those displays were showing the old &quot;Your machine needs to reboot&quot; prompt we all knew and loved from Windows 7, with the pre-reboot countdown timer inexorably rolling down towards zero.</p>
<p>If the role of an internal developer conference is to encourage discussions among teams, then that one certainly succeeded. Because discussions most definitely ensued.</p>

		
				</div>
		</li><!-- #comment-## -->
		<li class="comment even thread-odd thread-alt depth-1" id="comment-1217341">
				<div id="div-comment-1217341" class="comment-body">
				<div class="comment-author vcard">
						<cite class="fn">WinUser</cite> <span class="says">says:</span>		</div>
		
		<div class="comment-meta commentmetadata"><a href="https://blogs.msdn.microsoft.com/oldnewthing/20151203-00/?p=92261#comment-1217341">
			December 7, 2015 at 12:37 pm</a>		</div>

		<p>It&#39;s not just Windows Updates that would require a reboot.</p>
<p># The following Test-Path checks assume that only the OS has control over those keys.</p>
<p># When all pending operations have been completed after system start, the OS deletes the keys.</p>
<p>$PendingComponentBasedServicing = Test-Path &#39;HKLM:SOFTWAREMicrosoftWindowsCurrentVersionComponent Based ServicingRebootPending&#39;</p>
<p>$PendingWindowsUpdate = Test-Path &#39;HKLM:SOFTWAREMicrosoftWindowsCurrentVersionWindowsUpdateAuto UpdateRebootRequired&#39;</p>
<p>$PendingFileRename = (Get-ItemProperty &#39;HKLM:SYSTEMCurrentControlSetControlSession Manager&#39;).PendingFileRenameOperations.Length -gt 0</p>
<p># See <a rel="nofollow" target="_new" href="https://msdn.microsoft.com/en-us/library/windows/desktop/dd392286.aspx">msdn.microsoft.com/&#8230;/dd392286.aspx</a> for details about the use of the SETUPEXECUTE key.</p>
<p>$PendingSetupExecute = (Get-ItemProperty &#39;HKLM:SYSTEMCurrentControlSetControlSession Manager&#39;).SETUPEXECUTE.Length -gt 0</p>
<p># Check if the name of the computer was changed.</p>
<p>$PendingComputerRename = (Get-ItemProperty &#39;HKLM:SYSTEMCurrentControlSetControlComputerNameActiveComputerName&#39;).ComputerName -ne (Get-ItemProperty &#39;HKLM:SYSTEMCurrentControlSetControlComputerNameComputerName&#39;).ComputerName</p>
<p>$ResultsTable = @{}</p>
<p>$ResultsTable.Add(&quot;Component Based Servicing&quot;, $PendingComponentBasedServicing)</p>
<p>$ResultsTable.Add(&quot;Windows Update&quot;, $PendingWindowsUpdate)</p>
<p>$ResultsTable.Add(&quot;Pending File Rename&quot;, $PendingFileRename)</p>
<p>$ResultsTable.Add(&quot;Pending Setup Execute&quot;, $PendingSetupExecute)</p>
<p>$ResultsTable.Add(&quot;Computer Rename&quot;, $PendingComputerRename)</p>
<p># Show table</p>
<p>$ResultsTable</p>
<p>if ($ResultsTable.ContainsValue($true))</p>
<p>{</p>
<p> &#39;Reboot required&#39;</p>
<p>}</p>
<p>else</p>
<p>{</p>
<p> &#39;No reboot required&#39;</p>
<p>}</p>

		
				</div>
		</li><!-- #comment-## -->
		<li class="comment odd alt thread-even depth-1" id="comment-1217321">
				<div id="div-comment-1217321" class="comment-body">
				<div class="comment-author vcard">
						<cite class="fn">Mark Phaedrus (WU)</cite> <span class="says">says:</span>		</div>
		
		<div class="comment-meta commentmetadata"><a href="https://blogs.msdn.microsoft.com/oldnewthing/20151203-00/?p=92261#comment-1217321">
			December 7, 2015 at 1:55 pm</a>		</div>

		<p>Without commenting on any other aspects of the code above, I will say that HKLMSOFTWAREMicrosoftWindowsCurrentVersionWindowsUpdateAutoUpdateRebootRequired is an undocumented registry item. Like other undocumented registry items, its behavior is subject to change without notice. (The keen observer of detail will notice that a number of Windows Update-related undocumented registry values vanished entirely, and others changed their functions, in Windows 10; so this is not merely a theoretical concern.) The correct, documented, supported way of determining whether Windows Update needs to reboot the computer is the ISystemInformation::RebootRequired API documented on MSDN.</p>

		
				</div>
		</li><!-- #comment-## -->
		<li class="comment even thread-odd thread-alt depth-1" id="comment-1217311">
				<div id="div-comment-1217311" class="comment-body">
				<div class="comment-author vcard">
						<cite class="fn">DWalker</cite> <span class="says">says:</span>		</div>
		
		<div class="comment-meta commentmetadata"><a href="https://blogs.msdn.microsoft.com/oldnewthing/20151203-00/?p=92261#comment-1217311">
			December 7, 2015 at 2:08 pm</a>		</div>

		<p>Interesting! &nbsp;I thought it was possible in theory, but incredibly complex. &nbsp;(I don&#39;t think I underestimated the complexity; it&#39;s huge.) &nbsp;But per the later comments, it may be impossible in theory. &nbsp;Thanks for the comments!</p>

		
				</div>
		</li><!-- #comment-## -->
		<li class="comment odd alt thread-even depth-1" id="comment-1217541">
				<div id="div-comment-1217541" class="comment-body">
				<div class="comment-author vcard">
						<cite class="fn"><a href='http://harryjohnston.wordpress.com' rel='external nofollow' class='url'>Harry Johnston</a></cite> <span class="says">says:</span>		</div>
		
		<div class="comment-meta commentmetadata"><a href="https://blogs.msdn.microsoft.com/oldnewthing/20151203-00/?p=92261#comment-1217541">
			December 7, 2015 at 6:48 pm</a>		</div>

		<p>@Darran: on my home machine, I have WU configured as you describe.  It doesn&#8217;t seem to work.  At work, we have group policy set to prevent the machines from rebooting automatically.  That still seems to work, except that the user never seems to get any notification that the update is pending.</p>
<p>If the notification is in the Action Center, that might explain it &#8211; I&#8217;ll check next time I visit the test machine.  (It doesn&#8217;t solve the problem though, because Action Center notifications are too well hidden.)</p>

		
				</div>
		</li><!-- #comment-## -->
		<li class="comment even thread-odd thread-alt depth-1" id="comment-1217621">
				<div id="div-comment-1217621" class="comment-body">
				<div class="comment-author vcard">
						<cite class="fn">WinUser</cite> <span class="says">says:</span>		</div>
		
		<div class="comment-meta commentmetadata"><a href="https://blogs.msdn.microsoft.com/oldnewthing/20151203-00/?p=92261#comment-1217621">
			December 8, 2015 at 3:35 am</a>		</div>

		<p>Mark,</p>
<p>$PendingWindowsUpdate = (New-Object -ComObject Microsoft.Update.SystemInfo).RebootRequired</p>
<p>Cheers</p>

		
				</div>
		</li><!-- #comment-## -->
		<li class="comment byuser comment-author-fleet-command odd alt thread-even depth-1" id="comment-1217821">
				<div id="div-comment-1217821" class="comment-body">
				<div class="comment-author vcard">
						<cite class="fn"><a href='https://social.msdn.microsoft.com/profile/Fleet+Command' rel='external nofollow' class='url'>Fleet Command</a></cite> <span class="says">says:</span>		</div>
		
		<div class="comment-meta commentmetadata"><a href="https://blogs.msdn.microsoft.com/oldnewthing/20151203-00/?p=92261#comment-1217821">
			December 8, 2015 at 7:00 pm</a>		</div>

		<p>&#8220;Set Automatic Updates so it does not install updates immediately. Either disable it, or set it to download updates without installing them.&#8221;</p>
<p>With Windows 10, this is no longer possible.</p>

		
				</div>
		</li><!-- #comment-## -->
		</ol><!-- .comment-list -->

		<div class="navigation pagination">
					</div>

	
			<p class="no-comments">Comments are closed.</p>
<!-- COMMENTS END -->
</div></td></tr></table>

</body>
</html>
<br/><div class="disclaimer">
*DISCLAIMER: I DO NOT OWN THIS CONTENT. If you are the owner and would like it removed, please
<a target="_blank" href="/contact.htm">contact me</a>.
The content herein is an archived reproduction of entries from
Raymond Chen's "Old New Thing" Blog (most recent link is <a target="_blank" href="https://devblogs.microsoft.com/oldnewthing/">here</a>).
It may have slight formatting modifications for consistency and to improve readability.
<br/><br/>
WHY DID I DUPLICATE THIS CONTENT HERE?
Let me first say this site has never had anything to sell and has never shown ads of any kind. I have nothing monetarily to gain by duplicating content here.
Because I had made my own local copy of this content throughout the years, for ease of using tools like grep, I decided to put it online after I discovered
some of the original content previously and publicly available, had disappeared approximately early to mid 2019.
At the same time, I present the content in an easily accessible theme-agnostic way.
<br/><br/>
The information provided by Raymond's blog is, for all practical purposes, more authoritative on Windows Development than Microsoft's
own MSDN documentation and should be considered supplemental reading to that documentation. The wealth of missing details
provided by this blog that Microsoft could not or did not document about Windows over the years is vital enough, many would agree an online "backup" of these details
is a necessary endeavor. Specifics include:<br/>
<ul>
    <li>
        A "redesign" after 2019 erased thousands of user's comments from previous years. As many have stated, the comments are nearly as important as the postings themselves.
        The archived copies of the postings contained here retain the original comments.
    </li>
    <li>
        The blog has changed domains many times and the urls have otherwise been under constant change since 2003.
        Even when proper redirection has been set up for those links, redirection only works for a limited period of time.
        For example, all of the internal blog links that were valid in early 2019, were broken by 2020 without proper redirection.
    </li>
    <li>
        The blog has been under constant re-design and re-theming since its inception.
        It is downright irritating to deal with a bogged-down site experience as the result of the latest visual themes designed for cell-phone browsers.
        As of this writing, it is cumbersome to navigate titles with only 10 entries per page.
        While it is nice that the official site has a search feature, searching using this index (with all titles on a single page) is much quicker (CTRL-F in most browsers).
    </li>
</ul>
</div><br/>
&lt;-- Back to <a href="index.htm">Old New Thing Archive Index</a>

