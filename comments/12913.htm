<table class="commenttable" cellspacing="0" cellpadding="0"><tr><td><div class="commentdiv"><div class="commentdivhdr">
<!-- COMMENTS START -->
Comments (30)	</div>

	
			<div class="navigation pagination clear-both">
					</div>

		<ol class="comment-list">
					<li class="comment even thread-even depth-1" id="comment-859983">
				<div id="div-comment-859983" class="comment-body">
				<div class="comment-author vcard">
						<cite class="fn">Marquess</cite> <span class="says">says:</span>		</div>
		
		<div class="comment-meta commentmetadata"><a href="https://blogs.msdn.microsoft.com/oldnewthing/20100909-00/?p=12913#comment-859983">
			September 9, 2010 at 7:24 am</a>		</div>

		<p>That last link is disconcerting. That guy is a Microsoft employee, right? And he casually recommends to turn on a potentially dangerous setting without explaining the risks?</p>
<p>That explains a lot.</p>
<div class="post">[<i>I think you&#39;re reading too much into the identity of the person&#39;s employer. It&#39;s not like he&#39;s providing official technical support. It&#39;s just a blog. There&#39;s a lot of bad information in blogs. Including this one. -Raymond</i>]</div>

		
				</div>
		</li><!-- #comment-## -->
		<li class="comment byuser comment-author-maurits odd alt thread-odd thread-alt depth-1" id="comment-859993">
				<div id="div-comment-859993" class="comment-body">
				<div class="comment-author vcard">
						<cite class="fn"><a href='https://social.msdn.microsoft.com/profile/Maurits+%5BMSFT%5D' rel='external nofollow' class='url'>Maurits [MSFT]</a></cite> <span class="says">says:</span>		</div>
		
		<div class="comment-meta commentmetadata"><a href="https://blogs.msdn.microsoft.com/oldnewthing/20100909-00/?p=12913#comment-859993">
			September 9, 2010 at 8:09 am</a>		</div>

		<p>The transactional sword cuts both ways. &nbsp;If you&#39;re writing a database engine, then you may want to be really-super-positive that the data hit the disk before you report success back up the chain, so you would want to flush as far down as you could.</p>
<p>On the other hand, when I was setting up an SMTP anti-spam gateway, my permanent data store was the downstream SMTP server; so, far from flushing disk writes, I actually mounted my mail spool directory in RAM to increase performance. &nbsp;Power loss at any point would just result in a dropped SMTP connection, with no consummation of the transaction; in this case transactionality allows me to flush less.</p>

		
				</div>
		</li><!-- #comment-## -->
		<li class="comment even thread-even depth-1" id="comment-860003">
				<div id="div-comment-860003" class="comment-body">
				<div class="comment-author vcard">
						<cite class="fn">Someone You Know</cite> <span class="says">says:</span>		</div>
		
		<div class="comment-meta commentmetadata"><a href="https://blogs.msdn.microsoft.com/oldnewthing/20100909-00/?p=12913#comment-860003">
			September 9, 2010 at 8:37 am</a>		</div>

		<p>I find myself wondering if there are hard drives out there that ignore that command to flush their internal RAM, and lie to the operating system that they&#39;ve done it. I can&#39;t immediately think of why the drive would want to do that, but it seems like the sort of thing we hear about on this blog occasionally — like that video device that lied about which graphics capabilities it supported.</p>

		
				</div>
		</li><!-- #comment-## -->
		<li class="comment odd alt thread-odd thread-alt depth-1" id="comment-860013">
				<div id="div-comment-860013" class="comment-body">
				<div class="comment-author vcard">
						<cite class="fn">Adrian</cite> <span class="says">says:</span>		</div>
		
		<div class="comment-meta commentmetadata"><a href="https://blogs.msdn.microsoft.com/oldnewthing/20100909-00/?p=12913#comment-860013">
			September 9, 2010 at 8:43 am</a>		</div>

		<p>I used to work on hard drive firmware. &nbsp;Some hard drives lie even when you send the &quot;and flush your RAM cache, too&quot; message. &nbsp;If you have one of these drives, and you&#39;re trying to be transactional, you&#39;re wasting your effort.</p>

		
				</div>
		</li><!-- #comment-## -->
		<li class="comment even thread-even depth-1" id="comment-860023">
				<div id="div-comment-860023" class="comment-body">
				<div class="comment-author vcard">
						<cite class="fn">Arthur Strutzenberg</cite> <span class="says">says:</span>		</div>
		
		<div class="comment-meta commentmetadata"><a href="https://blogs.msdn.microsoft.com/oldnewthing/20100909-00/?p=12913#comment-860023">
			September 9, 2010 at 8:55 am</a>		</div>

		<p>What would happen if the machine in question was a virtual machine(hyperV base)? &nbsp;(and the &quot;drive&quot; is a vhd file)? &nbsp;</p>

		
				</div>
		</li><!-- #comment-## -->
		<li class="comment odd alt thread-odd thread-alt depth-1" id="comment-860053">
				<div id="div-comment-860053" class="comment-body">
				<div class="comment-author vcard">
						<cite class="fn">Mystic</cite> <span class="says">says:</span>		</div>
		
		<div class="comment-meta commentmetadata"><a href="https://blogs.msdn.microsoft.com/oldnewthing/20100909-00/?p=12913#comment-860053">
			September 9, 2010 at 9:47 am</a>		</div>

		<p>What about improper shutdown due to the system hanging? This happens to each and every computer every once in a year or so. Should it be enabled then?</p>
<div class="post">[<i>Not sure what you&#39;re asking about here. If the system hangs, then there&#39;s plenty of time for those buffers to get flushed out since the hard drive still has power. -Raymond</i>]</div>

		
				</div>
		</li><!-- #comment-## -->
		<li class="comment even thread-even depth-1" id="comment-860063">
				<div id="div-comment-860063" class="comment-body">
				<div class="comment-author vcard">
						<cite class="fn">ERock</cite> <span class="says">says:</span>		</div>
		
		<div class="comment-meta commentmetadata"><a href="https://blogs.msdn.microsoft.com/oldnewthing/20100909-00/?p=12913#comment-860063">
			September 9, 2010 at 9:56 am</a>		</div>

		<p>@Adrian:</p>
<p>Would you happen to be able to provide a source that names names and lists offenders? This disturbs me greatly&#8230; I would hope for the price overhead of enterprise hard drives that they follow the Operating System / RAID controller&#39;s orders.</p>

		
				</div>
		</li><!-- #comment-## -->
		<li class="comment odd alt thread-odd thread-alt depth-1" id="comment-860073">
				<div id="div-comment-860073" class="comment-body">
				<div class="comment-author vcard">
						<cite class="fn">Aram Hăvărneanu</cite> <span class="says">says:</span>		</div>
		
		<div class="comment-meta commentmetadata"><a href="https://blogs.msdn.microsoft.com/oldnewthing/20100909-00/?p=12913#comment-860073">
			September 9, 2010 at 10:53 am</a>		</div>

		<p>~Someone You Know: &quot;I find myself wondering if there are hard drives out there that ignore that command to flush their internal RAM, and lie to the operating system that they&#39;ve done it.&quot;</p>
<p>A lot of consumer-grade drives do this, it&#39;s one of the reasons Apple dropped ZFS support in Snow Leopard. ZFS require the flush command to truly do what it claims it does in order to guarantee transactional consistency (okay, all file systems require this, but because of ZFS architecture this problem was much more severe). A lot of consumer grade hard drives or USB memory sticks fail to implement this command properly.</p>
<p>For server-grade hardware this problem doesn&#39;t not exist, therefore SUN/Oracle can safely use ZFS on their servers.</p>

		
				</div>
		</li><!-- #comment-## -->
		<li class="comment even thread-even depth-1" id="comment-860083">
				<div id="div-comment-860083" class="comment-body">
				<div class="comment-author vcard">
						<cite class="fn">Alexandre Grigoriev</cite> <span class="says">says:</span>		</div>
		
		<div class="comment-meta commentmetadata"><a href="https://blogs.msdn.microsoft.com/oldnewthing/20100909-00/?p=12913#comment-860083">
			September 9, 2010 at 11:01 am</a>		</div>

		<p>In the old Windows98 days, there was a problem with IDE hard drives from Three Letter Name company, that even warranted a hotfix from Microsoft. The drives in question didn&#39;t flush their cache before system powerdown soon enough. I suspect they ignored the flush command altogether.</p>

		
				</div>
		</li><!-- #comment-## -->
		<li class="comment odd alt thread-odd thread-alt depth-1" id="comment-860103">
				<div id="div-comment-860103" class="comment-body">
				<div class="comment-author vcard">
						<cite class="fn">Anon</cite> <span class="says">says:</span>		</div>
		
		<div class="comment-meta commentmetadata"><a href="https://blogs.msdn.microsoft.com/oldnewthing/20100909-00/?p=12913#comment-860103">
			September 9, 2010 at 11:40 am</a>		</div>

		<p>&quot;FlushViewOfFile, FlushFileBuffers, RegFlushKey, they all wait until the data has been confirmed written to the disk.&quot;</p>
<p>The MSDN docs for FlushViewOfFile appear to explicitly state that it does _not_ wait:</p>
<p>&quot;Flushing a range of a mapped view initiates writing of dirty pages within that range to the disk. Dirty pages are those whose contents have changed since the file view was mapped. The FlushViewOfFile &nbsp;function does not flush the file metadata, and it does not wait to return until the changes are flushed from the underlying hardware disk cache and physically written to disk. To flush all the dirty pages plus the metadata for the file and ensure that they are physically written to disk, call FlushViewOfFile and then call the FlushFileBuffers function.&quot;</p>
<div class="post">[<i>Thanks for the correction. Fixed. -Raymond</i>]</div>

		
				</div>
		</li><!-- #comment-## -->
		<li class="comment even thread-even depth-1" id="comment-860113">
				<div id="div-comment-860113" class="comment-body">
				<div class="comment-author vcard">
						<cite class="fn">Lars</cite> <span class="says">says:</span>		</div>
		
		<div class="comment-meta commentmetadata"><a href="https://blogs.msdn.microsoft.com/oldnewthing/20100909-00/?p=12913#comment-860113">
			September 9, 2010 at 12:17 pm</a>		</div>

		<p>Does the Windows Logo device driver certification process ensure that hard drives don&#39;t lie about flushing their RAM cache?</p>

		
				</div>
		</li><!-- #comment-## -->
		<li class="comment odd alt thread-odd thread-alt depth-1" id="comment-860123">
				<div id="div-comment-860123" class="comment-body">
				<div class="comment-author vcard">
						<cite class="fn">Retro</cite> <span class="says">says:</span>		</div>
		
		<div class="comment-meta commentmetadata"><a href="https://blogs.msdn.microsoft.com/oldnewthing/20100909-00/?p=12913#comment-860123">
			September 9, 2010 at 1:14 pm</a>		</div>

		<p>They removed Raymond&#39;s wikipedia entry! :o</p>

		
				</div>
		</li><!-- #comment-## -->
		<li class="comment even thread-even depth-1" id="comment-860133">
				<div id="div-comment-860133" class="comment-body">
				<div class="comment-author vcard">
						<cite class="fn">James Day</cite> <span class="says">says:</span>		</div>
		
		<div class="comment-meta commentmetadata"><a href="https://blogs.msdn.microsoft.com/oldnewthing/20100909-00/?p=12913#comment-860133">
			September 9, 2010 at 1:51 pm</a>		</div>

		<p>@Aram, you&#39;re too optimistic. A few years back I had the dubious pleasure of making Slashdot when two brands of battery-backed RAID controller, one SATA, one SCSI, both failed to have hard drive write buffering off. One used to turn it off but removed the feature because it slowed them down. Expect vendors to cheat and lie about this and test it yourself with real power cycling to prove the data is there.</p>
<p>For data center people, even with a UPS and generator, it&#39;s usually going to be wrong to disable flushing. That&#39;s because someone, someday, is sure to hit the emergency power off button and that&#39;s generally required by fire codes to cut power immediately, Even UPS and generator power. Or a UPS service engineer working on your nice redundant UPS system will turn off the live feed instead of the one being serviced and you&#39;ll have an outage even with an otherwise working UPS. Or one of your power feeds will have a failure and you&#39;ll find your second one responds to the surge by failing as well. That&#39;s both of your redundant power supplies without power. Sad.</p>
<p>Count on losing power at the wrong moment. But maybe I&#39;m just an overly jaded database person&#8230;</p>
<p>Retro, one person had already decided that it should be kept but a second person deleted it without further discussion, breaching Wikipedia policies (and hiding what he&#39;d done from anyone who wasn&#39;t an administrator there) along the way. It may come back sometime, though I assume that Raymond still has a preference that it doesn&#39;t. Raymond is inconveniently close to the border between being sufficiently and insufficiently notable.</p>

		
				</div>
		</li><!-- #comment-## -->
		<li class="comment odd alt thread-odd thread-alt depth-1" id="comment-860153">
				<div id="div-comment-860153" class="comment-body">
				<div class="comment-author vcard">
						<cite class="fn">Poochner</cite> <span class="says">says:</span>		</div>
		
		<div class="comment-meta commentmetadata"><a href="https://blogs.msdn.microsoft.com/oldnewthing/20100909-00/?p=12913#comment-860153">
			September 9, 2010 at 2:01 pm</a>		</div>

		<p>@James Day, or the batteries in the UPS just go bad, and it drops even while mains power is on&#8230;</p>
<p>probably didn&#39;t help that I kept my coffee warmer on it, though.</p>

		
				</div>
		</li><!-- #comment-## -->
		<li class="comment even thread-even depth-1" id="comment-860173">
				<div id="div-comment-860173" class="comment-body">
				<div class="comment-author vcard">
						<cite class="fn">Martin Langhoff</cite> <span class="says">says:</span>		</div>
		
		<div class="comment-meta commentmetadata"><a href="https://blogs.msdn.microsoft.com/oldnewthing/20100909-00/?p=12913#comment-860173">
			September 9, 2010 at 3:56 pm</a>		</div>

		<p>Raymond (or some other competent Windows programmer) &#8212; can you provide some info on &quot;even in the cases in which you actually would want to call [fsync()], there are better ways of doing it nowadays&quot;.</p>
<p>In modern Windows-land, how do you get cost-effective atomicity?</p>
<p>In Linux-land, people who write something like a database use fsync() on their transaction log (hence you need to put that txlog on a separate disk for good performance. People wanting atomicity on file writes/updates write to a tmpfile (in the same fs as the destination file) and then rename/mv the file to it&#39;s final name.</p>
<p>Actually, according to POSIX you must write();close();fsync();rename() for the promise to hold, and if that mountpoint has lots of dirty buffers the sync() will be costly. However, ext3 has forever made write();close();rename() atomic (so you&#39;d get the old file, or the new file, but never a corrupt file) without incurring the heavy fsync() costs. This has turned out to be so efficient and practical that everyone uses it (often without realizing). Without being POSIX, it&#39;s become what a Linux FS is expected to do (see ext4, BtrFS).</p>
<p>(In case it isn&#39;t obvious, this is a Linux programmer asking about Windows low-cost-atomicity tricks. TONT is a great read for someone who&#39;s last seen Windows &gt;10 years ago but is curious as to whether there&#39;s intelligent life in that planet. Thanks Raymond!)</p>

		
				</div>
		</li><!-- #comment-## -->
		<li class="comment byuser comment-author-maurits odd alt thread-odd thread-alt depth-1" id="comment-860183">
				<div id="div-comment-860183" class="comment-body">
				<div class="comment-author vcard">
						<cite class="fn"><a href='https://social.msdn.microsoft.com/profile/Maurits+%5BMSFT%5D' rel='external nofollow' class='url'>Maurits [MSFT]</a></cite> <span class="says">says:</span>		</div>
		
		<div class="comment-meta commentmetadata"><a href="https://blogs.msdn.microsoft.com/oldnewthing/20100909-00/?p=12913#comment-860183">
			September 9, 2010 at 3:59 pm</a>		</div>

		<blockquote><p>
  I&#39;m just an overly jaded database person
</p></blockquote>
<p>It is not possible for a database person to be overly jaded. &nbsp;It is, perhaps, theoretically possible, though I have never seen it, for a database person to one day become /sufficiently/ jaded.</p>

		
				</div>
		</li><!-- #comment-## -->
		<li class="comment even thread-even depth-1" id="comment-860193">
				<div id="div-comment-860193" class="comment-body">
				<div class="comment-author vcard">
						<cite class="fn">AndyC</cite> <span class="says">says:</span>		</div>
		
		<div class="comment-meta commentmetadata"><a href="https://blogs.msdn.microsoft.com/oldnewthing/20100909-00/?p=12913#comment-860193">
			September 9, 2010 at 4:21 pm</a>		</div>

		<p>@Martin Langhoff, I&#39;d presume Raymond is suggesting you probably want to use Transactional NTFS or, at the very least, some other service built on top of the kernel transaction manager.</p>

		
				</div>
		</li><!-- #comment-## -->
		<li class="comment byuser comment-author-matteo odd alt thread-odd thread-alt depth-1" id="comment-860203">
				<div id="div-comment-860203" class="comment-body">
				<div class="comment-author vcard">
						<cite class="fn"><a href='https://social.msdn.microsoft.com/profile/Matteo+Italia' rel='external nofollow' class='url'>Matteo Italia</a></cite> <span class="says">says:</span>		</div>
		
		<div class="comment-meta commentmetadata"><a href="https://blogs.msdn.microsoft.com/oldnewthing/20100909-00/?p=12913#comment-860203">
			September 9, 2010 at 4:47 pm</a>		</div>

		<p>[ In the old Windows98 days, there was a problem with IDE hard drives from Three Letter Name company, that even warranted a hotfix from Microsoft. The drives in question didn&#39;t flush their cache before system powerdown soon enough. I suspect they ignored the flush command altogether. ]</p>
<p>Uhu, I perfectly remember it; the fix just waited few seconds before actually powering off the machine.</p>

		
				</div>
		</li><!-- #comment-## -->
		<li class="comment even thread-even depth-1" id="comment-860213">
				<div id="div-comment-860213" class="comment-body">
				<div class="comment-author vcard">
						<cite class="fn">Doug</cite> <span class="says">says:</span>		</div>
		
		<div class="comment-meta commentmetadata"><a href="https://blogs.msdn.microsoft.com/oldnewthing/20100909-00/?p=12913#comment-860213">
			September 9, 2010 at 5:46 pm</a>		</div>

		<p>@Aneurin Price</p>
<p>As you mentioned, ZFS does things transactionally. If the disk lies about the data for transaction #9&#39;s commit record reaching the disk surface, ZFS might start writing metadata from transaction #10 before the commit record for transaction #9 is actually saved. If power fails, recovery will involve rolling back transaction #9 (since it isn&#39;t recorded as committed), but the data from transaction #10 is not rolled back because according to the transaction logs, transaction #10 never even started. The result is file system corruption. CRC checking won&#39;t help. The problem is in the transaction system itself, so that won&#39;t help either. Copy-on-write applies to the data, but the error occured in the filesystem metadata, which is not copy-on-write. ZFS does some very advanced things, but these operations depend heavily on the accuracy of the transaction history data.</p>
<p>NTFS suffers from the same problem. Out-of-order writes can cause the filesystem transaction history to be invalid, making it possible to corrupt filesystem metadata.</p>

		
				</div>
		</li><!-- #comment-## -->
		<li class="comment odd alt thread-odd thread-alt depth-1" id="comment-860093">
				<div id="div-comment-860093" class="comment-body">
				<div class="comment-author vcard">
						<cite class="fn">Aneurin Price</cite> <span class="says">says:</span>		</div>
		
		<div class="comment-meta commentmetadata"><a href="https://blogs.msdn.microsoft.com/oldnewthing/20100909-00/?p=12913#comment-860093">
			September 9, 2010 at 11:12 am</a>		</div>

		<p>@Aram Hăvărneanu</p>
<p>That sounds highly implausible. ZFS is actually *more* resilient to this kind of problem than most filesystems because it a) is a copy-on-write fs and b) checksums blocks. In the case that the drive lied the checksum will be incorrect and it can roll back to the previous transaction whose checksum validates (which will probably be a few seconds earlier).</p>

		
				</div>
		</li><!-- #comment-## -->
		<li class="comment even thread-even depth-1" id="comment-860223">
				<div id="div-comment-860223" class="comment-body">
				<div class="comment-author vcard">
						<cite class="fn">Cheong</cite> <span class="says">says:</span>		</div>
		
		<div class="comment-meta commentmetadata"><a href="https://blogs.msdn.microsoft.com/oldnewthing/20100909-00/?p=12913#comment-860223">
			September 9, 2010 at 6:52 pm</a>		</div>

		<p>@Dong: Really? Thanks for the information.</p>
<p>I&#39;ve always thought that the inode location data (which transaction #10 writes to) only would be updated with the transaction record, so such thing shouldn&#39;t happen. A &quot;insert&quot;-&quot;update inode map&quot;-&quot;mark as update completed&quot; transaction record would have protected failure from that scenario.</p>

		
				</div>
		</li><!-- #comment-## -->
		<li class="comment byuser comment-author-dwalker-wk odd alt thread-odd thread-alt depth-1" id="comment-860163">
				<div id="div-comment-860163" class="comment-body">
				<div class="comment-author vcard">
						<cite class="fn"><a href='https://social.msdn.microsoft.com/profile/DWalker' rel='external nofollow' class='url'>DWalker</a></cite> <span class="says">says:</span>		</div>
		
		<div class="comment-meta commentmetadata"><a href="https://blogs.msdn.microsoft.com/oldnewthing/20100909-00/?p=12913#comment-860163">
			September 9, 2010 at 3:25 pm</a>		</div>

		<p>I *do* care about the files on my server&#39;s drives, and the server is connected to a UPS. &nbsp;With regular battery replacement, the UPS hasn&#39;t failed in 8 years. &nbsp;We also have database backups. &nbsp;The server never hangs either; it&#39;s mostly a file server for about 12 users, with a couple of database applications on it.</p>
<p>So I feel comfortable turning on that &quot;super-advanced performance&quot; checkbox. &nbsp;I don&#39;t like the description &quot;Enabling buggy behavior in Windows Server 2003&quot; at <a rel="nofollow" target="_new" href="http://technet.microsoft.com/en-us/magazine/2007.04.windowsconfidential.aspx" rel="nofollow">technet.microsoft.com/&#8230;/2007.04.windowsconfidential.aspx</a> &#8212; I don&#39;t think it&#39;s quite fair.</p>

		
				</div>
		</li><!-- #comment-## -->
		<li class="comment even thread-even depth-1" id="comment-860233">
				<div id="div-comment-860233" class="comment-body">
				<div class="comment-author vcard">
						<cite class="fn">Mystic</cite> <span class="says">says:</span>		</div>
		
		<div class="comment-meta commentmetadata"><a href="https://blogs.msdn.microsoft.com/oldnewthing/20100909-00/?p=12913#comment-860233">
			September 9, 2010 at 11:53 pm</a>		</div>

		<p>You mwan there&#39;s time to flush out the buffers even if a BSOD or complete freeze due to some hardware failing or memory corruption occurs?</p>

		
				</div>
		</li><!-- #comment-## -->
		<li class="comment odd alt thread-odd thread-alt depth-1" id="comment-860243">
				<div id="div-comment-860243" class="comment-body">
				<div class="comment-author vcard">
						<cite class="fn">ender</cite> <span class="says">says:</span>		</div>
		
		<div class="comment-meta commentmetadata"><a href="https://blogs.msdn.microsoft.com/oldnewthing/20100909-00/?p=12913#comment-860243">
			September 10, 2010 at 1:00 am</a>		</div>

		<p>Mystic: we&#39;re talking about drive&#39;s internal cache here, so yes, there is time, because even in the case of BSOD, the drive is still powered on.</p>

		
				</div>
		</li><!-- #comment-## -->
		<li class="comment even thread-even depth-1" id="comment-860253">
				<div id="div-comment-860253" class="comment-body">
				<div class="comment-author vcard">
						<cite class="fn"><a href='http://www.cs.washington.edu/homes/supersat/' rel='external nofollow' class='url'>Karl</a></cite> <span class="says">says:</span>		</div>
		
		<div class="comment-meta commentmetadata"><a href="https://blogs.msdn.microsoft.com/oldnewthing/20100909-00/?p=12913#comment-860253">
			September 10, 2010 at 3:22 am</a>		</div>

		<p>Lots of drives actually lie about this, even high-end SCSI drives. It doesn&#39;t matter if you use a RAID card with a battery backup &#8212; the drive will lie to the RAID card as well.</p>
<p>Luckily, there&#39;s a tool to see if your disks are lying: <a rel="nofollow" target="_new" href="http://brad.livejournal.com/2116715.html" rel="nofollow">brad.livejournal.com/2116715.html</a> (see <a rel="nofollow" target="_new" href="http://brad.livejournal.com/2094221.html" rel="nofollow">brad.livejournal.com/2094221.html</a> for some background&#8230; this caused a major outage for LiveJournal after an EPO shutoff at Fisher Plaza).</p>

		
				</div>
		</li><!-- #comment-## -->
		<li class="comment odd alt thread-odd thread-alt depth-1" id="comment-860293">
				<div id="div-comment-860293" class="comment-body">
				<div class="comment-author vcard">
						<cite class="fn">Steve Thresher</cite> <span class="says">says:</span>		</div>
		
		<div class="comment-meta commentmetadata"><a href="https://blogs.msdn.microsoft.com/oldnewthing/20100909-00/?p=12913#comment-860293">
			September 10, 2010 at 8:40 am</a>		</div>

		<p>Hi Raymond,</p>
<p>Like Martin, I&#39;d also love to hear about the &#39;better ways of doing it nowadays&#39; as we currently use FlushFileBuffers in an attempt to guarantee disk writes.</p>

		
				</div>
		</li><!-- #comment-## -->
		<li class="comment even thread-even depth-1" id="comment-860343">
				<div id="div-comment-860343" class="comment-body">
				<div class="comment-author vcard">
						<cite class="fn">rs</cite> <span class="says">says:</span>		</div>
		
		<div class="comment-meta commentmetadata"><a href="https://blogs.msdn.microsoft.com/oldnewthing/20100909-00/?p=12913#comment-860343">
			September 10, 2010 at 11:40 am</a>		</div>

		<p>This is related to the previous comment. Isn&#39;t FlushFileBuffers the proper way of checking whether a file has been successfully written? If you do not call FlushFileBuffers before finally closing a file, how can you avoid the following scenario:</p>
<p>(1) WriteFile places the data into the cache and returns a nonzero value.</p>
<p>(2) The program closes the file. The data is still not yet written to the disk, as described in <a rel="nofollow" target="_new" href="http://msdn.microsoft.com/en-us/library/aa364451(v=VS.85).aspx" rel="nofollow">msdn.microsoft.com/&#8230;/aa364451(v=VS.85).aspx</a></p>
<p>(3) The connection to the device is lost before the data is written. (Think of a network drive or a USB memory stick.)</p>
<p>(4) The program has no chance of realizing this. When it exits, the data is lost.</p>
<p>If, on the other hand, you call FlushFileBuffers before closing the file, and it returns zero, you know that something went wrong, and you can let the user specify another file for saving the data.</p>

		
				</div>
		</li><!-- #comment-## -->
		<li class="comment odd alt thread-odd thread-alt depth-1" id="comment-860283">
				<div id="div-comment-860283" class="comment-body">
				<div class="comment-author vcard">
						<cite class="fn">Knut</cite> <span class="says">says:</span>		</div>
		
		<div class="comment-meta commentmetadata"><a href="https://blogs.msdn.microsoft.com/oldnewthing/20100909-00/?p=12913#comment-860283">
			September 10, 2010 at 8:17 am</a>		</div>

		<p>A colleague of me happend to have a stroy with ups.</p>
<p>He was at the site for maintenance of a redundant system. They wanted to update the UPS at that site. So he made a shutdown on the backup server and told the electricians, they can work on the UPS for that server. Unfortunately someone had renewed the labels of the UPS and labeled them wrong. It&#39;s only a fifty-fifty chance. So the master server was taken down by cutting the power. The server was up an running again 15 Minutes later and had no important data loss.</p>
<p>I learned from this not to rely on UPS. *** happens ! </p>

		
				</div>
		</li><!-- #comment-## -->
		<li class="comment even thread-even depth-1" id="comment-860383">
				<div id="div-comment-860383" class="comment-body">
				<div class="comment-author vcard">
						<cite class="fn">Worf</cite> <span class="says">says:</span>		</div>
		
		<div class="comment-meta commentmetadata"><a href="https://blogs.msdn.microsoft.com/oldnewthing/20100909-00/?p=12913#comment-860383">
			September 10, 2010 at 10:51 pm</a>		</div>

		<p>One of my projects involved a Linux device providing mass storage over USB. We`had performance problems, but noted that Windows had tripled performance or so if it didn&#39;t do the Force Unit Access bit set (&quot;Optimize for quick removal&quot;), which let Linux actually handle caching.</p>
<p>Because there&#39;s no way to have Windows set those bits automatically, we coded the mass storage driver on pur device to ignore the bit. It was safe &#8211; our device had battery so there was plenty of time to flush the Linux caches (it did so every 5 seonds&#8230;).</p>

		
				</div>
		</li><!-- #comment-## -->
		<li class="comment odd alt thread-odd thread-alt depth-1" id="comment-860723">
				<div id="div-comment-860723" class="comment-body">
				<div class="comment-author vcard">
						<cite class="fn">benjamin</cite> <span class="says">says:</span>		</div>
		
		<div class="comment-meta commentmetadata"><a href="https://blogs.msdn.microsoft.com/oldnewthing/20100909-00/?p=12913#comment-860723">
			September 14, 2010 at 7:39 am</a>		</div>

		<p>This whole discussion (keeping in mind Adrian&#39;s comment, especially) reminds me of Raymond&#39;s article about the video card that claimed to support every DirectX call ever made. We&#39;ve got a function call that flushes to disk and the disk that says &#39;Okay, flushed.&#39; So then we needed a function that said &#39;No really, flush your stuff&#39; and disks that can potentially lie. So then we&#39;ll need a new function that says &quot;Seriously though, flush your buffers.&quot;</p>
<p>I&#39;d suspect at that point the function would just be a fairly lengthy NOP loop.</p>
<p>Maybe when super-capacitors become reliable enough and miniaturized HD manufacturers can stick one on their drives and have a disk that keeps going for a minute or two after power&#39;s lost.</p>

		
				</div>
		</li><!-- #comment-## -->
		</ol><!-- .comment-list -->

		<div class="navigation pagination">
					</div>

	
			<p class="no-comments">Comments are closed.</p>
<!-- COMMENTS END -->
</div></td></tr></table>