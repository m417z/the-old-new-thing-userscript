<table class="commenttable" cellspacing="0" cellpadding="0"><tr><td><div class="commentdiv"><div class="commentdivhdr">
<!-- COMMENTS START -->
Comments (20)	</div>

	
			<div class="navigation pagination clear-both">
					</div>

		<ol class="comment-list">
					<li class="comment even thread-even depth-1" id="comment-220963">
				<div id="div-comment-220963" class="comment-body">
				<div class="comment-author vcard">
						<cite class="fn">anon</cite> <span class="says">says:</span>		</div>
		
		<div class="comment-meta commentmetadata"><a href="https://blogs.msdn.microsoft.com/oldnewthing/20041026-00/?p=37473#comment-220963">
			October 26, 2004 at 8:42 am</a>		</div>

		<p>It also has a potential buffer overflow.</p>

		
				</div>
		</li><!-- #comment-## -->
		<li class="comment odd alt thread-odd thread-alt depth-1" id="comment-220973">
				<div id="div-comment-220973" class="comment-body">
				<div class="comment-author vcard">
						<cite class="fn">Doug</cite> <span class="says">says:</span>		</div>
		
		<div class="comment-meta commentmetadata"><a href="https://blogs.msdn.microsoft.com/oldnewthing/20041026-00/?p=37473#comment-220973">
			October 26, 2004 at 8:48 am</a>		</div>

		<p>It has many many bugs.  What is an error?</p>
<p>My question is, how could someone who knows enough to use said functions be stupid enough to make that many errors in one function?  This almost looks deliberate&#8230;.</p>

		
				</div>
		</li><!-- #comment-## -->
		<li class="comment even thread-even depth-1" id="comment-220983">
				<div id="div-comment-220983" class="comment-body">
				<div class="comment-author vcard">
						<cite class="fn">Shane</cite> <span class="says">says:</span>		</div>
		
		<div class="comment-meta commentmetadata"><a href="https://blogs.msdn.microsoft.com/oldnewthing/20041026-00/?p=37473#comment-220983">
			October 26, 2004 at 8:59 am</a>		</div>

		<p>I vote this be sent to &quot;The Daily WTF&quot; for inclusion!</p>

		
				</div>
		</li><!-- #comment-## -->
		<li class="comment odd alt thread-odd thread-alt depth-1" id="comment-220993">
				<div id="div-comment-220993" class="comment-body">
				<div class="comment-author vcard">
						<cite class="fn">anonymous</cite> <span class="says">says:</span>		</div>
		
		<div class="comment-meta commentmetadata"><a href="https://blogs.msdn.microsoft.com/oldnewthing/20041026-00/?p=37473#comment-220993">
			October 26, 2004 at 9:17 am</a>		</div>

		<p>So I can avoid it..</p>

		
				</div>
		</li><!-- #comment-## -->
		<li class="comment even thread-even depth-1" id="comment-221003">
				<div id="div-comment-221003" class="comment-body">
				<div class="comment-author vcard">
						<cite class="fn">Alex Feinman</cite> <span class="says">says:</span>		</div>
		
		<div class="comment-meta commentmetadata"><a href="https://blogs.msdn.microsoft.com/oldnewthing/20041026-00/?p=37473#comment-221003">
			October 26, 2004 at 10:32 am</a>		</div>

		<p>I don&#8217;t think the buffer overflow is something to worry about. That would mean that the system directory is over 248 characters deep. I would bet that a number of things will get brokien if that were the case</p>

		
				</div>
		</li><!-- #comment-## -->
		<li class="comment odd alt thread-odd thread-alt depth-1" id="comment-221013">
				<div id="div-comment-221013" class="comment-body">
				<div class="comment-author vcard">
						<cite class="fn">Gene Hamilton</cite> <span class="says">says:</span>		</div>
		
		<div class="comment-meta commentmetadata"><a href="https://blogs.msdn.microsoft.com/oldnewthing/20041026-00/?p=37473#comment-221013">
			October 26, 2004 at 10:47 am</a>		</div>

		<p>Do you know what their reasoning for detecting the OS version this way?</p>

		
				</div>
		</li><!-- #comment-## -->
		<li class="comment even thread-even depth-1" id="comment-221033">
				<div id="div-comment-221033" class="comment-body">
				<div class="comment-author vcard">
						<cite class="fn"><a href='http://blog.hackedbrain.com/' rel='external nofollow' class='url'>Drew Marsh</a></cite> <span class="says">says:</span>		</div>
		
		<div class="comment-meta commentmetadata"><a href="https://blogs.msdn.microsoft.com/oldnewthing/20041026-00/?p=37473#comment-221033">
			October 26, 2004 at 11:26 am</a>		</div>

		<p>Wow, that&#8217;s just scary.</p>

		
				</div>
		</li><!-- #comment-## -->
		<li class="comment odd alt thread-odd thread-alt depth-1" id="comment-221043">
				<div id="div-comment-221043" class="comment-body">
				<div class="comment-author vcard">
						<cite class="fn"><a href='http://blog.quicksurf.com/' rel='external nofollow' class='url'>Adrian</a></cite> <span class="says">says:</span>		</div>
		
		<div class="comment-meta commentmetadata"><a href="https://blogs.msdn.microsoft.com/oldnewthing/20041026-00/?p=37473#comment-221043">
			October 26, 2004 at 11:54 am</a>		</div>

		<p>Actually, it would be better to use GetVersionEx() Since GetVersion() has been superseded by GetVersionEx()</p>

		
				</div>
		</li><!-- #comment-## -->
		<li class="comment even thread-even depth-1" id="comment-221063">
				<div id="div-comment-221063" class="comment-body">
				<div class="comment-author vcard">
						<cite class="fn">Tony Cox [MS]</cite> <span class="says">says:</span>		</div>
		
		<div class="comment-meta commentmetadata"><a href="https://blogs.msdn.microsoft.com/oldnewthing/20041026-00/?p=37473#comment-221063">
			October 26, 2004 at 1:25 pm</a>		</div>

		<p>I just had an even scarier thought: what if this code is correct?</p>
<p>By which I mean, what if the thing they are trying to detect is not whether the system is NT, but whether is has this particular filemapping implementation quirk. The implication of which would be that somewhere they want to rely on it&#8230;</p>

		
				</div>
		</li><!-- #comment-## -->
		<li class="comment odd alt thread-odd thread-alt depth-1" id="comment-221083">
				<div id="div-comment-221083" class="comment-body">
				<div class="comment-author vcard">
						<cite class="fn">Tom</cite> <span class="says">says:</span>		</div>
		
		<div class="comment-meta commentmetadata"><a href="https://blogs.msdn.microsoft.com/oldnewthing/20041026-00/?p=37473#comment-221083">
			October 26, 2004 at 2:07 pm</a>		</div>

		<p>What about this</p>
<p>if ( !RegisterClass(&amp;wndclass) )<br />
<br />{<br />
<br />    MessageBox(NULL, TEXT(&quot;This program requires Windows NT&quot;), szAppName, MB_ICONERROR) ;<br />
<br />    return 0;<br />
<br />}</p>
<p>From Petzold. The idea being that the only reason RegisterClass would fail would be that you are running the Unicode build on Windows 9x/Me where RegisterClassW is a stub that returns FALSE.<br /></p>

		
				</div>
		</li><!-- #comment-## -->
		<li class="comment even thread-even depth-1" id="comment-221023">
				<div id="div-comment-221023" class="comment-body">
				<div class="comment-author vcard">
						<cite class="fn"><a href='http://TheDailyWTF.com/archive/2004/10/26/2920.aspx' rel='external nofollow' class='url'>The Daily WTF</a></cite> <span class="says">says:</span>		</div>
		
		<div class="comment-meta commentmetadata"><a href="https://blogs.msdn.microsoft.com/oldnewthing/20041026-00/?p=37473#comment-221023">
			October 26, 2004 at 2:13 pm</a>		</div>

		
		
				</div>
		</li><!-- #comment-## -->
		<li class="comment odd alt thread-odd thread-alt depth-1" id="comment-221093">
				<div id="div-comment-221093" class="comment-body">
				<div class="comment-author vcard">
						<cite class="fn"><a href='http://blogs.msdn.com/mgrier' rel='external nofollow' class='url'>Michael Grier</a></cite> <span class="says">says:</span>		</div>
		
		<div class="comment-meta commentmetadata"><a href="https://blogs.msdn.microsoft.com/oldnewthing/20041026-00/?p=37473#comment-221093">
			October 26, 2004 at 4:10 pm</a>		</div>

		<p>Actually the world ends if %windir% isn&#8217;t an 8.3 compatible name, so the buffer overrun is definitely conceptual not tangible.  The code /shouldn&#8217;t/ be written this way; the thing to keep you awake at night isn&#8217;t whether this function in particular will have a BO but rather whether all the other functions written by the same developer will&#8230;</p>

		
				</div>
		</li><!-- #comment-## -->
		<li class="comment even thread-even depth-1" id="comment-221103">
				<div id="div-comment-221103" class="comment-body">
				<div class="comment-author vcard">
						<cite class="fn">Norman Diamond</cite> <span class="says">says:</span>		</div>
		
		<div class="comment-meta commentmetadata"><a href="https://blogs.msdn.microsoft.com/oldnewthing/20041026-00/?p=37473#comment-221103">
			October 26, 2004 at 7:25 pm</a>		</div>

		<p>And I thought the most common uses of GetVersion() were for programs to inform Windows 2000 users that they had to get SP3 (when Windows 2000 was new and its SP3 was years in the future), or to inform Windows 2000 users that they didn&#8217;t have Direct X, or to find other random reasons why they would refuse to run themselves under Windows 2000.  Hmm&#8230; since this genuinely is an abuse of tools such as GetVersion(), one might wonder how many shims have been written in order to provide compatibility for these broken applications.</p>

		
				</div>
		</li><!-- #comment-## -->
		<li class="comment odd alt thread-odd thread-alt depth-1" id="comment-221113">
				<div id="div-comment-221113" class="comment-body">
				<div class="comment-author vcard">
						<cite class="fn"><a href='http://weblogs.asp.net/larryosterman' rel='external nofollow' class='url'>Larry Osterman</a></cite> <span class="says">says:</span>		</div>
		
		<div class="comment-meta commentmetadata"><a href="https://blogs.msdn.microsoft.com/oldnewthing/20041026-00/?p=37473#comment-221113">
			October 26, 2004 at 7:29 pm</a>		</div>

		<p>Tony, that may be the scariest thing I&#8217;ve heard all day&#8230;</p>

		
				</div>
		</li><!-- #comment-## -->
		<li class="comment even thread-even depth-1" id="comment-221153">
				<div id="div-comment-221153" class="comment-body">
				<div class="comment-author vcard">
						<cite class="fn">Dhericean</cite> <span class="says">says:</span>		</div>
		
		<div class="comment-meta commentmetadata"><a href="https://blogs.msdn.microsoft.com/oldnewthing/20041026-00/?p=37473#comment-221153">
			October 27, 2004 at 7:17 am</a>		</div>

		<p>Maybe this is to avoid the fact that a program can be lied to about the Windows version using various things such as the Application Compatibility Toolkit.</p>
<p>At least they didn&#8217;t write something to parse Kernel32.dll or some such.</p>

		
				</div>
		</li><!-- #comment-## -->
		<li class="comment odd alt thread-odd thread-alt depth-1" id="comment-221183">
				<div id="div-comment-221183" class="comment-body">
				<div class="comment-author vcard">
						<cite class="fn">Adrian</cite> <span class="says">says:</span>		</div>
		
		<div class="comment-meta commentmetadata"><a href="https://blogs.msdn.microsoft.com/oldnewthing/20041026-00/?p=37473#comment-221183">
			October 27, 2004 at 8:50 am</a>		</div>

		<p>We hear great scary stories from Raymond about the extent MS goes to in order to make Windows compatible with apps that made bad assumptions or relied on undocumented behavior.  The fact that this guy is testing for NT (even though it&#8217;s poorly done) reminds us that ISVs go to lengths to be compatible with an ever-growing number of Windows versions.  Some APIs have changed radically (e.g., printing), and occasionally we run into things that seem to work (or break) slightly differently on various versions of Windows.</p>
<p>Here&#8217;s one that hit me last night.  I have an HBITMAP that I know is really a DIB Section.  I use GetObject to retrieve a DIBSECTION that describes it.  This bitmap happens to have an odd width.  DIBs use DWORD alignment for scanlines, and I see that for almost every version of Windows dib.dsBm.bmWidthBytes is a multiple of 4 just like I&#8217;d expect.  But on Windows 2000, it&#8217;s only a multiple of 2 as though it&#8217;s a WORD-aligned device-DEpendent bitmap.  If I trust 2000 and use the WORD-aligned value for indexing into the pixels, it doesn&#8217;t work&#8211;the scanlines really are DWORD aligned.</p>
<p>Obviously, I can fix the problem by computing a DWORD-aligned stride without explicitly testing for the OS version.  I can&#8217;t find any documentation that guarantees DWORD alignment for a DIB Section, only for DIBs, so what if the next version of Windows really does align the DIB Section scanlines to WORD boundaries?    I would have to test OS versions to know whether or not to trust the alignment reported by GDI.</p>

		
				</div>
		</li><!-- #comment-## -->
		<li class="comment even thread-even depth-1" id="comment-221143">
				<div id="div-comment-221143" class="comment-body">
				<div class="comment-author vcard">
						<cite class="fn"><a href='http://TheDailyWTF.com/archive/0001/01/01/2920.aspx' rel='external nofollow' class='url'>The Daily WTF</a></cite> <span class="says">says:</span>		</div>
		
		<div class="comment-meta commentmetadata"><a href="https://blogs.msdn.microsoft.com/oldnewthing/20041026-00/?p=37473#comment-221143">
			October 27, 2004 at 8:52 am</a>		</div>

		
		
				</div>
		</li><!-- #comment-## -->
		<li class="comment odd alt thread-odd thread-alt depth-1" id="comment-221303">
				<div id="div-comment-221303" class="comment-body">
				<div class="comment-author vcard">
						<cite class="fn">Steve</cite> <span class="says">says:</span>		</div>
		
		<div class="comment-meta commentmetadata"><a href="https://blogs.msdn.microsoft.com/oldnewthing/20041026-00/?p=37473#comment-221303">
			October 27, 2004 at 9:44 pm</a>		</div>

		<p>Adrian,<br />
<br />I am not a GDI programmer but the info on MSDN seems to indicate that it is word aligned:</p>
<p><a target="_new" href="http://msdn.microsoft.com/library/default.asp?url=/library/en-us/gdi/bitmaps_0cqa.asp" rel="nofollow">http://msdn.microsoft.com/library/default.asp?url=/library/en-us/gdi/bitmaps_0cqa.asp</a></p>
<p><a target="_new" href="http://msdn.microsoft.com/library/default.asp?url=/library/en-us/gdi/bitmaps_2h6a.asp" rel="nofollow">http://msdn.microsoft.com/library/default.asp?url=/library/en-us/gdi/bitmaps_2h6a.asp</a> </p>
<p>bmWidthBytes<br />
<br />Specifies the number of bytes in each scan line. This value must be divisible by 2, because the system assumes that the bit values of a bitmap form an array that is word aligned. </p>
<p>Of course I may be missing your point.</p>

		
				</div>
		</li><!-- #comment-## -->
		<li class="comment even thread-even depth-1" id="comment-221383">
				<div id="div-comment-221383" class="comment-body">
				<div class="comment-author vcard">
						<cite class="fn">asdf</cite> <span class="says">says:</span>		</div>
		
		<div class="comment-meta commentmetadata"><a href="https://blogs.msdn.microsoft.com/oldnewthing/20041026-00/?p=37473#comment-221383">
			October 28, 2004 at 2:34 am</a>		</div>

		<p>DIBs (including DIBSECTIONS) are always DWORD aligned. The only things that use WORD aligned buffers are DDBs using CreateBitmap, CreateBitmapIndirect, GetBitmapBits, and SetBitmapBits (I think that is a comprehensive list, MSDN kind of sucks to navigate). The rest of the bitmap functions use DWORD aligned stuff.</p>

		
				</div>
		</li><!-- #comment-## -->
		<li class="comment odd alt thread-odd thread-alt depth-1" id="comment-228453">
				<div id="div-comment-228453" class="comment-body">
				<div class="comment-author vcard">
						<cite class="fn"><a href='http://weblog.arkane-systems.net/followme/archive/2004/11/22/303.aspx' rel='external nofollow' class='url'>Anonymous</a></cite> <span class="says">says:</span>		</div>
		
		<div class="comment-meta commentmetadata"><a href="https://blogs.msdn.microsoft.com/oldnewthing/20041026-00/?p=37473#comment-228453">
			November 22, 2004 at 8:24 am</a>		</div>

		
		
				</div>
		</li><!-- #comment-## -->
		</ol><!-- .comment-list -->

		<div class="navigation pagination">
					</div>

	
			<p class="no-comments">Comments are closed.</p>
<!-- COMMENTS END -->
</div></td></tr></table>