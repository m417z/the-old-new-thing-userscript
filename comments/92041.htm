<table class="commenttable" cellspacing="0" cellpadding="0"><tr><td><div class="commentdiv"><div class="commentdivhdr">
<!-- COMMENTS START -->
Comments (15)	</div>

	
			<div class="navigation pagination clear-both">
					</div>

		<ol class="comment-list">
					<li class="comment even thread-even depth-1" id="comment-1213111">
				<div id="div-comment-1213111" class="comment-body">
				<div class="comment-author vcard">
						<cite class="fn">Henke37</cite> <span class="says">says:</span>		</div>
		
		<div class="comment-meta commentmetadata"><a href="https://blogs.msdn.microsoft.com/oldnewthing/20151120-00/?p=92041#comment-1213111">
			November 20, 2015 at 7:09 am</a>		</div>

		<p>Rule number one for working with access masks: they have to be for the correct object type.</p>

		
				</div>
		</li><!-- #comment-## -->
		<li class="comment odd alt thread-odd thread-alt depth-1" id="comment-1213101">
				<div id="div-comment-1213101" class="comment-body">
				<div class="comment-author vcard">
						<cite class="fn">Joshua</cite> <span class="says">says:</span>		</div>
		
		<div class="comment-meta commentmetadata"><a href="https://blogs.msdn.microsoft.com/oldnewthing/20151120-00/?p=92041#comment-1213101">
			November 20, 2015 at 7:30 am</a>		</div>

		<p>Make the process deny-all for everyone, but start it suspended. Then track down the process&#39;s original handle to itself and replace it w/ yours.</p>

		
				</div>
		</li><!-- #comment-## -->
		<li class="comment even thread-even depth-1" id="comment-1213091">
				<div id="div-comment-1213091" class="comment-body">
				<div class="comment-author vcard">
						<cite class="fn">Wyatt</cite> <span class="says">says:</span>		</div>
		
		<div class="comment-meta commentmetadata"><a href="https://blogs.msdn.microsoft.com/oldnewthing/20151120-00/?p=92041#comment-1213091">
			November 20, 2015 at 7:36 am</a>		</div>

		<p>My brain hurts.</p>

		
				</div>
		</li><!-- #comment-## -->
		<li class="comment odd alt thread-odd thread-alt depth-1" id="comment-1213081">
				<div id="div-comment-1213081" class="comment-body">
				<div class="comment-author vcard">
						<cite class="fn">DWalker</cite> <span class="says">says:</span>		</div>
		
		<div class="comment-meta commentmetadata"><a href="https://blogs.msdn.microsoft.com/oldnewthing/20151120-00/?p=92041#comment-1213081">
			November 20, 2015 at 8:40 am</a>		</div>

		<p>Well, the customer&#39;s reply explains a lot! &nbsp;I have often said that good commenting helps a lot. &nbsp;</p>
<p>If the original coder would have added comments saying what he was TRYING to do, or WHY he was setting those masks, then the customer who acquired the code might have had a clue. &nbsp;Although I predict that the original coder didn&#39;t know what he was doing; maybe he cobbled it together from examples he found elsewhere.</p>
<p>If you don&#39;t know a piece of code well enough to write a meaningful comment explaining WHY you are doing what you are doing, then you don&#39;t understand the code well enough to include it in your program.</p>

		
				</div>
		</li><!-- #comment-## -->
		<li class="comment even thread-even depth-1" id="comment-1213041">
				<div id="div-comment-1213041" class="comment-body">
				<div class="comment-author vcard">
						<cite class="fn">Mark</cite> <span class="says">says:</span>		</div>
		
		<div class="comment-meta commentmetadata"><a href="https://blogs.msdn.microsoft.com/oldnewthing/20151120-00/?p=92041#comment-1213041">
			November 20, 2015 at 10:51 am</a>		</div>

		<p>Your analogies are really good at cracking me up. &nbsp;I just recovered from the cleanup tip, and then the restaurants came.</p>

		
				</div>
		</li><!-- #comment-## -->
		<li class="comment odd alt thread-odd thread-alt depth-1" id="comment-1213001">
				<div id="div-comment-1213001" class="comment-body">
				<div class="comment-author vcard">
						<cite class="fn">Yukkuri</cite> <span class="says">says:</span>		</div>
		
		<div class="comment-meta commentmetadata"><a href="https://blogs.msdn.microsoft.com/oldnewthing/20151120-00/?p=92041#comment-1213001">
			November 20, 2015 at 11:27 am</a>		</div>

		<p>People that slog through impossible mystery code and fix it are my heroes. A salute to whoever this customer was o&gt;</p>

		
				</div>
		</li><!-- #comment-## -->
		<li class="comment even thread-even depth-1" id="comment-1212991">
				<div id="div-comment-1212991" class="comment-body">
				<div class="comment-author vcard">
						<cite class="fn">Cesar</cite> <span class="says">says:</span>		</div>
		
		<div class="comment-meta commentmetadata"><a href="https://blogs.msdn.microsoft.com/oldnewthing/20151120-00/?p=92041#comment-1212991">
			November 20, 2015 at 11:38 am</a>		</div>

		<p>@DWalker: if the code is that confused, the comments probably would be too. Wouldn&#39;t surprise me if the comments say something completely different than what the code does, and neither &nbsp;is what the programmer actually wanted to do. (I&#39;ve seen things like a comment explaining what the string returned by the function means, while the function actually returns a boolean!)</p>

		
				</div>
		</li><!-- #comment-## -->
		<li class="comment odd alt thread-odd thread-alt depth-1" id="comment-1212981">
				<div id="div-comment-1212981" class="comment-body">
				<div class="comment-author vcard">
						<cite class="fn">Myria</cite> <span class="says">says:</span>		</div>
		
		<div class="comment-meta commentmetadata"><a href="https://blogs.msdn.microsoft.com/oldnewthing/20151120-00/?p=92041#comment-1212981">
			November 20, 2015 at 12:31 pm</a>		</div>

		<p>@Joshua: You don&#39;t need to replace a process&#39;s handle to itself: a process always has the -1 pseudo-handle that&#39;s always opened with full access.</p>
<p>But why would you want to make a process deny access to everyone running as the same user? &nbsp;This seems pointless, because if you&#39;re the process&#39;s owner, you can open the process with WRITE_DAC access using the owner&#39;s prerogative, then add access for yourself and/or remove the deny for yourself.</p>

		
				</div>
		</li><!-- #comment-## -->
		<li class="comment even thread-even depth-1" id="comment-1212961">
				<div id="div-comment-1212961" class="comment-body">
				<div class="comment-author vcard">
						<cite class="fn">Passed NULL, Gimme my $200</cite> <span class="says">says:</span>		</div>
		
		<div class="comment-meta commentmetadata"><a href="https://blogs.msdn.microsoft.com/oldnewthing/20151120-00/?p=92041#comment-1212961">
			November 20, 2015 at 4:42 pm</a>		</div>

		<p> &nbsp; &nbsp;&quot;the solution &#8230; is simple: Delete all the code &#8230; and just pass NULL&quot;</p>
<p>This applies universally. </p>

		
				</div>
		</li><!-- #comment-## -->
		<li class="comment odd alt thread-odd thread-alt depth-1" id="comment-1212951">
				<div id="div-comment-1212951" class="comment-body">
				<div class="comment-author vcard">
						<cite class="fn">Joshua</cite> <span class="says">says:</span>		</div>
		
		<div class="comment-meta commentmetadata"><a href="https://blogs.msdn.microsoft.com/oldnewthing/20151120-00/?p=92041#comment-1212951">
			November 21, 2015 at 2:44 pm</a>		</div>

		<p>To keep running after logout w/o admin of course.</p>

		
				</div>
		</li><!-- #comment-## -->
		<li class="comment even thread-even depth-1" id="comment-1212941">
				<div id="div-comment-1212941" class="comment-body">
				<div class="comment-author vcard">
						<cite class="fn">Hildar</cite> <span class="says">says:</span>		</div>
		
		<div class="comment-meta commentmetadata"><a href="https://blogs.msdn.microsoft.com/oldnewthing/20151120-00/?p=92041#comment-1212941">
			November 21, 2015 at 3:29 pm</a>		</div>

		<p>I have to ask, what the hell does PROCESS_SET_SESSIONÂ­ID do, and why is that a problem?</p>

		
				</div>
		</li><!-- #comment-## -->
		<li class="comment odd alt thread-odd thread-alt depth-1" id="comment-1212931">
				<div id="div-comment-1212931" class="comment-body">
				<div class="comment-author vcard">
						<cite class="fn">S</cite> <span class="says">says:</span>		</div>
		
		<div class="comment-meta commentmetadata"><a href="https://blogs.msdn.microsoft.com/oldnewthing/20151120-00/?p=92041#comment-1212931">
			November 22, 2015 at 3:04 am</a>		</div>

		<p>&quot;To keep running after logout w/o admin of course.&quot; And why that? Hopefully, the sesseion manager takes measure (by resetting this) to kill your rogue process on logout anyway.</p>
<p>Use services or scheduled tasks for this.</p>

		
				</div>
		</li><!-- #comment-## -->
		<li class="comment even thread-even depth-1" id="comment-1212921">
				<div id="div-comment-1212921" class="comment-body">
				<div class="comment-author vcard">
						<cite class="fn">Harry Johnston</cite> <span class="says">says:</span>		</div>
		
		<div class="comment-meta commentmetadata"><a href="https://blogs.msdn.microsoft.com/oldnewthing/20151120-00/?p=92041#comment-1212921">
			November 22, 2015 at 1:06 pm</a>		</div>

		<p>@Hildar: presumably related to terminal services (aka remote desktop) sessions. &nbsp;Although I didn&#39;t think it was actually possible to move a process between sessions or put it in any session other than the one given by its access token. &nbsp;The permission might be obsolete, or it might be used internally by Windows.</p>

		
				</div>
		</li><!-- #comment-## -->
		<li class="comment odd alt thread-odd thread-alt depth-1" id="comment-1215181">
				<div id="div-comment-1215181" class="comment-body">
				<div class="comment-author vcard">
						<cite class="fn">Darran Rowe</cite> <span class="says">says:</span>		</div>
		
		<div class="comment-meta commentmetadata"><a href="https://blogs.msdn.microsoft.com/oldnewthing/20151120-00/?p=92041#comment-1215181">
			November 23, 2015 at 8:26 am</a>		</div>

		<p>@Harry Johnston:</p>
<p>After doing a bit of digging, there is stuff defined in the WDK in regards to this. So if it is available from user mode, then it would be in the native API only. Even then, I wouldn&#39;t be surprised if you require the run as part of the operating system privilege to be able to do it.</p>
<p>There is more you can do with processes than is exposed in the Win32 API. The two most obvious ones are the posix support, and the sandbox mode that modern processes use. They are obviously possible because MS has used them before, the posix support was in sfu/sua and IE for Windows 8 and 8.1 used the sandbox for enhanced protected mode (it doesn&#39;t seem to do it in 10).</p>

		
				</div>
		</li><!-- #comment-## -->
		<li class="comment even thread-even depth-1" id="comment-1215141">
				<div id="div-comment-1215141" class="comment-body">
				<div class="comment-author vcard">
						<cite class="fn">Max</cite> <span class="says">says:</span>		</div>
		
		<div class="comment-meta commentmetadata"><a href="https://blogs.msdn.microsoft.com/oldnewthing/20151120-00/?p=92041#comment-1215141">
			November 23, 2015 at 11:48 am</a>		</div>

		<p>@DWalker: If the code is that old then it&#39;s likely been worked on by several people, going through incremental changes and updates and patches and bugfixes over the course of years. The comments don&#39;t just have to be made, they have to be maintained, just like the code is. And even if you meticulously document every fix, over time the comments will accumulate to the point where they become unreadable, and most likely no one&#39;s going to go back and analyze the code and rewrite/summarize all the comments into something that&#39;s still relevant and accurate until it&#39;s already become a problem. On projects that big and old, managing code readability isn&#39;t as simple as &quot;comment everything&quot;.</p>

		
				</div>
		</li><!-- #comment-## -->
		</ol><!-- .comment-list -->

		<div class="navigation pagination">
					</div>

	
			<p class="no-comments">Comments are closed.</p>
<!-- COMMENTS END -->
</div></td></tr></table>