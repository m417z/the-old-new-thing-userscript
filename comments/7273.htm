<table class="commenttable" cellspacing="0" cellpadding="0"><tr><td><div class="commentdiv"><div class="commentdivhdr">
<!-- COMMENTS START -->
Comments (44)	</div>

	
			<div class="navigation pagination clear-both">
					</div>

		<ol class="comment-list">
					<li class="comment even thread-even depth-1" id="comment-993963">
				<div id="div-comment-993963" class="comment-body">
				<div class="comment-author vcard">
						<cite class="fn">John</cite> <span class="says">says:</span>		</div>
		
		<div class="comment-meta commentmetadata"><a href="https://blogs.msdn.microsoft.com/oldnewthing/20120627-00/?p=7273#comment-993963">
			June 27, 2012 at 7:09 am</a>		</div>

		<p>You went full TARDIS, man. &nbsp;Never go full TARDIS.</p>

		
				</div>
		</li><!-- #comment-## -->
		<li class="comment odd alt thread-odd thread-alt depth-1" id="comment-993973">
				<div id="div-comment-993973" class="comment-body">
				<div class="comment-author vcard">
						<cite class="fn">Nick</cite> <span class="says">says:</span>		</div>
		
		<div class="comment-meta commentmetadata"><a href="https://blogs.msdn.microsoft.com/oldnewthing/20120627-00/?p=7273#comment-993973">
			June 27, 2012 at 7:14 am</a>		</div>

		<p>LOL by far the funniest article I&#39;ve seen in a while on here!!! On ya Raymond.</p>

		
				</div>
		</li><!-- #comment-## -->
		<li class="comment even thread-even depth-1" id="comment-993983">
				<div id="div-comment-993983" class="comment-body">
				<div class="comment-author vcard">
						<cite class="fn">Gabe</cite> <span class="says">says:</span>		</div>
		
		<div class="comment-meta commentmetadata"><a href="https://blogs.msdn.microsoft.com/oldnewthing/20120627-00/?p=7273#comment-993983">
			June 27, 2012 at 8:08 am</a>		</div>

		<p>I&#39;m guessing the real answer is that the server was truncating the drive size to 32 bits before returning it, while the available disk space (that everybody looks at) was fixed to be 64 bits ages ago when somebody first got a disk bigger than 4GB.</p>

		
				</div>
		</li><!-- #comment-## -->
		<li class="comment odd alt thread-odd thread-alt depth-1" id="comment-993993">
				<div id="div-comment-993993" class="comment-body">
				<div class="comment-author vcard">
						<cite class="fn">Programmerman</cite> <span class="says">says:</span>		</div>
		
		<div class="comment-meta commentmetadata"><a href="https://blogs.msdn.microsoft.com/oldnewthing/20120627-00/?p=7273#comment-993993">
			June 27, 2012 at 8:25 am</a>		</div>

		<p>Windows Home Server (the one built on Server 2003) does this. It reports the size of one of the disks as the total size and the combined free space as the available space.</p>

		
				</div>
		</li><!-- #comment-## -->
		<li class="comment byuser comment-author-alegrigoriev even thread-even depth-1" id="comment-994003">
				<div id="div-comment-994003" class="comment-body">
				<div class="comment-author vcard">
						<cite class="fn"><a href='https://social.msdn.microsoft.com/profile/alegr1' rel='external nofollow' class='url'>alegr1</a></cite> <span class="says">says:</span>		</div>
		
		<div class="comment-meta commentmetadata"><a href="https://blogs.msdn.microsoft.com/oldnewthing/20120627-00/?p=7273#comment-994003">
			June 27, 2012 at 8:41 am</a>		</div>

		<p>User quotes enabled?</p>

		
				</div>
		</li><!-- #comment-## -->
		<li class="comment byuser comment-author-maurits odd alt thread-odd thread-alt depth-1" id="comment-994013">
				<div id="div-comment-994013" class="comment-body">
				<div class="comment-author vcard">
						<cite class="fn"><a href='https://social.msdn.microsoft.com/profile/Maurits+%5BMSFT%5D' rel='external nofollow' class='url'>Maurits [MSFT]</a></cite> <span class="says">says:</span>		</div>
		
		<div class="comment-meta commentmetadata"><a href="https://blogs.msdn.microsoft.com/oldnewthing/20120627-00/?p=7273#comment-994013">
			June 27, 2012 at 8:56 am</a>		</div>

		<p>Why&#39;s the bar red then?</p>
<div class="post">[<i>Because the calculation of space used underflows and turns into a huge positive value, which means that the drive is a billion percent full. -Raymond</i>]</div>

		
				</div>
		</li><!-- #comment-## -->
		<li class="comment even thread-even depth-1" id="comment-994023">
				<div id="div-comment-994023" class="comment-body">
				<div class="comment-author vcard">
						<cite class="fn">Anonymous Coward</cite> <span class="says">says:</span>		</div>
		
		<div class="comment-meta commentmetadata"><a href="https://blogs.msdn.microsoft.com/oldnewthing/20120627-00/?p=7273#comment-994023">
			June 27, 2012 at 10:04 am</a>		</div>

		<p>While this sharpens the question somewhat, it doesn&#39;t answer it. Personally, I think the 32/64-bit truncation explanation is more likely than the WHS explanation since that would either require lots of disks, or possibly disks of very disparate sizes.</p>
<p>[ rest of post deleted because Raymond was there first ]</p>

		
				</div>
		</li><!-- #comment-## -->
		<li class="comment byuser comment-author-maurits odd alt thread-odd thread-alt depth-1" id="comment-994033">
				<div id="div-comment-994033" class="comment-body">
				<div class="comment-author vcard">
						<cite class="fn"><a href='https://social.msdn.microsoft.com/profile/Maurits+%5BMSFT%5D' rel='external nofollow' class='url'>Maurits [MSFT]</a></cite> <span class="says">says:</span>		</div>
		
		<div class="comment-meta commentmetadata"><a href="https://blogs.msdn.microsoft.com/oldnewthing/20120627-00/?p=7273#comment-994033">
			June 27, 2012 at 10:15 am</a>		</div>

		<p>One could make an argument that inconsistent data should result in an error condition (could not determine drive space) rather than a confusing display (3.8 TB are free but the bar is red.)</p>
<div class="post">[<i>At what point do you give up trying to defend against inconsistent data from a trusted component? -Raymond</i>]</div>

		
				</div>
		</li><!-- #comment-## -->
		<li class="comment even thread-even depth-1" id="comment-994043">
				<div id="div-comment-994043" class="comment-body">
				<div class="comment-author vcard">
						<cite class="fn">Laurence</cite> <span class="says">says:</span>		</div>
		
		<div class="comment-meta commentmetadata"><a href="https://blogs.msdn.microsoft.com/oldnewthing/20120627-00/?p=7273#comment-994043">
			June 27, 2012 at 10:19 am</a>		</div>

		<p>I used to see this daily when I was running WHS v1 at home. The &quot;free space&quot; was reported based upon the combined free space of the drive extended volume (which is spanned across multiple physical disks) &#8212; the &quot;total space&quot; was reported based upon the fixed size of the D: partition.</p>
<p>In my case, I had 2&#215;1.5TB and 2x2TB drives (in addition to the 1TB system drive). So it was not infrequent to see 2 &#8211; 3TB of free space on a .8TB network drive.</p>

		
				</div>
		</li><!-- #comment-## -->
		<li class="comment byuser comment-author-maurits odd alt thread-odd thread-alt depth-1" id="comment-994053">
				<div id="div-comment-994053" class="comment-body">
				<div class="comment-author vcard">
						<cite class="fn"><a href='https://social.msdn.microsoft.com/profile/Maurits+%5BMSFT%5D' rel='external nofollow' class='url'>Maurits [MSFT]</a></cite> <span class="says">says:</span>		</div>
		
		<div class="comment-meta commentmetadata"><a href="https://blogs.msdn.microsoft.com/oldnewthing/20120627-00/?p=7273#comment-994053">
			June 27, 2012 at 10:31 am</a>		</div>

		<p>&gt; At what point do you give up trying to defend against inconsistent data from a trusted component?</p>
<p>I don&#39;t understand this. &nbsp;Every time you do a division, check for zero. &nbsp;Every time you calculate a &quot;disk full&quot; percentage, check that it&#39;s in the range 0 to 100. &nbsp;It doesn&#39;t matter where the numbers came from.</p>
<p>If you&#39;re a performance bottleneck, the rules change, but that&#39;s not the case here. Premature optimization blah blah blah.</p>
<div class="post">[<i>That&#39;s what the code did. It noticed that the percentage was out of range, so it clipped it to 100%. -Raymond</i>]</div>

		
				</div>
		</li><!-- #comment-## -->
		<li class="comment byuser comment-author-alegrigoriev even thread-even depth-1" id="comment-994063">
				<div id="div-comment-994063" class="comment-body">
				<div class="comment-author vcard">
						<cite class="fn"><a href='https://social.msdn.microsoft.com/profile/alegr1' rel='external nofollow' class='url'>alegr1</a></cite> <span class="says">says:</span>		</div>
		
		<div class="comment-meta commentmetadata"><a href="https://blogs.msdn.microsoft.com/oldnewthing/20120627-00/?p=7273#comment-994063">
			June 27, 2012 at 10:51 am</a>		</div>

		<p>&gt; At what point do you give up trying to defend against inconsistent data from a trusted component?</p>
<p>I don&#39;t see how a network storage running on possibly third-party reverse-engineered software can be considered a trusted component.</p>
<div class="post">[<i>It came in via the file system, which is trusted. (Because how can you defend against a rogue file system? &quot;I issued a read request, and it formatted the drive!&quot;) -Raymond</i>]</div>

		
				</div>
		</li><!-- #comment-## -->
		<li class="comment byuser comment-author-maurits odd alt thread-odd thread-alt depth-1" id="comment-994073">
				<div id="div-comment-994073" class="comment-body">
				<div class="comment-author vcard">
						<cite class="fn"><a href='https://social.msdn.microsoft.com/profile/Maurits+%5BMSFT%5D' rel='external nofollow' class='url'>Maurits [MSFT]</a></cite> <span class="says">says:</span>		</div>
		
		<div class="comment-meta commentmetadata"><a href="https://blogs.msdn.microsoft.com/oldnewthing/20120627-00/?p=7273#comment-994073">
			June 27, 2012 at 10:51 am</a>		</div>

		<p>I see&#8230; this is the difference between</p>
<p>float PercentFull(float capacity, float used);</p>
<p>and</p>
<p>HRESULT PercentFull(float capacity, float used, float *pPercent);</p>

		
				</div>
		</li><!-- #comment-## -->
		<li class="comment even thread-even depth-1" id="comment-994083">
				<div id="div-comment-994083" class="comment-body">
				<div class="comment-author vcard">
						<cite class="fn">Joshua</cite> <span class="says">says:</span>		</div>
		
		<div class="comment-meta commentmetadata"><a href="https://blogs.msdn.microsoft.com/oldnewthing/20120627-00/?p=7273#comment-994083">
			June 27, 2012 at 10:54 am</a>		</div>

		<p>[At what point do you give up trying to defend against inconsistent data from a trusted component? -Raymond]</p>
<p>Since when do you trust removable media? [Insert obvious cheap shot about viruses here.]</p>
<div class="post">[<i>We&#39;re not trusting the files on the media. We&#39;re trusting the <span style="text-decoration:underline;">driver</span>. If you can&#39;t trust a driver, then you&#39;re doomed. -Raymond</i>]</div>

		
				</div>
		</li><!-- #comment-## -->
		<li class="comment odd alt thread-odd thread-alt depth-1" id="comment-994093">
				<div id="div-comment-994093" class="comment-body">
				<div class="comment-author vcard">
						<cite class="fn"><a href='http://blogs.msdn.com/arcangelpip_4000_hotmail.com/ProfileUrlRedirect.ashx' rel='external nofollow' class='url'>arcangelpip@hotmail.com</a></cite> <span class="says">says:</span>		</div>
		
		<div class="comment-meta commentmetadata"><a href="https://blogs.msdn.microsoft.com/oldnewthing/20120627-00/?p=7273#comment-994093">
			June 27, 2012 at 11:14 am</a>		</div>

		<p>[It came in via the file system, which is trusted. (Because how can you defend against a rogue file system? &quot;I issued a read request, and it formatted the drive!&quot;) -Raymond]</p>
<p>So combining the two, you get a rouge TARDIS?</p>
<p>Anyway, with all the comments wondering about why Explorer does things like it does. I&#39;m wondering what the commenters would do instead. Block access to the network share? Wouldn&#39;t that result in complaints, &quot;Windows will not show my network share&quot;. With the percentage bar, what would people do differently? Make it empty, but surely that would result in complaints &quot;My drive has data on there, but Explorer is showing it as empty, useless Explorer&quot;. The data is simply meaningless in this situation, so there is no good solution. Especially when the share used is a well trusted network share.</p>

		
				</div>
		</li><!-- #comment-## -->
		<li class="comment byuser comment-author-maurits even thread-even depth-1" id="comment-994103">
				<div id="div-comment-994103" class="comment-body">
				<div class="comment-author vcard">
						<cite class="fn"><a href='https://social.msdn.microsoft.com/profile/Maurits+%5BMSFT%5D' rel='external nofollow' class='url'>Maurits [MSFT]</a></cite> <span class="says">says:</span>		</div>
		
		<div class="comment-meta commentmetadata"><a href="https://blogs.msdn.microsoft.com/oldnewthing/20120627-00/?p=7273#comment-994103">
			June 27, 2012 at 11:25 am</a>		</div>

		<p>&gt; what the commenters would do instead</p>
<p>Well, if it were me, I would display the usage and capacity information as reported, but simply not color the bar in at all, or perhaps do diagonal strips or something (similar to what Outlook does when you&#39;re trying to schedule a meeting with people but their Free/Busy information is not available.)</p>
<p>Also note that GetDiskFreeSpace can fail.</p>
<div class="post">[<i>That&#39;s an awful lot of work (adding a bitmap is expensive) for a fringe scenario. And how would you test it? -Raymond</i>]</div>

		
				</div>
		</li><!-- #comment-## -->
		<li class="comment odd alt thread-odd thread-alt depth-1" id="comment-994113">
				<div id="div-comment-994113" class="comment-body">
				<div class="comment-author vcard">
						<cite class="fn">Avi</cite> <span class="says">says:</span>		</div>
		
		<div class="comment-meta commentmetadata"><a href="https://blogs.msdn.microsoft.com/oldnewthing/20120627-00/?p=7273#comment-994113">
			June 27, 2012 at 11:40 am</a>		</div>

		<p>&quot;So combining the two, you get a rouge TARDIS?&quot; &#8212; Crescens2k</p>
<p>And everyone knows the TARDIS is blue!</p>

		
				</div>
		</li><!-- #comment-## -->
		<li class="comment byuser comment-author-alegrigoriev even thread-even depth-1" id="comment-994123">
				<div id="div-comment-994123" class="comment-body">
				<div class="comment-author vcard">
						<cite class="fn"><a href='https://social.msdn.microsoft.com/profile/alegr1' rel='external nofollow' class='url'>alegr1</a></cite> <span class="says">says:</span>		</div>
		
		<div class="comment-meta commentmetadata"><a href="https://blogs.msdn.microsoft.com/oldnewthing/20120627-00/?p=7273#comment-994123">
			June 27, 2012 at 11:42 am</a>		</div>

		<p>[It came in via the file system, which is trusted. (Because how can you defend against a rogue file system? &quot;I issued a read request, and it formatted the drive!&quot;) -Raymond]</p>
<p>You have to trust the kernel code. The kernel code cannot trust the media, even the fixed disk. If a partition table contains bogus data, that should not cause the partmgr.sys to fail with a bugcheck. That&#39;s the point. For example, if you insert a USB device with bogus descriptors, USBHUB should not bugcheck (that was the case once).</p>
<p>[And how would you test it? -Raymond]</p>
<p>Using Microsoft Windows Home Server, of course.</p>

		
				</div>
		</li><!-- #comment-## -->
		<li class="comment odd alt thread-odd thread-alt depth-1" id="comment-994133">
				<div id="div-comment-994133" class="comment-body">
				<div class="comment-author vcard">
						<cite class="fn"><a href='http://blogs.msdn.com/arcangelpip_4000_hotmail.com/ProfileUrlRedirect.ashx' rel='external nofollow' class='url'>arcangelpip@hotmail.com</a></cite> <span class="says">says:</span>		</div>
		
		<div class="comment-meta commentmetadata"><a href="https://blogs.msdn.microsoft.com/oldnewthing/20120627-00/?p=7273#comment-994133">
			June 27, 2012 at 1:10 pm</a>		</div>

		<p>@alger1</p>
<p>The thing is, since this is via the network redirector, and the share is connected properly, this means that the file system driver on the server is up and running properly. If there was any problems, the partition would just fail to mount in the first place. In that case the share would just refuse to work and not even get this far. So the fact that everything is working implies that there is no problems that the driver would choke on.</p>
<p>So you can&#39;t say for sure that this is a case of the driver just implicitly trusting the media. This is a network share so the server would be responsible for all of that. Since this is a share, it is a matter of sending and receiving packets over SMB or whatever NFS uses, and so it is as far removed from the physical media as it can get.</p>

		
				</div>
		</li><!-- #comment-## -->
		<li class="comment byuser comment-author-maurits even thread-even depth-1" id="comment-994143">
				<div id="div-comment-994143" class="comment-body">
				<div class="comment-author vcard">
						<cite class="fn"><a href='https://social.msdn.microsoft.com/profile/Maurits+%5BMSFT%5D' rel='external nofollow' class='url'>Maurits [MSFT]</a></cite> <span class="says">says:</span>		</div>
		
		<div class="comment-meta commentmetadata"><a href="https://blogs.msdn.microsoft.com/oldnewthing/20120627-00/?p=7273#comment-994143">
			June 27, 2012 at 2:03 pm</a>		</div>

		<p>I didn&#39;t say it would be worth changing, just that it would be a reasonable alternative design.</p>

		
				</div>
		</li><!-- #comment-## -->
		<li class="comment byuser comment-author-alegrigoriev odd alt thread-odd thread-alt depth-1" id="comment-994153">
				<div id="div-comment-994153" class="comment-body">
				<div class="comment-author vcard">
						<cite class="fn"><a href='https://social.msdn.microsoft.com/profile/alegr1' rel='external nofollow' class='url'>alegr1</a></cite> <span class="says">says:</span>		</div>
		
		<div class="comment-meta commentmetadata"><a href="https://blogs.msdn.microsoft.com/oldnewthing/20120627-00/?p=7273#comment-994153">
			June 27, 2012 at 2:13 pm</a>		</div>

		<p>I hope the Windows SMB client doesn&#39;t trust the server too much. What if the server sends malformed packets and that causes the memory corruption and arbitrary code execution?</p>
<div class="post">[<i>That&#39;s the SMB driver&#39;s problem, not Explorer&#39;s. -Raymond</i>]</div>

		
				</div>
		</li><!-- #comment-## -->
		<li class="comment even thread-even depth-1" id="comment-994163">
				<div id="div-comment-994163" class="comment-body">
				<div class="comment-author vcard">
						<cite class="fn">Joshua</cite> <span class="says">says:</span>		</div>
		
		<div class="comment-meta commentmetadata"><a href="https://blogs.msdn.microsoft.com/oldnewthing/20120627-00/?p=7273#comment-994163">
			June 27, 2012 at 3:30 pm</a>		</div>

		<p>alegrl:</p>
<blockquote><p>
  Using Microsoft Windows Home Server, of course.
</p></blockquote>
<p>Feeling sharp?</p>

		
				</div>
		</li><!-- #comment-## -->
		<li class="comment odd alt thread-odd thread-alt depth-1" id="comment-994173">
				<div id="div-comment-994173" class="comment-body">
				<div class="comment-author vcard">
						<cite class="fn">Klimax</cite> <span class="says">says:</span>		</div>
		
		<div class="comment-meta commentmetadata"><a href="https://blogs.msdn.microsoft.com/oldnewthing/20120627-00/?p=7273#comment-994173">
			June 27, 2012 at 3:32 pm</a>		</div>

		<p>Some people should checkout security updates(oatches) with SMB in name and description. (something always slips past SDL no matter what)</p>

		
				</div>
		</li><!-- #comment-## -->
		<li class="comment even thread-even depth-1" id="comment-994203">
				<div id="div-comment-994203" class="comment-body">
				<div class="comment-author vcard">
						<cite class="fn">voo</cite> <span class="says">says:</span>		</div>
		
		<div class="comment-meta commentmetadata"><a href="https://blogs.msdn.microsoft.com/oldnewthing/20120627-00/?p=7273#comment-994203">
			June 27, 2012 at 4:14 pm</a>		</div>

		<p>Seems to me that doing lots of additional work (basically what Maurits proposes) for a case that shouldn&#39;t happen in the first place and if it happens only results in a slightly ugly looking GUI is a pretty bad idea. Yes, as soon as the team has finished doing everything else on their list, why not &#8211; but since that won&#39;t happen before 2025 (and that only if they stopped accepting new features and bugs right now) this seems like a sensible tradeoff.</p>
<p>If the wrong data caused explorer to fail in some spectacular manner? Sure fix it, but &quot;it shows a negative value and a full bar&quot; is a pretty minor thing.. especially since the fix wouldn&#39;t be perfect either (hard to be perfect if you only have useless information available).</p>

		
				</div>
		</li><!-- #comment-## -->
		<li class="comment byuser comment-author-maurits odd alt thread-odd thread-alt depth-1" id="comment-994213">
				<div id="div-comment-994213" class="comment-body">
				<div class="comment-author vcard">
						<cite class="fn"><a href='https://social.msdn.microsoft.com/profile/Maurits+%5BMSFT%5D' rel='external nofollow' class='url'>Maurits [MSFT]</a></cite> <span class="says">says:</span>		</div>
		
		<div class="comment-meta commentmetadata"><a href="https://blogs.msdn.microsoft.com/oldnewthing/20120627-00/?p=7273#comment-994213">
			June 27, 2012 at 4:49 pm</a>		</div>

		<p>Wow, I didn&#39;t think defensive programming was so controversial :-)</p>
<p>About 2/3 of my code tends to be error handling.</p>

		
				</div>
		</li><!-- #comment-## -->
		<li class="comment byuser comment-author-mikebmcl even thread-even depth-1" id="comment-994223">
				<div id="div-comment-994223" class="comment-body">
				<div class="comment-author vcard">
						<cite class="fn"><a href='https://social.msdn.microsoft.com/profile/MikeBMcL' rel='external nofollow' class='url'>MikeBMcL</a></cite> <span class="says">says:</span>		</div>
		
		<div class="comment-meta commentmetadata"><a href="https://blogs.msdn.microsoft.com/oldnewthing/20120627-00/?p=7273#comment-994223">
			June 27, 2012 at 6:38 pm</a>		</div>

		<p>@alegr1 I think the point Antonio Rodrigues was trying to make is that a SMB driver cannot possibly validate all data sent through it since it has no idea whether the data is an Excel spreadsheet, a plain text file, an EXE, a DLL, a log file, a virus being sent for analysis, an actual virus that will infect the computer, etc., etc., etc. It should validate that the packets conform to the SMB specs (and any other applicable specs), but beyond that it simply cannot validate every last bit of data because it doesn&#39;t know what that data is. (That&#39;s what antivirus software is for.)</p>
<p>Windows must trust drivers otherwise your computer cannot ever use hardware at all. And Microsoft cannot make drivers for every possible piece of equipment that might ever exist, but they do have generic drivers that work fine for many major components (though good luck using a generic video driver; there&#39;s a reason that Safe Mode doesn&#39;t look very good).</p>

		
				</div>
		</li><!-- #comment-## -->
		<li class="comment odd alt thread-odd thread-alt depth-1" id="comment-994233">
				<div id="div-comment-994233" class="comment-body">
				<div class="comment-author vcard">
						<cite class="fn">Kzinti</cite> <span class="says">says:</span>		</div>
		
		<div class="comment-meta commentmetadata"><a href="https://blogs.msdn.microsoft.com/oldnewthing/20120627-00/?p=7273#comment-994233">
			June 27, 2012 at 7:17 pm</a>		</div>

		<p>&quot;So combining the two, you get a rouge TARDIS?&quot;</p>
<p>The TARDIS is blue, how dare you.</p>

		
				</div>
		</li><!-- #comment-## -->
		<li class="comment even thread-even depth-1" id="comment-994263">
				<div id="div-comment-994263" class="comment-body">
				<div class="comment-author vcard">
						<cite class="fn"><a href='http://blogs.msdn.com/tawnos_4000_gmail.com/ProfileUrlRedirect.ashx' rel='external nofollow' class='url'>tawnos@gmail.com</a></cite> <span class="says">says:</span>		</div>
		
		<div class="comment-meta commentmetadata"><a href="https://blogs.msdn.microsoft.com/oldnewthing/20120627-00/?p=7273#comment-994263">
			June 27, 2012 at 8:47 pm</a>		</div>

		<p>@Maurits</p>
<p>I think Raymond&#39;s point is that there&#39;s a limit to the amount of effort that&#39;s worth investing into a hypercube&#39;s corner condition. Even though I can imagine how to test it (mock the network replies, give bad values back), if it doesn&#39;t crash, I doubt this would even make the MQ bar. Every feature is at -100 points, after all&#8230;.</p>

		
				</div>
		</li><!-- #comment-## -->
		<li class="comment odd alt thread-odd thread-alt depth-1" id="comment-994273">
				<div id="div-comment-994273" class="comment-body">
				<div class="comment-author vcard">
						<cite class="fn">Engywuck</cite> <span class="says">says:</span>		</div>
		
		<div class="comment-meta commentmetadata"><a href="https://blogs.msdn.microsoft.com/oldnewthing/20120627-00/?p=7273#comment-994273">
			June 27, 2012 at 10:20 pm</a>		</div>

		<p>@Kzinti: a normally operating TARDIS may be blue, but this is a rogue one, so it may well be red&#8230;</p>

		
				</div>
		</li><!-- #comment-## -->
		<li class="comment even thread-even depth-1" id="comment-994183">
				<div id="div-comment-994183" class="comment-body">
				<div class="comment-author vcard">
						<cite class="fn">Antonio Rodr&#237;guez</cite> <span class="says">says:</span>		</div>
		
		<div class="comment-meta commentmetadata"><a href="https://blogs.msdn.microsoft.com/oldnewthing/20120627-00/?p=7273#comment-994183">
			June 27, 2012 at 3:32 pm</a>		</div>

		<p>I think many commenters are ofrgetting the obvious: a computer system is based on trust. It is a *system*, a set of components that work together to achieve an end (in this case, managing the hardware and letting the user run applications). And as in every system, there has to be some kind of trust between its components. The application trusts the Win32/Win64 subsystem, which in turn trusts the I/O manager, which trusts the filesystem driver, which trusts the filter driver(s) (if any), which trust the port driver, which trusts the miniport driver, which trust the IDE/SATA/SCSI/SAS controller, which trusts the hard drive or SSD. Sometimes it&#39;s amazing to see all of this work reliably!</p>
<p>The SMB client filesystem driver, of course, has to trust the information send by the server over the network. It can (and must) do some sanity checks to avoid chocking on corrupt or malformed packets, but has no way to test the validity of every individual value.</p>
<p>That&#39;s what people don&#39;t understand. They go applying unofficial BIOS updates, drivers downloaded from who knows where, and overclocking the computer. Then it hangs or bluescreens, and of course, it&#39;s Windows&#39; blame. I always use drivers from Microsoft or the manufacturer, and never install third party kernel-mode software or run the hardware outside its specifications, and I barely see a bluescreen in years, even if my computer is running 24/7.</p>

		
				</div>
		</li><!-- #comment-## -->
		<li class="comment byuser comment-author-alegrigoriev odd alt thread-odd thread-alt depth-1" id="comment-994193">
				<div id="div-comment-994193" class="comment-body">
				<div class="comment-author vcard">
						<cite class="fn"><a href='https://social.msdn.microsoft.com/profile/alegr1' rel='external nofollow' class='url'>alegr1</a></cite> <span class="says">says:</span>		</div>
		
		<div class="comment-meta commentmetadata"><a href="https://blogs.msdn.microsoft.com/oldnewthing/20120627-00/?p=7273#comment-994193">
			June 27, 2012 at 3:53 pm</a>		</div>

		<p>Antonio Rodrigues,</p>
<p>Even first tier OEMs (think *first*) could release BIOS and video drivers that would crash the system periodically on very low level, without even allowing to save a crashdump. There is no perfect IHV/ISV. Of course, one better buys devices that are supported by a generic inbox driver. I would not want a webcam that requires an IHV driver. Although I learned that hard way.</p>
<p>But an SMB client CANNOT trust a remote server. Any network information crosses the trust boundary, and is untrusted by definition. An user application can&#39;t do anything about validity of data, but the service has to validate all metadata.</p>

		
				</div>
		</li><!-- #comment-## -->
		<li class="comment even thread-even depth-1" id="comment-994283">
				<div id="div-comment-994283" class="comment-body">
				<div class="comment-author vcard">
						<cite class="fn"><a href='http://blogs.msdn.com/arcangelpip_4000_hotmail.com/ProfileUrlRedirect.ashx' rel='external nofollow' class='url'>arcangelpip@hotmail.com</a></cite> <span class="says">says:</span>		</div>
		
		<div class="comment-meta commentmetadata"><a href="https://blogs.msdn.microsoft.com/oldnewthing/20120627-00/?p=7273#comment-994283">
			June 27, 2012 at 11:27 pm</a>		</div>

		<p>@alegr1</p>
<p>What does this have to do with anything in the post? The post was about a funny situation where the network share server reported a free space value higher than the total space value. How is that showing any kind of trust? Just because Explorer is dutifully reporting what it was given, that doesn&#39;t mean anything about the level of trust involved in the SMB client. Also, any conversation about that is out of scope here since it has nothing to do with Explorer. Network shares are not controlled by Explorer after all, they are controlled by a completely different component of Windows.</p>
<p>Also think about it, what could Explorer do in this situation? If the drive has already been mapped then that means the connection to the server has already been made, so nothing Explorer could do at this point would help any. Anyway, how long has SMB been around now? The NT driver was definitely in Windows NT 3, so we have had since the 1990s for people to come up with all sorts of attacks against the driver, and there have been may hotfixes for a long time. So I think by now Microsoft know that the SMB client and SMB server are a source of attacks. I also think that Microsoft don&#39;t trust the other end at all.</p>

		
				</div>
		</li><!-- #comment-## -->
		<li class="comment odd alt thread-odd thread-alt depth-1" id="comment-994293">
				<div id="div-comment-994293" class="comment-body">
				<div class="comment-author vcard">
						<cite class="fn"><a href='http://blogs.msdn.com/arcangelpip_4000_hotmail.com/ProfileUrlRedirect.ashx' rel='external nofollow' class='url'>arcangelpip@hotmail.com</a></cite> <span class="says">says:</span>		</div>
		
		<div class="comment-meta commentmetadata"><a href="https://blogs.msdn.microsoft.com/oldnewthing/20120627-00/?p=7273#comment-994293">
			June 27, 2012 at 11:30 pm</a>		</div>

		<p>@Everyone else concerning my TARDIS comment</p>
<p>Erm, that rouge was meant to be rogue. So it was meant to be a rogue TARDIS</p>

		
				</div>
		</li><!-- #comment-## -->
		<li class="comment even thread-even depth-1" id="comment-994313">
				<div id="div-comment-994313" class="comment-body">
				<div class="comment-author vcard">
						<cite class="fn">ender</cite> <span class="says">says:</span>		</div>
		
		<div class="comment-meta commentmetadata"><a href="https://blogs.msdn.microsoft.com/oldnewthing/20120627-00/?p=7273#comment-994313">
			June 28, 2012 at 1:57 am</a>		</div>

		<p>@Crescens2k: AFAIK, much of the filesharing stuff was rewritten with Vista, and IIRC, there was an exploit later that only affected Vista and Server 2008, but not older versions of Windows.</p>

		
				</div>
		</li><!-- #comment-## -->
		<li class="comment odd alt thread-odd thread-alt depth-1" id="comment-994243">
				<div id="div-comment-994243" class="comment-body">
				<div class="comment-author vcard">
						<cite class="fn">Simon</cite> <span class="says">says:</span>		</div>
		
		<div class="comment-meta commentmetadata"><a href="https://blogs.msdn.microsoft.com/oldnewthing/20120627-00/?p=7273#comment-994243">
			June 27, 2012 at 7:59 pm</a>		</div>

		<p>@Maurits &#8211; nothing wrong with defensive programming, but there are limits. Would you *really* write some simple feature like this one, in the assumption that you can&#39;t trust the information the kernel is supplying you?</p>

		
				</div>
		</li><!-- #comment-## -->
		<li class="comment even thread-even depth-1" id="comment-994323">
				<div id="div-comment-994323" class="comment-body">
				<div class="comment-author vcard">
						<cite class="fn">voo</cite> <span class="says">says:</span>		</div>
		
		<div class="comment-meta commentmetadata"><a href="https://blogs.msdn.microsoft.com/oldnewthing/20120627-00/?p=7273#comment-994323">
			June 28, 2012 at 4:59 am</a>		</div>

		<p>@Maurits So how much of your time are you spending defensively programming against rare errors that lead to cosmetic problems? Yes that does seem controversial if you could at the same time fix, you know, errors that lead to the process crashing (explorer still does some of those).</p>

		
				</div>
		</li><!-- #comment-## -->
		<li class="comment odd alt thread-odd thread-alt depth-1" id="comment-994333">
				<div id="div-comment-994333" class="comment-body">
				<div class="comment-author vcard">
						<cite class="fn">Simon R</cite> <span class="says">says:</span>		</div>
		
		<div class="comment-meta commentmetadata"><a href="https://blogs.msdn.microsoft.com/oldnewthing/20120627-00/?p=7273#comment-994333">
			June 28, 2012 at 5:16 am</a>		</div>

		<p>[And how would you test it? -Raymond]</p>
<p>You mean Windows Explorer isn&#39;t architected to allow unit testing and plugging in mock objects&#8230;? &nbsp;:p</p>

		
				</div>
		</li><!-- #comment-## -->
		<li class="comment even thread-even depth-1" id="comment-994423">
				<div id="div-comment-994423" class="comment-body">
				<div class="comment-author vcard">
						<cite class="fn">kbiel</cite> <span class="says">says:</span>		</div>
		
		<div class="comment-meta commentmetadata"><a href="https://blogs.msdn.microsoft.com/oldnewthing/20120627-00/?p=7273#comment-994423">
			June 28, 2012 at 8:11 am</a>		</div>

		<p>@Maurits</p>
<p>It depends on your level of defensive programming. If by defensive programming, you mean that we should check inputs for conditions that could cause catastrophic failure (i.e. does this parameter that I intend to use as a divisor hold a value of 0) then I think there is no controversy. But if your idea of defensive programming, as it would seem by your comments, is to partially or fully re-implement some other layer&#39;s logic because other programmers are not to be trusted, then you&#39;ve lost me and probably a whole lot of people.</p>
<p>In this specific example, you are asking a UI layer to re-implement logic regarding permissible values which it has no control over, can not correct, and really can not anticipate every possible situation without itself being more intelligent about the inner workings of other layers of software and hardware. This is the UI layer after all. So, as Raymond pointed out, the only defensive logic it needs to implement is to check for values that are impossible to display (i.e. it can&#39;t display greater than 100% so clip it).</p>

		
				</div>
		</li><!-- #comment-## -->
		<li class="comment odd alt thread-odd thread-alt depth-1" id="comment-994453">
				<div id="div-comment-994453" class="comment-body">
				<div class="comment-author vcard">
						<cite class="fn">Horst Kiehl</cite> <span class="says">says:</span>		</div>
		
		<div class="comment-meta commentmetadata"><a href="https://blogs.msdn.microsoft.com/oldnewthing/20120627-00/?p=7273#comment-994453">
			June 28, 2012 at 8:21 am</a>		</div>

		<p>@Crescens2k: You could&#39;ve said it was intentional: if it&#39;s a &quot;rogue TARDIS&quot; that&#39;s also red, well, c&#39;est TARDIS rouge! (Please forgive my broken French!)</p>

		
				</div>
		</li><!-- #comment-## -->
		<li class="comment even thread-even depth-1" id="comment-994543">
				<div id="div-comment-994543" class="comment-body">
				<div class="comment-author vcard">
						<cite class="fn">Anonymous Coward</cite> <span class="says">says:</span>		</div>
		
		<div class="comment-meta commentmetadata"><a href="https://blogs.msdn.microsoft.com/oldnewthing/20120627-00/?p=7273#comment-994543">
			June 28, 2012 at 9:47 am</a>		</div>

		<p>@alegr1: ‘Using Microsoft Windows Home Server, of course.’</p>
<p>Thank you. I gave me a laugh, which I sorely needed.</p>

		
				</div>
		</li><!-- #comment-## -->
		<li class="comment odd alt thread-odd thread-alt depth-1" id="comment-994693">
				<div id="div-comment-994693" class="comment-body">
				<div class="comment-author vcard">
						<cite class="fn">Gabe</cite> <span class="says">says:</span>		</div>
		
		<div class="comment-meta commentmetadata"><a href="https://blogs.msdn.microsoft.com/oldnewthing/20120627-00/?p=7273#comment-994693">
			June 28, 2012 at 10:50 am</a>		</div>

		<p>I&#39;d like to know what icon the underlined O is supposed to represent in the &quot;ASCII art&quot;.</p>

		
				</div>
		</li><!-- #comment-## -->
		<li class="comment byuser comment-author-maurits even thread-even depth-1" id="comment-994723">
				<div id="div-comment-994723" class="comment-body">
				<div class="comment-author vcard">
						<cite class="fn"><a href='https://social.msdn.microsoft.com/profile/Maurits+%5BMSFT%5D' rel='external nofollow' class='url'>Maurits [MSFT]</a></cite> <span class="says">says:</span>		</div>
		
		<div class="comment-meta commentmetadata"><a href="https://blogs.msdn.microsoft.com/oldnewthing/20120627-00/?p=7273#comment-994723">
			June 28, 2012 at 10:57 am</a>		</div>

		<p>Oh, good, there&#39;s already an HRESULT in play.</p>
<blockquote><p>
  The question is whether you want to return E_TARDIS to callers
</p></blockquote>
<p>I think so, yes.</p>
<blockquote><p>
  Do you have confidence that every third party app can handle the case where a drive cannot report its percent full?
</p></blockquote>
<p>I don&#39;t know. &nbsp;I suppose if there was a popular third party app that didn&#39;t handle the case (maybe they don&#39;t even check the HRESULT) then we would have to shim it. &nbsp;What does GetDetailsEx do if GetDiskFreeSpaceEx fails? &nbsp;I suppose I could look it up&#8230;</p>

		
				</div>
		</li><!-- #comment-## -->
		<li class="comment odd alt thread-odd thread-alt depth-1" id="comment-994793">
				<div id="div-comment-994793" class="comment-body">
				<div class="comment-author vcard">
						<cite class="fn">Jonathan_S</cite> <span class="says">says:</span>		</div>
		
		<div class="comment-meta commentmetadata"><a href="https://blogs.msdn.microsoft.com/oldnewthing/20120627-00/?p=7273#comment-994793">
			June 28, 2012 at 12:27 pm</a>		</div>

		<p>@gabe &#8211; I think it&#39;s suppose to be the windows networked drive icon. &nbsp;The drive with (what looks like) a 10base2 network cable running below/connect to it. (for example: <a rel="nofollow" target="_new" href="http://img.lib.msu.edu/computers/afsfiles.jpg" rel="nofollow">img.lib.msu.edu/&#8230;/afsfiles.jpg</a>)</p>
<p>Maybe</p>
<p>■</p>
<p>╧</p>
<p>would have been clearer, but probably not.</p>

		
				</div>
		</li><!-- #comment-## -->
		<li class="comment byuser comment-author-maurits even thread-even depth-1" id="comment-994653">
				<div id="div-comment-994653" class="comment-body">
				<div class="comment-author vcard">
						<cite class="fn"><a href='https://social.msdn.microsoft.com/profile/Maurits+%5BMSFT%5D' rel='external nofollow' class='url'>Maurits [MSFT]</a></cite> <span class="says">says:</span>		</div>
		
		<div class="comment-meta commentmetadata"><a href="https://blogs.msdn.microsoft.com/oldnewthing/20120627-00/?p=7273#comment-994653">
			June 28, 2012 at 10:29 am</a>		</div>

		<p>&gt; partially or fully re-implement some other layer&#39;s logic</p>
<p>I see&#8230;</p>
<p>No, I&#39;m definitely not suggesting that. &nbsp;I infer from this thread (I haven&#39;t looked at the code) that there&#39;s a function somewhere that looks like this:</p>
<p>float PercentFull(float capacity, float used);</p>
<p>This is either clipping to 100% internally, or is returning a value that is being clipped in the client.</p>
<p>What I&#39;m suggesting instead is a function that looks like this:</p>
<p>HRESULT PercentFull(float capacity, float used, float *pPercent);</p>
<p>This would fail instead of clipping. &nbsp;On failure, the client would skip the code that painted the &quot;full&quot; rectangle. &nbsp;The client doesn&#39;t need to care *why* the percentage couldn&#39;t be calculated (because the capacity was zero, or used was &gt; capacity, etc., etc.)</p>
<p>I&#39;m not suggesting that this scenario is compelling enough to merit a change to the existing implementation.</p>
<div class="post">[<i>It&#39;s neither. The function is HRESULT IShellFolder::GetDetailsEx() where the requested property is PKEY_PercentFull. The question is whether you want to return E_TARDIS to callers. Do you have confidence that every third party app can handle the case where a drive cannot report its percent full? -Raymond</i>]</div>

		
				</div>
		</li><!-- #comment-## -->
		<li class="comment byuser comment-author-maurits odd alt thread-odd thread-alt depth-1" id="comment-995343">
				<div id="div-comment-995343" class="comment-body">
				<div class="comment-author vcard">
						<cite class="fn"><a href='https://social.msdn.microsoft.com/profile/Maurits+%5BMSFT%5D' rel='external nofollow' class='url'>Maurits [MSFT]</a></cite> <span class="says">says:</span>		</div>
		
		<div class="comment-meta commentmetadata"><a href="https://blogs.msdn.microsoft.com/oldnewthing/20120627-00/?p=7273#comment-995343">
			June 30, 2012 at 2:00 am</a>		</div>

		<p>Since the output of GetDetailsEx is a VARIANT, another option is to return S_OK with a VT_EMPTY variant; this is idiomatic for &quot;the disk doesn&#39;t have a &#39;fullness&#39; property.&quot; &nbsp;On the other hand this violates typeInfo.</p>

		
				</div>
		</li><!-- #comment-## -->
		</ol><!-- .comment-list -->

		<div class="navigation pagination">
					</div>

	
			<p class="no-comments">Comments are closed.</p>
<!-- COMMENTS END -->
</div></td></tr></table>