<table class="commenttable" cellspacing="0" cellpadding="0"><tr><td><div class="commentdiv"><div class="commentdivhdr">
<!-- COMMENTS START -->
Comments (21)	</div>

	
			<div class="navigation pagination clear-both">
					</div>

		<ol class="comment-list">
					<li class="comment even thread-even depth-1" id="comment-1249346">
				<div id="div-comment-1249346" class="comment-body">
				<div class="comment-author vcard">
						<cite class="fn">Joshua</cite> <span class="says">says:</span>		</div>
		
		<div class="comment-meta commentmetadata"><a href="https://blogs.msdn.microsoft.com/oldnewthing/20160518-00/?p=93485#comment-1249346">
			May 18, 2016 at 8:17 am</a>		</div>

		<p>Wise customer.</p>

		
				</div>
		</li><!-- #comment-## -->
		<li class="comment byuser comment-author-fredericmagnyf odd alt thread-odd thread-alt depth-1" id="comment-1249355">
				<div id="div-comment-1249355" class="comment-body">
				<div class="comment-author vcard">
						<cite class="fn"><a href='https://social.msdn.microsoft.com/profile/Medinoc' rel='external nofollow' class='url'>Medinoc</a></cite> <span class="says">says:</span>		</div>
		
		<div class="comment-meta commentmetadata"><a href="https://blogs.msdn.microsoft.com/oldnewthing/20160518-00/?p=93485#comment-1249355">
			May 18, 2016 at 8:19 am</a>		</div>

		<p>At first I wondered why close the thread token in step 1, but apparently the thing is that GetCurrentThreadToken() returns a pseudo-handle, therefore DuplicateHandle() is necessary (and thus, step 1 does create a new token handle that must be closed).</p>

		
				</div>
		</li><!-- #comment-## -->
		<li class="comment byuser comment-author-matteo even thread-even depth-1" id="comment-1249365">
				<div id="div-comment-1249365" class="comment-body">
				<div class="comment-author vcard">
						<cite class="fn"><a href='https://social.msdn.microsoft.com/profile/Matteo+Italia' rel='external nofollow' class='url'>Matteo Italia</a></cite> <span class="says">says:</span>		</div>
		
		<div class="comment-meta commentmetadata"><a href="https://blogs.msdn.microsoft.com/oldnewthing/20160518-00/?p=93485#comment-1249365">
			May 18, 2016 at 10:19 am</a>		</div>

		<p>It&#8217;s a bit disappointing that this special case is actually necessary, this is a case where a model similar to device contexts (where there&#8217;s always a valid &#8220;something&#8221; selected, even if a &#8220;magic&#8221; null one, and there&#8217;s a SelectObject-like to perform switches) would have proven nicer to work with.</p>

		
				</div>
		</li><!-- #comment-## -->
		<li class="comment odd alt thread-odd thread-alt depth-1 parent" id="comment-1249375">
				<div id="div-comment-1249375" class="comment-body">
				<div class="comment-author vcard">
						<cite class="fn">Thomas Anderson</cite> <span class="says">says:</span>		</div>
		
		<div class="comment-meta commentmetadata"><a href="https://blogs.msdn.microsoft.com/oldnewthing/20160518-00/?p=93485#comment-1249375">
			May 18, 2016 at 11:39 am</a>		</div>

		<p>The SetThreadToken docs say &#8220;If Token is NULL, the function causes the thread to stop using an impersonation token.&#8221;.  So you should be able to pass NULL in step 4 in the case where GetThreadToken failed. (I think?).</p>

		
				</div>
		<ol class="children">
		<li class="comment byuser comment-author-oldnewthing bypostauthor even depth-2" id="comment-1249385">
				<div id="div-comment-1249385" class="comment-body">
				<div class="comment-author vcard">
						<cite class="fn"><a href='https://social.msdn.microsoft.com/profile/Raymond+Chen+-+MSFT' rel='external nofollow' class='url'>Raymond Chen - MSFT</a></cite> <span class="says">says:</span>		</div>
		
		<div class="comment-meta commentmetadata"><a href="https://blogs.msdn.microsoft.com/oldnewthing/20160518-00/?p=93485#comment-1249385">
			May 18, 2016 at 2:42 pm</a>		</div>

		<p>Yup, that&#8217;s certainly simpler.</p>

		
				</div>
		</li><!-- #comment-## -->
		<li class="comment odd alt depth-2" id="comment-1249405">
				<div id="div-comment-1249405" class="comment-body">
				<div class="comment-author vcard">
						<cite class="fn">Neil</cite> <span class="says">says:</span>		</div>
		
		<div class="comment-meta commentmetadata"><a href="https://blogs.msdn.microsoft.com/oldnewthing/20160518-00/?p=93485#comment-1249405">
			May 19, 2016 at 3:25 am</a>		</div>

		<p>&#8220;causes the thread to stop using an impersonation token&#8221; sounds like the phrase that should have been used to describe the effect of RevertToSelf.</p>

		
				</div>
		</li><!-- #comment-## -->
</ol><!-- .children -->
</li><!-- #comment-## -->
		<li class="comment even thread-even depth-1 parent" id="comment-1249386">
				<div id="div-comment-1249386" class="comment-body">
				<div class="comment-author vcard">
						<cite class="fn">andy_k</cite> <span class="says">says:</span>		</div>
		
		<div class="comment-meta commentmetadata"><a href="https://blogs.msdn.microsoft.com/oldnewthing/20160518-00/?p=93485#comment-1249386">
			May 18, 2016 at 9:46 pm</a>		</div>

		<p>&gt; When it returns, impersonation has terminated. It is an ex-impersonation.</p>
<p>The impersonation is not dead, it&#8217;s resting.</p>

		
				</div>
		<ol class="children">
		<li class="comment odd alt depth-2" id="comment-1249895">
				<div id="div-comment-1249895" class="comment-body">
				<div class="comment-author vcard">
						<cite class="fn">The_Assimilator</cite> <span class="says">says:</span>		</div>
		
		<div class="comment-meta commentmetadata"><a href="https://blogs.msdn.microsoft.com/oldnewthing/20160518-00/?p=93485#comment-1249895">
			May 23, 2016 at 1:48 am</a>		</div>

		<p>This impersonation is deceased! It is DEMISED!</p>

		
				</div>
		</li><!-- #comment-## -->
</ol><!-- .children -->
</li><!-- #comment-## -->
		<li class="comment byuser comment-author-raykoopa even thread-odd thread-alt depth-1" id="comment-1249396">
				<div id="div-comment-1249396" class="comment-body">
				<div class="comment-author vcard">
						<cite class="fn"><a href='https://social.msdn.microsoft.com/profile/Ray+Koopa' rel='external nofollow' class='url'>Ray Koopa</a></cite> <span class="says">says:</span>		</div>
		
		<div class="comment-meta commentmetadata"><a href="https://blogs.msdn.microsoft.com/oldnewthing/20160518-00/?p=93485#comment-1249396">
			May 19, 2016 at 12:46 am</a>		</div>

		<p>I totally agree with you that &#8220;ClearThreadToken&#8221; might have been a better name.</p>

		
				</div>
		</li><!-- #comment-## -->
		<li class="comment byuser comment-author-fleet-command odd alt thread-even depth-1 parent" id="comment-1249415">
				<div id="div-comment-1249415" class="comment-body">
				<div class="comment-author vcard">
						<cite class="fn"><a href='https://social.msdn.microsoft.com/profile/Fleet+Command' rel='external nofollow' class='url'>Fleet Command</a></cite> <span class="says">says:</span>		</div>
		
		<div class="comment-meta commentmetadata"><a href="https://blogs.msdn.microsoft.com/oldnewthing/20160518-00/?p=93485#comment-1249415">
			May 19, 2016 at 3:25 am</a>		</div>

		<p>Mr Chen, it appears your blog&#8217;s font problem (mentioned in previous feedbacks) is still not resolved. The blog looks awful on any system other than Windows Vista or later. (That means iPhone, iPad, Android tablets and phones, etc.) If I am remembering right, you said you&#8217;ve filed a ticket with your &#8230; webmaster or webmistress?</p>
<p>Your neighboring Windows PowerShell Blog seems to have solved this problem already.</p>

		
				</div>
		<ol class="children">
		<li class="comment even depth-2 parent" id="comment-1249425">
				<div id="div-comment-1249425" class="comment-body">
				<div class="comment-author vcard">
						<cite class="fn">Boris</cite> <span class="says">says:</span>		</div>
		
		<div class="comment-meta commentmetadata"><a href="https://blogs.msdn.microsoft.com/oldnewthing/20160518-00/?p=93485#comment-1249425">
			May 19, 2016 at 3:33 am</a>		</div>

		<p>I just want the old color scheme back, since white on black is more about uniformity and loss of identity among so many other MSDN blogs. The spirit of oldnewthing requires adaptation to new requirements and technology while also maintaining continuity with the past.</p>

		
				</div>
		<ol class="children">
		<li class="comment odd alt depth-3 parent" id="comment-1249435">
				<div id="div-comment-1249435" class="comment-body">
				<div class="comment-author vcard">
						<cite class="fn">Ron O</cite> <span class="says">says:</span>		</div>
		
		<div class="comment-meta commentmetadata"><a href="https://blogs.msdn.microsoft.com/oldnewthing/20160518-00/?p=93485#comment-1249435">
			May 19, 2016 at 5:03 am</a>		</div>

		<p>A current/recommended solution is to use the Stylish plugin/extension (I know it&#8217;s available for both Firefox and Chrome) and then add The Old New Thing Classic Style (<a href="https://userstyles.org/styles/121616/the-old-new-thing-classic-style" rel="nofollow">https://userstyles.org/styles/121616/the-old-new-thing-classic-style</a>).</p>

		
				</div>
		<ol class="children">
		<li class="comment even depth-4" id="comment-1249445">
				<div id="div-comment-1249445" class="comment-body">
				<div class="comment-author vcard">
						<cite class="fn"><a href='http://www.dox.com.au' rel='external nofollow' class='url'>Ian Yates</a></cite> <span class="says">says:</span>		</div>
		
		<div class="comment-meta commentmetadata"><a href="https://blogs.msdn.microsoft.com/oldnewthing/20160518-00/?p=93485#comment-1249445">
			May 19, 2016 at 6:03 am</a>		</div>

		<p>Thanks for the stylish link.  The familiar blog is back! :)</p>

		
				</div>
		</li><!-- #comment-## -->
</ol><!-- .children -->
</li><!-- #comment-## -->
		<li class="comment byuser comment-author-fleet-command odd alt depth-3" id="comment-1249455">
				<div id="div-comment-1249455" class="comment-body">
				<div class="comment-author vcard">
						<cite class="fn"><a href='https://social.msdn.microsoft.com/profile/Fleet+Command' rel='external nofollow' class='url'>Fleet Command</a></cite> <span class="says">says:</span>		</div>
		
		<div class="comment-meta commentmetadata"><a href="https://blogs.msdn.microsoft.com/oldnewthing/20160518-00/?p=93485#comment-1249455">
			May 19, 2016 at 7:05 am</a>		</div>

		<p>Hijacker!</p>

		
				</div>
		</li><!-- #comment-## -->
</ol><!-- .children -->
</li><!-- #comment-## -->
		<li class="comment byuser comment-author-oldnewthing bypostauthor even depth-2 parent" id="comment-1249446">
				<div id="div-comment-1249446" class="comment-body">
				<div class="comment-author vcard">
						<cite class="fn"><a href='https://social.msdn.microsoft.com/profile/Raymond+Chen+-+MSFT' rel='external nofollow' class='url'>Raymond Chen - MSFT</a></cite> <span class="says">says:</span>		</div>
		
		<div class="comment-meta commentmetadata"><a href="https://blogs.msdn.microsoft.com/oldnewthing/20160518-00/?p=93485#comment-1249446">
			May 19, 2016 at 7:04 am</a>		</div>

		<p>I don&#8217;t have an iPad so I don&#8217;t know how bad it looks there. Tell me what to fix.</p>

		
				</div>
		<ol class="children">
		<li class="comment byuser comment-author-fleet-command odd alt depth-3 parent" id="comment-1249465">
				<div id="div-comment-1249465" class="comment-body">
				<div class="comment-author vcard">
						<cite class="fn"><a href='https://social.msdn.microsoft.com/profile/Fleet+Command' rel='external nofollow' class='url'>Fleet Command</a></cite> <span class="says">says:</span>		</div>
		
		<div class="comment-meta commentmetadata"><a href="https://blogs.msdn.microsoft.com/oldnewthing/20160518-00/?p=93485#comment-1249465">
			May 19, 2016 at 7:07 am</a>		</div>

		<p>Then don&#8217;t trust ipadpreview.com ever again. It is using the local font.</p>
<p>I have an actual iPad. It is not okay.</p>

		
				</div>
		<ol class="children">
		<li class="comment even depth-4" id="comment-1249696">
				<div id="div-comment-1249696" class="comment-body">
				<div class="comment-author vcard">
						<cite class="fn">Scarlet Manuka</cite> <span class="says">says:</span>		</div>
		
		<div class="comment-meta commentmetadata"><a href="https://blogs.msdn.microsoft.com/oldnewthing/20160518-00/?p=93485#comment-1249696">
			May 19, 2016 at 11:28 pm</a>		</div>

		<p>In what way is that telling him what to fix? Anyone reading this blog ought to be able to leave a better bug report than &#8220;it is not okay&#8221;.</p>

		
				</div>
		</li><!-- #comment-## -->
</ol><!-- .children -->
</li><!-- #comment-## -->
		<li class="comment odd alt depth-3" id="comment-1249735">
				<div id="div-comment-1249735" class="comment-body">
				<div class="comment-author vcard">
						<cite class="fn"><a href='http://programmerman.net/' rel='external nofollow' class='url'>Nick</a></cite> <span class="says">says:</span>		</div>
		
		<div class="comment-meta commentmetadata"><a href="https://blogs.msdn.microsoft.com/oldnewthing/20160518-00/?p=93485#comment-1249735">
			May 20, 2016 at 7:00 am</a>		</div>

		<p>The theme sets font-family to &#8220;Segoe UI.&#8221; Add more fonts in the fallback (font-family: &#8220;Segoe UI&#8221;, sans-serif; would mostly solve it).</p>

		
				</div>
		</li><!-- #comment-## -->
</ol><!-- .children -->
</li><!-- #comment-## -->
</ol><!-- .children -->
</li><!-- #comment-## -->
		<li class="comment byuser comment-author-cheong even thread-odd thread-alt depth-1 parent" id="comment-1249656">
				<div id="div-comment-1249656" class="comment-body">
				<div class="comment-author vcard">
						<cite class="fn"><a href='https://social.msdn.microsoft.com/profile/cheong00' rel='external nofollow' class='url'>cheong00</a></cite> <span class="says">says:</span>		</div>
		
		<div class="comment-meta commentmetadata"><a href="https://blogs.msdn.microsoft.com/oldnewthing/20160518-00/?p=93485#comment-1249656">
			May 19, 2016 at 7:27 pm</a>		</div>

		<p>That said the instructions in the followup question may work for them &#8220;for this case&#8221;.</p>
<p>Since in the original qusetion, the customer mentioned reverting to &#8220;Network Service&#8221; is bad for them, I&#8217;ll think perheps their application code is always running under some impersonation context, so maybe the GetThreadToken() call would always succeed.</p>

		
				</div>
		<ol class="children">
		<li class="comment odd alt depth-2" id="comment-1249695">
				<div id="div-comment-1249695" class="comment-body">
				<div class="comment-author vcard">
						<cite class="fn">Scarlet Manuka</cite> <span class="says">says:</span>		</div>
		
		<div class="comment-meta commentmetadata"><a href="https://blogs.msdn.microsoft.com/oldnewthing/20160518-00/?p=93485#comment-1249695">
			May 19, 2016 at 11:26 pm</a>		</div>

		<p>That&#8217;s certainly possible, but it&#8217;s also possible that they may or may not be impersonating originally, but they&#8217;re only asking about the case where they are because that&#8217;s the case where their code isn&#8217;t working. It&#8217;s prudent to make your answers a bit more general than the exact scope of the stated problem.</p>

		
				</div>
		</li><!-- #comment-## -->
</ol><!-- .children -->
</li><!-- #comment-## -->
		<li class="comment even thread-even depth-1" id="comment-1250235">
				<div id="div-comment-1250235" class="comment-body">
				<div class="comment-author vcard">
						<cite class="fn">Hofi</cite> <span class="says">says:</span>		</div>
		
		<div class="comment-meta commentmetadata"><a href="https://blogs.msdn.microsoft.com/oldnewthing/20160518-00/?p=93485#comment-1250235">
			May 23, 2016 at 11:13 pm</a>		</div>

		<p>Any chance to get similar details in cases like this in the msdn documentation?</p>

		
				</div>
		</li><!-- #comment-## -->
		</ol><!-- .comment-list -->

		<div class="navigation pagination">
					</div>

	
			<p class="no-comments">Comments are closed.</p>
<!-- COMMENTS END -->
</div></td></tr></table>