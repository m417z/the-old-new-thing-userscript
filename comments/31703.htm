<table class="commenttable" cellspacing="0" cellpadding="0"><tr><td><div class="commentdiv"><div class="commentdivhdr">
<!-- COMMENTS START -->
Comments (133)	</div>

	
			<div class="navigation pagination clear-both">
					</div>

		<ol class="comment-list">
					<li class="comment even thread-even depth-1" id="comment-363713">
				<div id="div-comment-363713" class="comment-body">
				<div class="comment-author vcard">
						<cite class="fn">Adam</cite> <span class="says">says:</span>		</div>
		
		<div class="comment-meta commentmetadata"><a href="https://blogs.msdn.microsoft.com/oldnewthing/20060331-15/?p=31703#comment-363713">
			March 31, 2006 at 10:13 am</a>		</div>

		<p>So store the IP address of the server in the cache instead of the hostname. Samba only runs on one port, so you can&#8217;t have more server on the same IP, and you can&#8217;t do the &quot;billion hostnames on a single machine&quot; trick, unless you have a billion IP addresses.</p>
<p>(Yes, I know vista will support IP6. You got me there :)</p>
<p>On top of that, this is only an attack on the local network, so you&#8217;ve already got an insider running a rogue server. And as I&#8217;d hope that IFrames to UNC files wouldn&#8217;t be loaded from pages served over HTTP, so someone&#8217;s had to convince you to go to an actual HTML file on the SMB server to work. You can&#8217;t use index.html to autoload the attack file when someone&#8217;s just browsing directories.<br /></p>

		
				</div>
		</li><!-- #comment-## -->
		<li class="comment odd alt thread-odd thread-alt depth-1" id="comment-363723">
				<div id="div-comment-363723" class="comment-body">
				<div class="comment-author vcard">
						<cite class="fn">vince</cite> <span class="says">says:</span>		</div>
		
		<div class="comment-meta commentmetadata"><a href="https://blogs.msdn.microsoft.com/oldnewthing/20060331-15/?p=31703#comment-363723">
			March 31, 2006 at 10:14 am</a>		</div>

		<p>With all the weird compatibility hacks the Samba project has had to make over the years to be compatible with the various versions of Windows, I think MS can deal gracefully with this bug.</p>

		
				</div>
		</li><!-- #comment-## -->
		<li class="comment byuser comment-author-larryosterman even thread-even depth-1" id="comment-363743">
				<div id="div-comment-363743" class="comment-body">
				<div class="comment-author vcard">
						<cite class="fn"><a href='https://social.msdn.microsoft.com/profile/Larry+Osterman+%5BMSFT%5D' rel='external nofollow' class='url'>Larry Osterman [MSFT]</a></cite> <span class="says">says:</span>		</div>
		
		<div class="comment-meta commentmetadata"><a href="https://blogs.msdn.microsoft.com/oldnewthing/20060331-15/?p=31703#comment-363743">
			March 31, 2006 at 10:23 am</a>		</div>

		<p>Would Jeremy be willing to call the fixed version of the protocol a new dialect (or add a compatibility flag) to the negotiate SMB?</p>
<p>That way the redir could detect the fixed servers.<br /></p>

		
				</div>
		</li><!-- #comment-## -->
		<li class="comment odd alt thread-odd thread-alt depth-1" id="comment-363753">
				<div id="div-comment-363753" class="comment-body">
				<div class="comment-author vcard">
						<cite class="fn"><a href='http://www.indev.no' rel='external nofollow' class='url'>Einar Stangvik</a></cite> <span class="says">says:</span>		</div>
		
		<div class="comment-meta commentmetadata"><a href="https://blogs.msdn.microsoft.com/oldnewthing/20060331-15/?p=31703#comment-363753">
			March 31, 2006 at 10:27 am</a>		</div>

		<p>I still feel that storing a cache of broken addresses is a bad idea. Seems like an awful lot of trouble to go through, considering the ways this may be exploited. In addition, checks would have to be done periodically to see if a box is still behaving badly &#8212; since it might be upgraded / replaced / whatever. Doing such a re-check seems close to impossible or at least really impractical, as the client would have to wait till a folder of more than 100 files is re-opened, as well as knowing that it&#8217;s been so-and-so long since the last attempt.. Horrid.</p>

		
				</div>
		</li><!-- #comment-## -->
		<li class="comment even thread-even depth-1" id="comment-363763">
				<div id="div-comment-363763" class="comment-body">
				<div class="comment-author vcard">
						<cite class="fn"><a href='http://www.ras.ucalgary.ca/~dfugate' rel='external nofollow' class='url'>Dave</a></cite> <span class="says">says:</span>		</div>
		
		<div class="comment-meta commentmetadata"><a href="https://blogs.msdn.microsoft.com/oldnewthing/20060331-15/?p=31703#comment-363763">
			March 31, 2006 at 10:29 am</a>		</div>

		<p>It&#8217;s great to hear that Microsoft tests OS compatibility with Linux on some level:)</p>

		
				</div>
		</li><!-- #comment-## -->
		<li class="comment odd alt thread-odd thread-alt depth-1" id="comment-363773">
				<div id="div-comment-363773" class="comment-body">
				<div class="comment-author vcard">
						<cite class="fn">Nawak</cite> <span class="says">says:</span>		</div>
		
		<div class="comment-meta commentmetadata"><a href="https://blogs.msdn.microsoft.com/oldnewthing/20060331-15/?p=31703#comment-363773">
			March 31, 2006 at 10:34 am</a>		</div>

		<p>Well with background everything becomes more clear!</p>
<p>Knowing this I think I would favor this solution:<br />
<br />&#8211; For Explorer, default to slow mode with an option to use fast mode (option or reg_entry). A &#8216;slow mode servers&#8217; list would be used in to still allow for a few exceptions, either &#8216;dynamic&#8217; (discovered by the OS) or &#8216;static&#8217;. The list shall be bounded to N entries and survive reboots.</p>
<p>&#8211; For API, as I don&#8217;t have a great experience with it, maybe I will be blatantly wrong but I would say that a &#8216;use fast mode&#8217; flag would quickly become a burden. My proposal would therefore be to default to fast mode (if not in the &#8216;slow mode servers&#8217; list presented earlier) and issue an EAGAIN error when the problem arises. From then the server would be added to the &#8216;slow mode servers&#8217; list.</p>
<p>I used two cases (Explorer and API) since some people seemed to insinuate that Explorer didn&#8217;t use the standard API. If that&#8217;s not the case, then Explorer should try again on the API&#8217;s &#8216;EAGAIN&#8217; and if that fails again (meaning that it is not the &#8216;fast mode&#8217; bug), display a &#8216;server disconnected&#8217; error (or whatever the error is when a server suddenly becomes unreachable)<br />
<br />Eventually the code to detect the special EAGAIN case could be throwed away without any bad side effects except that when a &#8216;new&#8217; explorer (with no workaround) access an old Samba, the user would now see a &#8216;disconnected&#8217; message, scratch his head, dismiss it, try again and from this time it would work.<br />
<br />Maybe I would even use this solution since the beginning but it would depend of the rarity of the &#8216;bad&#8217; servers and the impression I would want Vista to make when it launches! ;-)</p>

		
				</div>
		</li><!-- #comment-## -->
		<li class="comment even thread-even depth-1" id="comment-363793">
				<div id="div-comment-363793" class="comment-body">
				<div class="comment-author vcard">
						<cite class="fn">Adam</cite> <span class="says">says:</span>		</div>
		
		<div class="comment-meta commentmetadata"><a href="https://blogs.msdn.microsoft.com/oldnewthing/20060331-15/?p=31703#comment-363793">
			March 31, 2006 at 10:46 am</a>		</div>

		<p>DO NOTHING Wins again!!!</p>
<p>Make them fix their buggy driver and all is right again.</p>

		
				</div>
		</li><!-- #comment-## -->
		<li class="comment odd alt thread-odd thread-alt depth-1" id="comment-363803">
				<div id="div-comment-363803" class="comment-body">
				<div class="comment-author vcard">
						<cite class="fn">mig</cite> <span class="says">says:</span>		</div>
		
		<div class="comment-meta commentmetadata"><a href="https://blogs.msdn.microsoft.com/oldnewthing/20060331-15/?p=31703#comment-363803">
			March 31, 2006 at 10:51 am</a>		</div>

		<p>I agree with Larry, if the OS knows an SMB server is being mounted default to slow mode unless a specific (new) flag or something along those lines is present to identify the &#8216;fixed&#8217; version of the server.</p>

		
				</div>
		</li><!-- #comment-## -->
		<li class="comment even thread-even depth-1" id="comment-363813">
				<div id="div-comment-363813" class="comment-body">
				<div class="comment-author vcard">
						<cite class="fn">Brian</cite> <span class="says">says:</span>		</div>
		
		<div class="comment-meta commentmetadata"><a href="https://blogs.msdn.microsoft.com/oldnewthing/20060331-15/?p=31703#comment-363813">
			March 31, 2006 at 10:56 am</a>		</div>

		<p>so much for open source being tested more better.</p>

		
				</div>
		</li><!-- #comment-## -->
		<li class="comment odd alt thread-odd thread-alt depth-1" id="comment-363833">
				<div id="div-comment-363833" class="comment-body">
				<div class="comment-author vcard">
						<cite class="fn">Sebastian Redl</cite> <span class="says">says:</span>		</div>
		
		<div class="comment-meta commentmetadata"><a href="https://blogs.msdn.microsoft.com/oldnewthing/20060331-15/?p=31703#comment-363833">
			March 31, 2006 at 11:17 am</a>		</div>

		<p>Ist it wise to allow UNC paths to be embedded in web pages? Shouldn&#8217;t a browser make some reasonable attempt at keeping protocols separate?<br />
<br />In particular: IE already prevents iframes from using file: URLs to access local files for obvious reasons. I think this is a restriction that should be extended to UNC paths anyway.</p>

		
				</div>
		</li><!-- #comment-## -->
		<li class="comment even thread-even depth-1" id="comment-363843">
				<div id="div-comment-363843" class="comment-body">
				<div class="comment-author vcard">
						<cite class="fn">BillK</cite> <span class="says">says:</span>		</div>
		
		<div class="comment-meta commentmetadata"><a href="https://blogs.msdn.microsoft.com/oldnewthing/20060331-15/?p=31703#comment-363843">
			March 31, 2006 at 11:17 am</a>		</div>

		<p>Perhaps the samba folks could update the &quot;Family&quot; field on the fixed version, so you could tell the old from the new? The people with the in-between versions (works fast but has the old family code value) would get slow when fast was possible, but they are the ones upgrading.</p>

		
				</div>
		</li><!-- #comment-## -->
		<li class="comment odd alt thread-odd thread-alt depth-1" id="comment-363853">
				<div id="div-comment-363853" class="comment-body">
				<div class="comment-author vcard">
						<cite class="fn">Anonymous Coward</cite> <span class="says">says:</span>		</div>
		
		<div class="comment-meta commentmetadata"><a href="https://blogs.msdn.microsoft.com/oldnewthing/20060331-15/?p=31703#comment-363853">
			March 31, 2006 at 11:24 am</a>		</div>

		<p>Is it even possible to make a random user connect to a random SMB server over the Internet? AFAIK, most ISPs filter the SMB ports (even those ISPs which do not filter anything else) for security reasons, and have been doing so for about ten years.</p>

		
				</div>
		</li><!-- #comment-## -->
		<li class="comment even thread-even depth-1" id="comment-363863">
				<div id="div-comment-363863" class="comment-body">
				<div class="comment-author vcard">
						<cite class="fn">Tony Centore</cite> <span class="says">says:</span>		</div>
		
		<div class="comment-meta commentmetadata"><a href="https://blogs.msdn.microsoft.com/oldnewthing/20060331-15/?p=31703#comment-363863">
			March 31, 2006 at 11:42 am</a>		</div>

		<p>Heh. I worked for one of the cheap crap network storage vendors, doing embedded Linux until I was lucky and they laid me off. My boss stayed, and they really hung him out to dry when they finally went bankrupt. Heck, I may have helped design this server.</p>
<p>Anyway, the best response is still displaying a &quot;this server is borked&quot; dialog to force the user to fix his server. It&#8217;s broken and needs to be fixed.</p>
<p>On the other hand, MS could save itself trouble like this in the future by documenting protocols. Most of SAMBA is based on reverse-engineering what comes across the wire. And make future protocols a hell of a lot simpler than Server Message Block.</p>
<p>The Internet protocols interop well because they&#8217;re simple and well documented.</p>

		
				</div>
		</li><!-- #comment-## -->
		<li class="comment odd alt thread-odd thread-alt depth-1" id="comment-363883">
				<div id="div-comment-363883" class="comment-body">
				<div class="comment-author vcard">
						<cite class="fn">Just Browsing</cite> <span class="says">says:</span>		</div>
		
		<div class="comment-meta commentmetadata"><a href="https://blogs.msdn.microsoft.com/oldnewthing/20060331-15/?p=31703#comment-363883">
			March 31, 2006 at 11:55 am</a>		</div>

		<p>It seems that the bad-list cache can be limitted to a smallish number of entries, at some cost in performance to neighboring servers:</p>
<p>if a server reports failure, use its IP (filter out DNS attacks).<br />
<br />if more than &#8216;x&#8217; instances from that IP range occur, then put a &#8216;network block&#8217; record. From then on, all accesses to that network block use slow accesses.<br />
<br />If more than &#8216;x&#8217; of network blocks are hit, then use a larger granularity (multi-network block). &nbsp;</p>
<p>The attack would need to have a botnet with addresses in many different address ranges. &nbsp;And even then, the only impact is that <em>all</em> accesses are slow.</p>
<p>Advantage &#8211; Keeps size of cache bounded. &nbsp;Tuneable for common scenario. &nbsp;</p>
<p>Disadvantages:<br />
<br />all other &#8216;blacklist&#8217; disadvantages (how to remove entries, etc).<br />
<br />Powerful attacker can force slow accesses on same subnet/network/etc<br /></p>

		
				</div>
		</li><!-- #comment-## -->
		<li class="comment even thread-even depth-1" id="comment-363893">
				<div id="div-comment-363893" class="comment-body">
				<div class="comment-author vcard">
						<cite class="fn">Brian Reiter</cite> <span class="says">says:</span>		</div>
		
		<div class="comment-meta commentmetadata"><a href="https://blogs.msdn.microsoft.com/oldnewthing/20060331-15/?p=31703#comment-363893">
			March 31, 2006 at 11:58 am</a>		</div>

		<p>Is it feasible to get the Samba team to change the name of their server in the Family field of the &quot;fixed&quot; version and all future versions moving forward to something like &quot;FastSamba&quot;? That way you can blacklist &quot;Samba&quot; and use the slow protocol safely with the legacy Samba servers without punishing the new/future versions that work correctly. </p>
<p>The only casualty would be the current version of Samba that is technically fixed but doesn&#8217;t include the changed name. Vista would use slow mode with that, even though fast mode would have worked. Since that code is not in wide distribution at the moment, it shouldn&#8217;t be much of an issue.</p>
<p>Also you could provide a Registry/Policy setting to control the fast mode blacklist.</p>

		
				</div>
		</li><!-- #comment-## -->
		<li class="comment odd alt thread-odd thread-alt depth-1" id="comment-363913">
				<div id="div-comment-363913" class="comment-body">
				<div class="comment-author vcard">
						<cite class="fn">J</cite> <span class="says">says:</span>		</div>
		
		<div class="comment-meta commentmetadata"><a href="https://blogs.msdn.microsoft.com/oldnewthing/20060331-15/?p=31703#comment-363913">
			March 31, 2006 at 12:04 pm</a>		</div>

		<p>&quot;Your argument that OSS is not tested as well is therefore worthless&quot;</p>
<p>How&#8217;s his argument worthless? &nbsp;Even you are saying that they released untested code. &nbsp;Sounds like his argument is pretty damn solid to me.<br /></p>

		
				</div>
		</li><!-- #comment-## -->
		<li class="comment even thread-even depth-1" id="comment-363943">
				<div id="div-comment-363943" class="comment-body">
				<div class="comment-author vcard">
						<cite class="fn"><a href='http://www.electricminds.org' rel='external nofollow' class='url'>Erbo</a></cite> <span class="says">says:</span>		</div>
		
		<div class="comment-meta commentmetadata"><a href="https://blogs.msdn.microsoft.com/oldnewthing/20060331-15/?p=31703#comment-363943">
			March 31, 2006 at 12:27 pm</a>		</div>

		<p>After careful consideration, I think the best answer would be just to disable the &quot;fast mode&quot; by default, with the additional proviso that there be a registry switch somewhere to re-enable it.</p>
<p>My reasoning is: If Samba&#8217;s the only SMB server that exhibits this problem, and a fix is already in the codebase, it&#8217;s only a matter of time before that fix gets everywhere it needs to be. &nbsp;By the time the next version of Windows comes out, the fix should be pretty much everywhere, and you can flip the switch. &nbsp;In the meantime, having the switch there allows folks that care to perform interoperability testing. &nbsp;(I might also drop a polite note to the NAS vendors in question, saying &quot;you might want to consider upgrading the Samba version you use, and here&#8217;s why.&quot;)</p>
<p>OK, addressing disadvantage number 1: &quot;the fast mode may as well not exist.&quot; &nbsp;True enough, but you&#8217;re also not shipping code that engages in buggy behavior by default, either, whether the source of the buggy behavior is your code or someone else&#8217;s. &nbsp;As you&#8217;ve pointed out before, if people upgrade Windows and something breaks, they&#8217;re going to blame the Windows upgrade, no matter whose &quot;fault&quot; the bug was. &nbsp;There&#8217;s certainly no shame in a mistake that isn&#8217;t made. &nbsp;And you have an &quot;out&quot; later for when things DO get better.</p>
<p>Addressing disadvantage number 2: &quot;People will accuse Microsoft of unfair business practices&#8230;&quot; People accuse Microsoft of unfair business practices about every damned thing in the world, sometimes rightly, sometimes wrongly, but it happens. &nbsp;One little detail about one teensy corner of the operating system isn&#8217;t going to change that by any significant amount in either direction. &nbsp;The people making the accusations would probably expect no better of Microsoft, and they probably weren&#8217;t &quot;your&quot; customers to begin with.</p>
<p>Yeah, it&#8217;s an imperfect solution. &nbsp;However, as far as I can see, all the other solutions are worse. &nbsp;This at least puts you in a position to take advantage and do what you originally wanted once &quot;outside conditions&quot; improve.</p>

		
				</div>
		</li><!-- #comment-## -->
		<li class="comment odd alt thread-odd thread-alt depth-1" id="comment-363963">
				<div id="div-comment-363963" class="comment-body">
				<div class="comment-author vcard">
						<cite class="fn">Mark Steward</cite> <span class="says">says:</span>		</div>
		
		<div class="comment-meta commentmetadata"><a href="https://blogs.msdn.microsoft.com/oldnewthing/20060331-15/?p=31703#comment-363963">
			March 31, 2006 at 1:07 pm</a>		</div>

		<p>Follow-up to my previous post: if you use the &quot;whitelist&quot; idea, don&#8217;t store it. &nbsp;It should be a session flag, discarded as soon as the session goes down. &nbsp;Having a list of IP addresses or NetBIOS name ignores the fact that such things are transitory.</p>
<p>If it&#8217;s not the SMB_FIND_ID_* bug, and is not a bug in FindNext which can be worked around, I&#8217;d second the API flag for programs that are aware of the error, along with delayed-write-failure style balloon to report the error in non-aware programs. &nbsp;Just like removing a USB drive, the enumeration should simply fail, as there&#8217;s no real way of recovering. &nbsp;This is not just an IShellFolder problem: what if it&#8217;s a kernel driver asking for the directory listing?</p>
<p>The balloon should link directly to a tab in System Properties&#8217;s &#8216;Performance Options&#8217; (or the equivalent in Vista) that will stop the redirector using fast directory listings, so users has a chance to ignore the problem, and time to stop whatever they&#8217;re doing if they want to fix it. &nbsp;Einar&#8217;s &quot;might be puzzled for a minute or two&quot; is no good if the user is in a rush to get something done!</p>
<p>I like Neil&#8217;s idea to provide this as an optional update for Windows (so only eager people get it), but what if an eager admin deploys it, and the user takes their laptop home?</p>
<p>Cheers,<br />
<br />Mark</p>

		
				</div>
		</li><!-- #comment-## -->
		<li class="comment even thread-even depth-1" id="comment-364003">
				<div id="div-comment-364003" class="comment-body">
				<div class="comment-author vcard">
						<cite class="fn">Riva</cite> <span class="says">says:</span>		</div>
		
		<div class="comment-meta commentmetadata"><a href="https://blogs.msdn.microsoft.com/oldnewthing/20060331-15/?p=31703#comment-364003">
			March 31, 2006 at 1:28 pm</a>		</div>

		<p>Shipping with slow enabled and fast on request is a horrible idea.</p>
<p>Scenario:<br />
<br />You check for the buggy Samba implementation on your network and find it doesn&#8217;t affect you so you deploy Vista and switch the default from slow to fast.</p>
<p>A year from now they purchase a NAS that ships with the faulty Samba version. What are the chances you&#8217;ll remember to check for the bug? Or by then someone else could be managing the network.</p>
<p>To avoid this Vista has to auto-check for the bug even if it&#8217;s being told to use fast so you&#8217;re better off starting off with fast and degrade down to slow as soon as the error pops up once. If the problem gets fixed, the admin can delete the setting and Vista goes back to default until it encounters another error.</p>
<p>It seems that the best solution is to simply contact the Samba team and ask what they would want. You can&#8217;t prevent conspiracy theories &nbsp;but to the sane ones the fact that Microsoft took the trouble to work with the Samba team to resolve the situation will show that whatever the outcome is, it was not done for malicious reasons.</p>

		
				</div>
		</li><!-- #comment-## -->
		<li class="comment odd alt thread-odd thread-alt depth-1" id="comment-364043">
				<div id="div-comment-364043" class="comment-body">
				<div class="comment-author vcard">
						<cite class="fn">Jules</cite> <span class="says">says:</span>		</div>
		
		<div class="comment-meta commentmetadata"><a href="https://blogs.msdn.microsoft.com/oldnewthing/20060331-15/?p=31703#comment-364043">
			March 31, 2006 at 2:07 pm</a>		</div>

		<p>Brian Reiter: &quot;Is it feasible to get the Samba team to change the name of their server in the Family field of the &quot;fixed&quot; version and all future versions moving forward to something like &quot;FastSamba&quot;? That way you can blacklist &quot;Samba&quot; and use the slow protocol safely with the legacy Samba servers without punishing the new/future versions that work correctly.&quot;</p>
<p>Unfortunately this wouldn&#8217;t work, as the family returned by Samba is a user-configurable setting.</p>
<p>J: &quot;How&#8217;s his argument worthless? &nbsp;Even you are saying that they released untested code. &nbsp;Sounds like his argument is pretty damn solid to me. &quot;</p>
<p>The argument is useless because they didn&#8217;t test against a case that was impossible to test for at time of release, as no version of Windows actually used the fast mode and available documentation wasn&#8217;t specific about how the server should behave. &nbsp;Saying &quot;OSS projects don&#8217;t test against bugs that are impossible to detect with currently available knowledge&quot; gets you nowhere fast.<br /></p>

		
				</div>
		</li><!-- #comment-## -->
		<li class="comment even thread-even depth-1" id="comment-364063">
				<div id="div-comment-364063" class="comment-body">
				<div class="comment-author vcard">
						<cite class="fn">Anonymous Coward</cite> <span class="says">says:</span>		</div>
		
		<div class="comment-meta commentmetadata"><a href="https://blogs.msdn.microsoft.com/oldnewthing/20060331-15/?p=31703#comment-364063">
			March 31, 2006 at 2:17 pm</a>		</div>

		<p>I still think the best thing is to notify Samba, or even better publish the problem somewhere. &nbsp;That way everyone who does SMB servers can also address it.</p>
<p>It is their problem, and they are the best judges of how to fix this with their community. &nbsp;And they will have roughly 7 months to do it.</p>
<p>You will end up with no workaround code (which would have to be maintained forever) and they would be fixed.</p>
<p>Just for the record, where do you want reports of the Vista SMB1 implementation being less than optimal? &nbsp;It is mostly evident just running network monitor/ethereal and doing various operations. &nbsp;I also applaud only using &nbsp;one stream for document properties rather than 15 or so earlier versions looked for.</p>

		
				</div>
		</li><!-- #comment-## -->
		<li class="comment odd alt thread-odd thread-alt depth-1" id="comment-364083">
				<div id="div-comment-364083" class="comment-body">
				<div class="comment-author vcard">
						<cite class="fn"><a href='http://www.guyswithtowels.com' rel='external nofollow' class='url'>Tim</a></cite> <span class="says">says:</span>		</div>
		
		<div class="comment-meta commentmetadata"><a href="https://blogs.msdn.microsoft.com/oldnewthing/20060331-15/?p=31703#comment-364083">
			March 31, 2006 at 2:33 pm</a>		</div>

		<p>Gosh, it&#8217;s almost as if Microsoft&#8217;s secrecy about the SMB protocol and making life hard for anyone (<a rel="nofollow" target="_new" href="http://www.linuxelectrons.com/article.php/20050607122215586" rel="nofollow">http://www.linuxelectrons.com/article.php/20050607122215586</a>) who tries to implement compatibility and interoperability with it has come back to bite them in the ass!</p>
<p>Shame.</p>
<p>Now I&#8217;ve got my snipe out of the way, it&#8217;s impressive how many people are still ignoring Raymond&#8217;s basic point with comments like:</p>
<p>&quot;Anyway, the best response is still displaying a &quot;this server is borked&quot; dialog to force the user to fix his server. It&#8217;s broken and needs to be fixed. &quot;</p>
<p>Yes, it is broken, but NO, it does not NEED to be fixed. &nbsp;It works fine with XP etc, as Raymond said.</p>
<p>You have to look at it from the user&#8217;s point of view: they just bought shiny new Vista, and their lovely network hard drive that they&#8217;ve had purring along just fine for 3 years suddenly won&#8217;t work because Vista tells them it&#8217;s &quot;broken&quot;.</p>
<p>The vast majority of users (i.e., the ones that matter) will actually conclude that Vista itself is broken, despite what the error message says. &nbsp;This is a bad thing for Microsoft. &nbsp;</p>
<p>And no, I&#8217;m not going to flash the ROMs of my Linksys NAS unit &#8211; for a start, how would I do this?</p>
<p>Raymond is dead on: it&#8217;s a problem, it&#8217;s annoying for MS, but ignoring the problem and shifting the blame is the worst thing they can do.</p>
<p>This same compatibility point has come up so often on this blog that I&#8217;m surprised people still don&#8217;t get it :-)</p>

		
				</div>
		</li><!-- #comment-## -->
		<li class="comment even thread-even depth-1" id="comment-364093">
				<div id="div-comment-364093" class="comment-body">
				<div class="comment-author vcard">
						<cite class="fn"><a href='http://mysteray.com' rel='external nofollow' class='url'>Marsh J. Ray</a></cite> <span class="says">says:</span>		</div>
		
		<div class="comment-meta commentmetadata"><a href="https://blogs.msdn.microsoft.com/oldnewthing/20060331-15/?p=31703#comment-364093">
			March 31, 2006 at 2:33 pm</a>		</div>

		<p>If it&#8217;s impossible to detect the bug in the remote server without causing a local failure, then your only options are to run predictably slow or unreliably fast. That&#8217;s really an ethical and a marketing decision based on the number of users expected to be affected, not really a technical one. Surely there are uncounted users out there with drives mapped to ten separate NAS devices who&#8217;s company requires they shut down their PCs every night. Locking up their explorer for 30 seconds ten times a day is probably best avoided.</p>
<p>However, if it&#8217;s practical to detect the server&#8217;s capabilites in advance, or to attempt fast mode and then fallback to slow mode without causing a local failure, then there are some other options. An evaluation of the user benefits of fast mode relative to the user pain of the fallback scheme will suggest how much development effort this issue deserves. &nbsp;</p>
<p>Figuring that any speed detection or fallback scheme will incurrs significant per-server costs at runtime (or else you probably wouldn&#8217;t have posted about it,) some form of persisting the info across reboots would probably be beneficial.</p>
<p>However, the cache doesn&#8217;t have to consume a lot of resources, and it doesn&#8217;t have to be particularly vulnerable to DOS. You just need an appropriate data structure.</p>
<p>What information needs to be stored? Any given server falls in one of three groups: &quot;Known Slow&quot;, &quot;Known Fast&quot;, or &quot;Not Known&quot;.</p>
<p>If an occasional fallback event isn&#8217;t too painful, then we can proceed optimistically. This allows us to only consider the &quot;Probably Fast&quot; and &quot;Known Slow&quot; cases, and take advantage of heuristics. For example, you could persist a bit vector indexed by a simple hash function of the remote server name. The vector gets initialized with 0, and gets set to 1 to represent &quot;Known Slow&quot;. Periodically, some percentage of the vector gets zeroed to allow upgraded servers to eventually be re-negotiated. A hash collision (or DOS attack at worst-case) produces a temporary revert to the (currently acceptable) &quot;slow&quot; behavior. At first glance, I&#8217;d guess that a table small enough for a single disk block would still be large enough to make false positives due to hash collisions extremely rare.</p>
<p>However, if fallback isn&#8217;t practical and server speed detection has to be done in advance, then any cache must use complete server identifers in the peristent cache. A size-limited circular file could be a simple way to implement &quot;least recently loaded&quot; expiration. If lookup needed to be faster than linear-search, a fixed-size hashtable could live at the start of the file.</p>

		
				</div>
		</li><!-- #comment-## -->
		<li class="comment odd alt thread-odd thread-alt depth-1" id="comment-364103">
				<div id="div-comment-364103" class="comment-body">
				<div class="comment-author vcard">
						<cite class="fn">Mike Weiss</cite> <span class="says">says:</span>		</div>
		
		<div class="comment-meta commentmetadata"><a href="https://blogs.msdn.microsoft.com/oldnewthing/20060331-15/?p=31703#comment-364103">
			March 31, 2006 at 2:36 pm</a>		</div>

		<p>I know I&#8217;m late with my suggestion, but here goes:</p>
<p>Always use fast. If an error is returned (maybe any error, maybe just this samba one), throw the results away and start over with slow, just this one time. Add an error to the log. Any additional requests simply keep doing this. Keep no history about this server having this problem.</p>
<p>The end result is that folders with 100+ items are REALLY slow on broken servers, but small folders on them are fast. Non-broken servers work fast as well. </p>
<p>Users are not burdened by error popups, admins don’t need to hack the registry, and the Windows code base isn&#8217;t burdened by complicated fixes that are no longer needed once Samba is patched.<br /></p>

		
				</div>
		</li><!-- #comment-## -->
		<li class="comment even thread-even depth-1" id="comment-364113">
				<div id="div-comment-364113" class="comment-body">
				<div class="comment-author vcard">
						<cite class="fn">Mihai</cite> <span class="says">says:</span>		</div>
		
		<div class="comment-meta commentmetadata"><a href="https://blogs.msdn.microsoft.com/oldnewthing/20060331-15/?p=31703#comment-364113">
			March 31, 2006 at 2:39 pm</a>		</div>

		<p>I like Brian&#8217;s idea with &quot;FastSamba&quot;<br />
<br />I wanted to propose the same, but he was faster :-)</p>
<p>And I think the Samba team would have nothing agains. They also want compatibility and their server not to be perceived as bugy/slow :-)</p>

		
				</div>
		</li><!-- #comment-## -->
		<li class="comment odd alt thread-odd thread-alt depth-1" id="comment-364143">
				<div id="div-comment-364143" class="comment-body">
				<div class="comment-author vcard">
						<cite class="fn">sayler</cite> <span class="says">says:</span>		</div>
		
		<div class="comment-meta commentmetadata"><a href="https://blogs.msdn.microsoft.com/oldnewthing/20060331-15/?p=31703#comment-364143">
			March 31, 2006 at 2:55 pm</a>		</div>

		<p>Also, </p>
<p>I don&#8217;t think I&#8217;ve seen this question asked upthread: has anyone from Microsoft either<br />
<br />1) commented on the bug in Samba&#8217;s tracker<br />
<br />2) spoken to one of the core developers<br />
<br />or<br />
<br />3) posted a message to a mailing list</p>
<p>asking the Samba team what they think about the problem and possible solutions?</p>

		
				</div>
		</li><!-- #comment-## -->
		<li class="comment even thread-even depth-1" id="comment-364153">
				<div id="div-comment-364153" class="comment-body">
				<div class="comment-author vcard">
						<cite class="fn">Stefan Kanthak</cite> <span class="says">says:</span>		</div>
		
		<div class="comment-meta commentmetadata"><a href="https://blogs.msdn.microsoft.com/oldnewthing/20060331-15/?p=31703#comment-364153">
			March 31, 2006 at 2:56 pm</a>		</div>

		<p>Raymond,</p>
<p>in this story I miss the precision you&#8217;re addicted to elsewhere.-)<br />
<br />I was a little bit disappointed then!</p>
<p>Some points already have been addressed, so repetition might happen:</p>
<p>1. UNC paths ain&#8217;t (valid) URLs.<br />
<br /> &nbsp; There&#8217;s only one (so called.-) web browser out there that accepts them.<br />
<br /> &nbsp; The correct notation is file://some.server/&#8230; and should work in other browsers running on Windows too (Netscape did it right many many years ago).</p>
<p>2. Overflowing a table of hostnames with wildcard DNS addresses can easily be avoided when the DNS client requests the canonical DNS name and only stores that.<br />
<br /> &nbsp; C.f. RFC 1123 chapter 5.2.2:<br />
<br /> &nbsp; | Canonicalization: RFC-821 Section 3.1</p>
<p>3. The problem is not really in Explorer resp. its IEnumIDList::next but in the redirector.</p>
<p>Now the constructive part:</p>
<p>0. When detecting the error write an event log entry referring to an MSKB article.</p>
<p>1. add a registry setting to force slow mode and document that in said MSKB article:<br />
<br /> &nbsp; there are so many SAMBA installations out there, not just running on different Linux distributions (and home brew LFS setups) as well as arbitrary Unix systems you won&#8217;t have even heard of, that it&#8217;s impossible to address every vendor or system administrator.<br />
<br /> &nbsp; Many SAMBA installations are run on fairly old distributions where the backport of a SAMBA fix would be necessary (this is especially true &nbsp;for the longer living RHEL or SLES installations in companies).<br />
<br /> &nbsp; Sometimes the host system for SAMBA can&#8217;t be upgraded because the main application is certified for exactly that current host system version, or won&#8217;t be upgraded since SAMBA ain&#8217;t the main application running there, it just happens to be installed and used too.<br />
<br /> &nbsp; I&#8217;ve two SVR4 Unices here still &nbsp;running SAMBA 2.2.12 because newer versions of SAMBA won&#8217;t compile (I&#8217;d have to repair many header files and the vendor&#8217;s compiler, or port GCC).<br />
<br /> &nbsp; BTW: does the error show in all SAMBA versions?</p>
<p>2. &quot;Be liberal in what you accept, and conservative in what you send&quot;.<br />
<br /> &nbsp; There are quite some hacks in SAMBA working around flaws in the Windows CIFS/SMB/NetBIOS implementation to keep both interoperable.<br />
<br /> &nbsp; Now it&#8217;s M&#237;crosofts turn.<br />
<br /> &nbsp; I&#8217;ve no doubt that SAMBA will fix it, but: see 2.</p>
<p>Stefan</p>

		
				</div>
		</li><!-- #comment-## -->
		<li class="comment odd alt thread-odd thread-alt depth-1" id="comment-364163">
				<div id="div-comment-364163" class="comment-body">
				<div class="comment-author vcard">
						<cite class="fn"><a href='http://mindon.net/~ayhal' rel='external nofollow' class='url'>A Tykhyy</a></cite> <span class="says">says:</span>		</div>
		
		<div class="comment-meta commentmetadata"><a href="https://blogs.msdn.microsoft.com/oldnewthing/20060331-15/?p=31703#comment-364163">
			March 31, 2006 at 3:15 pm</a>		</div>

		<p>Raymond, maybe it is still possible to continue after receiving a strange error? this would require that 1) the file names need not be returned in any particular order and 2) to remember the last query and when a bug is received indicating the old samba, issue a slow query and filter out the entries which have been returned already. And of course log an event for the administrator etc. Then it won&#8217;t be necessary to remember a list of servers, or waste a lot of memory, or return incomplete lists (unless the directory is modified between two queries, in which case the results probably wouldn&#8217;t be consistent anyway).</p>

		
				</div>
		</li><!-- #comment-## -->
		<li class="comment even thread-even depth-1" id="comment-364173">
				<div id="div-comment-364173" class="comment-body">
				<div class="comment-author vcard">
						<cite class="fn"><a href='http://www.debaasjes.nl' rel='external nofollow' class='url'>Vosselmans</a></cite> <span class="says">says:</span>		</div>
		
		<div class="comment-meta commentmetadata"><a href="https://blogs.msdn.microsoft.com/oldnewthing/20060331-15/?p=31703#comment-364173">
			March 31, 2006 at 3:21 pm</a>		</div>

		<p>&quot;On the other hand, MS could save itself trouble like this in the future by documenting protocols. Most of SAMBA is based on reverse-engineering what comes across the wire. And make future protocols a hell of a lot simpler than Server Message Block. &quot;</p>
<p>Nuf said.</p>

		
				</div>
		</li><!-- #comment-## -->
		<li class="comment odd alt thread-odd thread-alt depth-1" id="comment-364183">
				<div id="div-comment-364183" class="comment-body">
				<div class="comment-author vcard">
						<cite class="fn">stb</cite> <span class="says">says:</span>		</div>
		
		<div class="comment-meta commentmetadata"><a href="https://blogs.msdn.microsoft.com/oldnewthing/20060331-15/?p=31703#comment-364183">
			March 31, 2006 at 3:33 pm</a>		</div>

		<p>I agree with A Tykhyy.</p>
<p>While it&#8217;s not pretty, the best way to not break, and still work for all clients, would be to make a note of the filenames that are coming back from the request, and only discard that list when the request is completed.</p>
<p>Thus, if the strange error occurs, the request could be re-sent using the slow method, and the filenames already returned could be simply ignored.</p>
<p>It adds memory overhead for keeping track of the filenames, but it&#8217;s a temporary use of memory, and since it sounds like it&#8217;s usually around 100 files, it doesn&#8217;t sound like it would typically result in a very large spike in memory usage.</p>

		
				</div>
		</li><!-- #comment-## -->
		<li class="comment even thread-even depth-1" id="comment-364203">
				<div id="div-comment-364203" class="comment-body">
				<div class="comment-author vcard">
						<cite class="fn">zzz</cite> <span class="says">says:</span>		</div>
		
		<div class="comment-meta commentmetadata"><a href="https://blogs.msdn.microsoft.com/oldnewthing/20060331-15/?p=31703#comment-364203">
			March 31, 2006 at 3:48 pm</a>		</div>

		<p>There is lack of information regards whether the failure is a specific one, &quot;random&quot; or that only certain number of entries (100) are returned (with no hint that there should be more).</p>
<p>I am going to assume the error is such that upon encounter the server can be assumed to be the broken Samba one.</p>
<p>Thus I suggest:<br />
<br />A Twist to the popular suggestion:</p>
<p>Upon the particular failure, retry with slow mode. The user won&#8217;t be notified of this failure since there is little (s)he can do about it in many cases. If the slow list succeeds indicating that it really is the broken Samba, then try, for example, to create a directory on the Samba that is known not to cause directory to be created, but will put a failure in the log with the directory name. Such as mkdir &quot;Broken_Samba_Please_UpdateNULL&quot;. However if this approach won&#8217;t create entry in a log, then second approach is to try create a real directory in the root of the samba server, possibly hidden one: mkdir .Broken_Samba.. This will cause the admin to take a notice, but won&#8217;t clutter the server around with dirs and won&#8217;t really ruin the day since it is invisible by default.<br /></p>

		
				</div>
		</li><!-- #comment-## -->
		<li class="comment odd alt thread-odd thread-alt depth-1" id="comment-364213">
				<div id="div-comment-364213" class="comment-body">
				<div class="comment-author vcard">
						<cite class="fn">abcd</cite> <span class="says">says:</span>		</div>
		
		<div class="comment-meta commentmetadata"><a href="https://blogs.msdn.microsoft.com/oldnewthing/20060331-15/?p=31703#comment-364213">
			March 31, 2006 at 3:59 pm</a>		</div>

		<p>What&#8217;s the measured difference between fast and slow mode for large directories?</p>

		
				</div>
		</li><!-- #comment-## -->
		<li class="comment even thread-even depth-1" id="comment-364233">
				<div id="div-comment-364233" class="comment-body">
				<div class="comment-author vcard">
						<cite class="fn">Jen Kilmer</cite> <span class="says">says:</span>		</div>
		
		<div class="comment-meta commentmetadata"><a href="https://blogs.msdn.microsoft.com/oldnewthing/20060331-15/?p=31703#comment-364233">
			March 31, 2006 at 4:36 pm</a>		</div>

		<p>Stefan: re: UNC paths ain&#8217;t (valid) URLs.</p>
<p>[[ &nbsp;There&#8217;s only one (so called.-) web browser out there that accepts them. The correct notation is file://some.server/&#8230; and should work in other browsers running on Windows too (Netscape did it right many many years ago). ]]</p>
<p>You may not realize this, but Explorer and IE are pretty much the same code. Do you expect users to stop typing \servershare in Explorer? &nbsp;Or for Explorer to translate?</p>

		
				</div>
		</li><!-- #comment-## -->
		<li class="comment odd alt thread-odd thread-alt depth-1" id="comment-364243">
				<div id="div-comment-364243" class="comment-body">
				<div class="comment-author vcard">
						<cite class="fn">mph</cite> <span class="says">says:</span>		</div>
		
		<div class="comment-meta commentmetadata"><a href="https://blogs.msdn.microsoft.com/oldnewthing/20060331-15/?p=31703#comment-364243">
			March 31, 2006 at 4:53 pm</a>		</div>

		<p>Jen, you can already type things in the address bar of IE that aren&#8217;t URLs. &nbsp;For example, you can type &quot;www.microsoft.com&quot; instead of &quot;<a rel="nofollow" target="_new" href="http://www.microsoft.com/&quot;" rel="nofollow"></a><a href="http://www.microsoft.com/&#038;quot" rel="nofollow">http://www.microsoft.com/&#038;quot</a>;.</p>
<p>Having the ability to type &quot;\servershare&quot; in the address bar doesn&#8217;t mean you also have to accept such syntax where real URLs are required (like &quot;a&quot; tags in HTML documents).</p>

		
				</div>
		</li><!-- #comment-## -->
		<li class="comment even thread-even depth-1" id="comment-364253">
				<div id="div-comment-364253" class="comment-body">
				<div class="comment-author vcard">
						<cite class="fn">Cooney</cite> <span class="says">says:</span>		</div>
		
		<div class="comment-meta commentmetadata"><a href="https://blogs.msdn.microsoft.com/oldnewthing/20060331-15/?p=31703#comment-364253">
			March 31, 2006 at 5:03 pm</a>		</div>

		<p>Here&#8217;s something that you may have missed:</p>
<p>Work with Samba to build a solution that works with old versions of their stuff and allows Fast-mode without any config goofiness.</p>

		
				</div>
		</li><!-- #comment-## -->
		<li class="comment odd alt thread-odd thread-alt depth-1" id="comment-364263">
				<div id="div-comment-364263" class="comment-body">
				<div class="comment-author vcard">
						<cite class="fn">Stefan Kanthak</cite> <span class="says">says:</span>		</div>
		
		<div class="comment-meta commentmetadata"><a href="https://blogs.msdn.microsoft.com/oldnewthing/20060331-15/?p=31703#comment-364263">
			March 31, 2006 at 5:21 pm</a>		</div>

		<p>Jen:</p>
<p>believe me: I knew that!<br />
<br />I expect Explorer.exe to be able to browse to \servershare, and I don&#8217;t mind that IExplore.exe does it too.<br />
<br />In HTML code (not interactive) UNC paths are wrong and MUST yield an error!</p>
<p>Stefan</p>

		
				</div>
		</li><!-- #comment-## -->
		<li class="comment even thread-even depth-1" id="comment-363703">
				<div id="div-comment-363703" class="comment-body">
				<div class="comment-author vcard">
						<cite class="fn"><a href='http://satiricalramblings.blogspot.com/' rel='external nofollow' class='url'>tsrblke</a></cite> <span class="says">says:</span>		</div>
		
		<div class="comment-meta commentmetadata"><a href="https://blogs.msdn.microsoft.com/oldnewthing/20060331-15/?p=31703#comment-363703">
			March 31, 2006 at 10:10 am</a>		</div>

		<p>Raymond,<br />
<br />This may be a stupid question but: We are assuimg these are at least upgradable Flash ROMs right? &nbsp;This way in all probably theory the machine could eventually be upgraded. &nbsp;If even *one* vender isn&#8217;t selling Flash ROMs that would possibly change the fix.<br />
<br />(While it seems that since even TI&#8217;s have Flash ROM in it, I&#8217;ve seen alot of Cheap network storage&#8211;presumably for home us&#8211;hit the market lately, which may or may not be flashable.)</p>
<p>I suppose if you really wanted to get into left field, you could have Vista do something when exactly 100 files are returned. &nbsp;This of course would be based on the idea that the bug always returns exactly 100 files when the number is greater than 100 and always returns the correct number when the file number is less than or equal to 100. &nbsp;Furthermore you&#8217;d be assuming that the chances that a file sever with the bug having exactly 100 files on it is, well, small. &nbsp;Based on that you might be able to do something. &nbsp;Of course it&#8217;s convoluted, and pretty much useless&#8230;<br />
<br />(I never said the idea was good!)</p>

		
				</div>
		</li><!-- #comment-## -->
		<li class="comment odd alt thread-odd thread-alt depth-1" id="comment-364273">
				<div id="div-comment-364273" class="comment-body">
				<div class="comment-author vcard">
						<cite class="fn">Christian</cite> <span class="says">says:</span>		</div>
		
		<div class="comment-meta commentmetadata"><a href="https://blogs.msdn.microsoft.com/oldnewthing/20060331-15/?p=31703#comment-364273">
			March 31, 2006 at 6:39 pm</a>		</div>

		<p>I really hope that this cache and the even wilder ideas of this crowd won&#8217;t find their way into Vista.</p>
<p>Just make a group policy/reg key to disable the fast queries and have it default to off. (Thus breaking Samba)</p>
<p>People who use Samba willingly are used to it breaking when updating Windows to the newest version. Documenting this thing is a must of course.</p>

		
				</div>
		</li><!-- #comment-## -->
		<li class="comment even thread-even depth-1" id="comment-364283">
				<div id="div-comment-364283" class="comment-body">
				<div class="comment-author vcard">
						<cite class="fn">Mark Steward</cite> <span class="says">says:</span>		</div>
		
		<div class="comment-meta commentmetadata"><a href="https://blogs.msdn.microsoft.com/oldnewthing/20060331-15/?p=31703#comment-364283">
			March 31, 2006 at 6:40 pm</a>		</div>

		<p>zzz: what if the folder gets copied somewhere else? &nbsp;What if you don&#8217;t have write access to the share? &nbsp;I think this may be an archetypal method of warning about the error on Unix, but it doesn&#8217;t transfer to other architectures.</p>

		
				</div>
		</li><!-- #comment-## -->
		<li class="comment odd alt thread-odd thread-alt depth-1" id="comment-364323">
				<div id="div-comment-364323" class="comment-body">
				<div class="comment-author vcard">
						<cite class="fn"><a href='http://www.reactos.org' rel='external nofollow' class='url'>Steven Edwards</a></cite> <span class="says">says:</span>		</div>
		
		<div class="comment-meta commentmetadata"><a href="https://blogs.msdn.microsoft.com/oldnewthing/20060331-15/?p=31703#comment-364323">
			March 31, 2006 at 7:45 pm</a>		</div>

		<p>Then bugs like this would not happen as much. As it stands right now the CIFS license is not open enough for the use of the Samba prtoject so they still has to clean-room it. Maybe if they did not have to waste so much time reversing undocumented stuff then they would have more time and bugs like this would not show up.</p>

		
				</div>
		</li><!-- #comment-## -->
		<li class="comment even thread-even depth-1" id="comment-363873">
				<div id="div-comment-363873" class="comment-body">
				<div class="comment-author vcard">
						<cite class="fn">BryanK</cite> <span class="says">says:</span>		</div>
		
		<div class="comment-meta commentmetadata"><a href="https://blogs.msdn.microsoft.com/oldnewthing/20060331-15/?p=31703#comment-363873">
			March 31, 2006 at 11:52 am</a>		</div>

		<p>Raymond, your HTTP attack scenario will *only* work if the user is running IE. &nbsp;No other browser (&#8230;well, I&#8217;m not sure about Opera, but not FF, not Lynx, and not wget) will follow UNC paths, especially not in iframes. &nbsp;Not that this necessarily helps the end-user, but it is an instance of other browsers being better in some cases. &nbsp;;-)</p>
<p>Also, Samba is not a &quot;driver&quot; in the general sense of that word. &nbsp;It&#8217;s done in userspace (so much the better, because upgrading it doesn&#8217;t require a reboot!), not in kernel space. &nbsp;Not that that actually changes anything, but referring to it as a driver seemed to cause some of the issues in yesterday&#8217;s posts. &nbsp;Since that&#8217;s an inaccurate description anyway, maybe referring to it as the &quot;server software&quot; (or something), which would have been more accurate anyway, would have helped the confusion a bit.</p>
<p>Brian &#8212; there&#8217;s a problem with that statement. &nbsp;Samba *CAN&#8217;T* have been tested against this slow-query thing, because XP doesn&#8217;t do it. &nbsp;AFAIK 2K also doesn&#8217;t do it, but I&#8217;m not sure on that. &nbsp;Your argument that OSS is not tested as well is therefore worthless &#8212; it would not have been possible, short of writing your own SMB/CIFS client.</p>
<p>BillK &#8212; that sounds like a valid option, actually. &nbsp;If Samba already has a different value in there than Windows, and it&#8217;s the *only* other SMB server with this problem, that sounds like a decent fix. &nbsp;Not great, as my post yesterday on DOM detection went into, but perhaps passable.</p>

		
				</div>
		</li><!-- #comment-## -->
		<li class="comment odd alt thread-odd thread-alt depth-1" id="comment-363903">
				<div id="div-comment-363903" class="comment-body">
				<div class="comment-author vcard">
						<cite class="fn"><a href='http://www.crazyontap.com' rel='external nofollow' class='url'>Almost H. Anonymous</a></cite> <span class="says">says:</span>		</div>
		
		<div class="comment-meta commentmetadata"><a href="https://blogs.msdn.microsoft.com/oldnewthing/20060331-15/?p=31703#comment-363903">
			March 31, 2006 at 12:03 pm</a>		</div>

		<p>I just *knew* that link pointed to my post! &nbsp;</p>
<p>Anyway, I stand by my original assessment. &nbsp;The only reasonable course of action is to present an error (returning partial results without any indication is completely unacceptable). &nbsp;Furthermore, one should definately provide an option to switch to &quot;slow mode&quot;. &nbsp;Although I don&#8217;t what difficulty there might be in remembering which servers have been selected as slow or not. </p>
<p>I&#8217;m not terribly familar with the SMB protocol but is there a way to detect the specific version of SAMBA in use on the remote server? &nbsp;(if so, I hope every vendor doesn&#8217;t change this to their own value). &nbsp;If one could reasonably detect it, I would try and make slow mode the default for that server version.<br /></p>

		
				</div>
		</li><!-- #comment-## -->
		<li class="comment even thread-even depth-1" id="comment-364333">
				<div id="div-comment-364333" class="comment-body">
				<div class="comment-author vcard">
						<cite class="fn">Stefan Kanthak</cite> <span class="says">says:</span>		</div>
		
		<div class="comment-meta commentmetadata"><a href="https://blogs.msdn.microsoft.com/oldnewthing/20060331-15/?p=31703#comment-364333">
			March 31, 2006 at 8:15 pm</a>		</div>

		<p>Even the &quot;best&quot; developers/testers who have access to the CIFS specs produce bugs and don&#8217;t find them in time: see MSKB article 896427!</p>
<p>Stefan</p>

		
				</div>
		</li><!-- #comment-## -->
		<li class="comment odd alt thread-odd thread-alt depth-1" id="comment-363923">
				<div id="div-comment-363923" class="comment-body">
				<div class="comment-author vcard">
						<cite class="fn">Mark Steward</cite> <span class="says">says:</span>		</div>
		
		<div class="comment-meta commentmetadata"><a href="https://blogs.msdn.microsoft.com/oldnewthing/20060331-15/?p=31703#comment-363923">
			March 31, 2006 at 12:21 pm</a>		</div>

		<p>Damn &#8211; I was just about to add a comment to the last one, when I noticed the pingback!</p>
<p>In the SMB_FIND_ID bug, the difference between &quot;fast&quot; and &quot;slow&quot; is that the &quot;fast&quot; call returns an ID (which I assume it can then use in the future for faster calls). &nbsp;So running the &quot;faster&quot; one in the background is pointless. &nbsp;Smbd&#8217;s FindFileFirst happily retrieves the first 100 or so files (this number can be set by the client), but FindFileNext is missing the code for returning ID&#8217;s, and fails as soon as it&#8217;s called.</p>
<p>If that&#8217;s the case, a quick look at smbd.c suggests that if there are more than 100 files, the server itself re-queries the directory to find the next one, so has the race condition present. &nbsp;It also looks like the client could simply switch over to the non-ID listing if it detects the server can&#8217;t cope, and then get the IDs as required.</p>
<p>Also, if it knows it&#8217;s talking to a Samba server, the redirector could request only one file in the FindFirst transaction, and then issue a FindNext. &nbsp;This would allow the whitelisting to happen without an enormous directory. &nbsp;If there&#8217;s only one file, there really is no performance penalty.</p>
<p>So it looks like most of the suggested workarounds would work, and the user doesn&#8217;t need to be brought into it. &nbsp;Assuming this *is* the problem Raymond has in mind, the only question is which fix is most resilient.</p>
<p>Whatever is decided, it seems the best thing is (as Larry suggested) to create a new SMB dialect for the new fixed Samba, so that eventually the fix can be deprecated.</p>
<p>Mark</p>

		
				</div>
		</li><!-- #comment-## -->
		<li class="comment even thread-even depth-1" id="comment-363933">
				<div id="div-comment-363933" class="comment-body">
				<div class="comment-author vcard">
						<cite class="fn"><a href='http://t-mix.blogspot.com' rel='external nofollow' class='url'>Tony</a></cite> <span class="says">says:</span>		</div>
		
		<div class="comment-meta commentmetadata"><a href="https://blogs.msdn.microsoft.com/oldnewthing/20060331-15/?p=31703#comment-363933">
			March 31, 2006 at 12:21 pm</a>		</div>

		<p>In Pseudocode (Alas, I&#8217;m not familiar with IEnumIDList::Next):</p>
<p>Next(LPXY *list)<br />
<br />{<br />
<br /> &nbsp;hRes = GetNextFromServer(list);</p>
<p> &nbsp;if(hRes == kObscureSambaError)<br />
<br /> &nbsp;{<br />
<br /> &nbsp; &nbsp;SortOutSambaError(list);</p>
<p> &nbsp; &nbsp;// Remember to use slow for this server<br />
<br /> &nbsp; &nbsp;UseSlowForServer();<br />
<br /> &nbsp; &nbsp;UseGeneratedListForThisDirectory();<br />
<br /> &nbsp;}<br />
<br />}</p>
<p>SortOutSambaError(LPXY *list)<br />
<br />{<br />
<br /> &nbsp;// This will return files e.g. ACE<br />
<br /> &nbsp;GetListFastFromServer(fast);<br />
<br /> &nbsp;<br />
<br /> &nbsp;// This will return files e.g. ABCDE<br />
<br /> &nbsp;GetListSlowFromServer(slow);</p>
<p> &nbsp;// This will generate a new filelist e.g. ACEBD<br />
<br /> &nbsp;list = AppendFromSlowToFast(slow, fast);</p>
<p> &nbsp;// Save it for this server and this dirctory<br />
<br /> &nbsp;// So we can use it again for the next Next()<br />
<br /> &nbsp;this-&gt;generatedlist = list;<br />
<br />}<br />
<br />____________</p>
<p>Ok, there is more code needed, but I hope you catch my drift.</p>

		
				</div>
		</li><!-- #comment-## -->
		<li class="comment odd alt thread-odd thread-alt depth-1" id="comment-364343">
				<div id="div-comment-364343" class="comment-body">
				<div class="comment-author vcard">
						<cite class="fn">Nick Lamb</cite> <span class="says">says:</span>		</div>
		
		<div class="comment-meta commentmetadata"><a href="https://blogs.msdn.microsoft.com/oldnewthing/20060331-15/?p=31703#comment-364343">
			March 31, 2006 at 8:26 pm</a>		</div>

		<p>The fixed (for bug #3526) Samba is in Fedora Core 5, Debian Testing, and various other bleeding edge distros. It will be in all the new commercial supported offerings over the coming months and of course the newer version or a backport will be pushed into the update queue for existing systems like RHEL.</p>
<p>Bugs happen, people trying to pin &quot;blame&quot; on someone are missing Raymond&#8217;s point, with the possible exception of those pointing at an overcomplicated and underdocumented protocol as the cause.</p>

		
				</div>
		</li><!-- #comment-## -->
		<li class="comment even thread-even depth-1" id="comment-363953">
				<div id="div-comment-363953" class="comment-body">
				<div class="comment-author vcard">
						<cite class="fn">BryanK</cite> <span class="says">says:</span>		</div>
		
		<div class="comment-meta commentmetadata"><a href="https://blogs.msdn.microsoft.com/oldnewthing/20060331-15/?p=31703#comment-363953">
			March 31, 2006 at 12:34 pm</a>		</div>

		<p>J: *Everyone* releases untested code. &nbsp;Perhaps you are laboring under the assumption that it&#8217;s possible to completely test every single code path in a program? &nbsp;If so, you might want to shed that assumption right now, because it&#8217;s not actually possible.</p>
<p>The difference with open-source isn&#8217;t that it&#8217;s better tested, it&#8217;s that fixes for the breakage that get found in the tests get integrated into the main software tree much more quickly.</p>
<p>(I don&#8217;t know how many bugs I&#8217;ve found in third party closed source software that I use at work that will never get fixed, because basically the vendor doesn&#8217;t care anymore. &nbsp;That includes Microsoft stuff as well; in particular, there&#8217;s a huge problem with BITS 1.1 and proxies that&#8217;s bitten me several times, where the BITS 2.0 update won&#8217;t even download via Windows Update when an authenticating proxy is set up. &nbsp;Taking the issue up with the Windows Update PSS group resulted in a fix of basically &quot;don&#8217;t do that then, just set them up as a NAT client instead&quot;, which is not at all a good fix. &nbsp;The WU activex control should work with both BITS 1.1 and 2.0 &#8212; after all, it worked with 1.1 until WUv6, and BITS 2.0 is a required update before WUv6 will work anyway.)</p>

		
				</div>
		</li><!-- #comment-## -->
		<li class="comment odd alt thread-odd thread-alt depth-1" id="comment-363993">
				<div id="div-comment-363993" class="comment-body">
				<div class="comment-author vcard">
						<cite class="fn">David Walker</cite> <span class="says">says:</span>		</div>
		
		<div class="comment-meta commentmetadata"><a href="https://blogs.msdn.microsoft.com/oldnewthing/20060331-15/?p=31703#comment-363993">
			March 31, 2006 at 1:18 pm</a>		</div>

		<p>For the comments that say the following: &nbsp;&quot;You can apparently throw out all the suggestions about retrying the operation, because they would fail too: </p>
<p>The next NtQueryDirectoryFile [fast] call after getting the first 128 directory entries returns STATUS_INVALID_LEVEL. </p>
<p>If we switch to using the FileBothDirectoryInformation [slow] after getting this error, that call returns STATUS_NO_MORE_FILES. &nbsp;This does not happen when using the FileBothDirectoryInformation [slow] level right from the start. &quot;</p>
<p>****</p>
<p>IF you SWITCH to using the slow version after getting the STATUS_INVALID_LEVEL error. &nbsp;</p>
<p>How about closing the connection, and then reopening it in slow mode? (Starting completely over after seeing the error.) &nbsp;</p>
<p>If &quot;closing the connection&quot; isn&#8217;t the right term, then start over and do whatever you would have done if fast mode didn&#8217;t exist.</p>
<p>Why hasn&#8217;t anyone mentioned that possibility?</p>
<p>David W</p>

		
				</div>
		</li><!-- #comment-## -->
		<li class="comment even thread-even depth-1" id="comment-364353">
				<div id="div-comment-364353" class="comment-body">
				<div class="comment-author vcard">
						<cite class="fn">kuwanger</cite> <span class="says">says:</span>		</div>
		
		<div class="comment-meta commentmetadata"><a href="https://blogs.msdn.microsoft.com/oldnewthing/20060331-15/?p=31703#comment-364353">
			March 31, 2006 at 9:20 pm</a>		</div>

		<p>&quot;You could copyright the key too stop the Samba people from distributing it if they extracted it from the Vista server binaries.&quot;</p>
<p>Perhaps you&#8217;ve not heard of the case of Sega vs Accolade? &nbsp;Interoperability is a legitimate excuse for effectively violating copyright, even if it seems to cause endorsement by trademark, when the copyrighted work itself is used merely as an obstacle &nbsp;for interoperability&#8211;ie, Samba could copy said key but say Compaq had to reverse engineer the IBM BIOS, since the BIOS actually did work; I&#8217;m not sure what would happen if the code itself was the key, though I&#8217;d imagine it&#8217;d be kosher so long as they used it merely as a key and wrote their own code.</p>
<p>And just to point out how the DeCSS case doesn&#8217;t apply, the DeCSS case only shows that this doesn&#8217;t apply towards protecting specific works. &nbsp;But reasonably if one needed to CSS encrypt a movie for it work in a DVD player, then one would be perfectly allowed to encrypt one&#8217;s own movie. &nbsp;The DMCA, afterall, is about preventing the cracking of encryption for a work, not preventing the encryption of something one made. &nbsp;Go figure.</p>

		
				</div>
		</li><!-- #comment-## -->
		<li class="comment odd alt thread-odd thread-alt depth-1" id="comment-364053">
				<div id="div-comment-364053" class="comment-body">
				<div class="comment-author vcard">
						<cite class="fn">J</cite> <span class="says">says:</span>		</div>
		
		<div class="comment-meta commentmetadata"><a href="https://blogs.msdn.microsoft.com/oldnewthing/20060331-15/?p=31703#comment-364053">
			March 31, 2006 at 2:12 pm</a>		</div>

		<p>&quot;*Everyone* releases untested code. &nbsp;Perhaps you are laboring under the assumption that it&#8217;s possible to completely test every single code path in a program?&quot;</p>
<p>Stay within the context of the argument, please. &nbsp;If I release software that supports a fast mode and a slow mode, you can bet I&#8217;ll test both modes. &nbsp;Of course I won&#8217;t be able to test every possible branch, but I&#8217;ll be damned if I release a major feature without testing it.</p>
<p>But for that matter, you don&#8217;t even know whether they tested this feature, you&#8217;re just making stuff up for the sake of arguing. &nbsp;They probably did test it, and they probably just didn&#8217;t find this bug.<br /></p>

		
				</div>
		</li><!-- #comment-## -->
		<li class="comment even thread-even depth-1" id="comment-364073">
				<div id="div-comment-364073" class="comment-body">
				<div class="comment-author vcard">
						<cite class="fn">mikeb</cite> <span class="says">says:</span>		</div>
		
		<div class="comment-meta commentmetadata"><a href="https://blogs.msdn.microsoft.com/oldnewthing/20060331-15/?p=31703#comment-364073">
			March 31, 2006 at 2:18 pm</a>		</div>

		<p>&gt;&gt; If Samba&#8217;s the only SMB server that exhibits this problem, and a fix is already in the codebase, it&#8217;s only a matter of time before that fix gets everywhere it needs to be. &nbsp;By the time the next version of Windows comes out, the fix should be pretty much everywhere, and you can flip the switch. &lt;&lt;</p>
<p>Now think this through &#8211; the big problem is not:</p>
<p>1) whether or not (or when) the NAS vendors fix it; or</p>
<p>2) whether the kind of people who read Raymond&#8217;s blog will be able to handle the problems they might run into &#8211; they probably could handle it (even if it pisses them off when things stop working and they have to figure out how to fix it &#8211; I know I wouldn&#8217;t be thrilled);</p>
<p>The big problem for Microsoft in this situation is that there are probably thousands (hundreds of thousands?) of these defective servers out there being run in environments like your dentist&#8217;s office, the bar and grill where you&#8217;re getting lunch today, maybe even your neighbor&#8217;s mother&#8217;s house. &nbsp;None of these people know anything about Linux, Samba, or SMB. They probably don&#8217;t even really know what a server is. &nbsp;All that thing is to them is &quot;a box where my files are&quot;. Period.</p>
<p>If I&#8217;m one of those people and I install Vista and suddenly most of my files have vanished or I get these incomprehensible error messages (Error 0x81439003: Your SMB server device is running incompatible software, please upgrade it &#8211; Yes/No/Cancel), then Vista goes out the window. As a bonus, they get someone telling everyone they know that Vista is crap.</p>
<p>*That&#8217;s* why Microsoft cannot simply keep the OS &#8216;pure&#8217; and just let these servers break.</p>

		
				</div>
		</li><!-- #comment-## -->
		<li class="comment odd alt thread-odd thread-alt depth-1" id="comment-364373">
				<div id="div-comment-364373" class="comment-body">
				<div class="comment-author vcard">
						<cite class="fn"><a href='http://www.puckdroppers.us' rel='external nofollow' class='url'>Puckdropper</a></cite> <span class="says">says:</span>		</div>
		
		<div class="comment-meta commentmetadata"><a href="https://blogs.msdn.microsoft.com/oldnewthing/20060331-15/?p=31703#comment-364373">
			March 31, 2006 at 10:47 pm</a>		</div>

		<p>I think the suggestion about having the affected server (if there&#8217;s other SMB products out there, they could concieveably be affected too) update its &quot;family&quot; field to reflect compatibility is one of the best.</p>
<p>I&#8217;d like to suggest this alternative:<br />
<br />Set the mode to &quot;slow&quot; (or &quot;compatible&quot;) and make the user enable &quot;fast&quot; in Vista. &nbsp;In the next release of Windows, default to fast. &nbsp;This will allow time for people to upgrade their NAS devices as they break or run out of space. &nbsp;If you can upgrade the NAS for adding new hard drives, you should (hopefully) be able to upgrade it for OS updates.</p>
<p>Drawbacks:<br />
<br />1) Less incentive for immediate upgrades.<br />
<br />2) People accuse Microsoft of intentionally slowing the computer. &nbsp;(I&#8217;ve seen programs that made it sound like the 0.4 second delay for the start menu to pop up and go away was a huge conspiracy.)<br />
<br />3) The benefit of the Fast mode is not gotten<br />
<br />4) You&#8217;re time shifting the problem, hoping that it goes away.</p>

		
				</div>
		</li><!-- #comment-## -->
		<li class="comment even thread-even depth-1" id="comment-364123">
				<div id="div-comment-364123" class="comment-body">
				<div class="comment-author vcard">
						<cite class="fn">sayler</cite> <span class="says">says:</span>		</div>
		
		<div class="comment-meta commentmetadata"><a href="https://blogs.msdn.microsoft.com/oldnewthing/20060331-15/?p=31703#comment-364123">
			March 31, 2006 at 2:49 pm</a>		</div>

		<p>With respect to cache trashing, (and not that I think it&#8217;s the Right way to do it), caches can be &nbsp;(and usually *should be*) limited in size.</p>

		
				</div>
		</li><!-- #comment-## -->
		<li class="comment odd alt thread-odd thread-alt depth-1" id="comment-364133">
				<div id="div-comment-364133" class="comment-body">
				<div class="comment-author vcard">
						<cite class="fn">sayler</cite> <span class="says">says:</span>		</div>
		
		<div class="comment-meta commentmetadata"><a href="https://blogs.msdn.microsoft.com/oldnewthing/20060331-15/?p=31703#comment-364133">
			March 31, 2006 at 2:53 pm</a>		</div>

		<p>With respect to cache trashing, (and not that I think it&#8217;s the Right way to do it), caches can be &nbsp;(and usually *should be*) limited in size.</p>

		
				</div>
		</li><!-- #comment-## -->
		<li class="comment even thread-even depth-1" id="comment-364383">
				<div id="div-comment-364383" class="comment-body">
				<div class="comment-author vcard">
						<cite class="fn">Cooney</cite> <span class="says">says:</span>		</div>
		
		<div class="comment-meta commentmetadata"><a href="https://blogs.msdn.microsoft.com/oldnewthing/20060331-15/?p=31703#comment-364383">
			March 31, 2006 at 11:12 pm</a>		</div>

		<p>Better idea:</p>
<p>Set the default on a server to slow. If you encounter a folder with more than 100 files, send the fast command and, if it succeeds, tag the server as fast, else known slow. </p>
<p>This works with all servers, takes advantage of fast behavior when large folders are encountered, and requires no user interaction.</p>

		
				</div>
		</li><!-- #comment-## -->
		<li class="comment odd alt thread-odd thread-alt depth-1" id="comment-364193">
				<div id="div-comment-364193" class="comment-body">
				<div class="comment-author vcard">
						<cite class="fn">JSM</cite> <span class="says">says:</span>		</div>
		
		<div class="comment-meta commentmetadata"><a href="https://blogs.msdn.microsoft.com/oldnewthing/20060331-15/?p=31703#comment-364193">
			March 31, 2006 at 3:39 pm</a>		</div>

		<p>Default to fast, but fall back to slow if there is an error. &nbsp;Provide a registry setting to force the use of the slow method (thereby avoiding making two requests each time to buggy servers).</p>
<p>Advantages:<br />
<br />* Users see correct results in explorer regardless of whether the server has this bug. &nbsp;IMO this should be a requirement for any solution, not merely an advantage.<br />
<br />* Servers that correctly implement this feature are not disadvantaged (with the default configuration).<br />
<br />* Users are not presented with error messages which, for most of them, would probably be useless anyway.</p>
<p>Disadvantages:<br />
<br />* Vista will be somewhat slower than XP for this operation when communicating with buggy servers, since it will perform two requests at least some of the time (depending on how clever you want to be about &quot;remembering&quot; which servers are buggy).<br />
<br />* Additional code complexity to implement and maintain this workaround.</p>
<p>As a developer, I can imagine that this might require a fair amount of additional complexity, but from the user&#8217;s perspective it definitely seems like the best solution. &nbsp;</p>
<p>If the additional complexity is deemed unacceptable, it seems like the only viable option is to disable fast mode. &nbsp;The alternative is for Vista to display incorrect file listings to some customers, bearing in mind that many of these customer will (for various reasons) simply be *unable* to address the root cause of the problem. &nbsp;For them, the only way to avoid this problem would be to not use Vista.</p>
<p>Throwing up an error or warning dialog is worse than useless for most users, since most people either won&#8217;t know how to fix the problem or won&#8217;t care that it&#8217;s a little slower. &nbsp;If someone really cares about the difference in performance, then they&#8217;re more likely to be motivated to do a little research. &nbsp;Provide a KB article for the problem, and from there they can learn how to disable fast mode and at least get the same performance they had in XP.<br /></p>

		
				</div>
		</li><!-- #comment-## -->
		<li class="comment even thread-even depth-1" id="comment-364393">
				<div id="div-comment-364393" class="comment-body">
				<div class="comment-author vcard">
						<cite class="fn"><a href='http://samba.org/~jra' rel='external nofollow' class='url'>Jeremy Allison</a></cite> <span class="says">says:</span>		</div>
		
		<div class="comment-meta commentmetadata"><a href="https://blogs.msdn.microsoft.com/oldnewthing/20060331-15/?p=31703#comment-364393">
			April 1, 2006 at 12:07 am</a>		</div>

		<p>This is a bug someone reported to us 19th feb 2006. I fixed it the same day (it was an error in my code, missing a couple of entries in a switch statement). The bug &#8211; here :</p>
<p><a rel="nofollow" target="_new" href="https://bugzilla.samba.org/show_bug.cgi?id=3526" rel="nofollow">https://bugzilla.samba.org/show_bug.cgi?id=3526</a></p>
<p>was fixed in 3.0.21c. By the time Vista ships I expect most vendors to have moved to at least this version. If the Microsoft engineers came to the CIFS conference along with all the other CIFS engineers this problem would have been found and fixed in earlier versions of Samba. I urge Microsoft&#8217;s engineers to communicate directly with the Samba Team when they find problems like this. We have good relations with all our vendors and have the ability to push expidited bugfixes to people who are shipping Samba code.</p>
<p>To quote Steve McQueen, This is simply a failure to communicate :-). Let&#8217;s hope we all do a better job in future.</p>
<p>Jeremy Allison,<br />
<br />Samba Team.</p>

		
				</div>
		</li><!-- #comment-## -->
		<li class="comment odd alt thread-odd thread-alt depth-1" id="comment-364423">
				<div id="div-comment-364423" class="comment-body">
				<div class="comment-author vcard">
						<cite class="fn">Cheong</cite> <span class="says">says:</span>		</div>
		
		<div class="comment-meta commentmetadata"><a href="https://blogs.msdn.microsoft.com/oldnewthing/20060331-15/?p=31703#comment-364423">
			April 1, 2006 at 12:29 am</a>		</div>

		<p>After read about this, I go to check if Samba will register it&#8217;s version when joining domain, but sadly to find out that they just leave the OS version information blank.</p>
<p>And by right-click -&gt; properties, it just show that it&#8217;s a &quot;Windows NT 4.9 Server&quot;, which in this case doesn&#8217;t helpful either.</p>

		
				</div>
		</li><!-- #comment-## -->
		<li class="comment even thread-even depth-1" id="comment-364433">
				<div id="div-comment-364433" class="comment-body">
				<div class="comment-author vcard">
						<cite class="fn"><a href='http://www.deez.info/sengelha/blog/' rel='external nofollow' class='url'>Steven Engelhardt</a></cite> <span class="says">says:</span>		</div>
		
		<div class="comment-meta commentmetadata"><a href="https://blogs.msdn.microsoft.com/oldnewthing/20060331-15/?p=31703#comment-364433">
			April 1, 2006 at 1:06 am</a>		</div>

		<p>Suggestion:</p>
<p>1) Store a state per SMB connection: Untested, FastCompatible, SlowCompatible. &nbsp;All connections start Untested. &nbsp;Use &quot;slow&quot; mode for Untested and SlowCompatible, &quot;fast&quot; mode for FastCompatible.<br />
<br />2) If you come across large directory in the normal course of using an Untested server, save its name. &nbsp;On an idle thread, use this directory to identify whether the Untested server has the bug, and set its state to FastCompatible or SlowCompatible accordingly.<br />
<br />3) Change the SMB protocol to eliminate the long-term requirement of the compatilbity test in the long-term.</p>

		
				</div>
		</li><!-- #comment-## -->
		<li class="comment odd alt thread-odd thread-alt depth-1" id="comment-364443">
				<div id="div-comment-364443" class="comment-body">
				<div class="comment-author vcard">
						<cite class="fn"><a href='http://mindon.net/~ayhal' rel='external nofollow' class='url'>A Tykhyy</a></cite> <span class="says">says:</span>		</div>
		
		<div class="comment-meta commentmetadata"><a href="https://blogs.msdn.microsoft.com/oldnewthing/20060331-15/?p=31703#comment-364443">
			April 1, 2006 at 1:15 am</a>		</div>

		<p>Oh, and I forgot &#8212; when the count of filenames returned by a fast query exceeds say 200 (more than the maximum necessary for Samba to produce the bug) then the filename buffer may be discarded. And of course no buffer at all for slow queries.</p>

		
				</div>
		</li><!-- #comment-## -->
		<li class="comment even thread-even depth-1" id="comment-364453">
				<div id="div-comment-364453" class="comment-body">
				<div class="comment-author vcard">
						<cite class="fn">hmm</cite> <span class="says">says:</span>		</div>
		
		<div class="comment-meta commentmetadata"><a href="https://blogs.msdn.microsoft.com/oldnewthing/20060331-15/?p=31703#comment-364453">
			April 1, 2006 at 1:58 am</a>		</div>

		<p>Well there you go Raymond. Leave it as fast mode, document older Samba/NAS devices may have issues, and link to a quote from Jeremy saying that said devices have had the code for a while and should be fixed :)</p>
<p>If you are feeling nice, provide a RegKey to force it down to SLOW, for those who cannot upgrade.<br /></p>

		
				</div>
		</li><!-- #comment-## -->
		<li class="comment odd alt thread-odd thread-alt depth-1" id="comment-364463">
				<div id="div-comment-364463" class="comment-body">
				<div class="comment-author vcard">
						<cite class="fn">Brian</cite> <span class="says">says:</span>		</div>
		
		<div class="comment-meta commentmetadata"><a href="https://blogs.msdn.microsoft.com/oldnewthing/20060331-15/?p=31703#comment-364463">
			April 1, 2006 at 2:45 am</a>		</div>

		<p>&quot;My bug equals your failure to communicate.&quot;</p>
<p>Gotta love accountability. &nbsp;Hey, you&#8217;re reverse engineering software&#8211;that&#8217;s life in the big city. &nbsp;Feel free to come up with your own network service, it has been done (Microsoft reverse engineered the Netware client way back when).</p>

		
				</div>
		</li><!-- #comment-## -->
		<li class="comment even thread-even depth-1" id="comment-364293">
				<div id="div-comment-364293" class="comment-body">
				<div class="comment-author vcard">
						<cite class="fn">Amos Houndsbreath</cite> <span class="says">says:</span>		</div>
		
		<div class="comment-meta commentmetadata"><a href="https://blogs.msdn.microsoft.com/oldnewthing/20060331-15/?p=31703#comment-364293">
			March 31, 2006 at 7:17 pm</a>		</div>

		<p>I have an idea. It&#8217;s practical and user friendly, and it will save time testing. Additionally, it will give the slashdot crowd aneurisms. I consider this to be a feature.</p>
<p>Add a new transaction to SMB, &quot;Check server trust level&quot;. The client would send a random challenge, and the server would sign the challenge with a private key and return the digital signature. The client could then check this signature and know if it was a trusted implementation, i.e. one that was verified in house, or some untested junk like Samba written by the great unwashed with a user configurable and hence untrusted version string.</p>
<p>You could copyright the key too stop the Samba people from distributing it if they extracted it from the Vista server binaries.</p>
<p>If the server were trusted, you could use new prototol stuff like fast queries. Untrusted servers would run in compatibility mode, i.e. whatever works on *all* untrusted servers.</p>
<p>That way, you can innovate freely, and you only need to test clients against servers running your code. When the client is used with a untrusted server it goes into legacy mode. And you can stop the thieving samba hippies from impersonating a real Windows machine if you get the security/legal stuff right. </p>
<p>You could even have a &#8216;CIFS+&#8217; licensing program, where OEM&#8217;s would license a know good implementation of the latest server code, and it would be tested in the MS labs. They&#8217;d get a copyright license for the cryptographic keys once it had been tested, and would be considered &#8216;trusted&#8217; by Windows clients. It would be a bit like a HQL lab for server code. Given that 64bit Vista requires tested and signed drivers, I see no reason why it shouldn&#8217;t require tested and signed servers.</p>
<p>Hell, I&#8217;ll buy an extra copy of Vista if you pull it off, because I have an irrational hatred for those open source guys. I only hope that the real solution is different enough from this that you can patent it too.</p>
<p>It&#8217;s the AARD code for the 21st Century. Bwahahaha!</p>

		
				</div>
		</li><!-- #comment-## -->
		<li class="comment odd alt thread-odd thread-alt depth-1" id="comment-364313">
				<div id="div-comment-364313" class="comment-body">
				<div class="comment-author vcard">
						<cite class="fn">BryanK</cite> <span class="says">says:</span>		</div>
		
		<div class="comment-meta commentmetadata"><a href="https://blogs.msdn.microsoft.com/oldnewthing/20060331-15/?p=31703#comment-364313">
			March 31, 2006 at 7:32 pm</a>		</div>

		<p>J: You&#8217;re right, I went off on a huge tangent there. &nbsp;So let me recap what happened up until that point.</p>
<p>Brian asserted that this specific case &quot;proves&quot; OSS isn&#8217;t tested any &quot;more better&quot; [sic] than closed source. &nbsp;(Never mind the fallacy of the excluded middle in that argument, at least for the moment.) &nbsp;I responded, saying that there was no way they could have tested it with any known-good client. &nbsp;Remember, the protocol spec is *closed*; Samba does *not* have any way to know what legal client behavior is. &nbsp;(Or if they do, I don&#8217;t know where it would have come from; certainly not Microsoft.) &nbsp;The only thing they can go on is the behavior of released OSes, i.e. XP and 2K. &nbsp;And XP doesn&#8217;t do fast enumerations.</p>
<p>You said, basically &quot;so this shows he&#8217;s right, that they didn&#8217;t test this feature before releasing it&quot;. &nbsp;That&#8217;s not the point, though &#8212; the point is, they *couldn&#8217;t* test it. &nbsp;Even if they had wanted to, they couldn&#8217;t.</p>
<p>Now, if may have been a mistake for them to include that feature (or enable it) without testing, I will admit that. &nbsp;(If it&#8217;s even possible to advertise support for &quot;fast enumeration&quot;. &nbsp;If not, then they don&#8217;t have much of a choice.) &nbsp;But that still doesn&#8217;t mean that OSS is tested less than closed-source, which is what Brian was saying!</p>
<p>(Back to the fallacy of the excluded middle: &nbsp;One OSS program has a bug, OK; that does not preclude the possibility that in general, open-source is less buggy than closed. &nbsp;One counterexample in Samba would disprove the statement &quot;all OSS programs are less buggy than closed source stuff, all the time&quot;, but nobody I know of has ever made that assertion.)</p>

		
				</div>
		</li><!-- #comment-## -->
		<li class="comment even thread-even depth-1" id="comment-364473">
				<div id="div-comment-364473" class="comment-body">
				<div class="comment-author vcard">
						<cite class="fn"><a href='http://www.reactos.org' rel='external nofollow' class='url'>Steven Edwards</a></cite> <span class="says">says:</span>		</div>
		
		<div class="comment-meta commentmetadata"><a href="https://blogs.msdn.microsoft.com/oldnewthing/20060331-15/?p=31703#comment-364473">
			April 1, 2006 at 4:07 am</a>		</div>

		<p>Its articals like this that show the real problem. I think most vendors would be happy to work with Microsoft to fix these kinds of issues. I mean come on Windows makes up 99% of the desktop market. Rather than adding more hacks they could use the strength of the 5000 pound guerrilla to say &quot;There is a bug here, please fix this, we have already tracked down most of the issue for you&quot;. It seems to me the cost in QA time would be less than the cost of adding all of these hacks and going through the process to get them in the source tree. </p>
<p>I can understand the point of needing hacks for third party buggy code back in the Win9x days when no one was on the internet and getting a application update was not possible. Those days are past. As for the custom inhouse application argument. If Microsoft stopped adding hacks then maybe developers would get the idea that they cannot do undocumented stuff and a lot of the problem would go away leaving the majority of the compatiblity issue being bugs like this.<br /></p>

		
				</div>
		</li><!-- #comment-## -->
		<li class="comment odd alt thread-odd thread-alt depth-1" id="comment-364483">
				<div id="div-comment-364483" class="comment-body">
				<div class="comment-author vcard">
						<cite class="fn">Christian</cite> <span class="says">says:</span>		</div>
		
		<div class="comment-meta commentmetadata"><a href="https://blogs.msdn.microsoft.com/oldnewthing/20060331-15/?p=31703#comment-364483">
			April 1, 2006 at 4:30 am</a>		</div>

		<blockquote><p>
  Its articals like this that show the real<br />
  <br />&gt;problem. I think most vendors would be<br />
  <br />&gt;happy to work with Microsoft to fix these<br />
  <br />&gt;kinds of issues. I mean come on Windows<br />
  <br />&gt;makes up 99% of the desktop market.</p>
<p>No! There are so many lazy ineffective stupid IT-departments out there (which ruin whole companies).</p>
<p>Some MS-blogger talked about how often MS should release new versions of WIndows or Office:<br />
  <br />End Users would which it every 6 months.<br />
  <br />Big corporations wish for every 10 years!</p>
<p>They don&#8217;t want to update Samba and they don&#8217;t want Vista either, not matter how much better it is.
</p></blockquote>

		
				</div>
		</li><!-- #comment-## -->
		<li class="comment even thread-even depth-1" id="comment-364513">
				<div id="div-comment-364513" class="comment-body">
				<div class="comment-author vcard">
						<cite class="fn">pbkg</cite> <span class="says">says:</span>		</div>
		
		<div class="comment-meta commentmetadata"><a href="https://blogs.msdn.microsoft.com/oldnewthing/20060331-15/?p=31703#comment-364513">
			April 1, 2006 at 6:19 am</a>		</div>

		<p>So, I don&#8217;t have a solution to problem, but how long before hackersite.com now gets bought up and transformed into a porn site and someone says &quot;Look, MS are now advocating porn in the blogs, they really are the spawn of the devil&#8230;&quot;?</p>

		
				</div>
		</li><!-- #comment-## -->
		<li class="comment odd alt thread-odd thread-alt depth-1" id="comment-364543">
				<div id="div-comment-364543" class="comment-body">
				<div class="comment-author vcard">
						<cite class="fn">Eric</cite> <span class="says">says:</span>		</div>
		
		<div class="comment-meta commentmetadata"><a href="https://blogs.msdn.microsoft.com/oldnewthing/20060331-15/?p=31703#comment-364543">
			April 1, 2006 at 7:39 am</a>		</div>

		<p>As I said before&#8230; No errors; no new APIs; run in slow mode unless a fast mode server can be identified. </p>
<p>If Samba is always slow, tough. The long-term solution is for Samba to change the identify (eg. &quot;Sambb&quot;) presented to Vista.</p>
<p>Ideally Vista should detect fast mode Samba now, even if by looking at odd side effects such as unused bytes in packets or timing.</p>

		
				</div>
		</li><!-- #comment-## -->
		<li class="comment even thread-even depth-1" id="comment-364553">
				<div id="div-comment-364553" class="comment-body">
				<div class="comment-author vcard">
						<cite class="fn">Steven Brown</cite> <span class="says">says:</span>		</div>
		
		<div class="comment-meta commentmetadata"><a href="https://blogs.msdn.microsoft.com/oldnewthing/20060331-15/?p=31703#comment-364553">
			April 1, 2006 at 7:50 am</a>		</div>

		<p>So you knew the &#8216;SMB2&#8217; negotiation you were adding to Vista would break Samba-based devices since at least late 2005, but didn&#8217;t even /notify/ the Samba team? &nbsp;Instead, you did nothing while they had to reverse engineer what you had changed and add support for it. &nbsp;Why?</p>
<p>Is that your policy for how to deal with backwards compatibility issues created by pre-release software, or is this a special case due to Samba being a competitor? &nbsp;This sounds a lot like DR-DOS.<br /></p>

		
				</div>
		</li><!-- #comment-## -->
		<li class="comment odd alt thread-odd thread-alt depth-1" id="comment-364403">
				<div id="div-comment-364403" class="comment-body">
				<div class="comment-author vcard">
						<cite class="fn"><a href='http://samba.org/~jra' rel='external nofollow' class='url'>Jeremy Allison</a></cite> <span class="says">says:</span>		</div>
		
		<div class="comment-meta commentmetadata"><a href="https://blogs.msdn.microsoft.com/oldnewthing/20060331-15/?p=31703#comment-364403">
			April 1, 2006 at 12:21 am</a>		</div>

		<p>I forgot to mention. The bug was open in our bug db for a grand total of *three* minutes before I had the fix committed into the SVN tree. I don&#8217;t think we could have reacted faster in getting a fix done than that.</p>
<p>As I said, if it&#8217;s causing a problem with Vista deployments let us know and we&#8217;ll poke our vendors with a stick to make sure the fix gets widely updated. It&#8217;s two extra lines in a switch statement so I don&#8217;t think it&#8217;s a problem for people to review it for correctness :-).</p>
<p>Jeremy Allison,<br />
<br />Samba Team.<br /></p>

		
				</div>
		</li><!-- #comment-## -->
		<li class="comment even thread-even depth-1" id="comment-364593">
				<div id="div-comment-364593" class="comment-body">
				<div class="comment-author vcard">
						<cite class="fn"><a href='http://StevenEdwards' rel='external nofollow' class='url'>Steven Edwards</a></cite> <span class="says">says:</span>		</div>
		
		<div class="comment-meta commentmetadata"><a href="https://blogs.msdn.microsoft.com/oldnewthing/20060331-15/?p=31703#comment-364593">
			April 1, 2006 at 8:42 am</a>		</div>

		<p>Christian:<br />
<br />It seems to me your example of IT departments switching every 10 years makes it less trouble for issues like this. Thats more than enough time for third party vendors to release updates and be vista compatible. In 10 years if someone is running the version of Samba in question they should go find another field to work in due to poor understanding of how to manage infrastructure. Just calculate the amount of bugs found for any product over any length of time for any product.</p>
<p>Whats sad about issues like this is that the ammount of time it takes to report a bug like this is the amount of time it takes me to log on to irc.freenode.net and join #samba to talk to one of the developers. They have always been quick to help me in the past. I understand that for older applications, where the vendor is out of business or its a custom application there needs to be more room for compatiblity hacks but for a open source project there is no excuse. </p>
<p>Trying to use the argument&#8230;&quot;if we make it slower then people will say we are trying to break Samba&quot; is totally bogus. Go talk to the samba developers. Show a public record of trying to work with them to fix the problems. If the result is that a hack has to be added and it makes Vista run like crap when talking to Samba then you have a public record showing your co-operation with the third party. That should make the EU, US and any other court and the paranoid happy.<br /></p>

		
				</div>
		</li><!-- #comment-## -->
		<li class="comment odd alt thread-odd thread-alt depth-1" id="comment-364603">
				<div id="div-comment-364603" class="comment-body">
				<div class="comment-author vcard">
						<cite class="fn"><a href='http://www.meikel.com' rel='external nofollow' class='url'>Meikel</a></cite> <span class="says">says:</span>		</div>
		
		<div class="comment-meta commentmetadata"><a href="https://blogs.msdn.microsoft.com/oldnewthing/20060331-15/?p=31703#comment-364603">
			April 1, 2006 at 9:02 am</a>		</div>

		<p>I didn&#8217;t find anyone mentioning the following solution:</p>
<p>Forget about &quot;Fast Mode&quot; protocol completely. Implement a totally new protocol &quot;Fast Mode 2&quot; which could act just like &quot;Fast Mode&quot;. Any server not supporting &quot;Fast Mode 2&quot; will fail immediately on the first call and you can simply fallback to &quot;Slow Mode&quot; then. Any server implementing &quot;Fast Mode 2&quot; can be assumed to not have the 100+ files bug. You can even tell the SAMBA people how to correctly implement that new protocol and you can backport it down to 2003/2000 server.</p>
<p>This way no user ever has problems with that broken &quot;Fast Mode&quot; protocol. No cache, no hacks&#8230;</p>
<p>Unfortunately I think this solution is quite expensive to implement :-)</p>

		
				</div>
		</li><!-- #comment-## -->
		<li class="comment even thread-even depth-1" id="comment-364613">
				<div id="div-comment-364613" class="comment-body">
				<div class="comment-author vcard">
						<cite class="fn"><a href='http://www.reactos.org' rel='external nofollow' class='url'>Steven Edwards</a></cite> <span class="says">says:</span>		</div>
		
		<div class="comment-meta commentmetadata"><a href="https://blogs.msdn.microsoft.com/oldnewthing/20060331-15/?p=31703#comment-364613">
			April 1, 2006 at 9:03 am</a>		</div>

		<p>I will followup my last comment with this&#8230;you have a vendor with a embedded device. I have a router here that runs Linux and from time to time gets flash updates. If there is a problem, I flash it. I am sure the Samba project has a good relationship with its vendors. I am sure Microsoft has a ok relationship with them as well. Simple communication will get a fix released and deployed.<br /></p>

		
				</div>
		</li><!-- #comment-## -->
		<li class="comment byuser comment-author-larryosterman odd alt thread-odd thread-alt depth-1" id="comment-364623">
				<div id="div-comment-364623" class="comment-body">
				<div class="comment-author vcard">
						<cite class="fn"><a href='https://social.msdn.microsoft.com/profile/Larry+Osterman+%5BMSFT%5D' rel='external nofollow' class='url'>Larry Osterman [MSFT]</a></cite> <span class="says">says:</span>		</div>
		
		<div class="comment-meta commentmetadata"><a href="https://blogs.msdn.microsoft.com/oldnewthing/20060331-15/?p=31703#comment-364623">
			April 1, 2006 at 9:45 am</a>		</div>

		<p>Jeremy,<br />
<br /> &nbsp;The problem is that fixing the bug isn&#8217;t the issue. &nbsp;Raymond acknowledged that the bug was fixed quickly.</p>
<p> &nbsp;The problem is that people have deployed servers with the bug in them, and now the question is how do we work around those broken servers. &nbsp;Unless you can guarantee that the population of SAMBA servers in the wild with the bug is exactly 0, it doesn&#8217;t change Raymond&#8217;s problem.</p>
<p> &nbsp;This is the problem with compatibility issues, especially when they&#8217;re cross-platform. &nbsp;Microsoft can blacklist drivers that are known to be bad and let the user know how to get a new one. &nbsp;We can&#8217;t do the same thing for software running on some other box (which may not have a mechanism for updating).<br /></p>

		
				</div>
		</li><!-- #comment-## -->
		<li class="comment even thread-even depth-1" id="comment-364633">
				<div id="div-comment-364633" class="comment-body">
				<div class="comment-author vcard">
						<cite class="fn">Steve Loughran</cite> <span class="says">says:</span>		</div>
		
		<div class="comment-meta commentmetadata"><a href="https://blogs.msdn.microsoft.com/oldnewthing/20060331-15/?p=31703#comment-364633">
			April 1, 2006 at 9:49 am</a>		</div>

		<p>I run 5 samba servers, this is going to break me. Fortunately, I will have upgraded all my (non-embedded) systems way before Vista ships, though the version embedded into VMWare is out of my control.</p>
<p>The best fix in this solution is: never let it happen again. </p>
<p>1. document your protocols, the way the EU have been telling you to do for months. The source (with restrictions) is wrong, all people need is honest documentation.</p>
<p>2. discuss changes with other users of the protocol. That includes the OSS implementation.</p>
<p>3. recognise that you no longer own SMB, just as Novell dont own Netware and sun dont own NFS. It is so embedded that you cannot change things willy-nilly.</p>
<p>Its unfortunate that SMB is an ugly dog of a filesystem protocol. NFS is a lot cleaner and much easier to implement, and is well documented, with open interop festivals to find problems early. Of course, NFS has different flaws -it was never written for a world where a &nbsp;laptop could 0wn the LAN.</p>

		
				</div>
		</li><!-- #comment-## -->
		<li class="comment odd alt thread-odd thread-alt depth-1" id="comment-364653">
				<div id="div-comment-364653" class="comment-body">
				<div class="comment-author vcard">
						<cite class="fn">Stefan Kanthak</cite> <span class="says">says:</span>		</div>
		
		<div class="comment-meta commentmetadata"><a href="https://blogs.msdn.microsoft.com/oldnewthing/20060331-15/?p=31703#comment-364653">
			April 1, 2006 at 10:34 am</a>		</div>

		<p>Adam,</p>
<p>you look at file URIs only from the Windows side and the implementation chosen there!<br />
<br />In general, file://server/path says &quot;use the local filesystem access methods to fetch //server/path&quot;.<br />
<br />Just try it.<br />
<br />The other notation for access to files on local drives needed in Windows is a pita!</p>
<p>Stefan<br /></p>

		
				</div>
		</li><!-- #comment-## -->
		<li class="comment even thread-even depth-1" id="comment-364673">
				<div id="div-comment-364673" class="comment-body">
				<div class="comment-author vcard">
						<cite class="fn">James Risto</cite> <span class="says">says:</span>		</div>
		
		<div class="comment-meta commentmetadata"><a href="https://blogs.msdn.microsoft.com/oldnewthing/20060331-15/?p=31703#comment-364673">
			April 1, 2006 at 11:07 am</a>		</div>

		<p>I doubt I am adding value to this, but thinking about the idea of &quot;remembering&quot; features of any connections; I wonder if this is a good strategy at all. There is the &quot;cache pollution/DOS&quot; idea, plus what if I replace my xxx server with yyy with the same name and IP? What about load balancers and such that mask what the real target is? Also, unless I misunderstand, Raymond is saying that it is too late to do anything anyway because you are already 100 files in. So, much as I hate leaving performance on the table, I think that we will let this one go, leave it in slow mode for now, and put fast mode in CIFS 1.1 in LongHorn server. At least not slower than XP today. Shame though, the lowest common denominator holding us back &#8230; but compat is king in the Windows space unless there is Security risk.</p>

		
				</div>
		</li><!-- #comment-## -->
		<li class="comment odd alt thread-odd thread-alt depth-1" id="comment-364693">
				<div id="div-comment-364693" class="comment-body">
				<div class="comment-author vcard">
						<cite class="fn">Amos Houndsbreath</cite> <span class="says">says:</span>		</div>
		
		<div class="comment-meta commentmetadata"><a href="https://blogs.msdn.microsoft.com/oldnewthing/20060331-15/?p=31703#comment-364693">
			April 1, 2006 at 11:40 am</a>		</div>

		<p>kuwanger wrote<br />
<br />&quot;Interoperability is a legitimate excuse for effectively violating copyright&quot;</p>
<p>With my solution, Samba would still be interoperable. Fast mode is a performance thing, Microsoft don&#8217;t have to support fast mode on a third party server if they don&#8217;t want to. So the samba guys wouldn&#8217;t have interoperability as an excuse for violation copyright/patents.</p>
<p>In fact, SMB is in an ideal state for this. There&#8217;s the current stuff which is de facto open. All the new stuff doesn&#8217;t have to be. Users would be free to choose cheap NAS boxes based on samba, or expensive ones based on a licensed/tested Microsoft protocol implementation with slightly better performance and more features.</p>
<p>Steve Loughran<br />
<br />&quot;3. recognise that you no longer own SMB, just as Novell dont own Netware and sun dont own NFS. It is so embedded that you cannot change things willy-nilly.&quot;</p>
<p>Seems to me that they do recognise this. The whole point of this is to preserve the user experience with broken third party servers, just like they do it with broken third party applications. </p>
<p>The problem with Samba is that you can&#8217;t tell which version you are dealing with. If it&#8217;s a NAS box, you have no way of knowing if it has a particular bug or not. And this bug looks like you can&#8217;t even switch back to slow mode if fast mode fails.</p>
<p>Incidentally, is it possible to restart the connection after a fast mode fail? Maybe you could disconnect, set the &quot;slow mode only&quot; flag for the server and reconnect, and that would be sufficient to reset the server&#8217;s internal state.</p>

		
				</div>
		</li><!-- #comment-## -->
		<li class="comment even thread-even depth-1" id="comment-364703">
				<div id="div-comment-364703" class="comment-body">
				<div class="comment-author vcard">
						<cite class="fn">Joe User</cite> <span class="says">says:</span>		</div>
		
		<div class="comment-meta commentmetadata"><a href="https://blogs.msdn.microsoft.com/oldnewthing/20060331-15/?p=31703#comment-364703">
			April 1, 2006 at 11:59 am</a>		</div>

		<p>Vista isn&#8217;t done till Samba won&#8217;t run. &nbsp;Just another example of why Micosoft S.U.C.K.S</p>

		
				</div>
		</li><!-- #comment-## -->
		<li class="comment odd alt thread-odd thread-alt depth-1" id="comment-364723">
				<div id="div-comment-364723" class="comment-body">
				<div class="comment-author vcard">
						<cite class="fn">Adam</cite> <span class="says">says:</span>		</div>
		
		<div class="comment-meta commentmetadata"><a href="https://blogs.msdn.microsoft.com/oldnewthing/20060331-15/?p=31703#comment-364723">
			April 1, 2006 at 12:16 pm</a>		</div>

		<p>Stefan:</p>
<p>No, I&#8217;m looking at this from a multi-system point of view.</p>
<p>&quot;In general, file://server/path says &quot;use the local filesystem access methods to fetch //server/path&quot;.&quot;</p>
<p>Um. How does the &quot;file&quot; protocol work remotely? What port does it run over? If you can point to any kind of discussion on how this protocol might work, anywhere, I&#8217;d be glad to read about it.</p>
<p>The &quot;file&quot; schema makes <em>no sense</em> remotely. You have to have a <em>protocol</em> to access a remote file. There is no way to access a remote file with the &quot;file&quot; URI schema, <em>unless</em> that file has been mapped to part of your local filesystem&#8217;s namespace.</p>
<p>Windows just does this automatically for SMB. It effectively &quot;mounts&quot; all the SMB shares on your local network to the &quot;\&quot; part of your local filesystem. All the files are treated, by all applications, exactly the same as local files.</p>
<p>So, the following absolute paths to files exist under windows, both as names in your computer&#8217;s filesystem.</p>
<p>c:pathtofile.txt<br />
<br />\serversharepathtofile.txt</p>
<p>For that reason, they need to be treated the same as parts of URIs. They both go after the &quot;file:///&quot;</p>
<p>I&#8217;d like to see you try &quot;file://server/share/path/to/file&quot; on a UNIX system and see what happens. Yeah. That&#8217;s really going to work.</p>
<p>Not.</p>
<p>If you want a remote file that&#8217;s not been mounted to your local FS, you need to specify an actual protocol.</p>
<p>smb://server/share/path/to/file<br />
<br />nfs://server/export/path/to/file<br />
<br /><a rel="nofollow" target="_new" href="ftp://server/path/to/file" rel="nofollow">ftp://server/path/to/file</a><br />
<br /><a rel="nofollow" target="_new" href="http://server/path/to/file" rel="nofollow">http://server/path/to/file</a></p>
<p>Will work (protocol handlers permitting) as all of those are defined protocols.</p>
<p>&quot;file&quot; is not a network protocol!<br /></p>

		
				</div>
		</li><!-- #comment-## -->
		<li class="comment even thread-even depth-1" id="comment-364753">
				<div id="div-comment-364753" class="comment-body">
				<div class="comment-author vcard">
						<cite class="fn">Christian</cite> <span class="says">says:</span>		</div>
		
		<div class="comment-meta commentmetadata"><a href="https://blogs.msdn.microsoft.com/oldnewthing/20060331-15/?p=31703#comment-364753">
			April 1, 2006 at 1:32 pm</a>		</div>

		<p>I hope that Raymond does not get ANY trouble for posting this!</p>
<p>Just imagine that things like this appear in the current EU-court!</p>
<p>@Raymond: Do you get permission for posting this? Wouldn&#8217;t you post it if you knew people find out that it is Samba?</p>

		
				</div>
		</li><!-- #comment-## -->
		<li class="comment odd alt thread-odd thread-alt depth-1" id="comment-364503">
				<div id="div-comment-364503" class="comment-body">
				<div class="comment-author vcard">
						<cite class="fn">Nawak</cite> <span class="says">says:</span>		</div>
		
		<div class="comment-meta commentmetadata"><a href="https://blogs.msdn.microsoft.com/oldnewthing/20060331-15/?p=31703#comment-364503">
			April 1, 2006 at 5:37 am</a>		</div>

		<p>Jeremy Allison: don&#8217;t brag about the bug being open for 3 minutes, the bug report clearly stated the solution!<br />
<br />You should be thankful to have such nice testers!</p>
<p>And by the way, I think Raymond&#8217;s ultimate point is to prove you that you *can&#8217;t* just say &quot;Break stuff, force developpers to fix!!&quot; like many people do in some of his blog-entries.<br />
<br />You *too* would want to release a painless product and would taint your code with ugly patches&#8230;</p>

		
				</div>
		</li><!-- #comment-## -->
		<li class="comment even thread-even depth-1" id="comment-364763">
				<div id="div-comment-364763" class="comment-body">
				<div class="comment-author vcard">
						<cite class="fn">Mark Steward</cite> <span class="says">says:</span>		</div>
		
		<div class="comment-meta commentmetadata"><a href="https://blogs.msdn.microsoft.com/oldnewthing/20060331-15/?p=31703#comment-364763">
			April 1, 2006 at 2:33 pm</a>		</div>

		<p>Wow, you get everything in this blog! &nbsp;Oh well, at least Jeremy&#8217;s post should stop the politics, although he may have pre-empted Raymond&#8217;s usual denouement (&quot;in fact, here&#8217;s what we were able to do&#8230;&quot;).</p>
<p>Apologies if this reply is made redundant by queued posts.</p>

		
				</div>
		</li><!-- #comment-## -->
		<li class="comment odd alt thread-odd thread-alt depth-1" id="comment-364773">
				<div id="div-comment-364773" class="comment-body">
				<div class="comment-author vcard">
						<cite class="fn">Stefan Kanthak</cite> <span class="says">says:</span>		</div>
		
		<div class="comment-meta commentmetadata"><a href="https://blogs.msdn.microsoft.com/oldnewthing/20060331-15/?p=31703#comment-364773">
			April 1, 2006 at 3:12 pm</a>		</div>

		<p>Adam,</p>
<p>take a Netscape on Unix, enter file://localhost/ and watch your ftp servers DIR listing appear (given that you have an ftpd running.-).<br />
<br />Netscape on Windows will but show the appropriate file share, just like IExplorer.</p>
<p>(I&#8217;m writing this from memory, I don&#8217;t have a Netscape running here any more and did not test it with Mozilla*).</p>
<p>file:// is a kludge.<br />
<br />Since Windows &quot;automounts&quot; remote shares this local access protocol works remote too.<br />
<br />That&#8217;s all, nothing more.<br />
<br />What do you expect on a Unix system with automountd running when you enter file://net/remotehost/path/ (in a browser that does not map file: to ftp:)?<br />
<br />Does file:// now really means nfs://?</p>
<p>Yes, I could have written file://\servershare in the first place, but the client used here is Windows, so I choose the somehow sloppy but nevertheless working notation.</p>
<p>Stefan</p>

		
				</div>
		</li><!-- #comment-## -->
		<li class="comment even thread-even depth-1" id="comment-364783">
				<div id="div-comment-364783" class="comment-body">
				<div class="comment-author vcard">
						<cite class="fn"><a href='http://qstuff.blogspot.com/' rel='external nofollow' class='url'>Justin Olbrantz (Quantam)</a></cite> <span class="says">says:</span>		</div>
		
		<div class="comment-meta commentmetadata"><a href="https://blogs.msdn.microsoft.com/oldnewthing/20060331-15/?p=31703#comment-364783">
			April 1, 2006 at 3:54 pm</a>		</div>

		<p>Can somebody pander to my ignorance and tell me how long Samba has supported fast queries?</p>

		
				</div>
		</li><!-- #comment-## -->
		<li class="comment odd alt thread-odd thread-alt depth-1" id="comment-364793">
				<div id="div-comment-364793" class="comment-body">
				<div class="comment-author vcard">
						<cite class="fn">BryanK</cite> <span class="says">says:</span>		</div>
		
		<div class="comment-meta commentmetadata"><a href="https://blogs.msdn.microsoft.com/oldnewthing/20060331-15/?p=31703#comment-364793">
			April 1, 2006 at 4:01 pm</a>		</div>

		<p>Jeremy:</p>
<p>&gt; If the new info level doesn&#8217;t work right then applications may fail when running against a Samba server, and we of course get the blame.</p>
<p>Haven&#8217;t you been listening to Raymond&#8217;s back-compat posts? &nbsp;Microsoft is the one that gets blamed for this kind of problem, since it&#8217;s their client that fails. &nbsp;Not you! &nbsp;;-)</p>
<p>(Not that I entirely disagree with Raymond; certainly a nontrivial subset of people that don&#8217;t have a clue about how network protocols actually work will blame any problem on the most recent change. &nbsp;That doesn&#8217;t mean they&#8217;re right, but when the only thing holding your company afloat is the number of people using your products (and buying new licenses for upgrades), it becomes important to prevent inaccurate &quot;this OS has bugs!!!!&quot; claims from surfacing.)</p>
<p>Anyway, thanks for the post; I bet I&#8217;m not the only one that thinks that from time to time, it&#8217;s good to hear exactly how a certain bug got into any program.</p>

		
				</div>
		</li><!-- #comment-## -->
		<li class="comment even thread-even depth-1" id="comment-364583">
				<div id="div-comment-364583" class="comment-body">
				<div class="comment-author vcard">
						<cite class="fn">Adam</cite> <span class="says">says:</span>		</div>
		
		<div class="comment-meta commentmetadata"><a href="https://blogs.msdn.microsoft.com/oldnewthing/20060331-15/?p=31703#comment-364583">
			April 1, 2006 at 8:24 am</a>		</div>

		<p>Stefan Kanthak: &quot;1. UNC paths ain&#8217;t (valid) URLs.<br />
<br /> &nbsp;The correct notation is file://some.server/&#8230; and should work in other browsers running on Windows too&quot;</p>
<p>No, the correct notation for local files is</p>
<p>file:///c:pathtofile.txt</p>
<p>Because the file protocol does have a &quot;server&quot; component, but it must be either a valid name of your own computer, or left blank in which case &quot;localhost&quot; is assumed.</p>
<p>Similarly, the correct notation for UNC paths in Windows is:</p>
<p>file:///\serversharepathtofile.txt</p>
<p>because you&#8217;re still talking to the local filesystem when opening a file via a UNC path. Yes, the local filesystem is doing some network access to get the file for you, but UNC paths are part of the local filesystem namespace, and therefore need the &quot;file:///&quot; before the &quot;\servershare&quot; to be valid.</p>
<p>What you want is:</p>
<p>smb://server/share/path/to/file.txt</p>
<p>which accesses the remote computer directly over SMB without talking to the local filesystem.</p>
<p>Now, it has to be said that Internet Explorer (and Windows Explorer, which might be the same application, but I can never tell) are very lax here and do do their best to autocorrect invalid file URIs for you. So yes, if you limit yourself to IE, what you said will work.</p>
<p>But you *can&#8217;t* generally use file URIs like that to open remote files with other browsers (or on other OSs).</p>
<p>(Remember, URIs have strict definitions that are not tied to Windows)</p>

		
				</div>
		</li><!-- #comment-## -->
		<li class="comment odd alt thread-odd thread-alt depth-1" id="comment-364803">
				<div id="div-comment-364803" class="comment-body">
				<div class="comment-author vcard">
						<cite class="fn">orcmid</cite> <span class="says">says:</span>		</div>
		
		<div class="comment-meta commentmetadata"><a href="https://blogs.msdn.microsoft.com/oldnewthing/20060331-15/?p=31703#comment-364803">
			April 1, 2006 at 7:04 pm</a>		</div>

		<p>Jeremy, &quot;To quote Steve McQueen, This is simply a failure to communicate :-).&quot; &nbsp;Actually, it was in a Paul Newman film and Paul&#8217;s character didn&#8217;t say it, it was the guy who ran the chain gang, a recognizable character actor whose name I never learned (but evidently was Strother Martin). &nbsp;Cool Hand Luke was the film.</p>
<p>Meanwhile, I love your report on what you go through to maintain Samba interoperability with Microsoft products.</p>
<p>Raymond: can you exploit Internet zone information (local, trusted internet, other internet, etc.) in determining an appropriate response, at least in the local fileserver case?</p>

		
				</div>
		</li><!-- #comment-## -->
		<li class="comment even thread-even depth-1" id="comment-364833">
				<div id="div-comment-364833" class="comment-body">
				<div class="comment-author vcard">
						<cite class="fn">Adam</cite> <span class="says">says:</span>		</div>
		
		<div class="comment-meta commentmetadata"><a href="https://blogs.msdn.microsoft.com/oldnewthing/20060331-15/?p=31703#comment-364833">
			April 1, 2006 at 8:12 pm</a>		</div>

		<p>Stefan:</p>
<p>file://localhost/ returns a list of my root directory.<br />
<br /><a rel="nofollow" target="_new" href="ftp://localhost/" rel="nofollow">ftp://localhost/</a> returns &quot;Connection was refused&quot;<br />
<br /><a rel="nofollow" target="_new" href="http://localhost/" rel="nofollow">http://localhost/</a> returns the default apache page.</p>
<p>Running Firefox on Linux 2.6.15. Konqueror mostly does the same, but isn&#8217;t picking up http for some reason :-/</p>
<p>On a unix system with automountd running, I&#8217;d expect file://remotehost/path/to/file.txt to return an error, as it <em>makes</em> <em>no</em> <em>sense</em>. It does not map to nfs, it does not map to smb, it is just an error.</p>
<p>If you want to use remote smb or nfs (or ftp, or http, or scp, or &#8230;) files without mounting them to the local filesystem, you need to use an explicit protocol handler to talk to the relevant server. The way to do this is to specify is as the schema of the URI, using smb://server/&#8230; or nfs://server/&#8230; (or <a rel="nofollow" target="_new" href="ftp://server/" rel="nofollow">ftp://server/</a>&#8230;, or &#8230;.)</p>
<p>(I actually have no idea if userspace nfs clients actually exist, but you get the idea)</p>
<p>Btw, it&#8217;s not file://\servershare, it&#8217;s file:///\servershare, and you did claim that file://server/share was &quot;the correct notation&quot;. Also, as I pointed out, I am also aware that file://server/share works, it&#8217;s just not correct.</p>
<p>&lt;/pedant&gt;</p>
<p>:)<br /></p>

		
				</div>
		</li><!-- #comment-## -->
		<li class="comment odd alt thread-odd thread-alt depth-1" id="comment-364733">
				<div id="div-comment-364733" class="comment-body">
				<div class="comment-author vcard">
						<cite class="fn"><a href='http://samba.org/~jra' rel='external nofollow' class='url'>Jeremy Allison</a></cite> <span class="says">says:</span>		</div>
		
		<div class="comment-meta commentmetadata"><a href="https://blogs.msdn.microsoft.com/oldnewthing/20060331-15/?p=31703#comment-364733">
			April 1, 2006 at 12:35 pm</a>		</div>

		<p>So, let me explain *exactly* how this bug occurred, maybe it will illuminate the situation.</p>
<p>Microsoft commonly adds new info levels with each Windows release or service pack. They don&#8217;t document these, they just appear.</p>
<p>Tridge has a protocol info level scanner as part of the smbtorture suite. This detects new info levels in the trans2 and nttrans SMB calls.</p>
<p>When we find a new info level we work out what it does and implement it as soon as possible &#8211; ususally a new info level appearing usually means that the client version of the Windows server version we tested against will start using the info level, so it&#8217;s very important to get this implemented asap as new Windows clients will expect this info level to work against a server and the downgrading code in the client doesn&#8217;t always work right. (We&#8217;ve seen that before in older versinos of the Windows redirector). If the new info level doesn&#8217;t work right then applications may fail when running against a Samba server, and we of course get the blame.</p>
<p>tridge detected the new info levels and worked out what their internal structure was. He added test code to smbtorture to ensure that querying this info level &nbsp;returned what we expected against a W2K3 server. Once we were sure that our analysis was correct we added it into the server code. We tested the code using the smbtorture analyser to ensure we were returning the correct data structure (so much for the claims we releas untested code).</p>
<p>The bug occurred when I only added the switch statements to field the incoming info level values into the SMBfindfirst code path, and forgot to add them into the SMBfindnext code path. The torture tester didn&#8217;t find this case because it didn&#8217;t test more than 100 files on this particular code path (it normally does when testing the directory scan code, but not specific info levels).</p>
<p>Since we&#8217;ve been aware of this problem tridge is adding such a coverage to smbtorture so we won&#8217;t get this problem again.</p>
<p>We&#8217;re also communicating with some of the Windows engineers and tridge has given a suggestion on how to fix this in the Windows implementation.</p>
<p>Jeremy Allison,<br />
<br />Samba Team.<br /></p>

		
				</div>
		</li><!-- #comment-## -->
		<li class="comment even thread-even depth-1" id="comment-364853">
				<div id="div-comment-364853" class="comment-body">
				<div class="comment-author vcard">
						<cite class="fn"><a href='http://www.mutexed.com' rel='external nofollow' class='url'>Jeremy Boschen</a></cite> <span class="says">says:</span>		</div>
		
		<div class="comment-meta commentmetadata"><a href="https://blogs.msdn.microsoft.com/oldnewthing/20060331-15/?p=31703#comment-364853">
			April 1, 2006 at 10:59 pm</a>		</div>

		<p>There are some good ideas here. The bad ones are more fun though, and it&#8217;s still 04/01 here, so I&#8217;ll add a bad one&#8230;</p>
<p>&#8211; If it&#8217;s a low-memory machine, force IEnumXxx::Next to use the slow-method. This sucks for them, but oh well, it works.</p>
<p>&#8211; If it&#8217;s <em>not</em> a low-mem machine, send 2 queries for each call from IEnumXxx::Next, a slow and a fast. You wait for both to finish, compare the results to make sure they&#8217;re the same and return to the caller. When you get to 100+ with no error, drop the slow result set. If you do have an error after 100+, drop the fast set and move on with the slow set. If you end up with different results, drop the fast set and move on with the slow set. You chew up extra memory for the first few hundred records then things even out. You maybe even chew up 2 connections if the server can&#8217;t do both query types simultaneously on 1 connection. For a server that&#8217;s updated frequently enough to always cause the 2 queries to return different results, sucks for that user. And, you can totally hammer that server to death with your DOS scenario.</p>

		
				</div>
		</li><!-- #comment-## -->
		<li class="comment odd alt thread-odd thread-alt depth-1" id="comment-364873">
				<div id="div-comment-364873" class="comment-body">
				<div class="comment-author vcard">
						<cite class="fn">John</cite> <span class="says">says:</span>		</div>
		
		<div class="comment-meta commentmetadata"><a href="https://blogs.msdn.microsoft.com/oldnewthing/20060331-15/?p=31703#comment-364873">
			April 2, 2006 at 1:19 am</a>		</div>

		<p>My idea:<br />
<br />-&gt; User connects to SMB<br />
<br />&#8211;&gt; Popup comes up &quot;The server you have connected to may have an error in it. &nbsp;If files are missing, please switch to slow mode.&quot;</p>
<p>This gives the user the ultimate choice, which evidently I am in favour of :-)<br />
<br />microsoft cant be blamed, since its not their error, and the 3rd parties will be lickety split in updating when they find out their hardware is coming up with this error every first connect.</p>
<p>It depends on how well you can detect the smb version being ran on the server, and unfortunately no new updates in smb will solve that problem, due to the firmware being inable to update</p>

		
				</div>
		</li><!-- #comment-## -->
		<li class="comment even thread-even depth-1" id="comment-364863">
				<div id="div-comment-364863" class="comment-body">
				<div class="comment-author vcard">
						<cite class="fn">steveg</cite> <span class="says">says:</span>		</div>
		
		<div class="comment-meta commentmetadata"><a href="https://blogs.msdn.microsoft.com/oldnewthing/20060331-15/?p=31703#comment-364863">
			April 1, 2006 at 11:46 pm</a>		</div>

		<p>Jeremy Allison said: &quot;I forgot to mention. The bug was open in our bug db for a grand total of *three* minutes before I had the fix committed into the SVN tree. I don&#8217;t think we could have reacted faster in getting a fix done than that.&quot;</p>
<p>I&#8217;ve never worked on a project where I can fix, compile, *test* and check-in within a 3 minute period of time.</p>
<p>I&#8217;d really love to see a &quot;MS Vista developmemt procedures vs [pick any other major project, OSS or otherwise] development procedures&quot; analysis. It&#8217;d be interesting &#8212; I suspect Raymond has more hoops to jump through than many projects, but I may well be wrong.</p>
<p>Jeremy Borschen: &quot;send 2 queries for each call from IEnumXxx::Next, a slow and a fast&quot;</p>
<p>Sounds like it would be work, but I doubt doubling server/network usage would be worth it. Most admins I know like to keep their bandwidth empty rather than using it.</p>

		
				</div>
		</li><!-- #comment-## -->
		<li class="comment odd alt thread-odd thread-alt depth-1" id="comment-364903">
				<div id="div-comment-364903" class="comment-body">
				<div class="comment-author vcard">
						<cite class="fn">bohan</cite> <span class="says">says:</span>		</div>
		
		<div class="comment-meta commentmetadata"><a href="https://blogs.msdn.microsoft.com/oldnewthing/20060331-15/?p=31703#comment-364903">
			April 2, 2006 at 11:28 am</a>		</div>

		<p>John: a popup message? we can&#8217;t assume there is any kind of GUI attached to the process, nor that the process is interactive (i.e. there&#8217;s no user behind it watching what happens).<br /></p>

		
				</div>
		</li><!-- #comment-## -->
		<li class="comment even thread-even depth-1" id="comment-364913">
				<div id="div-comment-364913" class="comment-body">
				<div class="comment-author vcard">
						<cite class="fn">Paul de Vrieze</cite> <span class="says">says:</span>		</div>
		
		<div class="comment-meta commentmetadata"><a href="https://blogs.msdn.microsoft.com/oldnewthing/20060331-15/?p=31703#comment-364913">
			April 2, 2006 at 2:24 pm</a>		</div>

		<p>There seems to be a way that samba can give it&#8217;s version. If I query my samba server for the available shares I get this result:</p>
<p>Domain=[MYDOMAIN] OS=[Unix] Server=[Samba 3.0.21c]</p>
<p> &nbsp; &nbsp; &nbsp; &nbsp;Sharename &nbsp; &nbsp; &nbsp; Type &nbsp; &nbsp; &nbsp;Comment<br />
<br /> &nbsp; &nbsp; &nbsp; &nbsp;&#8212;&#8212;&#8212; &nbsp; &nbsp; &nbsp; &#8212;- &nbsp; &nbsp; &nbsp;&#8212;&#8212;-<br />
<br /> &nbsp; &nbsp; &nbsp; &nbsp;software &nbsp; &nbsp; &nbsp; &nbsp;Disk &nbsp; &nbsp; &nbsp;software dir</p>
<p>This clearly includes a software version. I don&#8217;t know whether a samba specific extension is used for this, but the information seems to be there.</p>

		
				</div>
		</li><!-- #comment-## -->
		<li class="comment odd alt thread-odd thread-alt depth-1" id="comment-364923">
				<div id="div-comment-364923" class="comment-body">
				<div class="comment-author vcard">
						<cite class="fn">Kuwanger</cite> <span class="says">says:</span>		</div>
		
		<div class="comment-meta commentmetadata"><a href="https://blogs.msdn.microsoft.com/oldnewthing/20060331-15/?p=31703#comment-364923">
			April 2, 2006 at 5:26 pm</a>		</div>

		<p>&quot;With my solution, Samba would still be interoperable. Fast mode is a performance thing, Microsoft don&#8217;t have to support fast mode on a third party server if they don&#8217;t want to. So the samba guys wouldn&#8217;t have interoperability as an excuse for violation copyright/patents.&quot;</p>
<p>You should read the Sega vs Accolade case. &nbsp;In short, Sega could&#8217;t forbid 3rd parties from interoperating software with their hardware through the use of copyrights or trademarks, even if they have a licensing program available to allow people to develop for the hardware. &nbsp;There has yet to be a case, that I&#8217;m aware of, of a company producing a low end and high end solution and claiming free interoperability with the former somehow negates any validity of attempts to interoperability with the latter. &nbsp;Given the Sega vs Accolade case, I don&#8217;t see why they&#8217;d suddendly decide it&#8217;s okay for a copyright/trademark holder to abuse the copyright/trademark system.</p>

		
				</div>
		</li><!-- #comment-## -->
		<li class="comment even thread-even depth-1" id="comment-364933">
				<div id="div-comment-364933" class="comment-body">
				<div class="comment-author vcard">
						<cite class="fn">Sandy Wilbourn</cite> <span class="says">says:</span>		</div>
		
		<div class="comment-meta commentmetadata"><a href="https://blogs.msdn.microsoft.com/oldnewthing/20060331-15/?p=31703#comment-364933">
			April 2, 2006 at 7:37 pm</a>		</div>

		<p>Terrific issue, as usual.</p>
<p>I haven&#8217;t seen many posters comment on how much of the final decision depends on details around the assumptions:</p>
<p>1) When was support for fast queries added?<br />
<br />2) How big a difference is there in the timing between slow and fast?<br />
<br />3) Where are you in the release cycle?<br />
<br />4) How likely is it that servers that have been released and have this claim are going to be fixed, etc.<br />
<br />5) And there are certainly several more considerations&#8230;</p>
<p>If one believes that there are going to be lots of servers with the bug out there once the new OS is released, and that the difference between slow and fast is not too different, then the answer has got to be that when Windows gets the &#8216;strange error code&#8217; back that it reissues the query in &#8216;slow&#8217; mode. </p>
<p>That means that you get correct functionality all of the time and that as servers are upgraded, they still get the faster queries working. &nbsp;This solution means that the new client will be slower in some cases, but I suspect that it is a minority of cases. &nbsp;Caching could be applied, but I would only have it be dynamic to avoid all of the weird questions about where it goes, what it means, etc.</p>

		
				</div>
		</li><!-- #comment-## -->
		<li class="comment odd alt thread-odd thread-alt depth-1" id="comment-364963">
				<div id="div-comment-364963" class="comment-body">
				<div class="comment-author vcard">
						<cite class="fn">steveg</cite> <span class="says">says:</span>		</div>
		
		<div class="comment-meta commentmetadata"><a href="https://blogs.msdn.microsoft.com/oldnewthing/20060331-15/?p=31703#comment-364963">
			April 2, 2006 at 9:56 pm</a>		</div>

		<p>I once ran an interview for a programming job and we asked a few &quot;which do you prefer questions&quot;: windows/unix, vim/emacs, STL/boost, borland/ms etc.</p>
<p>After a couple of these he said in his deep Russian accent, &quot;Ah, you like religous debate&quot;.</p>
<p>My point is, I think a few people who have contributed should step back and consider the issue from a slightly more abstract point-of-view.</p>
<p>[as a regular reader I&#8217;m also waiting for Norman&#8217;s Marvin-the-robot-like comment anxiously]</p>

		
				</div>
		</li><!-- #comment-## -->
		<li class="comment even thread-even depth-1" id="comment-364973">
				<div id="div-comment-364973" class="comment-body">
				<div class="comment-author vcard">
						<cite class="fn">Yuhong Bao</cite> <span class="says">says:</span>		</div>
		
		<div class="comment-meta commentmetadata"><a href="https://blogs.msdn.microsoft.com/oldnewthing/20060331-15/?p=31703#comment-364973">
			April 2, 2006 at 11:12 pm</a>		</div>

		<p>I think that we should both in the KB article and in the read me file, define a file server as &quot;any device or computer that users can connect to access files on it, including NASes and computers running file server software, whether it is commonly called a server or not&quot;.</p>

		
				</div>
		</li><!-- #comment-## -->
		<li class="comment odd alt thread-odd thread-alt depth-1" id="comment-364943">
				<div id="div-comment-364943" class="comment-body">
				<div class="comment-author vcard">
						<cite class="fn">Stefan Kanthak</cite> <span class="says">says:</span>		</div>
		
		<div class="comment-meta commentmetadata"><a href="https://blogs.msdn.microsoft.com/oldnewthing/20060331-15/?p=31703#comment-364943">
			April 2, 2006 at 7:47 pm</a>		</div>

		<p>Adam:</p>
<p>I wrote file://*net*/remotehost/&#8230; (assuming that automountd uses /net/).</p>
<p>Stefan</p>
<p>PS: the missing third slash was just a typo.-)</p>

		
				</div>
		</li><!-- #comment-## -->
		<li class="comment even thread-even depth-1" id="comment-364983">
				<div id="div-comment-364983" class="comment-body">
				<div class="comment-author vcard">
						<cite class="fn">Toma Bussarov</cite> <span class="says">says:</span>		</div>
		
		<div class="comment-meta commentmetadata"><a href="https://blogs.msdn.microsoft.com/oldnewthing/20060331-15/?p=31703#comment-364983">
			April 3, 2006 at 4:19 am</a>		</div>

		<p>Ok, it&#8217;s not quite different. The user Meikel already suggested it, but I thought about this by myself.<br />
<br />Imagine if many SMB servers has bugs in &#8216;Fast Mode&#8217; (not quite difficult bacuse since WinXP don&#8217;t use it and nobody tested &#8216;Fast Mode&#8217; with a serious client). Then you will have to give up using &#8216;Fast mode&#8217;. Just forget it.<br />
<br />Create a new mode, called for example &#8216;Fast Mode 2&#8217; that will be supported by Vista. It can be even the same as &#8216;Fast Mode&#8217; but with different identifier. In this way new servers supporting &#8216;Fast Mode 2&#8217; won&#8217;t have the bug in question and probably other bugs, because when server developers add &#8216;Fast Mode 2&#8217; they will test it with Windows Vista.<br />
<br />Disadvantage: You have to change SMB protocol spec.<br />
<br />Advantages: No workarounds, no bugs, Vista remains pure.</p>

		
				</div>
		</li><!-- #comment-## -->
		<li class="comment odd alt thread-odd thread-alt depth-1" id="comment-364993">
				<div id="div-comment-364993" class="comment-body">
				<div class="comment-author vcard">
						<cite class="fn">Rich</cite> <span class="says">says:</span>		</div>
		
		<div class="comment-meta commentmetadata"><a href="https://blogs.msdn.microsoft.com/oldnewthing/20060331-15/?p=31703#comment-364993">
			April 3, 2006 at 4:42 am</a>		</div>

		<p>&quot;&#8230;certainly a nontrivial subset of people that don&#8217;t have a clue about how network protocols actually work will blame any problem on the most recent change.&quot; (BryanK)</p>
<p>People with a clue think that, too. &nbsp;In the absence of any other information, starting the troubleshooting process at the most recent change is an eminently reasonable thing to do.</p>
<p>It is quite humorous&#8211;I wonder how long MS knew about this bug, but Samba didn&#8217;t? &nbsp;If &quot;everything gets blamed on Microsoft&quot;, wouldn&#8217;t it be to MS&#8217;s advantage to at least report the bug so it&#8217;d get fixed and everyone&#8217;s happy?</p>
<p>And don&#8217;t get me started on the lack of SMB documentation&#8230;</p>

		
				</div>
		</li><!-- #comment-## -->
		<li class="comment even thread-even depth-1" id="comment-365043">
				<div id="div-comment-365043" class="comment-body">
				<div class="comment-author vcard">
						<cite class="fn">Adam</cite> <span class="says">says:</span>		</div>
		
		<div class="comment-meta commentmetadata"><a href="https://blogs.msdn.microsoft.com/oldnewthing/20060331-15/?p=31703#comment-365043">
			April 3, 2006 at 7:32 am</a>		</div>

		<p>Stefan: Are you sure you&#8217;re not missing a slash again, and don&#8217;t mean:</p>
<p>file:///net/remotehost/</p>
<p>If you&#8217;re not missing a slash, what browser are you using?</p>
<p>Adam<br /></p>

		
				</div>
		</li><!-- #comment-## -->
		<li class="comment odd alt thread-odd thread-alt depth-1" id="comment-365053">
				<div id="div-comment-365053" class="comment-body">
				<div class="comment-author vcard">
						<cite class="fn">Adam</cite> <span class="says">says:</span>		</div>
		
		<div class="comment-meta commentmetadata"><a href="https://blogs.msdn.microsoft.com/oldnewthing/20060331-15/?p=31703#comment-365053">
			April 3, 2006 at 7:37 am</a>		</div>

		<p>8: Yes, I know that &quot;smb:&quot; works, but &quot;smb:&quot; <em>is</em> <em>not</em> &quot;file:&quot;</p>
<p>&quot;smb:&quot;, by definition, works remotely. It&#8217;s a remote access protocol.<br />
<br />&quot;file:&quot;, by definition, does not, <em>unless</em> you have the remote file mapped to your local FS tree in some way.</p>
<p>How much clearer I can be here?<br /></p>

		
				</div>
		</li><!-- #comment-## -->
		<li class="comment even thread-even depth-1" id="comment-365063">
				<div id="div-comment-365063" class="comment-body">
				<div class="comment-author vcard">
						<cite class="fn">jg</cite> <span class="says">says:</span>		</div>
		
		<div class="comment-meta commentmetadata"><a href="https://blogs.msdn.microsoft.com/oldnewthing/20060331-15/?p=31703#comment-365063">
			April 3, 2006 at 8:36 am</a>		</div>

		<p>Seems to me there are a number of requirements for an ideal fix.</p>
<p>User should not have to do anything, and they always get a complete file listing.<br />
<br />Windows should be able to detect bad servers and use the good old slow mode on them.<br />
<br />Windows should use the shiny new fast mode on servers that support it properly.<br />
<br />The fix should not involve too much housekeeping on the part of windows.<br />
<br />The fix should only come into operation when bad servers are detected. Those good little boys who keep there NAS/Linux servers up to date should not have to pay any performance for those who don&#8217;t.<br />
<br />The fix should not hammer the server trying to determine if it&#8217;s good/bad</p>
<p>If Samba was changed today to say it supports fast mode then windows can check this first.<br />
<br />It is not possible to start off with fast mode and then if it borks switch to slow. Files may have changed so we can&#8217;t just start over.</p>
<p>We could start off in slow mode, if a read involves more than 100 files then silently in the background we could do a fast read and see if we get this error when expected. If we don&#8217;t get this error, add it to the fast list.<br />
<br />If we do get this error, add it to a slow list with a reminder to check again in x amount of time, and continure using slow mode until then.</p>
<p>Obviously, as Raymond said, list will need to be capped to prevent DoS attacks. </p>
<p>Advantages:<br />
<br />Users alwasy get complete file listings.<br />
<br />On good servers, windows will ultimately use fast mode.<br />
<br />On bad servers, windows will never return a bad file list to a user/application.</p>
<p>Disadvantages:<br />
<br />Maintaining good/bad lists is a PITA. As with everything, it&#8217;s a compramise between keeping enough of a list so we don&#8217;t hammer servers. But not too much that the DoS attack has impact.<br />
<br />File servers would have to service these extra background requests which is extra load they shouldn&#8217;t have to handle. These extra requests may have other undesireable requests I haven&#8217;t thought of. They are just a hack to find out if the server is good/bad<br />
<br />This still has the problem of a server that is marked as good, then I be naughty and downgrade the firmware of that server to be bad. If windows doesn&#8217;t check again then it will get to file 100 and bork. We can&#8217;t force a re-check every time as we default to a slow read.</p>
<p>Just makes you wonder how many other compatability hacks are in windows already. It&#8217;s ugly, I don&#8217;t like it and I&#8217;d be tempted to say screw you buggy servers. But then I&#8217;m not MS :) I&#8217;d only do something like this as a temporary measure, but that&#8217;s not an option for windows. Once this fix is in, it&#8217;ll be there for ever.</p>

		
				</div>
		</li><!-- #comment-## -->
		<li class="comment odd alt thread-odd thread-alt depth-1" id="comment-365113">
				<div id="div-comment-365113" class="comment-body">
				<div class="comment-author vcard">
						<cite class="fn">8</cite> <span class="says">says:</span>		</div>
		
		<div class="comment-meta commentmetadata"><a href="https://blogs.msdn.microsoft.com/oldnewthing/20060331-15/?p=31703#comment-365113">
			April 3, 2006 at 10:01 am</a>		</div>

		<p>Adam: You can&#8217;t. You&#8217;re right.</p>
<p>jg: yes, whitelisting with your method is better, or just put a flag in the connection state data and have no list, but indeed this behaviour makes the new fast mode a possible performance penalty.</p>
<p>What did Tridge suggest?</p>

		
				</div>
		</li><!-- #comment-## -->
		<li class="comment even thread-even depth-1" id="comment-365123">
				<div id="div-comment-365123" class="comment-body">
				<div class="comment-author vcard">
						<cite class="fn">dave</cite> <span class="says">says:</span>		</div>
		
		<div class="comment-meta commentmetadata"><a href="https://blogs.msdn.microsoft.com/oldnewthing/20060331-15/?p=31703#comment-365123">
			April 3, 2006 at 10:05 am</a>		</div>

		<p>No problem. Samba should of course follow the published and freely-available SMB interoperability specifications from Microsoft. </p>
<p>What&#8230;? Oh, nevermind&#8230;</p>
<p></p>

		
				</div>
		</li><!-- #comment-## -->
		<li class="comment odd alt thread-odd thread-alt depth-1" id="comment-365133">
				<div id="div-comment-365133" class="comment-body">
				<div class="comment-author vcard">
						<cite class="fn">Miles Archer</cite> <span class="says">says:</span>		</div>
		
		<div class="comment-meta commentmetadata"><a href="https://blogs.msdn.microsoft.com/oldnewthing/20060331-15/?p=31703#comment-365133">
			April 3, 2006 at 10:23 am</a>		</div>

		<p>How slow can &quot;slow&quot; be if that&#8217;s all we have now?</p>
<p>When in doubt, use slow and reliable.</p>

		
				</div>
		</li><!-- #comment-## -->
		<li class="comment even thread-even depth-1" id="comment-365373">
				<div id="div-comment-365373" class="comment-body">
				<div class="comment-author vcard">
						<cite class="fn"><a href='http://botanicus.net/dw/' rel='external nofollow' class='url'>David Wilson</a></cite> <span class="says">says:</span>		</div>
		
		<div class="comment-meta commentmetadata"><a href="https://blogs.msdn.microsoft.com/oldnewthing/20060331-15/?p=31703#comment-365373">
			April 3, 2006 at 1:27 pm</a>		</div>

		<p>Raymond,</p>
<p>The Samba command-line tool &quot;smbclient&quot; prints exact version information from a remote SMB server when you ask it for a remote share listing using &quot;-L&quot;, for example:</p>
<p>[17:17:13] [cambodia:8:~]$ smbclient -L //cambodia<br />
<br />Password:<br />
<br />Anonymous login successful<br />
<br />Domain=[WORKGROUP] OS=[Unix] Server=[Samba 3.0.20b-Debian]</p>
<p>On investigation with Ethereal, this information is passed from the server to the client as a multibyte string, apparently multiple times, during the course of communication. At least one of these times is what Ethereal calls an NTLMSSP_CHALLENGE response &#8211; the Samba version string is clearly part of the response frame.</p>
<p>It seems to indicate to me that Windows has a chance right at the start of authenticating to a new server, to note whether or not its version string matches one of the known bad versions.</p>
<p>What is stopping you using this information?</p>
<p>David.</p>

		
				</div>
		</li><!-- #comment-## -->
		<li class="comment odd alt thread-odd thread-alt depth-1" id="comment-365033">
				<div id="div-comment-365033" class="comment-body">
				<div class="comment-author vcard">
						<cite class="fn">8</cite> <span class="says">says:</span>		</div>
		
		<div class="comment-meta commentmetadata"><a href="https://blogs.msdn.microsoft.com/oldnewthing/20060331-15/?p=31703#comment-365033">
			April 3, 2006 at 7:30 am</a>		</div>

		<p>Adam: &quot;On top of that, this is only an attack on the local network&quot;<br />
<br />a1.hackersite.com is a valid Internet hostname.</p>
<p>AC: &quot;AFAIK, most ISPs filter the SMB ports&quot;<br />
<br />The attacker knows it and doesn&#8217;t use such an ISP.</p>
<p>mph: &quot;Having the ability to type &quot;\servershare&quot; in the address bar doesn&#8217;t mean you also have to accept such syntax where real URLs are required (like &quot;a&quot; tags in HTML documents).&quot;</p>
<p>Great. Some guy reports an error with his NAS setup and as a result the RTM version of Vista will not support hyptertext links to file shares. Who do you think will complain now?</p>
<p>Adam: &quot;But you *can&#8217;t* generally use file URIs like that to open remote files with other browsers (or on other OSs).&quot;</p>
<p>It (smb://) works in Konqueror (KDE) and Nautilus (Gnome).</p>
<p>Amos: &quot;you can stop the thieving samba hippies from impersonating a real Windows machine [because] I have an irrational hatred for those open source guys&quot;</p>
<p>Oh boy, RMS watch out!</p>
<p>Based on all this, I want to propose a fix that combines several solutions: add a static variable to the FindNextFile function that&#8217;s incremented each call if it&#8217;s &gt;0. If it&#8217;s &lt;0 use FileBothDirectoryInformation. Otherwise, use NtQueryDirectoryFile (if the server supports it). If it returns STATUS_NO_MORE_FILES, then if it&#8217;s the 129th call, and FileBothDirectoryInformation returns STATUS_INVALID_LEVEL, negate the variable so it&#8217;s negative, disconnect, reconnect and fetch the first 128 files again, possibly using the scheduler and a mutex to make the API more responsive. Return EAGAIN.</p>
<p>Advantages:</p>
<p> &nbsp; &nbsp;* Windows auto-detects the problem and works around it.</p>
<p>Disadvantages:<br />
<br /> &nbsp; &nbsp;* Windows doesn&#8217;t remain pure and unsullied by compatibility hacks</p>

		
				</div>
		</li><!-- #comment-## -->
		<li class="comment even thread-even depth-1" id="comment-365583">
				<div id="div-comment-365583" class="comment-body">
				<div class="comment-author vcard">
						<cite class="fn"><a href='http://botanicus.net/dw/' rel='external nofollow' class='url'>David Wilson</a></cite> <span class="says">says:</span>		</div>
		
		<div class="comment-meta commentmetadata"><a href="https://blogs.msdn.microsoft.com/oldnewthing/20060331-15/?p=31703#comment-365583">
			April 3, 2006 at 2:41 pm</a>		</div>

		<p>I thought about it a little more while walking the dogs:</p>
<p>a) My reasoning was incomplete: this is a stateless method of detecting &quot;slow only&quot; servers, and could cause the fast codepaths to proxy on to the slow codepaths in the case of some flag in the connection structure being set.</p>
<p>It requires zero bandwidth wastage, and avoids all the silly tricks other people have been suggesting (the mkdir one was my personal favourite).</p>
<p>b) Embedding vendors may deliberately change the version string, either appending a suffix (as my Debian install does above), or in its entirety.</p>
<p>Perhaps a &quot;known good&quot; list could be used to match the server version against, instead. That might give future embedders more motivation for not masquerading the real software versions they are using.</p>
<p>On saying this though, I would still assume Microsoft&#8217;s testing division might be large enough to build a practically large enough &quot;known bad&quot; list that would cover 95%+ of NASes on the market, or those that have been discontinued.</p>
<p>If some popular/obscure NAS is forgotten, a small hotfix for the &quot;known bad&quot; list could be released through Windows Update, or via MSKB.</p>
<p>I am assuming this is a valid fix; I know next to nothing about the layering of the code in question.</p>
<p>Thanks again,</p>
<p>David.</p>

		
				</div>
		</li><!-- #comment-## -->
		<li class="comment odd alt thread-odd thread-alt depth-1" id="comment-365713">
				<div id="div-comment-365713" class="comment-body">
				<div class="comment-author vcard">
						<cite class="fn">Sjoerd Verweij</cite> <span class="says">says:</span>		</div>
		
		<div class="comment-meta commentmetadata"><a href="https://blogs.msdn.microsoft.com/oldnewthing/20060331-15/?p=31703#comment-365713">
			April 3, 2006 at 4:31 pm</a>		</div>

		<p>Default to slow (for Samba), on a network driver level.</p>
<p>Upon first connect, put in list with (Unknown). </p>
<p>Every time a query is done, see if there are a 100 or more records returned. If so, do a dummy, identical, fast check in the background. If no error is returned, mark as (Fast). If an error is returned, mark as slow.</p>
<p>Advantages:</p>
<p>&#8211; Transparent to user<br />
<br />&#8211; Never incorrect results<br />
<br />&#8211; Doesn&#8217;t matter if server rotates out of cache</p>
<p>Disadvantages:</p>
<p>&#8211; Perf hit on small queries against Samba servers until a big one is done<br />
<br />&#8211; Perf hit on the first large query against a Samba server<br />
<br />&#8211; Have to store server list</p>
<p>If you store the list in the registry, fast mode can be forced for known-good boxes.<br /></p>

		
				</div>
		</li><!-- #comment-## -->
		<li class="comment even thread-even depth-1" id="comment-365723">
				<div id="div-comment-365723" class="comment-body">
				<div class="comment-author vcard">
						<cite class="fn">Sjoerd Verweij</cite> <span class="says">says:</span>		</div>
		
		<div class="comment-meta commentmetadata"><a href="https://blogs.msdn.microsoft.com/oldnewthing/20060331-15/?p=31703#comment-365723">
			April 3, 2006 at 4:43 pm</a>		</div>

		<p>My suggestion is suspiciously like jg&#8217;s.</p>
<p>Sorry, didn&#8217;t mean to look like a thief.</p>

		
				</div>
		</li><!-- #comment-## -->
		<li class="comment odd alt thread-odd thread-alt depth-1" id="comment-365143">
				<div id="div-comment-365143" class="comment-body">
				<div class="comment-author vcard">
						<cite class="fn"><a href='http://sab39.dev.netreach.com/' rel='external nofollow' class='url'>Stuart Ballard</a></cite> <span class="says">says:</span>		</div>
		
		<div class="comment-meta commentmetadata"><a href="https://blogs.msdn.microsoft.com/oldnewthing/20060331-15/?p=31703#comment-365143">
			April 3, 2006 at 10:53 am</a>		</div>

		<p>A variation on the &quot;FastSamba&quot; suggestion that&#8217;s been made already. I&#8217;m assuming that there is at least a little bit of room for this string to grow. So how about now, retroactively, defining a protocol for versioning that uses this string? I&#8217;m sure this won&#8217;t be the last case where you want to work around bugs in &quot;all versions older than X&quot; of a particular family of clients, and that applies to Windows too.</p>
<p>So how about saying that if the string contains a &quot;#&quot;, for example (you can pick a different character if &quot;#&quot; is in use a lot already, perhaps something weird and unprintable (or unicodey, if the protocol allows)), the part of the string after the &quot;#&quot; is a version number.</p>
<p>Then the Samba folks can keep their configurable family string but *whatever* it&#8217;s configured to, add a &quot;#4.x&quot; or whatever to the end of it.</p>
<p>This allows you to address this particular problem (if the version string is present at all, the bug isn&#8217;t) and also provides a framework for future such workarounds without this kind of angst.</p>
<p>Having said that, though, more importantly than any specific suggestion is the fact that you should be discussing this issue *with the Samba team* rather than with random people on your blog. How do *they* want you to address it?</p>
<p>(And I have to agree with the irony of the situation when the Samba team has struggled for years &#8211; more than a decade? &#8211; trying to find and workaround the bugs and undocumented behaviors of SMB in all the different versions of Windows. Without any cooperation from Microsoft. One bug in Samba in a feature that&#8217;s never been used by any Windows version&#8230;? One could even call it a &quot;taste of your own medicine&quot;, except that clearly the Samba team have been more than cooperative already in fixing the bug in current versions)</p>

		
				</div>
		</li><!-- #comment-## -->
		<li class="comment even thread-even depth-1" id="comment-365763">
				<div id="div-comment-365763" class="comment-body">
				<div class="comment-author vcard">
						<cite class="fn">8</cite> <span class="says">says:</span>		</div>
		
		<div class="comment-meta commentmetadata"><a href="https://blogs.msdn.microsoft.com/oldnewthing/20060331-15/?p=31703#comment-365763">
			April 3, 2006 at 6:24 pm</a>		</div>

		<p>David Wilson: &quot;a small hotfix for the &quot;known bad&quot; list could be released through Windows Update, or via MSKB&quot;</p>
<p>I don&#8217;t think that&#8217;ll ever happen unless it&#8217;s profitable. They could call it something else though instead of hotfix.</p>

		
				</div>
		</li><!-- #comment-## -->
		<li class="comment odd alt thread-odd thread-alt depth-1" id="comment-365803">
				<div id="div-comment-365803" class="comment-body">
				<div class="comment-author vcard">
						<cite class="fn">Stefan Kanthak</cite> <span class="says">says:</span>		</div>
		
		<div class="comment-meta commentmetadata"><a href="https://blogs.msdn.microsoft.com/oldnewthing/20060331-15/?p=31703#comment-365803">
			April 3, 2006 at 7:20 pm</a>		</div>

		<p>Adam: sorry, of course file:///net/<br /></p>

		
				</div>
		</li><!-- #comment-## -->
		<li class="comment even thread-even depth-1" id="comment-365873">
				<div id="div-comment-365873" class="comment-body">
				<div class="comment-author vcard">
						<cite class="fn">Richard Brightwell</cite> <span class="says">says:</span>		</div>
		
		<div class="comment-meta commentmetadata"><a href="https://blogs.msdn.microsoft.com/oldnewthing/20060331-15/?p=31703#comment-365873">
			April 3, 2006 at 10:12 pm</a>		</div>

		<p>First I want to admit that I didn&#8217;t read anyone else&#8217;s responses so I&#8217;m sorry if this has already been accepted or rejected. &nbsp;Here&#8217;s my solution:</p>
<p>1) Create a cache of known file servers. More than 16&#8230; maybe 256 of them. &nbsp;This cache would store the server info plus fast/slow preference for this server.</p>
<p>2) Whenever a server is accessed first check for a known server in the cache. </p>
<p>3) If found use prefered settings (fast/slow). &nbsp;If fast is used and error occurs then reset preference to slow.</p>
<p>4) If not found create dummy folder and throw &gt; 100 dummy files into it and read it back. &nbsp;If error occurs then cache server with a preferenc for slow access. &nbsp;If no error cache with fast access. &nbsp;I know this is slow but only the first time a server is ever accessed.</p>
<p>5) Live happily accessing the good servers in fast mode and not loosing files from the bad servers.</p>
<p>Thanks for a great blog. &nbsp;It&#8217;s a hoot!</p>
<p>Richard</p>

		
				</div>
		</li><!-- #comment-## -->
		<li class="comment odd alt thread-odd thread-alt depth-1" id="comment-365883">
				<div id="div-comment-365883" class="comment-body">
				<div class="comment-author vcard">
						<cite class="fn">DavRis</cite> <span class="says">says:</span>		</div>
		
		<div class="comment-meta commentmetadata"><a href="https://blogs.msdn.microsoft.com/oldnewthing/20060331-15/?p=31703#comment-365883">
			April 3, 2006 at 10:54 pm</a>		</div>

		<p>Adam,</p>
<p>You wrote:<br />
<br />&gt; Btw, it&#8217;s not file://\servershare, it&#8217;s file:///\servershare, and you did claim that file://server/share was &quot;the correct notation&quot;. Also, as I pointed out, I am also aware that file://server/share works, it&#8217;s just not correct. </p>
<p>May I ask where you are getting your information on the file URI?</p>
<p>I&#8217;d suggest you read the following excellent blog post by ZekeL describing the problems with the file URI form you&#8217;re promoting:<br />
<br /><a rel="nofollow" target="_new" href="http://blogs.msdn.com/freeassociations/archive/2005/05/19/420059.aspx" rel="nofollow">http://blogs.msdn.com/freeassociations/archive/2005/05/19/420059.aspx</a></p>
<p>The following is section 3.10 of RFC 1738 &quot;Uniform Resource Locators (URL)&quot; &lt;<a rel="nofollow" target="_new" href="http://www.ietf.org/rfc/rfc1738.txt&gt;" rel="nofollow"></a><a href="http://www.ietf.org/rfc/rfc1738.txt&#038;gt" rel="nofollow">http://www.ietf.org/rfc/rfc1738.txt&#038;gt</a>; that describes file URIs.</p>
<p>Thanks,<br />
<br />Dave</p>
<p>3.10 FILES</p>
<p> &nbsp; The file URL scheme is used to designate files accessible on a particular host computer. This scheme, unlike most other URL schemes, does not designate a resource that is universally accessible over the Internet.</p>
<p> &nbsp; A file URL takes the form:</p>
<p> &nbsp; &nbsp; &nbsp; file://&lt;host&gt;/&lt;path&gt;</p>
<p> &nbsp; where &lt;host&gt; is the fully qualified domain name of the system on which the &lt;path&gt; is accessible, and &lt;path&gt; is a hierarchical directory path of the form &lt;directory&gt;/&lt;directory&gt;/&#8230;/&lt;name&gt;.</p>
<p> &nbsp; For example, a VMS file</p>
<p> &nbsp; &nbsp; DISK$USER:[MY.NOTES]NOTE123456.TXT</p>
<p> &nbsp; might become</p>
<p> &nbsp; &nbsp; &lt;URL:file://vms.host.edu/disk$user/my/notes/note12345.txt&gt;</p>
<p> &nbsp; As a special case, &lt;host&gt; can be the string &quot;localhost&quot; or the empty string; this is interpreted as `the machine from which the URL is being interpreted&#8217;.</p>
<p> &nbsp; The file URL scheme is unusual in that it does not specify an Internet protocol or access method for such files; as such, its utility in network protocols between hosts is limited.<br /></p>

		
				</div>
		</li><!-- #comment-## -->
		<li class="comment even thread-even depth-1" id="comment-366023">
				<div id="div-comment-366023" class="comment-body">
				<div class="comment-author vcard">
						<cite class="fn">Adam</cite> <span class="says">says:</span>		</div>
		
		<div class="comment-meta commentmetadata"><a href="https://blogs.msdn.microsoft.com/oldnewthing/20060331-15/?p=31703#comment-366023">
			April 4, 2006 at 8:24 am</a>		</div>

		<p>DavRiS:</p>
<p>Yes &#8211; the portion between the 2nd and 3rd / is a hostname.</p>
<p>And like the portion of the RFC you quoted:</p>
<p>&quot;This scheme, unlike most other URL schemes, does not designate a resource that is universally accessible over the Internet.&quot;</p>
<p>So, any file that is on another host <em>is not a resource that is accessible over the internet</em>.</p>
<p>The only way to reliably access files with the &quot;file:&quot; schema is when &quot;&lt;host&gt; [is] the string &quot;localhost&quot; or the empty string; this is interpreted as `the machine from which the URL is being interpreted&#8217;.&quot;</p>
<p>So &quot;file:&quot; URIs, in order to <em>be accessible</em>, must have &lt;host&gt; as the local host name, &quot;localhost&quot;, or empty. i.e. &quot;file:///&quot;</p>
<p>After that, you put the absolute path of any file in your local filesystem&#8217;s namespace. Which, on Windows, is either of the form:</p>
<p>c:pathtofile.txt<br />
<br />\server\sharepathtofile.txt</p>
<p>Which gives us the following URLs:</p>
<p>file:///c:pathtofile.txt<br />
<br />file:///\serversharepathtofile.txt</p>
<p>I don&#8217;t see where the post you mention points out any problems with the file:///\servershare&#8230; schema, or gives any justification for why file://server/share/&#8230; is better, considering that, as the RFC points out:</p>
<p>&quot;[The file protocol] does not designate a resource that is universally accessible over the Internet. [&#8230;] its utility in network protocols between hosts is limited.&quot;</p>
<p>The &quot;file:&quot; schema is used to access files in your local filesystem&#8217;s namespace.</p>
<p>All smb shares on your network are visible in your local filesystem&#8217;s namespace.</p>
<p>In order to access a file in your local filesystem&#8217;s namespace, including remote files that are mapped into it, you specify &quot;file:///&quot; followed by the path in your local filesystem&#8217;s namespace for the file you want to access.</p>
<p>That&#8217;s the clearest I can put it.</p>
<p>If you can&#8217;t understand that then answer this:</p>
<p>If the &quot;file:&quot; schema can be used to access files on remote hosts, then what transport protocol does the &quot;file:&quot; protocol run over (e.g. TCP/IP), what &quot;port&quot; (or equivalent) does it run on (e.g. 138, 139, 445), and where can I see a single piece of documentation about this remote &quot;file:&quot; protocol? I&#8217;d like to implement it for UNIX.</p>
<p>Hint: &quot;file:&quot; is not &quot;smb:&quot;, and any answer that claims &quot;file:&quot; is &quot;smb:&quot; is wrong. I already have &quot;smb://server/share/path/to/file.txt&quot; on my computer. Now I want this remote &quot;file:&quot; protocol you speak of.</p>
<p>Remember what the &quot;U&quot; in &quot;URI&quot; stands for.<br /></p>

		
				</div>
		</li><!-- #comment-## -->
		<li class="comment odd alt thread-odd thread-alt depth-1" id="comment-366043">
				<div id="div-comment-366043" class="comment-body">
				<div class="comment-author vcard">
						<cite class="fn">Adam</cite> <span class="says">says:</span>		</div>
		
		<div class="comment-meta commentmetadata"><a href="https://blogs.msdn.microsoft.com/oldnewthing/20060331-15/?p=31703#comment-366043">
			April 4, 2006 at 8:35 am</a>		</div>

		<p>Stefan:</p>
<p>Right &#8211; I was confused because you put &quot;net&quot; in the &quot;hostname&quot; part of a URL.</p>
<p>Well, I&#8217;d expect both of the following equivalent URIs:</p>
<p>file:///net/server/&#8230;.<br />
<br />file://localhost/net/server&#8230;</p>
<p>to access whatever exists at:</p>
<p>/net/server/&#8230;</p>
<p>in the filesystem on your computer. Three slashes and then whatever exists in your local filesystem. That&#8217;s entirely my point.</p>
<p>On UNIX, remote files can be part of your local filesystem if mounted there. To access them with a file URI is just:</p>
<p>file:///mnt/remote-mount/path/to/file.txt</p>
<p>On Windows, remote files shared over smb are automatically part of your local filesystem via an automatic mounting at //. Under windows, the following are both paths in your local filesystem:</p>
<p>c:pathtofile.txt<br />
<br />\serversharepathtofile.txt</p>
<p>even though one is not a local file, just as the following are both paths in your local filesystem under unix:</p>
<p>/etc/passwd<br />
<br />/mnt/some-remote-nfs-share/path/to/file.txt</p>
<p>even though (again) one is not a local file.</p>
<p>&quot;file&quot; URIs made from those four local paths are therefore:</p>
<p>file:///c:pathtofile.txt<br />
<br />file:///\serversharepathtofile.txt<br />
<br />file:///etc/passwd<br />
<br />file:///mnt/some-remote-nfs-share/path/to/file.txt</p>
<p>Is this making sense yet?<br /></p>

		
				</div>
		</li><!-- #comment-## -->
		<li class="comment even thread-even depth-1" id="comment-366063">
				<div id="div-comment-366063" class="comment-body">
				<div class="comment-author vcard">
						<cite class="fn">read ahead optimization</cite> <span class="says">says:</span>		</div>
		
		<div class="comment-meta commentmetadata"><a href="https://blogs.msdn.microsoft.com/oldnewthing/20060331-15/?p=31703#comment-366063">
			April 4, 2006 at 10:09 am</a>		</div>

		<p>Could one solution to this problem be to modify FindFirst to read ahead atleast 101 entries on file shares? Most of the times FindFirst are called, FindNext are called shortly after. Read ahead would be an optimization in most cases.</p>
<p>This problem get worse because the lack of a API to get the whole dir in one call.<br />
<br />FindFirst/FindNext are very unoptimized for large dirs.<br /></p>

		
				</div>
		</li><!-- #comment-## -->
		<li class="comment odd alt thread-odd thread-alt depth-1" id="comment-366213">
				<div id="div-comment-366213" class="comment-body">
				<div class="comment-author vcard">
						<cite class="fn">Jules</cite> <span class="says">says:</span>		</div>
		
		<div class="comment-meta commentmetadata"><a href="https://blogs.msdn.microsoft.com/oldnewthing/20060331-15/?p=31703#comment-366213">
			April 4, 2006 at 1:34 pm</a>		</div>

		<p>Adam: just a nitpick, but URLs require the directory separator to be a forward slash, so yours should be:</p>
<p>file:///c:/path/to/file.txt<br />
<br />file://///server/share/path/to/file.txt </p>
<p>I&#8217;m not sure if the latter is actualy a valid file URL, syntatically speaking, but it is likely the most correct way of expressing it. &nbsp;The syntax calls for the part following the third slash to be a slash-separated directory path followed by a filename. &nbsp;The &#8216;//&#8217; at the start of the UNC name doesn&#8217;t really follow this pattern.</p>

		
				</div>
		</li><!-- #comment-## -->
		<li class="comment even thread-even depth-1" id="comment-366273">
				<div id="div-comment-366273" class="comment-body">
				<div class="comment-author vcard">
						<cite class="fn">DavRis</cite> <span class="says">says:</span>		</div>
		
		<div class="comment-meta commentmetadata"><a href="https://blogs.msdn.microsoft.com/oldnewthing/20060331-15/?p=31703#comment-366273">
			April 4, 2006 at 4:12 pm</a>		</div>

		<p>Adam,</p>
<p>There are a couple of problem with putting a Windows file path after &#8216;file://&#8217; and calling it a file URI (although I think (2) provides the only real-world problems)</p>
<p>(1) Windows file paths may contain characters that aren&#8217;t allowed in URIs. &nbsp;This includes &#8221;, &#8216;&lt;&#8216;, &#8216; &#8216;, all int&#8217;l characters outside of US-ASCII, etc..</p>
<p>(2) URIs use percent-encoding to encode characters that aren&#8217;t allowed in a URI or that would interfere with the parsing of a URI where Windows file paths don&#8217;t have a concept of encoding characters. &nbsp;This is a problem if your Windows file path contains a &#8216;%&#8217;, &#8216;#&#8217;, or &#8216;?&#8217;. &nbsp;If you have a file named &#8216;C:tmpMy Phone #s.txt&#8217; the corresponding file URI should be &#8216;file:///C:/tmp/My%20Phone%20%23s.txt&#8217;. &nbsp;If you simply take the Windows file path and stick it after &#8216;file://&#8217; you end up with &#8216;file://C:tmpMy Phone #s.txt&#8217;. &nbsp;If you were to parse this URI (ignoring the spaces which technically aren&#8217;t allowed in a URI) the &#8216;s.txt&#8217; at the end of the URI ends up as the fragment rather than part of the path. &nbsp;Similar problems occur if you have a &#8216;%&#8217; in your Windows file path.</p>
<p>Problem (2) is what Zeke was describing in the blog post to which I linked previously.</p>
<p>Additionally, file URIs aren&#8217;t intended to only access files from your local filesystem. &nbsp;As noted in RFC 1738:</p>
<p>&quot;The file URL scheme is used to designate files accessible on a particular host computer.&quot;</p>
<p>The method of access is left up to the resolving system and resolving the URI is very much dependent on the what system does the resolving however file URIs weren&#8217;t intended for only the local file system. &nbsp;The lack of specification here does limit the use of the file URI when going between multiple systems. &nbsp;I&#8217;m aware that the U in URI stands for Uniform however as the RFC points out the file scheme is unusual in this fashion.</p>
<p>-Dave</p>

		
				</div>
		</li><!-- #comment-## -->
		<li class="comment odd alt thread-odd thread-alt depth-1" id="comment-366303">
				<div id="div-comment-366303" class="comment-body">
				<div class="comment-author vcard">
						<cite class="fn">DavRis</cite> <span class="says">says:</span>		</div>
		
		<div class="comment-meta commentmetadata"><a href="https://blogs.msdn.microsoft.com/oldnewthing/20060331-15/?p=31703#comment-366303">
			April 4, 2006 at 4:46 pm</a>		</div>

		<p>Sorry, that should be a &#8216;{&#8216; not a &#8216;&lt;&#8216; under (1).</p>

		
				</div>
		</li><!-- #comment-## -->
		<li class="comment even thread-even depth-1" id="comment-366343">
				<div id="div-comment-366343" class="comment-body">
				<div class="comment-author vcard">
						<cite class="fn">Stefan Kanthak</cite> <span class="says">says:</span>		</div>
		
		<div class="comment-meta commentmetadata"><a href="https://blogs.msdn.microsoft.com/oldnewthing/20060331-15/?p=31703#comment-366343">
			April 4, 2006 at 7:01 pm</a>		</div>

		<p>Adam: in your answer to DavRis you omitted the &quot;universally&quot; twice before &quot;accessible&quot;. &quot;file:// does not need to be universally accessible over the internet&quot; does not mean that it&#8217;s not accessible at all.</p>
<p>{Windows,Internet} Explorer both handle file://remotehost/path/to/file.txt in a transparent thanks to the redirector, mapping file:// to either<br />
<br />&#8211; local accesses<br />
<br />&#8211; NetBIOS over NetBEUI<br />
<br />&#8211; NetBIOS over IPX<br />
<br />&#8211; NetBIOS over TCP<br />
<br />&#8211; CIFS/SMB<br />
<br />&#8211; any third party add-on to the redirector.</p>
<p>This implementation is correct with regard to RFC1738 (and its updates), RFC1739 and RFC2151, the latter both using the same (informal) description:</p>
<p> &nbsp; file://host/directory/file-name<br />
<br /> &nbsp; &nbsp; &nbsp; Identifies a specific file. E.g., the file htmlasst in the edu<br />
<br /> &nbsp; &nbsp; directory at host <a href="http://ftp.cs.da" rel="nofollow">http://ftp.cs.da</a> would be denoted, using the full URL<br />
<br /> &nbsp; &nbsp; form: &nbsp;&lt;URL:file://ftp.cs.da/edu/htmlasst&gt;.</p>
<p>(I should have taken a closer look into the RFCs earlier instead of using my memory only to avoid this side-thread here altogether:-(<br />
<br />Sorry Raymond!</p>
<p>Using &quot;ftp&quot; as DNS hostname in the example was a bad or ambiguous choice, since file:// clearly does not denote ftp:// here!</p>
<p>Before you start to implement it for UNIX: <a rel="nofollow" target="_new" href="http://curl.haxx.se/" rel="nofollow">http://curl.haxx.se/</a> exists and supports file:// already, although not the way you want and the above referenced RFCs describe it.<br />
<br />(Even on Windows cURL only supports &quot;localhost&quot;, discarding ANY other hostname given silently, retrieving files from local and UNC paths.)</p>
<p>It&#8217;s up to you to come up with a RFC-compliant implementation on UNIX now.-) Maybe you supply a correction to cURL for both UNIX and Windows? &lt;bg&gt;</p>
<p>Jules: see RFC1738 and its updates,<br />
<br /> file://server/path is perfectly right.</p>
<p>Stefan</p>

		
				</div>
		</li><!-- #comment-## -->
		<li class="comment odd alt thread-odd thread-alt depth-1" id="comment-366383">
				<div id="div-comment-366383" class="comment-body">
				<div class="comment-author vcard">
						<cite class="fn">Richard</cite> <span class="says">says:</span>		</div>
		
		<div class="comment-meta commentmetadata"><a href="https://blogs.msdn.microsoft.com/oldnewthing/20060331-15/?p=31703#comment-366383">
			April 5, 2006 at 2:35 am</a>		</div>

		<p>Someone mentioned that Samba can&#8217;t change the family for the fixed versions because it&#8217;s a user configurable setting; that makes things even better. Vista could look for some indication in the family that the server will support fast mode, and then Samba can tell their users to use the appropriate configuration if they don&#8217;t have a broken version (either setting a specific string or having a new configuration option that will add something). If Vista does have to default to slow mode, it should do it in the most restrictive way possible; if this means all Samba server by default, at least others can still take advantage of the fast mode.</p>
<p>Another solution would be to make the blacklist process manual; when the error is encountered, the user is given the choice to always use slow mode with that server. This could get annoying though, and make the spamming problem even worse.</p>

		
				</div>
		</li><!-- #comment-## -->
		<li class="comment even thread-even depth-1" id="comment-366513">
				<div id="div-comment-366513" class="comment-body">
				<div class="comment-author vcard">
						<cite class="fn">Dancing Monkey Keeper</cite> <span class="says">says:</span>		</div>
		
		<div class="comment-meta commentmetadata"><a href="https://blogs.msdn.microsoft.com/oldnewthing/20060331-15/?p=31703#comment-366513">
			April 5, 2006 at 11:19 am</a>		</div>

		<p>This problem should be resolved by management, not code monkeys.</p>

		
				</div>
		</li><!-- #comment-## -->
		<li class="comment odd alt thread-odd thread-alt depth-1" id="comment-366813">
				<div id="div-comment-366813" class="comment-body">
				<div class="comment-author vcard">
						<cite class="fn"><a href='http://blogs.msdn.com/oldnewthing/archive/2006/04/06/569873.aspx' rel='external nofollow' class='url'>The Old New Thing : It's more efficient when you buy in bulk</a></cite> <span class="says">says:</span>		</div>
		
		<div class="comment-meta commentmetadata"><a href="https://blogs.msdn.microsoft.com/oldnewthing/20060331-15/?p=31703#comment-366813">
			April 6, 2006 at 10:00 am</a>		</div>

		<p>PingBack from <a rel="nofollow" target="_new" href="http://blogs.msdn.com/oldnewthing/archive/2006/04/06/569873.aspx" rel="nofollow">http://blogs.msdn.com/oldnewthing/archive/2006/04/06/569873.aspx</a></p>

		
				</div>
		</li><!-- #comment-## -->
		<li class="comment even thread-even depth-1" id="comment-367463">
				<div id="div-comment-367463" class="comment-body">
				<div class="comment-author vcard">
						<cite class="fn">Norman Diamond</cite> <span class="says">says:</span>		</div>
		
		<div class="comment-meta commentmetadata"><a href="https://blogs.msdn.microsoft.com/oldnewthing/20060331-15/?p=31703#comment-367463">
			April 7, 2006 at 8:06 am</a>		</div>

		<p>Saturday, April 01, 2006 8:24 AM by Adam<br />
<br />&gt; Stefan Kanthak:<br />
<br />&gt;&gt;<br />
<br />&gt;&gt; The correct notation is<br />
<br />&gt;&gt; file://some.server/&#8230; and should work in<br />
<br />&gt;&gt; other browsers running on Windows too<br />
<br />&gt;<br />
<br />&gt; No, the correct notation for local files is<br />
<br />&gt; file:///c:pathtofile.txt</p>
<p>Microsoft and at least one hardware vendor disagree with both of you. &nbsp;At the moment I&#8217;m looking at Pocket Internet Explorer&#8217;s display of an unnameable vendor&#8217;s built-in home page:</p>
<p>file://windowsdefault_HP.htm</p>
<p>&gt; Now, it has to be said that Internet Explorer<br />
<br />&gt; (and Windows Explorer, which might be the<br />
<br />&gt; same application, but I can never tell)</p>
<p>If you were using Windows Explorer and didn&#8217;t even have Internet Explorer open, and Windows puts up a message box (which no one ever reads) saying that Internet Explorer crashed, then you can tell that they&#8217;re the same application.</p>
<p>Sunday, April 02, 2006 9:56 PM by steveg<br />
<br />&gt; [as a regular reader I&#8217;m also waiting for<br />
<br />&gt; Norman&#8217;s Marvin-the-robot-like comment<br />
<br />&gt; anxiously]</p>
<p>What an incredibly stupid machine.</p>
<p>(Sorry the wording is probably inaccurate because a few decades have passed since I read it. &nbsp;Anyway tanks for the memory.)</p>
<p>Monday, April 03, 2006 4:42 AM by Rich<br />
<br />&gt; In the absence of any other information,<br />
<br />&gt; starting the troubleshooting process at the<br />
<br />&gt; most recent change is an eminently reasonable<br />
<br />&gt; thing to do.</p>
<p>Oops. &nbsp;I agree with that, and Microsoft agrees with that (they say so in white fixed-width text on a background which is turning gray), which means I now agree with Microsoft.</p>
<p>Monday, April 03, 2006 7:30 AM by 8<br />
<br />&gt; AC: &quot;AFAIK, most ISPs filter the SMB ports&quot;<br />
<br />&gt; The attacker knows it and doesn&#8217;t use such<br />
<br />&gt; an ISP.</p>
<p>True. &nbsp;My firewall logs often include attacks on SMB ports. &nbsp;With my former ISP, my firewall logs included several attacks each day coming from US military sites. &nbsp;Hope this makes someone feel secure.</p>

		
				</div>
		</li><!-- #comment-## -->
		<li class="comment odd alt thread-odd thread-alt depth-1" id="comment-371313">
				<div id="div-comment-371313" class="comment-body">
				<div class="comment-author vcard">
						<cite class="fn"><a href='http://blogs.msdn.com/oldnewthing/archive/2006/04/19/578991.aspx' rel='external nofollow' class='url'>The Old New Thing : Adding a new flag to enable behavior that previously was on by default</a></cite> <span class="says">says:</span>		</div>
		
		<div class="comment-meta commentmetadata"><a href="https://blogs.msdn.microsoft.com/oldnewthing/20060331-15/?p=31703#comment-371313">
			April 19, 2006 at 10:00 am</a>		</div>

		<p>PingBack from <a rel="nofollow" target="_new" href="http://blogs.msdn.com/oldnewthing/archive/2006/04/19/578991.aspx" rel="nofollow">http://blogs.msdn.com/oldnewthing/archive/2006/04/19/578991.aspx</a></p>

		
				</div>
		</li><!-- #comment-## -->
		<li class="comment even thread-even depth-1" id="comment-414693">
				<div id="div-comment-414693" class="comment-body">
				<div class="comment-author vcard">
						<cite class="fn"><a href='http://blogs.msdn.com/oldnewthing/archive/2006/08/29/730002.aspx' rel='external nofollow' class='url'>The Old New Thing : As I recall, Germany did not ratify the United States Constitution</a></cite> <span class="says">says:</span>		</div>
		
		<div class="comment-meta commentmetadata"><a href="https://blogs.msdn.microsoft.com/oldnewthing/20060331-15/?p=31703#comment-414693">
			August 29, 2006 at 10:00 am</a>		</div>

		<p>PingBack from <a rel="nofollow" target="_new" href="http://blogs.msdn.com/oldnewthing/archive/2006/08/29/730002.aspx" rel="nofollow">http://blogs.msdn.com/oldnewthing/archive/2006/08/29/730002.aspx</a></p>

		
				</div>
		</li><!-- #comment-## -->
		<li class="comment odd alt thread-odd thread-alt depth-1" id="comment-467033">
				<div id="div-comment-467033" class="comment-body">
				<div class="comment-author vcard">
						<cite class="fn"><a href='http://blogs.msdn.com/oldnewthing/archive/2007/02/01/1573160.aspx' rel='external nofollow' class='url'>The Old New Thing : The network interoperability compatibility problem, second follow-up</a></cite> <span class="says">says:</span>		</div>
		
		<div class="comment-meta commentmetadata"><a href="https://blogs.msdn.microsoft.com/oldnewthing/20060331-15/?p=31703#comment-467033">
			February 1, 2007 at 10:00 am</a>		</div>

		<p>PingBack from <a rel="nofollow" target="_new" href="http://blogs.msdn.com/oldnewthing/archive/2007/02/01/1573160.aspx" rel="nofollow">http://blogs.msdn.com/oldnewthing/archive/2007/02/01/1573160.aspx</a></p>

		
				</div>
		</li><!-- #comment-## -->
		<li class="comment even thread-even depth-1" id="comment-467203">
				<div id="div-comment-467203" class="comment-body">
				<div class="comment-author vcard">
						<cite class="fn"><a href='http://gabrielstein.org/?p=67' rel='external nofollow' class='url'>Steady Ocean of Good Things &raquo; Interoperabilidade - Ainda ?? poss??vel?</a></cite> <span class="says">says:</span>		</div>
		
		<div class="comment-meta commentmetadata"><a href="https://blogs.msdn.microsoft.com/oldnewthing/20060331-15/?p=31703#comment-467203">
			February 1, 2007 at 12:38 pm</a>		</div>

		<p>PingBack from <a rel="nofollow" target="_new" href="http://gabrielstein.org/?p=67" rel="nofollow">http://gabrielstein.org/?p=67</a></p>

		
				</div>
		</li><!-- #comment-## -->
		</ol><!-- .comment-list -->

		<div class="navigation pagination">
					</div>

	
			<p class="no-comments">Comments are closed.</p>
<!-- COMMENTS END -->
</div></td></tr></table>