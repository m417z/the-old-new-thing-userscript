<table class="commenttable" cellspacing="0" cellpadding="0"><tr><td><div class="commentdiv"><div class="commentdivhdr">
<!-- COMMENTS START -->
Comments (21)	</div>

	
			<div class="navigation pagination clear-both">
					</div>

		<ol class="comment-list">
					<li class="comment byuser comment-author-alegrigoriev even thread-even depth-1" id="comment-1063333">
				<div id="div-comment-1063333" class="comment-body">
				<div class="comment-author vcard">
						<cite class="fn"><a href='https://social.msdn.microsoft.com/profile/alegr1' rel='external nofollow' class='url'>alegr1</a></cite> <span class="says">says:</span>		</div>
		
		<div class="comment-meta commentmetadata"><a href="https://blogs.msdn.microsoft.com/oldnewthing/20130627-00/?p=3973#comment-1063333">
			June 27, 2013 at 7:10 am</a>		</div>

		<p>Now, if only Windows Vista+ haven&#39;t made WM_QUERYENDSESSION meaningless&#8230;</p>

		
				</div>
		</li><!-- #comment-## -->
		<li class="comment odd alt thread-odd thread-alt depth-1" id="comment-1063343">
				<div id="div-comment-1063343" class="comment-body">
				<div class="comment-author vcard">
						<cite class="fn"><a href='http://blogs.msdn.com/raceprouk_4000_hotmail.co.uk/ProfileUrlRedirect.ashx' rel='external nofollow' class='url'>raceprouk@hotmail.co.uk</a></cite> <span class="says">says:</span>		</div>
		
		<div class="comment-meta commentmetadata"><a href="https://blogs.msdn.microsoft.com/oldnewthing/20130627-00/?p=3973#comment-1063343">
			June 27, 2013 at 7:19 am</a>		</div>

		<p>@alegr1: Because there&#39;s nothing I like better than to have a program I can&#39;t interact with preventing me from shutting the PC down.</p>

		
				</div>
		</li><!-- #comment-## -->
		<li class="comment even thread-even depth-1" id="comment-1063353">
				<div id="div-comment-1063353" class="comment-body">
				<div class="comment-author vcard">
						<cite class="fn">Adam Rosenfield</cite> <span class="says">says:</span>		</div>
		
		<div class="comment-meta commentmetadata"><a href="https://blogs.msdn.microsoft.com/oldnewthing/20130627-00/?p=3973#comment-1063353">
			June 27, 2013 at 7:21 am</a>		</div>

		<p>The application developer says, &quot;It must be a bug in the library.&quot; &nbsp;The library developer says, &quot;It must be a bug in the kernel.&quot; &nbsp;The kernel developer says, &quot;It must be a bug in the hardware.&quot; &nbsp;The hardware developer says, &quot;[Expletive], it must be a bug in physics.&quot;</p>

		
				</div>
		</li><!-- #comment-## -->
		<li class="comment byuser comment-author-fredericmagnyf odd alt thread-odd thread-alt depth-1" id="comment-1063363">
				<div id="div-comment-1063363" class="comment-body">
				<div class="comment-author vcard">
						<cite class="fn"><a href='https://social.msdn.microsoft.com/profile/Medinoc' rel='external nofollow' class='url'>Medinoc</a></cite> <span class="says">says:</span>		</div>
		
		<div class="comment-meta commentmetadata"><a href="https://blogs.msdn.microsoft.com/oldnewthing/20130627-00/?p=3973#comment-1063363">
			June 27, 2013 at 7:25 am</a>		</div>

		<p>This mean you can&#39;t have global objects which perform important stuff in their destructors, doesn&#39;t it? Or else the only way to clean up is to call The CRT exit() without ever responding to the WM_ENDSESSION message&#8230;</p>

		
				</div>
		</li><!-- #comment-## -->
		<li class="comment even thread-even depth-1" id="comment-1063373">
				<div id="div-comment-1063373" class="comment-body">
				<div class="comment-author vcard">
						<cite class="fn">deiruch</cite> <span class="says">says:</span>		</div>
		
		<div class="comment-meta commentmetadata"><a href="https://blogs.msdn.microsoft.com/oldnewthing/20130627-00/?p=3973#comment-1063373">
			June 27, 2013 at 7:26 am</a>		</div>

		<p>Well, the documentation could be clearer. It doesn&#39;t state that the process will just be terminated. Instead of</p>
<p>the session can end any time after all applications have returned from processing this message.</p>
<p>the documentation could state</p>
<p>the current process may be terminated any time after all applications have returned from processing this message.</p>
<p>to make it more obvious what&#39;s happening. But that&#39;s just, like, my opinion, man.</p>
<div class="post">[<em>The missing dot to be connected is that when a session ends, all processes in it are implicitly terminated. The statement in the documentation is broader because it covers the case where somebody hands work off to some other process in the same session. -Raymond</em>]</div>

		
				</div>
		</li><!-- #comment-## -->
		<li class="comment odd alt thread-odd thread-alt depth-1" id="comment-1063403">
				<div id="div-comment-1063403" class="comment-body">
				<div class="comment-author vcard">
						<cite class="fn">640k</cite> <span class="says">says:</span>		</div>
		
		<div class="comment-meta commentmetadata"><a href="https://blogs.msdn.microsoft.com/oldnewthing/20130627-00/?p=3973#comment-1063403">
			June 27, 2013 at 7:31 am</a>		</div>

		<p>@Medinoc: Yes, global variables, either simple types or complex objects, is BAD programming. You&#39;re doing it WRONG.</p>

		
				</div>
		</li><!-- #comment-## -->
		<li class="comment even thread-even depth-1" id="comment-1063413">
				<div id="div-comment-1063413" class="comment-body">
				<div class="comment-author vcard">
						<cite class="fn">640k</cite> <span class="says">says:</span>		</div>
		
		<div class="comment-meta commentmetadata"><a href="https://blogs.msdn.microsoft.com/oldnewthing/20130627-00/?p=3973#comment-1063413">
			June 27, 2013 at 7:34 am</a>		</div>

		<p>@deiruch: Loss of power can happen at all times. There&#39;s not a &quot;safe&quot; moment in an applications executing lifetime.</p>

		
				</div>
		</li><!-- #comment-## -->
		<li class="comment byuser comment-author-alegrigoriev odd alt thread-odd thread-alt depth-1" id="comment-1063423">
				<div id="div-comment-1063423" class="comment-body">
				<div class="comment-author vcard">
						<cite class="fn"><a href='https://social.msdn.microsoft.com/profile/alegr1' rel='external nofollow' class='url'>alegr1</a></cite> <span class="says">says:</span>		</div>
		
		<div class="comment-meta commentmetadata"><a href="https://blogs.msdn.microsoft.com/oldnewthing/20130627-00/?p=3973#comment-1063423">
			June 27, 2013 at 7:36 am</a>		</div>

		<p>Saving state only after exiting the message loop was why Visual Studio.NET was not saving last project if it was closed by the logoff. And also why Explorer in earlier Windows was not saving states in logoff.</p>

		
				</div>
		</li><!-- #comment-## -->
		<li class="comment even thread-even depth-1" id="comment-1063433">
				<div id="div-comment-1063433" class="comment-body">
				<div class="comment-author vcard">
						<cite class="fn">Simon Farnsworth</cite> <span class="says">says:</span>		</div>
		
		<div class="comment-meta commentmetadata"><a href="https://blogs.msdn.microsoft.com/oldnewthing/20130627-00/?p=3973#comment-1063433">
			June 27, 2013 at 7:54 am</a>		</div>

		<p>@Adam Rosenfield</p>
<p>In my experience, it&#39;s an endless loop:</p>
<p>The application developer says &quot;It must be a bug in the library.&quot;</p>
<p>The library developer says &quot;It must be a bug in the kernel.&quot;</p>
<p>The kernel developer says &quot;It must be a bug in the hardware.&quot;</p>
<p>The hardware developer says, &quot;It must be a bug in the application.&quot;</p>
<p>Rinse, wash, repeat, until you get app, library, kernel and hardware developers together to stop the blame game.</p>

		
				</div>
		</li><!-- #comment-## -->
		<li class="comment odd alt thread-odd thread-alt depth-1" id="comment-1063453">
				<div id="div-comment-1063453" class="comment-body">
				<div class="comment-author vcard">
						<cite class="fn">JM</cite> <span class="says">says:</span>		</div>
		
		<div class="comment-meta commentmetadata"><a href="https://blogs.msdn.microsoft.com/oldnewthing/20130627-00/?p=3973#comment-1063453">
			June 27, 2013 at 9:01 am</a>		</div>

		<p>This might be a good hook to promote crash-only software (<a rel="nofollow" target="_new" href="https://www.usenix.org/legacy/events/hotos03/tech/full_papers/candea/candea_html/">http://www.usenix.org/&#8230;/candea_html</a>): assume your program will end by someone calling TerminateProcess() and design transaction processing and recovery accordingly. Do not bother with any complicated shutdown logic, because you have to handle the case where it never gets to run anyway &#8212; bother with robust startup recovery instead. This model isn&#39;t always appropriate, but where it is it can be surprisingly powerful.</p>

		
				</div>
		</li><!-- #comment-## -->
		<li class="comment even thread-even depth-1" id="comment-1063463">
				<div id="div-comment-1063463" class="comment-body">
				<div class="comment-author vcard">
						<cite class="fn">AsmGuru62</cite> <span class="says">says:</span>		</div>
		
		<div class="comment-meta commentmetadata"><a href="https://blogs.msdn.microsoft.com/oldnewthing/20130627-00/?p=3973#comment-1063463">
			June 27, 2013 at 9:18 am</a>		</div>

		<p>There is nothing wrong with global variables.</p>
<p>Just new/delete them at proper times (create Startup/ShutDown routine(s) and call them as needed) instead of just declaring them.</p>

		
				</div>
		</li><!-- #comment-## -->
		<li class="comment odd alt thread-odd thread-alt depth-1" id="comment-1063513">
				<div id="div-comment-1063513" class="comment-body">
				<div class="comment-author vcard">
						<cite class="fn">JM</cite> <span class="says">says:</span>		</div>
		
		<div class="comment-meta commentmetadata"><a href="https://blogs.msdn.microsoft.com/oldnewthing/20130627-00/?p=3973#comment-1063513">
			June 27, 2013 at 1:09 pm</a>		</div>

		<p>@Myria: I can see two obvious problems with that.</p>
<p>First, correct shutdown code is often harder than other code because all sorts of previously safe assumptions are being invalidated left and right, in nondeterministic order if you&#39;re unlucky. If your shutdown code itself is buggy, then you have to fix it, but this does nothing to improve the quality of actually useful work our program performs. Applying a good programming regime like localized destructors and minimizing dependencies can reduce the complexity, but it&#39;s still a code burden. By contrast, validating your runtime state while you&#39;re still sure that it&#39;s all there is a lot easier.</p>
<p>Second, you&#39;re detecting bugs at a time when we don&#39;t care anymore. If the bugs affected the program&#39;s execution, well, the damage has been done when it was still doing work. If they didn&#39;t, then either they&#39;re not bugs, or they&#39;re leaks that only affect other programs and we&#39;re shutting down to solve them. Of course, these objections disappear when you&#39;re in a debugging session exactly to establish if the program would exhibit instability or resource leaks over longer periods of time, so certainly this can be useful, but if you care about this sort of thing it probably pays off more to invest in piecewise validation at runtime and less in having the shutdown phase double as a leak detector or consistency checker. Since shutdown code isn&#39;t usually designed for that, the best it can do is tell you there is possibly a problem somewhere, then leave you all alone in the dark.</p>

		
				</div>
		</li><!-- #comment-## -->
		<li class="comment even thread-even depth-1" id="comment-1063493">
				<div id="div-comment-1063493" class="comment-body">
				<div class="comment-author vcard">
						<cite class="fn">Myria</cite> <span class="says">says:</span>		</div>
		
		<div class="comment-meta commentmetadata"><a href="https://blogs.msdn.microsoft.com/oldnewthing/20130627-00/?p=3973#comment-1063493">
			June 27, 2013 at 10:29 am</a>		</div>

		<p>@JM: I agree with that. &nbsp;Assume that your program can go *poof* at any moment, and preserve important state accordingly.</p>
<p>The reason I see for keeping a controlled shutdown sequence in such software is that it helps you find bugs. &nbsp;Often, your code will crash at shutdown because there was a mistake made while running. &nbsp;Shutting down goes through your object tree and implicitly validates a lot of the runtime state.</p>
<p>I generally work on programs that don&#39;t care about WM_ENDSESSION, because sudden disappearing from existence is nonfatal.</p>

		
				</div>
		</li><!-- #comment-## -->
		<li class="comment odd alt thread-odd thread-alt depth-1" id="comment-1063543">
				<div id="div-comment-1063543" class="comment-body">
				<div class="comment-author vcard">
						<cite class="fn">henke37</cite> <span class="says">says:</span>		</div>
		
		<div class="comment-meta commentmetadata"><a href="https://blogs.msdn.microsoft.com/oldnewthing/20130627-00/?p=3973#comment-1063543">
			June 27, 2013 at 8:29 pm</a>		</div>

		<p>Just stick a call to TerminateProcess in the message handler, problem solved.</p>
<div class="post">[<em>You think you&#39;re joking but you&#39;re not. -Raymond</em>]</div>

		
				</div>
		</li><!-- #comment-## -->
		<li class="comment even thread-even depth-1" id="comment-1063553">
				<div id="div-comment-1063553" class="comment-body">
				<div class="comment-author vcard">
						<cite class="fn">asdbsd</cite> <span class="says">says:</span>		</div>
		
		<div class="comment-meta commentmetadata"><a href="https://blogs.msdn.microsoft.com/oldnewthing/20130627-00/?p=3973#comment-1063553">
			June 27, 2013 at 11:20 pm</a>		</div>

		<p>@640k:</p>
<p>Stop assaulting global variables, people. They&#39;re fine. From a purist point of view, in a functional world they may be ugly but passing everything by params and writing five level deep qualifiers is uglier.</p>

		
				</div>
		</li><!-- #comment-## -->
		<li class="comment odd alt thread-odd thread-alt depth-1" id="comment-1063563">
				<div id="div-comment-1063563" class="comment-body">
				<div class="comment-author vcard">
						<cite class="fn">Wak</cite> <span class="says">says:</span>		</div>
		
		<div class="comment-meta commentmetadata"><a href="https://blogs.msdn.microsoft.com/oldnewthing/20130627-00/?p=3973#comment-1063563">
			June 28, 2013 at 1:48 am</a>		</div>

		<p>[&#8230;]Because, of course, when you find a problem with your program, your first reaction should be to assume that you found a bug in Windows so blatant it should be affecting every program on the planet[&#8230;]</p>
<p>Not every program on the planet runs on Windows.</p>
<div class="post">[<em>You must be a lot of fun at parties. s/every program/every Windows program/. While you&#39;re at it, /your program/your Windows program/. (You might be surprised that this Web site deals primarily with Windows programming, and consequently the scope of most qualifiers is implied.) -Raymond</em>]</div>

		
				</div>
		</li><!-- #comment-## -->
		<li class="comment even thread-even depth-1" id="comment-1063573">
				<div id="div-comment-1063573" class="comment-body">
				<div class="comment-author vcard">
						<cite class="fn">JM</cite> <span class="says">says:</span>		</div>
		
		<div class="comment-meta commentmetadata"><a href="https://blogs.msdn.microsoft.com/oldnewthing/20130627-00/?p=3973#comment-1063573">
			June 28, 2013 at 2:46 am</a>		</div>

		<p>@Wak: good point. Your first reaction should be to assume that you found a bug in the foundations of computing. &quot;Turing complete&quot; my ass.</p>

		
				</div>
		</li><!-- #comment-## -->
		<li class="comment odd alt thread-odd thread-alt depth-1" id="comment-1063643">
				<div id="div-comment-1063643" class="comment-body">
				<div class="comment-author vcard">
						<cite class="fn"><a href='http://blogs.msdn.com/raceprouk_4000_hotmail.co.uk/ProfileUrlRedirect.ashx' rel='external nofollow' class='url'>raceprouk@hotmail.co.uk</a></cite> <span class="says">says:</span>		</div>
		
		<div class="comment-meta commentmetadata"><a href="https://blogs.msdn.microsoft.com/oldnewthing/20130627-00/?p=3973#comment-1063643">
			June 28, 2013 at 7:45 am</a>		</div>

		<p>@Wak: Raymond&#39;s not allowed to exaggerate for dramatic effect? ;)</p>

		
				</div>
		</li><!-- #comment-## -->
		<li class="comment byuser comment-author-alegrigoriev even thread-even depth-1" id="comment-1063963">
				<div id="div-comment-1063963" class="comment-body">
				<div class="comment-author vcard">
						<cite class="fn"><a href='https://social.msdn.microsoft.com/profile/alegr1' rel='external nofollow' class='url'>alegr1</a></cite> <span class="says">says:</span>		</div>
		
		<div class="comment-meta commentmetadata"><a href="https://blogs.msdn.microsoft.com/oldnewthing/20130627-00/?p=3973#comment-1063963">
			June 28, 2013 at 3:54 pm</a>		</div>

		<p>&gt;Because, of course, when you find a problem with your program, your first reaction should be to assume that you found a bug in Windows so blatant it should be affecting every program on the planet</p>
<p>In kernel programming, I encounter Windows bugs pretty often. Most not so severe, but some cause BSODs. Sometimes I can work around that, sometimes, it requires a QFE.</p>

		
				</div>
		</li><!-- #comment-## -->
		<li class="comment odd alt thread-odd thread-alt depth-1" id="comment-1064023">
				<div id="div-comment-1064023" class="comment-body">
				<div class="comment-author vcard">
						<cite class="fn">Ian Boyd</cite> <span class="says">says:</span>		</div>
		
		<div class="comment-meta commentmetadata"><a href="https://blogs.msdn.microsoft.com/oldnewthing/20130627-00/?p=3973#comment-1064023">
			June 28, 2013 at 9:36 pm</a>		</div>

		<p>And as we learned last time: stop trying to cleanup resources or free memory when your application shuts down.</p>
<p><a rel="nofollow" target="_new" href="http://blogs.msdn.com/b/oldnewthing/archive/2012/01/05/10253268.aspx">blogs.msdn.com/&#8230;/10253268.aspx</a></p>

		
				</div>
		</li><!-- #comment-## -->
		<li class="comment byuser comment-author-mike-dimmick even thread-even depth-1" id="comment-1065113">
				<div id="div-comment-1065113" class="comment-body">
				<div class="comment-author vcard">
						<cite class="fn"><a href='https://social.msdn.microsoft.com/profile/Mike+Dimmick' rel='external nofollow' class='url'>Mike Dimmick</a></cite> <span class="says">says:</span>		</div>
		
		<div class="comment-meta commentmetadata"><a href="https://blogs.msdn.microsoft.com/oldnewthing/20130627-00/?p=3973#comment-1065113">
			July 3, 2013 at 6:00 am</a>		</div>

		<p>I discovered in the past that it&#39;s a bad idea to use C++ globals with a destructor in a DLL. The destructor runs, effectively, after the DLL_PROCESS_DETACH notification in DllMain (it runs in the *real* DllMain, DllMainCRTStartup, which the compiler inserts for you and calls your DllMain). That means that the destructor runs under the loader lock&#8230;</p>

		
				</div>
		</li><!-- #comment-## -->
		</ol><!-- .comment-list -->

		<div class="navigation pagination">
					</div>

	
			<p class="no-comments">Comments are closed.</p>
<!-- COMMENTS END -->
</div></td></tr></table>