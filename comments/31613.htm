<table class="commenttable" cellspacing="0" cellpadding="0"><tr><td><div class="commentdiv"><div class="commentdivhdr">
<!-- COMMENTS START -->
Comments (65)	</div>

	
			<div class="navigation pagination clear-both">
					</div>

		<ol class="comment-list">
					<li class="comment even thread-even depth-1" id="comment-367513">
				<div id="div-comment-367513" class="comment-body">
				<div class="comment-author vcard">
						<cite class="fn"><a href='http://www.geekswithblogs.net/bradc' rel='external nofollow' class='url'>Brad Corbin</a></cite> <span class="says">says:</span>		</div>
		
		<div class="comment-meta commentmetadata"><a href="https://blogs.msdn.microsoft.com/oldnewthing/20060407-25/?p=31613#comment-367513">
			April 7, 2006 at 10:14 am</a>		</div>

		<p>Don&#8217;t leave us hanging like that, Raymond!</p>
<p>You have to at least let us know how they ultimately decide to resolve this one. I think its been a great discussion-starter, and a good peek into the true difficulty of programming in the real world.</p>

		
				</div>
		</li><!-- #comment-## -->
		<li class="comment odd alt thread-odd thread-alt depth-1" id="comment-367523">
				<div id="div-comment-367523" class="comment-body">
				<div class="comment-author vcard">
						<cite class="fn"><a href='http://www.petiejoe.com/' rel='external nofollow' class='url'>Jo-Pete Nelson</a></cite> <span class="says">says:</span>		</div>
		
		<div class="comment-meta commentmetadata"><a href="https://blogs.msdn.microsoft.com/oldnewthing/20060407-25/?p=31613#comment-367523">
			April 7, 2006 at 10:15 am</a>		</div>

		<p>&quot;By now, I&#8217;m kind of sick of it and will probably not bother checking back to see how things have settled out.&quot;</p>
<p>My friends think I&#8217;m crazy because I&#8217;m always happy to help people find and fix their bugs, but you nailed it on the head with this last comment. If it&#8217;s somebody else&#8217;s bug, I get to have the fun mind-binding experiment and if it gets too tough, I get to say &quot;sorry, I don&#8217;t have any more time.&quot; I rarely actually cut out on them like that (or else they wouldn&#8217;t ask me for help), but it&#8217;s always nice to have an escape plan.</p>

		
				</div>
		</li><!-- #comment-## -->
		<li class="comment even thread-even depth-1" id="comment-367533">
				<div id="div-comment-367533" class="comment-body">
				<div class="comment-author vcard">
						<cite class="fn">Keith</cite> <span class="says">says:</span>		</div>
		
		<div class="comment-meta commentmetadata"><a href="https://blogs.msdn.microsoft.com/oldnewthing/20060407-25/?p=31613#comment-367533">
			April 7, 2006 at 10:19 am</a>		</div>

		<p>SHITEMID; it always makes me laugh.</p>

		
				</div>
		</li><!-- #comment-## -->
		<li class="comment odd alt thread-odd thread-alt depth-1" id="comment-367543">
				<div id="div-comment-367543" class="comment-body">
				<div class="comment-author vcard">
						<cite class="fn">JS</cite> <span class="says">says:</span>		</div>
		
		<div class="comment-meta commentmetadata"><a href="https://blogs.msdn.microsoft.com/oldnewthing/20060407-25/?p=31613#comment-367543">
			April 7, 2006 at 10:26 am</a>		</div>

		<p>If merely failing to plan one&#8217;s meals a week at a time makes one a slacker, I&#8217;m afraid I must downgrade myself from &quot;slacker&quot; to something even more unsavory.</p>

		
				</div>
		</li><!-- #comment-## -->
		<li class="comment even thread-even depth-1" id="comment-367563">
				<div id="div-comment-367563" class="comment-body">
				<div class="comment-author vcard">
						<cite class="fn">Dave</cite> <span class="says">says:</span>		</div>
		
		<div class="comment-meta commentmetadata"><a href="https://blogs.msdn.microsoft.com/oldnewthing/20060407-25/?p=31613#comment-367563">
			April 7, 2006 at 10:39 am</a>		</div>

		<p>&quot;But if the computer you&#8217;re talking to is halfway around the world, then even if you can communicate at the theoretical maximum possible speed (namely, the speed of light), it&#8217;ll take 66 milliseconds for your request to reach the other computer and another 66 milliseconds for the reply to come back.&quot;</p>
<p>Management says we need to work on making this more performant. How can we reduce this serious bottleneck for our customers?</p>

		
				</div>
		</li><!-- #comment-## -->
		<li class="comment odd alt thread-odd thread-alt depth-1" id="comment-367573">
				<div id="div-comment-367573" class="comment-body">
				<div class="comment-author vcard">
						<cite class="fn"><a href='http://www.geekswithblogs.net/bradc' rel='external nofollow' class='url'>Brad Corbin</a></cite> <span class="says">says:</span>		</div>
		
		<div class="comment-meta commentmetadata"><a href="https://blogs.msdn.microsoft.com/oldnewthing/20060407-25/?p=31613#comment-367573">
			April 7, 2006 at 10:53 am</a>		</div>

		<blockquote><p>
  Management says we need to work on making<br />
  <br />&gt;this more performant. How can we reduce this<br />
  <br />&gt;serious bottleneck for our customers</p>
<p>We could drill a cable directly through the center of the earth. That should reduce the cable distance, but might increase maintenance costs. I&#8217;ll start working on some competitive bids :)
</p></blockquote>

		
				</div>
		</li><!-- #comment-## -->
		<li class="comment even thread-even depth-1" id="comment-367603">
				<div id="div-comment-367603" class="comment-body">
				<div class="comment-author vcard">
						<cite class="fn">Grant</cite> <span class="says">says:</span>		</div>
		
		<div class="comment-meta commentmetadata"><a href="https://blogs.msdn.microsoft.com/oldnewthing/20060407-25/?p=31613#comment-367603">
			April 7, 2006 at 11:30 am</a>		</div>

		<p>Dave,</p>
<p>Running fiber through the center of the earth should increase performance by about 3.14 times.</p>

		
				</div>
		</li><!-- #comment-## -->
		<li class="comment odd alt thread-odd thread-alt depth-1" id="comment-367613">
				<div id="div-comment-367613" class="comment-body">
				<div class="comment-author vcard">
						<cite class="fn">Centaur</cite> <span class="says">says:</span>		</div>
		
		<div class="comment-meta commentmetadata"><a href="https://blogs.msdn.microsoft.com/oldnewthing/20060407-25/?p=31613#comment-367613">
			April 7, 2006 at 11:39 am</a>		</div>

		<p>The documentation on BY_HANDLE_FILE_INFORMATION says:</p>
<p>&gt; Note that this value is useful only while the file is<br />
<br />&gt; open by at least one process. If no processes have it<br />
<br />&gt; open, the index may change the next time the file is<br />
<br />&gt; opened. </p>
<p>&gt; The identifier (low and high parts) and the volume<br />
<br />&gt; serial number uniquely identify a file on a single<br />
<br />&gt; computer. To determine whether two open handles<br />
<br />&gt; represent the same file, combine this identifier and<br />
<br />&gt; the volume serial number for each file and compare<br />
<br />&gt; them.</p>
<p>So the file index is something that allows us to tell one open file from other open files, by comparing the index of the file in question with indices of other files we have opened. And, once we close the file, the index may lose its meaning, so Explorer couldn’t possibly be storing them anywhere. So the only meaningful thing Explorer can do with each file index, is to compare it with indices of other open files it has, and determine whether they are the same file, or not.</p>
<p>This prompts two questions.</p>
<p>First, if Explorer has no remote files open, the comparison will always yield false. What legitimate reason is there for Explorer to open any remote files?</p>
<p>Second, what use is the knowledge that this particular file is the one it has open? What would it do when/if it found that out?</p>
<p>I think Explorer has no business keeping any remote files open. And even if it does, I do not see why it would need to treat open files specially. So I would vote for removal of this unnecessary file opening/querying/closing.</p>

		
				</div>
		</li><!-- #comment-## -->
		<li class="comment even thread-even depth-1" id="comment-367623">
				<div id="div-comment-367623" class="comment-body">
				<div class="comment-author vcard">
						<cite class="fn"><a href='http://sab39.dev.netreach.com/' rel='external nofollow' class='url'>Stuart Ballard</a></cite> <span class="says">says:</span>		</div>
		
		<div class="comment-meta commentmetadata"><a href="https://blogs.msdn.microsoft.com/oldnewthing/20060407-25/?p=31613#comment-367623">
			April 7, 2006 at 11:39 am</a>		</div>

		<p>Grant,</p>
<p>Management says that they need something more specific than &quot;about 3.14 times&quot;. Please give the exact number.</p>

		
				</div>
		</li><!-- #comment-## -->
		<li class="comment odd alt thread-odd thread-alt depth-1" id="comment-367633">
				<div id="div-comment-367633" class="comment-body">
				<div class="comment-author vcard">
						<cite class="fn">ChrisR</cite> <span class="says">says:</span>		</div>
		
		<div class="comment-meta commentmetadata"><a href="https://blogs.msdn.microsoft.com/oldnewthing/20060407-25/?p=31613#comment-367633">
			April 7, 2006 at 11:50 am</a>		</div>

		<p>Hmm, it seems to me that it would be pi/2 times. &nbsp;The distance travelled halfway around the globe is pi, and the distance straight through the global is 2.</p>
<p>Or maybe I need more coffee&#8230;who knows.</p>

		
				</div>
		</li><!-- #comment-## -->
		<li class="comment even thread-even depth-1" id="comment-367643">
				<div id="div-comment-367643" class="comment-body">
				<div class="comment-author vcard">
						<cite class="fn">Billy</cite> <span class="says">says:</span>		</div>
		
		<div class="comment-meta commentmetadata"><a href="https://blogs.msdn.microsoft.com/oldnewthing/20060407-25/?p=31613#comment-367643">
			April 7, 2006 at 12:17 pm</a>		</div>

		<p>So as someone who telecommutes most of the time and is forced to use Explorer (and SourceSafe) over the VPN, how do I enable &#8216;fast mode&#8217; in XP?</p>

		
				</div>
		</li><!-- #comment-## -->
		<li class="comment odd alt thread-odd thread-alt depth-1" id="comment-367683">
				<div id="div-comment-367683" class="comment-body">
				<div class="comment-author vcard">
						<cite class="fn">/df</cite> <span class="says">says:</span>		</div>
		
		<div class="comment-meta commentmetadata"><a href="https://blogs.msdn.microsoft.com/oldnewthing/20060407-25/?p=31613#comment-367683">
			April 7, 2006 at 1:10 pm</a>		</div>

		<p>Centaur<br />
<br />&quot;&#8230;What legitimate reason is there for Explorer to open any remote files?&quot;</p>
<p>Reading the file&#8217;s icon.</p>
<p>Reading the MP3 ID tag.</p>
<p>Reading the start of the file to determine its type &#224; la Unix (does Explorer still do this?)</p>
<p>Etc.<br /></p>

		
				</div>
		</li><!-- #comment-## -->
		<li class="comment even thread-even depth-1" id="comment-367693">
				<div id="div-comment-367693" class="comment-body">
				<div class="comment-author vcard">
						<cite class="fn">Gabe</cite> <span class="says">says:</span>		</div>
		
		<div class="comment-meta commentmetadata"><a href="https://blogs.msdn.microsoft.com/oldnewthing/20060407-25/?p=31613#comment-367693">
			April 7, 2006 at 1:25 pm</a>		</div>

		<p>Alas, I find myself longing for the days of File Manager, when viewing a directory listing on a remote server was no slower than just doing a DIR. I would be satisfied if Explorer&#8217;s &quot;Fast Mode&quot; would simply not open any files (no icons, no previews, no properties that aren&#8217;t in the directory).</p>

		
				</div>
		</li><!-- #comment-## -->
		<li class="comment odd alt thread-odd thread-alt depth-1" id="comment-367713">
				<div id="div-comment-367713" class="comment-body">
				<div class="comment-author vcard">
						<cite class="fn"><a href='http://qstuff.blogspot.com/' rel='external nofollow' class='url'>Justin Olbrantz (Quantam)</a></cite> <span class="says">says:</span>		</div>
		
		<div class="comment-meta commentmetadata"><a href="https://blogs.msdn.microsoft.com/oldnewthing/20060407-25/?p=31613#comment-367713">
			April 7, 2006 at 2:33 pm</a>		</div>

		<p>An unimportant remark that might be interesting to one person, at least: you don&#8217;t actually need to open the file to retrieve its icon. I once wrote an archive viewer that used standard shell API to get the icon for files in the archive, even when the files don&#8217;t exist in the file system. This simply uses the file&#8217;s extension, and so will not call icon extension (different &#8216;extension&#8217;) handlers (which would probably open the file).</p>

		
				</div>
		</li><!-- #comment-## -->
		<li class="comment even thread-even depth-1" id="comment-367733">
				<div id="div-comment-367733" class="comment-body">
				<div class="comment-author vcard">
						<cite class="fn"><a href='http://www.codedazure.com/' rel='external nofollow' class='url'>David Conrad</a></cite> <span class="says">says:</span>		</div>
		
		<div class="comment-meta commentmetadata"><a href="https://blogs.msdn.microsoft.com/oldnewthing/20060407-25/?p=31613#comment-367733">
			April 7, 2006 at 2:49 pm</a>		</div>

		<p>I think you probably should have called it SH_ITEM_ID instead.</p>

		
				</div>
		</li><!-- #comment-## -->
		<li class="comment odd alt thread-odd thread-alt depth-1" id="comment-367763">
				<div id="div-comment-367763" class="comment-body">
				<div class="comment-author vcard">
						<cite class="fn">DmitryKo</cite> <span class="says">says:</span>		</div>
		
		<div class="comment-meta commentmetadata"><a href="https://blogs.msdn.microsoft.com/oldnewthing/20060407-25/?p=31613#comment-367763">
			April 7, 2006 at 3:26 pm</a>		</div>

		<p>&quot;I&#8217;m kind of sick of it and will probably not bother checking back to see how things have settled out.&quot;</p>
<p>Raymond, people will lose sleep if you won&#8217;t tell us the outcome&#8230; I certainly will :)</p>

		
				</div>
		</li><!-- #comment-## -->
		<li class="comment even thread-even depth-1" id="comment-367773">
				<div id="div-comment-367773" class="comment-body">
				<div class="comment-author vcard">
						<cite class="fn">Wang-Lo</cite> <span class="says">says:</span>		</div>
		
		<div class="comment-meta commentmetadata"><a href="https://blogs.msdn.microsoft.com/oldnewthing/20060407-25/?p=31613#comment-367773">
			April 7, 2006 at 4:01 pm</a>		</div>

		<p>&quot;&#8230;Tuesday night &#8230;time I should have been spending planning Wednesday night&#8217;s dinner, mind you. (Yes, I&#8217;m a slacker and don&#8217;t plan my meals out a week at a time like organized people do.)&quot;</p>
<p>Men often compensate for a lack of domesticity with meticulous grocery lists and weekly meal planning. &nbsp;Women can run a household almost instinctively and rarely need to think more than one or two meals ahead. &nbsp;So I guess you eat like a girl too.</p>
<p>-Wang-Lo.<br /></p>

		
				</div>
		</li><!-- #comment-## -->
		<li class="comment odd alt thread-odd thread-alt depth-1" id="comment-367783">
				<div id="div-comment-367783" class="comment-body">
				<div class="comment-author vcard">
						<cite class="fn">steveg</cite> <span class="says">says:</span>		</div>
		
		<div class="comment-meta commentmetadata"><a href="https://blogs.msdn.microsoft.com/oldnewthing/20060407-25/?p=31613#comment-367783">
			April 7, 2006 at 5:28 pm</a>		</div>

		<p>&quot;But if the computer you&#8217;re talking to is halfway around the world, then even if you can communicate at the theoretical maximum possible speed (namely, the speed of light), it&#8217;ll take 66 milliseconds for your request to reach the other computer and another 66 milliseconds for the reply to come back.&quot;</p>
<p>We&#8217;re putting a satellite into VLOE (very low earth orbit) to reduce network latency between Australia and the US. We are simply going to dig a tunnel (or use the existing Verne tunnel in Iceland, depending on the cost of shipping the satellite there) to the centre of the earth, and place the satellite there.</p>
<p>The brilliance of this plan is we only need to use enuf power to send the signal halfway through the planet, the satellite relays the signal through the other half (free thermal power, you see). We are having heat disappation issues with the P4 chips we&#8217;re using, though&#8230;</p>

		
				</div>
		</li><!-- #comment-## -->
		<li class="comment even thread-even depth-1" id="comment-367793">
				<div id="div-comment-367793" class="comment-body">
				<div class="comment-author vcard">
						<cite class="fn">/df</cite> <span class="says">says:</span>		</div>
		
		<div class="comment-meta commentmetadata"><a href="https://blogs.msdn.microsoft.com/oldnewthing/20060407-25/?p=31613#comment-367793">
			April 7, 2006 at 6:17 pm</a>		</div>

		<p>Justin Olbrantz<br />
<br />&quot;&#8230;you don&#8217;t actually need to open the file to retrieve its icon&#8230;&quot;</p>
<p>It can be debated whether it was a good design decision, &nbsp;but Explorer wants to display the exact shell icon which is not always a generic icon for the file type: for instance, the Word icon in winword.exe, or the file itself for *.ico. As a result, it&#8217;s confusing for users to see a file listing with different (generic) icons. Potentially file-specific icons could be overridden for remote filesystems, but as in newer versions of Windows it&#8217;s better to hive off the icon updating to a background thread. You can wait a long time to display a remote folder in Win98 if its contents are executables or icons.</p>

		
				</div>
		</li><!-- #comment-## -->
		<li class="comment odd alt thread-odd thread-alt depth-1" id="comment-367813">
				<div id="div-comment-367813" class="comment-body">
				<div class="comment-author vcard">
						<cite class="fn">jim</cite> <span class="says">says:</span>		</div>
		
		<div class="comment-meta commentmetadata"><a href="https://blogs.msdn.microsoft.com/oldnewthing/20060407-25/?p=31613#comment-367813">
			April 7, 2006 at 7:56 pm</a>		</div>

		<p>People plan meanls?</p>

		
				</div>
		</li><!-- #comment-## -->
		<li class="comment even thread-even depth-1" id="comment-367823">
				<div id="div-comment-367823" class="comment-body">
				<div class="comment-author vcard">
						<cite class="fn">Gabe</cite> <span class="says">says:</span>		</div>
		
		<div class="comment-meta commentmetadata"><a href="https://blogs.msdn.microsoft.com/oldnewthing/20060407-25/?p=31613#comment-367823">
			April 8, 2006 at 12:24 am</a>		</div>

		<p>I should point out that typical files that Explorer opens to get the icon are EXE and ICO files. However, in theory any iconhandler can access the file to get its icon. For example, Photoshop could install an iconhandler that opens up PSD files to user their preview as an icon.</p>
<p>It would be nice if there was a &quot;fast mode&quot; in Explorer where it just acted like Fileman (i.e. ignoring icon handlers), so all operations would be fast.</p>
<p>Incidentally, it would be appropriate to mention that the reason NSS (native structured storage) never shipped is that it was horrible for use over the network. If a document had 10 streams in it, reading the file would have 10 round trips to open them, 10 round trips to read them, and 10 round trips to close them. When they&#8217;re all stored in one file like they are now, you would only have 1 round trip to open, 10 to read them, and 1 to close. This means NSS would only be useful on local files, but most of the users with complex docfiles (the ones that would benefit most from NSS) keep most of their document on file servers. It was a shame because the technology was so cool and lots of people spent lots of time on it, but it just didn&#8217;t provide any real benefit.</p>

		
				</div>
		</li><!-- #comment-## -->
		<li class="comment odd alt thread-odd thread-alt depth-1" id="comment-367833">
				<div id="div-comment-367833" class="comment-body">
				<div class="comment-author vcard">
						<cite class="fn">Chris Moorhouse</cite> <span class="says">says:</span>		</div>
		
		<div class="comment-meta commentmetadata"><a href="https://blogs.msdn.microsoft.com/oldnewthing/20060407-25/?p=31613#comment-367833">
			April 8, 2006 at 2:34 am</a>		</div>

		<p>&quot;By now, I&#8217;m kind of sick of it&#8230;&quot;</p>
<p>And the lousier suggestions, of course, although I note that your dribble-the-facts-out strategy has managed to filter out pretty much all the finger-pointing by this post. :D</p>
<p>Seriously, though, this was excellent. I know I got to sit down and figure out what &quot;should&quot; be done, and what I would probably &quot;would&quot; do, given my own business situation. My &quot;final draft&quot; was two pages of reasoning and balancing; even my own real code issues haven&#8217;t gotten me to analyse them that heavily.</p>
<p>More than what gets done about it, I&#8217;d like to know why, but for various reasons I kinda doubt that information will be available. At any rate, it&#8217;s been very entertaining and useful, and I hope you are willing to share other stuff in as mush depth as this.</p>
<p>As an aside, this is one of the first topics on which I&#8217;ve noticed your own post-post comments deal with the meat of the issue, rather than responding to some of the more pointless commentary (my own excluded). It&#8217;s nice, but it also seems to tell on you.</p>

		
				</div>
		</li><!-- #comment-## -->
		<li class="comment byuser comment-author-oldnewthing bypostauthor even thread-even depth-1" id="comment-367873">
				<div id="div-comment-367873" class="comment-body">
				<div class="comment-author vcard">
						<cite class="fn"><a href='https://social.msdn.microsoft.com/profile/Raymond+Chen+-+MSFT' rel='external nofollow' class='url'>Raymond Chen - MSFT</a></cite> <span class="says">says:</span>		</div>
		
		<div class="comment-meta commentmetadata"><a href="https://blogs.msdn.microsoft.com/oldnewthing/20060407-25/?p=31613#comment-367873">
			April 8, 2006 at 12:33 pm</a>		</div>

		<p>If I make a post-post comment, it&#8217;s always a brief one. The more substantial commentary I convert into new posts and toss into the queue.</p>

		
				</div>
		</li><!-- #comment-## -->
		<li class="comment odd alt thread-odd thread-alt depth-1" id="comment-367883">
				<div id="div-comment-367883" class="comment-body">
				<div class="comment-author vcard">
						<cite class="fn">Reinder</cite> <span class="says">says:</span>		</div>
		
		<div class="comment-meta commentmetadata"><a href="https://blogs.msdn.microsoft.com/oldnewthing/20060407-25/?p=31613#comment-367883">
			April 8, 2006 at 1:08 pm</a>		</div>

		<p>&quot;Running fiber through the center of the earth should increase performance by about 3.14 times.&quot;</p>
<p>Make that 1.5. I can see a physicist round π/2 to 2 (for large values of π, if you will), but not to 3, and certainly not to anything with two decimals that is larger than 3.<br /></p>

		
				</div>
		</li><!-- #comment-## -->
		<li class="comment even thread-even depth-1" id="comment-367893">
				<div id="div-comment-367893" class="comment-body">
				<div class="comment-author vcard">
						<cite class="fn">Iain</cite> <span class="says">says:</span>		</div>
		
		<div class="comment-meta commentmetadata"><a href="https://blogs.msdn.microsoft.com/oldnewthing/20060407-25/?p=31613#comment-367893">
			April 8, 2006 at 2:39 pm</a>		</div>

		<p>On the subject of Explorer and networks &#8211; I use Windows 2000 at work. If I&#8217;ve pointed explorer at a \UNCc$ address&#8230; and if I have the Folders pane open on the left&#8230;</p>
<p>Then Explorer merrily loads every server and workstation it can find in our whole domain into that explorer tree. This is tens of thousands of machines. !$*^!!</p>
<p>Does anyone know how to stop it doing this?</p>

		
				</div>
		</li><!-- #comment-## -->
		<li class="comment odd alt thread-odd thread-alt depth-1" id="comment-367923">
				<div id="div-comment-367923" class="comment-body">
				<div class="comment-author vcard">
						<cite class="fn"><a href='http://jaysonknight.com/blog' rel='external nofollow' class='url'>jayson knight</a></cite> <span class="says">says:</span>		</div>
		
		<div class="comment-meta commentmetadata"><a href="https://blogs.msdn.microsoft.com/oldnewthing/20060407-25/?p=31613#comment-367923">
			April 8, 2006 at 5:01 pm</a>		</div>

		<p>yeah, close the folders pane.</p>

		
				</div>
		</li><!-- #comment-## -->
		<li class="comment even thread-even depth-1" id="comment-367933">
				<div id="div-comment-367933" class="comment-body">
				<div class="comment-author vcard">
						<cite class="fn">__int128</cite> <span class="says">says:</span>		</div>
		
		<div class="comment-meta commentmetadata"><a href="https://blogs.msdn.microsoft.com/oldnewthing/20060407-25/?p=31613#comment-367933">
			April 8, 2006 at 5:18 pm</a>		</div>

		<p>I just got around to reading up on this whole slow-mode/fast-mode issue, and it might not even be relevant anymore, but I&#8217;m going to write my thoughts on it anyway.</p>
<p>1. Under no circumstance should Explorer prompt the user. It&#8217;s not the user&#8217;s problem.</p>
<p>2. Disabling fast-mode by default is a really, really, REALLY bad idea. You don&#8217;t disable features just because they predictably misbehave in 1 out of 100 cases. You implement workarounds for those scenarios.</p>
<p>3. My current main idea, which I don&#8217;t think has been invalidated, would be to upgrade the protocol to ask for version info as well (at least if it&#8217;s a Samba). If it&#8217;s a Samba and it doesn&#8217;t reply with a version string, then you go into slow mode. They&#8217;ll fix it and make it work. They shouldn&#8217;t have released untested code in the first place. If they have been able to implement the feature, they should have been able to test it right as well. Of course, extending the protocol like this might not be backward-compatible. You might choose to integrate the version information directly into the family id, such as Samba|3.0.22 instead of just Samba.</p>
<p>4. Another way of ensuring backward compatibility would be to always connect using fast-mode, but during the first FindFirstFile you would perform as many roundtrips as needed to determine whether you&#8217;re running on a buggy server. If it&#8217;s a buggy server, you just do it all again using slow-mode. All of this happens inside FindFirstFile(), before sending any information upstream.</p>
<p>I had a couple more ideas, but I think these two should cover it. I&#8217;ve become quite adept over time at thinking up ways of hacking code for compatibility reasons.</p>
<p>Under no circumstance should things break in new versions. The only change users will see will be your new code, and all the blame will fall on you, rather than on the 3rd parties.</p>

		
				</div>
		</li><!-- #comment-## -->
		<li class="comment odd alt thread-odd thread-alt depth-1" id="comment-367953">
				<div id="div-comment-367953" class="comment-body">
				<div class="comment-author vcard">
						<cite class="fn"><a href='http://samba.org/~jra' rel='external nofollow' class='url'>Jeremy Allison</a></cite> <span class="says">says:</span>		</div>
		
		<div class="comment-meta commentmetadata"><a href="https://blogs.msdn.microsoft.com/oldnewthing/20060407-25/?p=31613#comment-367953">
			April 8, 2006 at 8:44 pm</a>		</div>

		<p>Repost as no one noticed that last time I posted it :-).</p>
<p>FYI: This is the fix that tridge suggested to Raymond. No reason why this shouldn&#8217;t work &#8211; and be completely transparent to application code.</p>
<p>No reason to bother userspace code about it,<br />
<br />no reason for GUI changes or looking for<br />
<br />specific versions or detecting Samba as<br />
<br />opposed to any other server, no need to<br />
<br />keep things in &quot;slow&quot; mode now the bug<br />
<br />is fixed.</p>
<p>Jeremy</p>
<p>From tridge:</p>
<p>&quot;If we had run across the error you<br />
<br />described (INVALID_LEVEL from a continue)<br />
<br />then we would have added a bit flag on the<br />
<br />current connection structure to mark this<br />
<br />connection so it won&#8217;t use that level in<br />
<br />future, then repeat the search using a<br />
<br />different level. That means you would get<br />
<br />one useless search on the network with each<br />
<br />connection to a buggy server, but no impact<br />
<br />against non-buggy servers and no user observable<br />
<br />affects. The denial of service attack you<br />
<br />mention with this type of fix doesn&#8217;t happen<br />
<br />as the extra bit is per-connection, not long<br />
<br />lived (trying to remember long lived info<br />
<br />about specific servers is a losing game).&quot;</p>

		
				</div>
		</li><!-- #comment-## -->
		<li class="comment even thread-even depth-1" id="comment-367983">
				<div id="div-comment-367983" class="comment-body">
				<div class="comment-author vcard">
						<cite class="fn">Mark Steward</cite> <span class="says">says:</span>		</div>
		
		<div class="comment-meta commentmetadata"><a href="https://blogs.msdn.microsoft.com/oldnewthing/20060407-25/?p=31613#comment-367983">
			April 9, 2006 at 7:06 am</a>		</div>

		<p>Conscious that a lot of people are bored of this (and that I got it a bit wrong last time), I&#8217;ll try to keep this brief:</p>
<p>Tridge&#8217;s suggestion does have the race problem, but as mentioned, there&#8217;s a race condition with &gt; 100 files on Samba anyway.</p>
<p>Will the user blame the server if you just merge the queries and they see both names for a renamed file? &nbsp;Hopefully, although I know quite a few who would just blame Microsoft&#8217;s protocol. &nbsp;Perhaps you could show the error message iff the second query comes up with a different listing? &nbsp;Then everyone&#8217;s happy :-)<br /></p>

		
				</div>
		</li><!-- #comment-## -->
		<li class="comment byuser comment-author-larryosterman odd alt thread-odd thread-alt depth-1" id="comment-368003">
				<div id="div-comment-368003" class="comment-body">
				<div class="comment-author vcard">
						<cite class="fn"><a href='https://social.msdn.microsoft.com/profile/Larry+Osterman+%5BMSFT%5D' rel='external nofollow' class='url'>Larry Osterman [MSFT]</a></cite> <span class="says">says:</span>		</div>
		
		<div class="comment-meta commentmetadata"><a href="https://blogs.msdn.microsoft.com/oldnewthing/20060407-25/?p=31613#comment-368003">
			April 9, 2006 at 11:45 am</a>		</div>

		<p>Jeremy, reposting since you didn&#8217;t notice my response.</p>
<p>The fact that you fixed the problem quickly was noted in the original article. &nbsp; It is also completely and utterly irrelevant to Raymond&#8217;s post.</p>
<p>There are distributions out there that have the bug, and there are embedded devices (NAS boxes) that have the bug. &nbsp;That means that Microsoft needs to come up with a workaround for YOUR bug. &nbsp;Because you don&#8217;t have a mechanism in place to ensure that ALL the devices containing the buggy code are fixed (you depend on 3rd parties to pick up the fix ad-hoc), there is no way for Microsoft to ensure that all devices have the fix. &nbsp;</p>
<p>The consequences of NOT working around the fix are catastrophic (users will believe they lose data), and they will blame Vista for the problem, and not your code (they have no other way of knowing it&#8217;s your old bug, they installed vista and thousands of their files disappeared).</p>
<p>This is the hell of developing commercial solutions that are deployed to hundreds of millions of customers. &nbsp;You MUST fix all the bugs in the other guys products.</p>
<p>It&#8217;s WONDERFUL that you guys jumped on the bug and fixed it quickly. &nbsp;It would be even MORE wonderful if everybody who picked up the buggy code would fix their distribution.<br /></p>

		
				</div>
		</li><!-- #comment-## -->
		<li class="comment byuser comment-author-oldnewthing bypostauthor even thread-even depth-1" id="comment-368033">
				<div id="div-comment-368033" class="comment-body">
				<div class="comment-author vcard">
						<cite class="fn"><a href='https://social.msdn.microsoft.com/profile/Raymond+Chen+-+MSFT' rel='external nofollow' class='url'>Raymond Chen - MSFT</a></cite> <span class="says">says:</span>		</div>
		
		<div class="comment-meta commentmetadata"><a href="https://blogs.msdn.microsoft.com/oldnewthing/20060407-25/?p=31613#comment-368033">
			April 9, 2006 at 4:36 pm</a>		</div>

		<p>I guess I didn&#8217;t follow the solution. How does one &quot;repeat the search using a<br />
<br />different level&quot; without having to keep track of the items returned by the previous search and then doing merging/filtering?</p>

		
				</div>
		</li><!-- #comment-## -->
		<li class="comment odd alt thread-odd thread-alt depth-1" id="comment-368043">
				<div id="div-comment-368043" class="comment-body">
				<div class="comment-author vcard">
						<cite class="fn"><a href='http://samba.org/~jra' rel='external nofollow' class='url'>Jeremy Allison</a></cite> <span class="says">says:</span>		</div>
		
		<div class="comment-meta commentmetadata"><a href="https://blogs.msdn.microsoft.com/oldnewthing/20060407-25/?p=31613#comment-368043">
			April 9, 2006 at 6:38 pm</a>		</div>

		<p>You don&#8217;t keep track of the items returned by the previous search, you junk them. You just re-issue the search from scratch with a different info level and mark that server (in memory) as unable to use that info level.</p>
<p>The &quot;race condition&quot; complaint is bogus, as there are no consistency guarentees in the face of renames in SMB/CIFS anyway.</p>
<p>Jeremy.<br /></p>

		
				</div>
		</li><!-- #comment-## -->
		<li class="comment byuser comment-author-oldnewthing bypostauthor even thread-even depth-1" id="comment-368053">
				<div id="div-comment-368053" class="comment-body">
				<div class="comment-author vcard">
						<cite class="fn"><a href='https://social.msdn.microsoft.com/profile/Raymond+Chen+-+MSFT' rel='external nofollow' class='url'>Raymond Chen - MSFT</a></cite> <span class="says">says:</span>		</div>
		
		<div class="comment-meta commentmetadata"><a href="https://blogs.msdn.microsoft.com/oldnewthing/20060407-25/?p=31613#comment-368053">
			April 9, 2006 at 6:53 pm</a>		</div>

		<p>But how do you &quot;take back&quot; all the items you returned from the first request? The first call to NtQueryDirectoryFile succeeds; it&#8217;s the second call that fails. How do you go back and say, &quot;Oh, that first call that succeeded? Yeah, um, I&#8217;d like to change my mind. It actually failed, sorry.&quot;</p>

		
				</div>
		</li><!-- #comment-## -->
		<li class="comment odd alt thread-odd thread-alt depth-1" id="comment-368013">
				<div id="div-comment-368013" class="comment-body">
				<div class="comment-author vcard">
						<cite class="fn"><a href='http://samba.org/~jra' rel='external nofollow' class='url'>Jeremy Allison</a></cite> <span class="says">says:</span>		</div>
		
		<div class="comment-meta commentmetadata"><a href="https://blogs.msdn.microsoft.com/oldnewthing/20060407-25/?p=31613#comment-368013">
			April 9, 2006 at 4:28 pm</a>		</div>

		<p>You didn&#8217;t understand why I posted the response.</p>
<p>Yes, I understand all the above. I understand it&#8217;s irrelevent that the bug is now fixed. Microsoft must simply work around the buggy code out there. This isn&#8217;t a big deal, and is the kind of thing they have to do for older versions of their own software.</p>
<p>What I was showing was that working around this is *easy* and does not require any of the drastic responses that people have been posting in these forums. No need to detect version strings, show dialog boxes to users etc. Just a simple, low level, transparent workaround, which works without any issues for buggy and non-buggy code out there.</p>
<p>This is same kind of workaround we do all the time to deal with &#8216;differences&#8217; (some could say &#8216;bugs&#8217; on occasion) in Microsoft clients and the way they drive Samba as a server. This is the sort of thing that client and server vendors have to do every day, it&#8217;s called &quot;interoperability testing&quot; and if Microsoft bothered to turn up at the CIFS conference, or even at Connectathon then they&#8217;d find engineers from all the major server vendors ready and eager to help work through these issues to make life better for all our customers.</p>
<p>Rather than spending the money creating the nice-looking but ultimately irrelevent port 25 web site I&#8217;d like to see them use that cash to fund some travel for the client and server engineers so they can actually learn to play well with others in the industry. They&#8217;d be welcomed with open arms.</p>
<p>Jeremy.</p>

		
				</div>
		</li><!-- #comment-## -->
		<li class="comment even thread-even depth-1" id="comment-368023">
				<div id="div-comment-368023" class="comment-body">
				<div class="comment-author vcard">
						<cite class="fn"><a href='http://samba.org/~jra' rel='external nofollow' class='url'>Jeremy Allison</a></cite> <span class="says">says:</span>		</div>
		
		<div class="comment-meta commentmetadata"><a href="https://blogs.msdn.microsoft.com/oldnewthing/20060407-25/?p=31613#comment-368023">
			April 9, 2006 at 4:35 pm</a>		</div>

		<p>I missed this part, which is quite humorous :-)</p>
<p>LarryOsterman wrote : &quot;This is the hell of developing commercial solutions that are deployed to hundreds of millions of customers. &nbsp;You MUST fix all the bugs in the other guys products.&quot;</p>
<p>Tell me about it :-). Ok, we don&#8217;t deploy to *hundreds* of millions of customers, but we do deploy to *tens* of millions of customers.</p>
<p>Believe me that&#8217;s quite enough to have to fix all the bugs in the other guy&#8217;s products too :-). If Windows clients break with Samba, they don&#8217;t blame Windows, they blame Samba. Trust me on this &#8211; remember, because CIFS has no spec, whatever Windows clients do is considered &quot;right&quot;, and thus by definition if we don&#8217;t do the same we&#8217;re wrong. I have some *very* large customers who beat me with this every day :-) :-).</p>
<p>Jeremy.<br /></p>

		
				</div>
		</li><!-- #comment-## -->
		<li class="comment odd alt thread-odd thread-alt depth-1" id="comment-368093">
				<div id="div-comment-368093" class="comment-body">
				<div class="comment-author vcard">
						<cite class="fn">Gabe</cite> <span class="says">says:</span>		</div>
		
		<div class="comment-meta commentmetadata"><a href="https://blogs.msdn.microsoft.com/oldnewthing/20060407-25/?p=31613#comment-368093">
			April 10, 2006 at 1:11 am</a>		</div>

		<p>It sounds like tridge is suggesting just returning an error on the first enumeration from a slow server.</p>
<p>However, it does not sounds like this is necessary. I don&#8217;t see why the server can&#8217;t do this:</p>
<p>1. Issue FindFirst 128 files FAST command to server<br />
<br />2. Return first 128 files to calling program<br />
<br />3. Issue FindNext 128 files FAST command to server<br />
<br />4. If this works, return files as expected and ignore the rest of these steps; if this fails, close the FAST search and mark this server as buggy<br />
<br />5. Issue FindFirst 128 files SLOW command to server<br />
<br />6. Discard the results, assuming they will be the same as the previous 128 (they may not be, but Samba doesn&#8217;t guarantee consistency anyway)<br />
<br />7. Issue FindNext 128 files SLOW command to server<br />
<br />8. Return files to programs using SLOW mode from now on with this connection</p>

		
				</div>
		</li><!-- #comment-## -->
		<li class="comment even thread-even depth-1" id="comment-368113">
				<div id="div-comment-368113" class="comment-body">
				<div class="comment-author vcard">
						<cite class="fn">Mark Steward</cite> <span class="says">says:</span>		</div>
		
		<div class="comment-meta commentmetadata"><a href="https://blogs.msdn.microsoft.com/oldnewthing/20060407-25/?p=31613#comment-368113">
			April 10, 2006 at 4:17 am</a>		</div>

		<p>On the topic of roundtrips, does anyone have an opinion on requesting only one file in FindFirst, and counting the added roundtrip as a &quot;handshake&quot; for Fast mode (you&#8217;d be roundtripping for the ID in slow mode anyway)?</p>
<p>Is cutting out the roundtrip more important than accuracy in Explorer? &nbsp;Is there a way to cut out the roundtrip in future clients (without the hassle of a new dialect)? &nbsp;Is it a bit too hacky? &nbsp;Is it impossible (i.e. the protocol doesn&#8217;t allow it)?</p>
<p>Cheers,<br />
<br />Mark</p>

		
				</div>
		</li><!-- #comment-## -->
		<li class="comment odd alt thread-odd thread-alt depth-1" id="comment-368163">
				<div id="div-comment-368163" class="comment-body">
				<div class="comment-author vcard">
						<cite class="fn">Moi</cite> <span class="says">says:</span>		</div>
		
		<div class="comment-meta commentmetadata"><a href="https://blogs.msdn.microsoft.com/oldnewthing/20060407-25/?p=31613#comment-368163">
			April 10, 2006 at 8:44 am</a>		</div>

		<blockquote><p>
  SH_ITEM_ID</p>
<p>I&#8217;m glad I wasn&#8217;t the only one whose brain threw an exception when parsing SHITEMID :-)
</p></blockquote>

		
				</div>
		</li><!-- #comment-## -->
		<li class="comment even thread-even depth-1" id="comment-368293">
				<div id="div-comment-368293" class="comment-body">
				<div class="comment-author vcard">
						<cite class="fn">BryanK</cite> <span class="says">says:</span>		</div>
		
		<div class="comment-meta commentmetadata"><a href="https://blogs.msdn.microsoft.com/oldnewthing/20060407-25/?p=31613#comment-368293">
			April 10, 2006 at 11:25 am</a>		</div>

		<p>Raymond:</p>
<p>&gt; But how do you &quot;take back&quot; all the items you returned from the first request?</p>
<p>You don&#8217;t. &nbsp;You never return them to the client to begin with; you&#8217;re thinking at too high of a level. &nbsp;The fix must be done in the redirector. &nbsp;(Not the implementation of FindFirstFile or NtQueryDirectoryFile or whatever, the CIFS client code that decides which packets to send when.)</p>
<p>This client code sends one packet with a file-count of 1 (call it a &quot;fast-mode handshake&quot;, as Mark Steward said; I do like this idea), then sends another packet with a file-count of 100 (this is a good optimization of my original proposal, which was send a second packet with a size of 1). &nbsp;Do not return ANYTHING to the client until the response from the second packet comes back. &nbsp;If it&#8217;s an error, then restart in slow mode. &nbsp;If it&#8217;s not an error, then start returning the 101 results to the client.</p>
<p>As you said, slow mode costs 1 roundtrip per 100 results, plus 3 per file. &nbsp;Today, fast mode costs 1 roundtrip per 100 results (without the extra 3n roundtrips). &nbsp;With this change, fast mode would cost 1 roundtrip per 100 results, plus 1; the buggy Samba servers would cost 1 roundtrip per 100 results, plus 3 per file, plus 2. &nbsp;XP-style &quot;use slow mode all the time&quot; would be the same as it is today. &nbsp;Vista-style &quot;use fast mode all the time&quot; would be the same as it is today (faster, but inconsistent when looking at a Samba server with the bug).</p>
<p>These extra 1 or 2 roundtrips take time, yes (especially over a high-latency link). &nbsp;But compared to the latency introduced by the rest of the code (especially slow mode, which is what everyone&#8217;s used to today!), it&#8217;s tiny. &nbsp;Especially when there are large numbers of files and you&#8217;re using fast mode; the extra hanshake time is a constant cost, where the rest of the roundtrip times are all O(n).</p>
<p>But this post did explain something useful: The saved cost of fast mode is definitely significant.</p>

		
				</div>
		</li><!-- #comment-## -->
		<li class="comment byuser comment-author-oldnewthing bypostauthor odd alt thread-odd thread-alt depth-1" id="comment-368303">
				<div id="div-comment-368303" class="comment-body">
				<div class="comment-author vcard">
						<cite class="fn"><a href='https://social.msdn.microsoft.com/profile/Raymond+Chen+-+MSFT' rel='external nofollow' class='url'>Raymond Chen - MSFT</a></cite> <span class="says">says:</span>		</div>
		
		<div class="comment-meta commentmetadata"><a href="https://blogs.msdn.microsoft.com/oldnewthing/20060407-25/?p=31613#comment-368303">
			April 10, 2006 at 11:45 am</a>		</div>

		<p>BryanK: Yes, I understood this as your proposal. I was reacting to Jeremy/Andrew&#8217;s, since they claim &quot;no impact against non-buggy servers&quot; &#8211; but your proposal does have an impact on non-buggy servers (though a small one, namely one additional round-trip).</p>

		
				</div>
		</li><!-- #comment-## -->
		<li class="comment even thread-even depth-1" id="comment-368423">
				<div id="div-comment-368423" class="comment-body">
				<div class="comment-author vcard">
						<cite class="fn">Nekto2</cite> <span class="says">says:</span>		</div>
		
		<div class="comment-meta commentmetadata"><a href="https://blogs.msdn.microsoft.com/oldnewthing/20060407-25/?p=31613#comment-368423">
			April 10, 2006 at 1:34 pm</a>		</div>

		<p>Agreed to Gabe&#8217;s idea<br /></p>

		
				</div>
		</li><!-- #comment-## -->
		<li class="comment odd alt thread-odd thread-alt depth-1" id="comment-368483">
				<div id="div-comment-368483" class="comment-body">
				<div class="comment-author vcard">
						<cite class="fn"><a href='http://samba.org/~jra' rel='external nofollow' class='url'>Jeremy Allison</a></cite> <span class="says">says:</span>		</div>
		
		<div class="comment-meta commentmetadata"><a href="https://blogs.msdn.microsoft.com/oldnewthing/20060407-25/?p=31613#comment-368483">
			April 10, 2006 at 6:30 pm</a>		</div>

		<p>Raymond,</p>
<p>&gt; But how do you &quot;take back&quot; all the items you returned from the first request?</p>
<p>BryanK is correct. You don&#8217;t take them back. You&#8217;re thinking too high a level. Calls like &nbsp;NtQueryDirectoryFile should mean nothing to the &nbsp;redirector &#8211; it&#8217;s just told to fetch directory contents &nbsp;when going through the underlying Windows VFS layer. What the client API&#8217;s ask for is irrelevent &#8211; so there&#8217;s nothing to take back &#8211; the call hasn&#8217;t returned to the client application yet.</p>
<p>Whenever you get a &quot;scan this directory for this pattern&quot; at the redirector level you just issue at least two calls &#8211; the findfirst and findnext. This readahead will let you know if you&#8217;re talking to a server with a bug here, and allow you to redo the query with a different level if not.</p>
<p>Jeremy.<br /></p>

		
				</div>
		</li><!-- #comment-## -->
		<li class="comment byuser comment-author-oldnewthing bypostauthor even thread-even depth-1" id="comment-368493">
				<div id="div-comment-368493" class="comment-body">
				<div class="comment-author vcard">
						<cite class="fn"><a href='https://social.msdn.microsoft.com/profile/Raymond+Chen+-+MSFT' rel='external nofollow' class='url'>Raymond Chen - MSFT</a></cite> <span class="says">says:</span>		</div>
		
		<div class="comment-meta commentmetadata"><a href="https://blogs.msdn.microsoft.com/oldnewthing/20060407-25/?p=31613#comment-368493">
			April 10, 2006 at 6:40 pm</a>		</div>

		<p>In which case I don&#8217;t get it. If the error comes back on the continuation request, why does it fail at the 129th file instead of the 2nd?</p>

		
				</div>
		</li><!-- #comment-## -->
		<li class="comment odd alt thread-odd thread-alt depth-1" id="comment-368503">
				<div id="div-comment-368503" class="comment-body">
				<div class="comment-author vcard">
						<cite class="fn"><a href='http://samba.org/~jra' rel='external nofollow' class='url'>Jeremy Allison</a></cite> <span class="says">says:</span>		</div>
		
		<div class="comment-meta commentmetadata"><a href="https://blogs.msdn.microsoft.com/oldnewthing/20060407-25/?p=31613#comment-368503">
			April 10, 2006 at 7:15 pm</a>		</div>

		<p>The continuation request is a different network protocol requst number (SMBfindnext) than the first (SMBfindfirst). The bug lies in the two missing lines in the switch statement. So the Samba SMBfindfirst code handles the new info level correctly, the Samba SMBfindnext code returns NT_STATUS_INVALID_INFO_LEVEL instead (at least the buggy versions do).</p>
<p>So at the redirector level you always issue a SMBfindfirst call followed by a SMBfindnext with the new info level. If you get back correct results then great &#8211; not a buggy server, just cache the values returned and prepare to return them up through the VFS later. If you get back NT_STATUS_INVALID_INFO_LEVEL atfter the SMBfindnext request you just junk both replies and re-issue an SMBfindfirst and SMBfindnext with lower info level (possibly then doing another SMBfindfirst/SMBfindnext pair to get the extra info you would have got first time from a non-buggy server). Then you mark that connection as &quot;buggy&quot; and make sure you never issue the new info level on that connection again as long as it exists.</p>
<p>You never give anything back to the VFS until this is finished &#8211; it&#8217;ll all batched and asynchronous anyway, so this has no impact on non-buggy servers and only two extra round trips on buggy servers.</p>
<p>Jeremy<br /></p>

		
				</div>
		</li><!-- #comment-## -->
		<li class="comment byuser comment-author-oldnewthing bypostauthor even thread-even depth-1" id="comment-368513">
				<div id="div-comment-368513" class="comment-body">
				<div class="comment-author vcard">
						<cite class="fn"><a href='https://social.msdn.microsoft.com/profile/Raymond+Chen+-+MSFT' rel='external nofollow' class='url'>Raymond Chen - MSFT</a></cite> <span class="says">says:</span>		</div>
		
		<div class="comment-meta commentmetadata"><a href="https://blogs.msdn.microsoft.com/oldnewthing/20060407-25/?p=31613#comment-368513">
			April 10, 2006 at 7:23 pm</a>		</div>

		<p>Okay, I see. Of course, there is additional virtualization work needed to regurgitate the cached values correctly. (The client&#8217;s second call to NtQueryDirectoryFile might passes a different sized buffer from the speculative request.)<br /></p>

		
				</div>
		</li><!-- #comment-## -->
		<li class="comment byuser comment-author-oldnewthing bypostauthor odd alt thread-odd thread-alt depth-1" id="comment-368543">
				<div id="div-comment-368543" class="comment-body">
				<div class="comment-author vcard">
						<cite class="fn"><a href='https://social.msdn.microsoft.com/profile/Raymond+Chen+-+MSFT' rel='external nofollow' class='url'>Raymond Chen - MSFT</a></cite> <span class="says">says:</span>		</div>
		
		<div class="comment-meta commentmetadata"><a href="https://blogs.msdn.microsoft.com/oldnewthing/20060407-25/?p=31613#comment-368543">
			April 10, 2006 at 7:44 pm</a>		</div>

		<p>(However I don&#8217;t understand why the problem shows up on the 129th query if the wire protocol is &quot;one file at a time&quot;.)</p>

		
				</div>
		</li><!-- #comment-## -->
		<li class="comment even thread-even depth-1" id="comment-368393">
				<div id="div-comment-368393" class="comment-body">
				<div class="comment-author vcard">
						<cite class="fn">BryanK</cite> <span class="says">says:</span>		</div>
		
		<div class="comment-meta commentmetadata"><a href="https://blogs.msdn.microsoft.com/oldnewthing/20060407-25/?p=31613#comment-368393">
			April 10, 2006 at 1:15 pm</a>		</div>

		<p>Ah, OK, I get it. &nbsp;I hope. &nbsp;;-)</p>
<p>It may be worthwhile to do what Gabe has said, which sounds like it was built on Andrew&#8217;s fix (throw away the first 128 results from the *new* query when you requery in slow mode after seeing the error). &nbsp;My hack is still faster than slow mode today &#8212; at least as far as Explorer is concerned &#8212; although it doesn&#8217;t really gain anything in terms of consistency. &nbsp;This hack would be even faster, at the expense of &#8230; well, nothing that I can see at the moment.</p>
<p>In any mode, the results might be inconsistent between two 128-file queries anyway, because CIFS doesn&#8217;t guarantee consistency (or at least, I don&#8217;t see how it could, short of a shadow copy on the server). &nbsp;The same problem exists today; what happens if a file is changed between the first 128-file query and the second?</p>

		
				</div>
		</li><!-- #comment-## -->
		<li class="comment odd alt thread-odd thread-alt depth-1" id="comment-368593">
				<div id="div-comment-368593" class="comment-body">
				<div class="comment-author vcard">
						<cite class="fn"><a href='http://samba.org/~jra' rel='external nofollow' class='url'>Jeremy Allison</a></cite> <span class="says">says:</span>		</div>
		
		<div class="comment-meta commentmetadata"><a href="https://blogs.msdn.microsoft.com/oldnewthing/20060407-25/?p=31613#comment-368593">
			April 11, 2006 at 1:09 am</a>		</div>

		<p>No the wire protocol isn&#8217;t one file at a time. It&#8217;s one &quot;block&quot; of files at a time, where &quot;block&quot; is a maximum number of returns that will fit into the allowed buffer. The latancies would be horrible if it were one file at a time.</p>
<p>Jeremy.</p>

		
				</div>
		</li><!-- #comment-## -->
		<li class="comment byuser comment-author-oldnewthing bypostauthor even thread-even depth-1" id="comment-368603">
				<div id="div-comment-368603" class="comment-body">
				<div class="comment-author vcard">
						<cite class="fn"><a href='https://social.msdn.microsoft.com/profile/Raymond+Chen+-+MSFT' rel='external nofollow' class='url'>Raymond Chen - MSFT</a></cite> <span class="says">says:</span>		</div>
		
		<div class="comment-meta commentmetadata"><a href="https://blogs.msdn.microsoft.com/oldnewthing/20060407-25/?p=31613#comment-368603">
			April 11, 2006 at 1:28 am</a>		</div>

		<p>In which case there will need to be virtualization.</p>
<p>App says &quot;Please give me 4KB of results.&quot;</p>
<p>Client sends to server &quot;please give me 4KB of results the fast way&quot; followed by &quot;please give me another 4KB of results&quot; to see if an error occurs.</p>
<p>If an error occurs, then the client switches to slow mode.</p>
<p>If no error occurs, then the client returns the result of the first 4KB query to the application, and saves the second 4KB for later.</p>
<p>The application now submits a 2KB query. The client has to hand back 2KB of results and save the other 2KB for next time. (Or if the application submits an 8KB request, the client has to hand back the 4KB result and then issue another 4KB query to fill the second half of the buffer.)<br /></p>

		
				</div>
		</li><!-- #comment-## -->
		<li class="comment odd alt thread-odd thread-alt depth-1" id="comment-368703">
				<div id="div-comment-368703" class="comment-body">
				<div class="comment-author vcard">
						<cite class="fn"><a href='http://samba.org/~jra' rel='external nofollow' class='url'>Jeremy Allison</a></cite> <span class="says">says:</span>		</div>
		
		<div class="comment-meta commentmetadata"><a href="https://blogs.msdn.microsoft.com/oldnewthing/20060407-25/?p=31613#comment-368703">
			April 11, 2006 at 11:56 am</a>		</div>

		<p>Of couse. That&#8217;s how network redirectors work. Application requests don&#8217;t drive the network redirector directly &#8211; they cause the redirector to do things on the application&#8217;s behalf &#8211; but the redirector is in charge of how these things are done.</p>
<p>Redirectors must already batch calls together to improve performance. I don&#8217;t understand why you&#8217;re having a problem with this &#8211; it&#8217;s standard network programming.</p>
<p>It&#8217;s like using fopen()/fread()/fwrite() at the application level instead of open()/read()/write(). I know Microsoft programming guides seem to prefer people to use the system calls (possibly in order to tie people to Windows and not use portable constructs) but the performance will be massively improved if aggregating calls are used.</p>
<p>Jeremy.<br /></p>

		
				</div>
		</li><!-- #comment-## -->
		<li class="comment byuser comment-author-oldnewthing bypostauthor even thread-even depth-1" id="comment-368713">
				<div id="div-comment-368713" class="comment-body">
				<div class="comment-author vcard">
						<cite class="fn"><a href='https://social.msdn.microsoft.com/profile/Raymond+Chen+-+MSFT' rel='external nofollow' class='url'>Raymond Chen - MSFT</a></cite> <span class="says">says:</span>		</div>
		
		<div class="comment-meta commentmetadata"><a href="https://blogs.msdn.microsoft.com/oldnewthing/20060407-25/?p=31613#comment-368713">
			April 11, 2006 at 12:07 pm</a>		</div>

		<p>I can see batching happening for common operations like reading and writing, but lower-level things like locking and &quot;reading the contents of a directory directly&quot; I assumed were more pass-through.</p>

		
				</div>
		</li><!-- #comment-## -->
		<li class="comment odd alt thread-odd thread-alt depth-1" id="comment-368753">
				<div id="div-comment-368753" class="comment-body">
				<div class="comment-author vcard">
						<cite class="fn">DeepICE2</cite> <span class="says">says:</span>		</div>
		
		<div class="comment-meta commentmetadata"><a href="https://blogs.msdn.microsoft.com/oldnewthing/20060407-25/?p=31613#comment-368753">
			April 11, 2006 at 1:06 pm</a>		</div>

		<p>&quot;I know Microsoft programming guides seem to prefer people to use the system calls (possibly in order to tie people to Windows and not use portable constructs) but the performance will be massively improved if aggregating calls are used.&quot;</p>
<p>I think I now understand why microsoft does not send developers to the samba confrences &#8211; Who would want to go when the samba guys profess such &quot;Evil M$&quot; attitudes<br /></p>

		
				</div>
		</li><!-- #comment-## -->
		<li class="comment even thread-even depth-1" id="comment-368773">
				<div id="div-comment-368773" class="comment-body">
				<div class="comment-author vcard">
						<cite class="fn">BryanK</cite> <span class="says">says:</span>		</div>
		
		<div class="comment-meta commentmetadata"><a href="https://blogs.msdn.microsoft.com/oldnewthing/20060407-25/?p=31613#comment-368773">
			April 11, 2006 at 1:47 pm</a>		</div>

		<p>Locking, yes, that would (probably) have to be close to pass-through. &nbsp;IIRC, that&#8217;s the reason that NFSv2 systems have issues with locking; because various operations (including locking) can be batched at the client.</p>
<p>But why would reading the contents of a directory have to be pass-through? &nbsp;I&#8217;m coming from the Unix &quot;everything is a file&quot; mindset, but isn&#8217;t a directory just a special type of file, whose contents are all the filenames in that directory? &nbsp;(Along with a pointer to where each file&#8217;s info is stored on the disk, of course.) &nbsp;If that&#8217;s true, then there&#8217;s really no reason to have any kind of difference (in the redirector anyway) between enumerating a directory and reading from a file.</p>
<p>But maybe I&#8217;m assuming too much of a &quot;sane&quot; implementation of a directory in NTFS/FAT. &nbsp;:-P &nbsp;I know I&#8217;ve been assuming a bunch of things about the redirector&#8217;s operation throughout much of this topic (most importantly, that the redirector is what does the &quot;batching&quot;, and it just returns results to the implementation of NtQueryDirectoryFile out of its local cache when possible), and those assumptions may be false.</p>

		
				</div>
		</li><!-- #comment-## -->
		<li class="comment byuser comment-author-oldnewthing bypostauthor odd alt thread-odd thread-alt depth-1" id="comment-368783">
				<div id="div-comment-368783" class="comment-body">
				<div class="comment-author vcard">
						<cite class="fn"><a href='https://social.msdn.microsoft.com/profile/Raymond+Chen+-+MSFT' rel='external nofollow' class='url'>Raymond Chen - MSFT</a></cite> <span class="says">says:</span>		</div>
		
		<div class="comment-meta commentmetadata"><a href="https://blogs.msdn.microsoft.com/oldnewthing/20060407-25/?p=31613#comment-368783">
			April 11, 2006 at 1:53 pm</a>		</div>

		<p>My thought was that the batching happened at layer above the redirector (but below the application). Otherwise, every redirector would have to reimplement all the batching logic.</p>

		
				</div>
		</li><!-- #comment-## -->
		<li class="comment even thread-even depth-1" id="comment-368853">
				<div id="div-comment-368853" class="comment-body">
				<div class="comment-author vcard">
						<cite class="fn">BryanK</cite> <span class="says">says:</span>		</div>
		
		<div class="comment-meta commentmetadata"><a href="https://blogs.msdn.microsoft.com/oldnewthing/20060407-25/?p=31613#comment-368853">
			April 11, 2006 at 4:16 pm</a>		</div>

		<p>Raymond:</p>
<p>&gt; Otherwise, every redirector would have to reimplement all the batching logic.</p>
<p>What I understand about redirectors makes me think that this is really where the batching should be done anyway, regardless of the duplication. &nbsp;I am assuming that there&#8217;s one (and only one) redirector for CIFS, one for the local hard drive(s) (if one is needed for them), one for Exchange&#8217;s &quot;M drive&quot; (a view into the Jet database where Exchange keeps all the emails for every user), and one for any other required non-NTFS/non-FAT entity that wants to look like a filesystem. &nbsp;(For example: WebDAV, NFS, etc., etc.)</p>
<p>The optimal batching rules for all these could potentially be different (especially Exchange). &nbsp;The difference in requirements for the cases is what made me think that the redirector is what did the batching. &nbsp;Though I don&#8217;t know for sure.</p>
<p>It probably is a decent-sized chunk of duplicated code, yes, but if some virtualized FSes need it and others don&#8217;t, then having it happen for all FSes may not be a good idea.</p>

		
				</div>
		</li><!-- #comment-## -->
		<li class="comment odd alt thread-odd thread-alt depth-1" id="comment-368843">
				<div id="div-comment-368843" class="comment-body">
				<div class="comment-author vcard">
						<cite class="fn"><a href='http://samba.org/~jra' rel='external nofollow' class='url'>Jeremy Allison</a></cite> <span class="says">says:</span>		</div>
		
		<div class="comment-meta commentmetadata"><a href="https://blogs.msdn.microsoft.com/oldnewthing/20060407-25/?p=31613#comment-368843">
			April 11, 2006 at 3:23 pm</a>		</div>

		<p>DeepICE2 wrote : </p>
<p>&quot;I think I now understand why microsoft does not send developers to the samba confrences &#8211; Who would want to go when the samba guys profess such &quot;Evil M$&quot; attitudes&quot;</p>
<p>Don&#8217;t be silly, and stop using such childish abbreviations. The CIFS conference was a Microsoft *initiated* conference. It used to be held every year in Redmond (it&#8217;s a lot more convenient to me now it&#8217;s here in Santa Clara though :-). Connectathon is a Sun sponosored conference (but is attended by IBM, HP, NetApp, EMC &#8211; all Sun competitors). Microsoft would be very welcome at both of these events.</p>
<p>I wish Microsoft pushed people towards more standards-based API&#8217;s that&#8217;s all (gssapi rather than sspi etc.). There are *reasons* for these standards you know. Some Windows apps have *horrible* network performance because of the &quot;use system calls they&#8217;re faster&quot; mentality.</p>
<p>Jeremy.<br /></p>

		
				</div>
		</li><!-- #comment-## -->
		<li class="comment even thread-even depth-1" id="comment-369013">
				<div id="div-comment-369013" class="comment-body">
				<div class="comment-author vcard">
						<cite class="fn"><a href='http://www.clan-senescence.com' rel='external nofollow' class='url'>Ivan Cronyn</a></cite> <span class="says">says:</span>		</div>
		
		<div class="comment-meta commentmetadata"><a href="https://blogs.msdn.microsoft.com/oldnewthing/20060407-25/?p=31613#comment-369013">
			April 12, 2006 at 7:24 am</a>		</div>

		<p>I wish there was more stuff out there on dealing with high-latency scenarios. In my office environment (with a 100Mb/s connection between NYC and London, UK) we&#8217;ve had to implement Tacit (<a rel="nofollow" target="_new" href="http://www.tacitnetworks.com/" rel="nofollow">http://www.tacitnetworks.com/</a>) to get acceptable file-browsing and are still battling with SQL Server.</p>
<p>Does anyone know how to get SQL Server to stop waiting for acknowledgements after sending TDS data blocks? We&#8217;re currently maxing out at 80KB/s on our line, with the possibility of increasing performance 4x if we try messing with the &quot;network packet size&quot; settings on client and server, but this will still not be good enough and may cause instability.</p>
<p>Surely TDS isn&#8217;t a worse protocol than FTP, where we see bursting all the way up to our 100Mb/s capacity?</p>

		
				</div>
		</li><!-- #comment-## -->
		<li class="comment odd alt thread-odd thread-alt depth-1" id="comment-369183">
				<div id="div-comment-369183" class="comment-body">
				<div class="comment-author vcard">
						<cite class="fn">BryanK</cite> <span class="says">says:</span>		</div>
		
		<div class="comment-meta commentmetadata"><a href="https://blogs.msdn.microsoft.com/oldnewthing/20060407-25/?p=31613#comment-369183">
			April 12, 2006 at 12:55 pm</a>		</div>

		<p>Well, I doubt that FTP requires any kind of handshaking above what TCP already provides. &nbsp;(The data connection is only open for one file; each new file transferred gets its own data connection.) &nbsp;If that&#8217;s true, then it would only be possible to provide performance that&#8217;s similar to FTP if the TDS protocol also didn&#8217;t require any higher-level synchronization.</p>
<p>But it sounds like it does require more synchronization, since it&#8217;s waiting for something. &nbsp;Maybe there are reasons for this requirement, I&#8217;m not sure (I&#8217;d guess that if there are, they have to do with data consistency). &nbsp;But whether there are reasons or not, it won&#8217;t work like FTP if the protocol requires more synchronization.</p>

		
				</div>
		</li><!-- #comment-## -->
		<li class="comment even thread-even depth-1" id="comment-369443">
				<div id="div-comment-369443" class="comment-body">
				<div class="comment-author vcard">
						<cite class="fn"><a href='http://www.zettaserve.com' rel='external nofollow' class='url'>Troy Phillips</a></cite> <span class="says">says:</span>		</div>
		
		<div class="comment-meta commentmetadata"><a href="https://blogs.msdn.microsoft.com/oldnewthing/20060407-25/?p=31613#comment-369443">
			April 12, 2006 at 11:44 pm</a>		</div>

		<p>I am definately glad to hear that some work is being done on Windows Explorer for Vista with regard to WAN performance. I have done demonstrations for WAN accelerators (Riverbed Steelheads) and Windows Explorer for XP really is the poster child for applications that barf bigtime on a high latency connection. As a matter of fact, I always wondered why MS didn&#8217;t just buy Riverbed to incorporate some of their stuff into Windows?</p>
<p>On a separate note, now that Samba is widespread enough for Samba&lt;-&gt;Windows interoperability issues to matter to MS, then does that mean that maybe it is time for MS to share full documentation on the network interface with Samba? I may be wrong, but I assumed that they were still working out the interface by reverse engineering etc, which surely is more likely to lead to issues like this. Obviously MS has no reason to be overly charitable, but based on this sort of issue, it sounds like it is/will be in MS best interest. Probably look good to the European&#8217;s too :)</p>
<p>ps: Raymond, I am glad you have a thick skin &#8211; as a highly visible blogger within the shell team you definately cop alot of abuse on behalf of MS and Windows that you don&#8217;t deserve. Keep up the great work.</p>

		
				</div>
		</li><!-- #comment-## -->
		<li class="comment odd alt thread-odd thread-alt depth-1" id="comment-370023">
				<div id="div-comment-370023" class="comment-body">
				<div class="comment-author vcard">
						<cite class="fn">Neil</cite> <span class="says">says:</span>		</div>
		
		<div class="comment-meta commentmetadata"><a href="https://blogs.msdn.microsoft.com/oldnewthing/20060407-25/?p=31613#comment-370023">
			April 14, 2006 at 3:11 pm</a>		</div>

		<p>&quot;It&#8217;s like using fopen()/fread()/fwrite() at the application level instead of open()/read()/write(). I know Microsoft programming guides seem to prefer people to use the system calls (possibly in order to tie people to Windows and not use portable constructs) but the performance will be massively improved if aggregating calls are used.&quot;</p>
<p>In my possibly limited experience there was only one case when stdio was faster, and that was in certain Windows 3.1 configurations when all the network I/O went through the real mode redirector so that each read required a transition in and out of real mode. Unfortunately for me the compiler I was using only supported 20 stdio handles and I needed 65.</p>

		
				</div>
		</li><!-- #comment-## -->
		<li class="comment even thread-even depth-1" id="comment-370133">
				<div id="div-comment-370133" class="comment-body">
				<div class="comment-author vcard">
						<cite class="fn">Cutting corners of a circle</cite> <span class="says">says:</span>		</div>
		
		<div class="comment-meta commentmetadata"><a href="https://blogs.msdn.microsoft.com/oldnewthing/20060407-25/?p=31613#comment-370133">
			April 16, 2006 at 3:55 pm</a>		</div>

		<p>If by &quot;halfway around the world&quot; you mean the other side of the Earth, then the <em>theoretical</em> minimum latency is closer to 42ms rather than 66ms :)</p>

		
				</div>
		</li><!-- #comment-## -->
		<li class="comment odd alt thread-odd thread-alt depth-1" id="comment-370173">
				<div id="div-comment-370173" class="comment-body">
				<div class="comment-author vcard">
						<cite class="fn">BryanK</cite> <span class="says">says:</span>		</div>
		
		<div class="comment-meta commentmetadata"><a href="https://blogs.msdn.microsoft.com/oldnewthing/20060407-25/?p=31613#comment-370173">
			April 17, 2006 at 8:31 am</a>		</div>

		<p>Neil: Maybe you didn&#8217;t notice non-stdio calls being slower, but I would bet that they were.</p>
<p>stdio buffers everything. &nbsp;Reading from memory is *always* faster than reading from either disk or network. &nbsp;Therefore, reading from a buffer is going to be faster than reading from the network or the disk.</p>

		
				</div>
		</li><!-- #comment-## -->
		<li class="comment even thread-even depth-1" id="comment-370733">
				<div id="div-comment-370733" class="comment-body">
				<div class="comment-author vcard">
						<cite class="fn">Steve Loughran</cite> <span class="says">says:</span>		</div>
		
		<div class="comment-meta commentmetadata"><a href="https://blogs.msdn.microsoft.com/oldnewthing/20060407-25/?p=31613#comment-370733">
			April 17, 2006 at 4:54 pm</a>		</div>

		<p>I&#8217;m fed up with blaming Samba, and dont think there is a good solution.</p>
<p>But I think raymond is missing something when he says that enterprise users are complaining about how long explorer takes, so the solution should be to do queries in bulk. </p>
<p>My issues are not just that things take ages, but that explorer hangs for a minute when trying to talk to a share from a PC on the lan that is switched off. And it hangs for a minute &nbsp;if you mount a fully qualified host at work (\host1.example.orgc$) and then, outside the firewall, that hostname still resolves. It just plain sucks. What is wrong with doing stuff in a separate thread?</p>

		
				</div>
		</li><!-- #comment-## -->
		<li class="comment odd alt thread-odd thread-alt depth-1" id="comment-378203">
				<div id="div-comment-378203" class="comment-body">
				<div class="comment-author vcard">
						<cite class="fn"><a href='http://blogs.msdn.com/larryosterman/archive/2006/05/08/592763.aspx' rel='external nofollow' class='url'>Larry Osterman's WebLog</a></cite> <span class="says">says:</span>		</div>
		
		<div class="comment-meta commentmetadata"><a href="https://blogs.msdn.microsoft.com/oldnewthing/20060407-25/?p=31613#comment-378203">
			May 8, 2006 at 7:01 pm</a>		</div>

		<p>I keep on doing this, clearly it&#8217;s evidence of a lack of imagination on my part&#8230;<br />
<br />Raymond&#8217;s post a&#8230;</p>

		
				</div>
		</li><!-- #comment-## -->
		<li class="comment even thread-even depth-1" id="comment-427503">
				<div id="div-comment-427503" class="comment-body">
				<div class="comment-author vcard">
						<cite class="fn"><a href='http://blogs.msdn.com/oldnewthing/archive/2006/10/03/785925.aspx' rel='external nofollow' class='url'>The Old New Thing</a></cite> <span class="says">says:</span>		</div>
		
		<div class="comment-meta commentmetadata"><a href="https://blogs.msdn.microsoft.com/oldnewthing/20060407-25/?p=31613#comment-427503">
			October 5, 2006 at 2:13 am</a>		</div>

		<p>So you can write on them.</p>

		
				</div>
		</li><!-- #comment-## -->
		</ol><!-- .comment-list -->

		<div class="navigation pagination">
					</div>

	
			<p class="no-comments">Comments are closed.</p>
<!-- COMMENTS END -->
</div></td></tr></table>