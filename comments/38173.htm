<table class="commenttable" cellspacing="0" cellpadding="0"><tr><td><div class="commentdiv"><div class="commentdivhdr">
<!-- COMMENTS START -->
Comments (17)	</div>

	
			<div class="navigation pagination clear-both">
					</div>

		<ol class="comment-list">
					<li class="comment even thread-even depth-1" id="comment-203143">
				<div id="div-comment-203143" class="comment-body">
				<div class="comment-author vcard">
						<cite class="fn">Yann</cite> <span class="says">says:</span>		</div>
		
		<div class="comment-meta commentmetadata"><a href="https://blogs.msdn.microsoft.com/oldnewthing/20040813-00/?p=38173#comment-203143">
			August 13, 2004 at 7:31 am</a>		</div>

		<p>Today is a black day. I only discovered this weblog a few weeks ago. Then I went on holiday. Since I&#8217;m back, I&#8217;ve been reading all entries and all comments. Now I&#8217;m competely up-to-date. That means that I have to wait until 7AM everyday for a new entry of Raymond. I&#8217;m a bit sad&#8230;<br /></p>

		
				</div>
		</li><!-- #comment-## -->
		<li class="comment odd alt thread-odd thread-alt depth-1" id="comment-203153">
				<div id="div-comment-203153" class="comment-body">
				<div class="comment-author vcard">
						<cite class="fn">John Bergman</cite> <span class="says">says:</span>		</div>
		
		<div class="comment-meta commentmetadata"><a href="https://blogs.msdn.microsoft.com/oldnewthing/20040813-00/?p=38173#comment-203153">
			August 13, 2004 at 7:42 am</a>		</div>

		<p>Is this also true for Exchange 2003?  I hunted around on Microsoft&#8217;s support site and could not find any indication that the /3GB is required to improve performance there.</p>

		
				</div>
		</li><!-- #comment-## -->
		<li class="comment even thread-even depth-1" id="comment-203163">
				<div id="div-comment-203163" class="comment-body">
				<div class="comment-author vcard">
						<cite class="fn">Miles Archer</cite> <span class="says">says:</span>		</div>
		
		<div class="comment-meta commentmetadata"><a href="https://blogs.msdn.microsoft.com/oldnewthing/20040813-00/?p=38173#comment-203163">
			August 13, 2004 at 8:17 am</a>		</div>

		<p>Now I&#8217;m really confused. I thought I understood address space/virtual memory and the 3G switch.</p>
<p>Are you saying that Exchange doesn&#8217;t use the full 2GB of virtual memory if there is less than 1GB of real memory? </p>
<p>Or is it that Exchange gets the full virtual address space, but Windows doesn&#8217;t allow it to get more than 1GB of real memory. If so, why is that. Is it something special about Exchange?</p>

		
				</div>
		</li><!-- #comment-## -->
		<li class="comment odd alt thread-odd thread-alt depth-1" id="comment-203173">
				<div id="div-comment-203173" class="comment-body">
				<div class="comment-author vcard">
						<cite class="fn"><a href='http://weblogs.asp.net/larryosterman' rel='external nofollow' class='url'>Larry Osterman</a></cite> <span class="says">says:</span>		</div>
		
		<div class="comment-meta commentmetadata"><a href="https://blogs.msdn.microsoft.com/oldnewthing/20040813-00/?p=38173#comment-203173">
			August 13, 2004 at 8:25 am</a>		</div>

		<p>I agree with Miles.  Are you sure it&#8217;s recommending /3G with more than 1G of RAM?  It would seem to me that the recommendation should kick in with more than 2G of RAM.</p>

		
				</div>
		</li><!-- #comment-## -->
		<li class="comment even thread-even depth-1" id="comment-203203">
				<div id="div-comment-203203" class="comment-body">
				<div class="comment-author vcard">
						<cite class="fn">Marc</cite> <span class="says">says:</span>		</div>
		
		<div class="comment-meta commentmetadata"><a href="https://blogs.msdn.microsoft.com/oldnewthing/20040813-00/?p=38173#comment-203203">
			August 15, 2004 at 1:17 am</a>		</div>

		<p>Though the article mentiones in Raymond&#8217;s entry states the 3Gb swicht can be used on Advanced Server only because of fragmentation on Win 2000 server and alike.</p>
<p>How comes? What makes the OS behave in a different way?</p>

		
				</div>
		</li><!-- #comment-## -->
		<li class="comment odd alt thread-odd thread-alt depth-1" id="comment-203193">
				<div id="div-comment-203193" class="comment-body">
				<div class="comment-author vcard">
						<cite class="fn"><a href='http://weblogs.asp.net/oldnewthing/' rel='external nofollow' class='url'>Raymond Chen</a></cite> <span class="says">says:</span>		</div>
		
		<div class="comment-meta commentmetadata"><a href="https://blogs.msdn.microsoft.com/oldnewthing/20040813-00/?p=38173#comment-203193">
			August 14, 2004 at 11:48 pm</a>		</div>

		<p>Aw come on guys; now you&#8217;re not even trying. You&#8217;re making mistakes even more basic than the ones I&#8217;m trying to demystify. </p>
<p>1. There are things in your address space aside from data. (You may have heard of &quot;code&quot;.)<br />
<br />2. Just because it&#8217;s in your address space doesn&#8217;t mean it needs RAM. (&quot;Working set&quot;)<br />
<br />3. Address space allocation granularity is 64K. (&quot;Fragmentation&quot;.) </p>
<p>COMPLETELY MAKING UP NUMBERS: Suppose that in order to support n users, store.exe needs 512MB+n*64K of address space and 256MB+n*8K of RAM. So if you have 24000 users, that means you need 1.96GB of address space and 700MB of RAM. If you add 1GB, the extra 300MB doesn&#8217;t help you increase &quot;n&quot; because you&#8217;ve already hit the address space limit. </p>
<p>I tried to use the bologna sandwich analogy as an example of &quot;resource that runs out first sets the limit&quot; but apparently that didn&#8217;t make the point well enough. </p>

		
				</div>
		</li><!-- #comment-## -->
		<li class="comment even thread-even depth-1" id="comment-203223">
				<div id="div-comment-203223" class="comment-body">
				<div class="comment-author vcard">
						<cite class="fn"><a href='http://www.valhallalegends.com' rel='external nofollow' class='url'>Skywing</a></cite> <span class="says">says:</span>		</div>
		
		<div class="comment-meta commentmetadata"><a href="https://blogs.msdn.microsoft.com/oldnewthing/20040813-00/?p=38173#comment-203223">
			August 15, 2004 at 7:50 am</a>		</div>

		<p>Windows 2000 Professional and Windows 2000 Server ignore the /3GB switch.  You need to buy Advanced Server if you want it.</p>

		
				</div>
		</li><!-- #comment-## -->
		<li class="comment odd alt thread-odd thread-alt depth-1" id="comment-203233">
				<div id="div-comment-203233" class="comment-body">
				<div class="comment-author vcard">
						<cite class="fn">timchen</cite> <span class="says">says:</span>		</div>
		
		<div class="comment-meta commentmetadata"><a href="https://blogs.msdn.microsoft.com/oldnewthing/20040813-00/?p=38173#comment-203233">
			August 15, 2004 at 7:43 pm</a>		</div>

		<p>You can&#8217;t always trust knowledge base articles. Using /3GB here just prevents the address space being fragmented and used up, but based on my experience, this does not happen that often under 2GB space. This also has nothing to do with the RAM size.</p>
<p>Apart of this, you won&#8217;t get a performance raise (more VM = more paging). Plus, you don&#8217;t need to worry about wasting RAM as the system cache will use a lot of RAM anyway and 1GB RAM is always not enough (think about the size of all the mailboxes).</p>
<p>And the poor size of paged/nonpaged pool, system ptes under /3gb&#8230;</p>

		
				</div>
		</li><!-- #comment-## -->
		<li class="comment even thread-even depth-1" id="comment-203273">
				<div id="div-comment-203273" class="comment-body">
				<div class="comment-author vcard">
						<cite class="fn"><a href='http://mikedimmick.blogspot.com' rel='external nofollow' class='url'>Mike Dimmick</a></cite> <span class="says">says:</span>		</div>
		
		<div class="comment-meta commentmetadata"><a href="https://blogs.msdn.microsoft.com/oldnewthing/20040813-00/?p=38173#comment-203273">
			August 16, 2004 at 5:22 am</a>		</div>

		<p>KB article 867628 (<a target="_new" href="http://support.microsoft.com/?id=867628" rel="nofollow">http://support.microsoft.com/?id=867628</a>) mentions that the Jet cache was shown as &#8216;mapped bytes&#8217; before Exchange 2003 SP1 but as &#8216;private bytes&#8217; afterward. This suggests they&#8217;ve changed calls to CreateFileMapping( INVALID_HANDLE_VALUE, &#8230; ) to VirtualAlloc. I&#8217;d have expected the code to just map the appropriate areas of the files, though, which I believe is how SQL Server works.</p>
<p>I don&#8217;t expect they&#8217;ve made the mistake of using VirtualAlloc to allocate a single page, but reserve the whole 64KB (remember that virtual address space is reserved in 64KB blocks).</p>
<p>I seem to recall seeing somewhere that the next version of Exchange was to use a common data storage engine, shared with SQL Server. Last I heard, though, Exchange &#8216;Kodiak&#8217; has been postponed until the Longhorn Server timeframe.</p>

		
				</div>
		</li><!-- #comment-## -->
		<li class="comment odd alt thread-odd thread-alt depth-1" id="comment-203473">
				<div id="div-comment-203473" class="comment-body">
				<div class="comment-author vcard">
						<cite class="fn"><a href='http://weblogs.asp.net/larryosterman' rel='external nofollow' class='url'>Larry Osterman</a></cite> <span class="says">says:</span>		</div>
		
		<div class="comment-meta commentmetadata"><a href="https://blogs.msdn.microsoft.com/oldnewthing/20040813-00/?p=38173#comment-203473">
			August 16, 2004 at 4:25 pm</a>		</div>

		<p>Raymond,<br />
<br />  My 1G point was that Exchange is a server.  And as you&#8217;ve said, for servers, paging=death. If an Exchange store ever used more than 2G of virtual address space on a machine with 1G of RAM, then it&#8217;d be paging itself to death.  And that would be a VERY bad thing.</p>
<p>So I&#8217;m confused as to how /3G benefits an Exchange server with only 1G of RAM.  An Exchange server that&#8217;s spending all its time paging in memory isn&#8217;t servicing those users.</p>

		
				</div>
		</li><!-- #comment-## -->
		<li class="comment even thread-even depth-1" id="comment-203493">
				<div id="div-comment-203493" class="comment-body">
				<div class="comment-author vcard">
						<cite class="fn">Norman Diamond</cite> <span class="says">says:</span>		</div>
		
		<div class="comment-meta commentmetadata"><a href="https://blogs.msdn.microsoft.com/oldnewthing/20040813-00/?p=38173#comment-203493">
			August 16, 2004 at 7:13 pm</a>		</div>

		<p>8/16/2004 4:25 PM Larry Osterman</p>
<p>&gt; If an Exchange store ever used more than 2G<br />
<br />&gt; of virtual address space on a machine with<br />
<br />&gt; 1G of RAM, then it&#8217;d be paging itself to<br />
<br />&gt; death.</p>
<p>If it used 2G of virtual memory in its working set, yes.  If it used 2G of virtual address space but didn&#8217;t actually store anything in half the pages, its working set would still be 1G.  Which of these situations actually occurs?</p>

		
				</div>
		</li><!-- #comment-## -->
		<li class="comment odd alt thread-odd thread-alt depth-1" id="comment-203633">
				<div id="div-comment-203633" class="comment-body">
				<div class="comment-author vcard">
						<cite class="fn"><a href='http://weblogs.asp.net/larryosterman' rel='external nofollow' class='url'>Larry Osterman</a></cite> <span class="says">says:</span>		</div>
		
		<div class="comment-meta commentmetadata"><a href="https://blogs.msdn.microsoft.com/oldnewthing/20040813-00/?p=38173#comment-203633">
			August 17, 2004 at 8:53 am</a>		</div>

		<p>Exchange uses VM for two things.  The first is for the database buffers (cache, transaction lookaside lists, etc).  That takes about 75% of available physical memory (this is a guess, the actual percentage is configurable).  The database memory is allocated in a single honking great big allocation and is carved up by the database internally.</p>
<p>The rest is used up for process heaps.  In the absence of a memory leak (and there aren&#8217;t any), the memory in an Exchange server is churned quite heavily, so all the pages in the heaps tend to be hot.</p>
<p>Starting with Exchange 2000, Exchange uses fixed sized heaps to reduce memory fragmentation.  The only thing that having a 3G address space would do to help is if there weren&#8217;t sufficient virtual memory addresses available to allocate a new heap.  Which is why I&#8217;m surprised at the recommendation.<br /></p>

		
				</div>
		</li><!-- #comment-## -->
		<li class="comment even thread-even depth-1" id="comment-203643">
				<div id="div-comment-203643" class="comment-body">
				<div class="comment-author vcard">
						<cite class="fn"><a href='http://weblogs.asp.net/larryosterman' rel='external nofollow' class='url'>Larry Osterman</a></cite> <span class="says">says:</span>		</div>
		
		<div class="comment-meta commentmetadata"><a href="https://blogs.msdn.microsoft.com/oldnewthing/20040813-00/?p=38173#comment-203643">
			August 17, 2004 at 8:55 am</a>		</div>

		<p>Oh, and Mike: you don&#8217;t want to use memory mapping for your database.  You need a higher level of control of the access to the database file than you can get through memory management.  Instead, the exchange database has its own internal cache, and it uses non buffered I/O to access the database files (and transaction logs).<br /></p>

		
				</div>
		</li><!-- #comment-## -->
		<li class="comment odd alt thread-odd thread-alt depth-1" id="comment-204003">
				<div id="div-comment-204003" class="comment-body">
				<div class="comment-author vcard">
						<cite class="fn">DrPizza</cite> <span class="says">says:</span>		</div>
		
		<div class="comment-meta commentmetadata"><a href="https://blogs.msdn.microsoft.com/oldnewthing/20040813-00/?p=38173#comment-204003">
			August 18, 2004 at 5:11 am</a>		</div>

		<p>&quot;The database memory is allocated in a single honking great big allocation and is carved up by the database internally. &quot;<br />
<br />Not that big, really.  Less than 2 GiB.</p>
<p>&quot;Starting with Exchange 2000, Exchange uses fixed sized heaps to reduce memory fragmentation. &quot;<br />
<br />How does that work?  Surely there&#8217;d still be fragmentation&#8211;its fixed-size heaps are surely still going to be internally subdivided to meet application demands, aren&#8217;t they?</p>
<p>Given that fragmentation has persistently been a problem for Exchange it&#8217;s somewhat surprising to me that they don&#8217;t use a compacting garbage collector of some form.</p>
<p>I wouldn&#8217;t think they&#8217;d want to go for managed code or anything like that, but memory fragmentation is one of the things GCs are well equipped to deal with.</p>
<p></p>

		
				</div>
		</li><!-- #comment-## -->
		<li class="comment even thread-even depth-1" id="comment-204443">
				<div id="div-comment-204443" class="comment-body">
				<div class="comment-author vcard">
						<cite class="fn"><a href='http://blogs.msdn.com/gpage' rel='external nofollow' class='url'>Greg Page</a></cite> <span class="says">says:</span>		</div>
		
		<div class="comment-meta commentmetadata"><a href="https://blogs.msdn.microsoft.com/oldnewthing/20040813-00/?p=38173#comment-204443">
			August 19, 2004 at 12:10 pm</a>		</div>

		<p>You need it, at least, because Exchange support will not help you unless you have it. </p>
<p>No matter why we need it, the 3GB switch is a horrid thing to do to a server and to me, it shows that Exchange memory manager seems a wee bit of the refactoring.</p>

		
				</div>
		</li><!-- #comment-## -->
		<li class="comment odd alt thread-odd thread-alt depth-1" id="comment-204823">
				<div id="div-comment-204823" class="comment-body">
				<div class="comment-author vcard">
						<cite class="fn"><a href='http://www.savagenomads.net/archives/000203.html' rel='external nofollow' class='url'>Savage Nomads</a></cite> <span class="says">says:</span>		</div>
		
		<div class="comment-meta commentmetadata"><a href="https://blogs.msdn.microsoft.com/oldnewthing/20040813-00/?p=38173#comment-204823">
			August 20, 2004 at 1:42 pm</a>		</div>

		<p>&amp;nbsp; As Evan&amp;nbsp;already mentioned on his blog, Raymond Chen has a great series on /3GB switch on his blog. What is really cool is that Raymond takes on some myths about the /3GB switch and&amp;nbsp; the fact that he&#8230;</p>

		
				</div>
		</li><!-- #comment-## -->
		<li class="comment even thread-even depth-1" id="comment-206743">
				<div id="div-comment-206743" class="comment-body">
				<div class="comment-author vcard">
						<cite class="fn">Attila the Hun</cite> <span class="says">says:</span>		</div>
		
		<div class="comment-meta commentmetadata"><a href="https://blogs.msdn.microsoft.com/oldnewthing/20040813-00/?p=38173#comment-206743">
			August 30, 2004 at 5:38 pm</a>		</div>

		<p>It looks like Savage Nomads was clubbed in the head in the middle of his post. Lets hope he&#8217;s ok!</p>

		
				</div>
		</li><!-- #comment-## -->
		</ol><!-- .comment-list -->

		<div class="navigation pagination">
					</div>

	
			<p class="no-comments">Comments are closed.</p>
<!-- COMMENTS END -->
</div></td></tr></table>