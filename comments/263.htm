<table class="commenttable" cellspacing="0" cellpadding="0"><tr><td><div class="commentdiv"><div class="commentdivhdr">
<!-- COMMENTS START -->
Comments (19)	</div>

	
			<div class="navigation pagination clear-both">
					</div>

		<ol class="comment-list">
					<li class="comment even thread-even depth-1" id="comment-1144013">
				<div id="div-comment-1144013" class="comment-body">
				<div class="comment-author vcard">
						<cite class="fn">acq</cite> <span class="says">says:</span>		</div>
		
		<div class="comment-meta commentmetadata"><a href="https://blogs.msdn.microsoft.com/oldnewthing/20140812-00/?p=263#comment-1144013">
			August 12, 2014 at 7:14 am</a>		</div>

		<p>Thanks for giving the new links to the texts of Michael Kaplan! Maybe you can fix the &quot;blogroll&quot; section too.</p>

		
				</div>
		</li><!-- #comment-## -->
		<li class="comment odd alt thread-odd thread-alt depth-1" id="comment-1144023">
				<div id="div-comment-1144023" class="comment-body">
				<div class="comment-author vcard">
						<cite class="fn">Grzechooo</cite> <span class="says">says:</span>		</div>
		
		<div class="comment-meta commentmetadata"><a href="https://blogs.msdn.microsoft.com/oldnewthing/20140812-00/?p=263#comment-1144023">
			August 12, 2014 at 7:15 am</a>		</div>

		<p>&gt; 2014</p>
<p>&gt; codepages</p>
<p>&gt; ANSI</p>
<p>Is this serious</p>

		
				</div>
		</li><!-- #comment-## -->
		<li class="comment even thread-even depth-1" id="comment-1144033">
				<div id="div-comment-1144033" class="comment-body">
				<div class="comment-author vcard">
						<cite class="fn">Craig</cite> <span class="says">says:</span>		</div>
		
		<div class="comment-meta commentmetadata"><a href="https://blogs.msdn.microsoft.com/oldnewthing/20140812-00/?p=263#comment-1144033">
			August 12, 2014 at 7:42 am</a>		</div>

		<p>The default for these two attributes is extremely unfortunate. In support, I see issues resulting from this maybe once or twice a year.</p>
<p>While the defaults cannot be changed, I can think of at least two improvements:</p>
<p>1) Depreciate the constructor that does not take a CharSet parameter. Of course you can&#39;t remove it, but at least it will produce a warning. Some people will still ignore it, but at least some will address it.</p>
<p>2) Depreciate both StructLayout and DllImport, and add a StructLayoutEx and DllImportEx that default to CharSet.Unicode. Or just leave out the default and force the developer to choose appropriately.</p>
<p>Also, thanks for the Michael Kaplan link. I had been wondering what happened to his him and his blog for months.</p>

		
				</div>
		</li><!-- #comment-## -->
		<li class="comment odd alt thread-odd thread-alt depth-1" id="comment-1144043">
				<div id="div-comment-1144043" class="comment-body">
				<div class="comment-author vcard">
						<cite class="fn">Chris Warrick</cite> <span class="says">says:</span>		</div>
		
		<div class="comment-meta commentmetadata"><a href="https://blogs.msdn.microsoft.com/oldnewthing/20140812-00/?p=263#comment-1144043">
			August 12, 2014 at 8:34 am</a>		</div>

		<p>@Grzechooo: yes. &nbsp;Windows is stuck with all that, because they just HAVE to be backwards compatible with every single app developed in the last 19 (or so) years. &nbsp;For some crazy reason, they can’t just say “okay, it should not be used by any good program, we’ll get rid of it”. &nbsp;Not that there are programs that are incompatible with the newer versions, tons of them.</p>

		
				</div>
		</li><!-- #comment-## -->
		<li class="comment even thread-even depth-1" id="comment-1144053">
				<div id="div-comment-1144053" class="comment-body">
				<div class="comment-author vcard">
						<cite class="fn">Wear</cite> <span class="says">says:</span>		</div>
		
		<div class="comment-meta commentmetadata"><a href="https://blogs.msdn.microsoft.com/oldnewthing/20140812-00/?p=263#comment-1144053">
			August 12, 2014 at 9:03 am</a>		</div>

		<p>@Craig Deprecating things becomes a documentation nightmare. Java&#39;s done this a fair bit and HTML did it heavily with the move to CSS for styling. You have a bunch of code that works fine and then you upgrade to the newest version (Or DOCTYPE for HTML) and suddenly everything is underlined. There are tooltips everywhere telling you how it&#39;s really bad for you to do what you&#39;ve been doing for years. Now you need to go hunting to figure out why you can&#39;t do what you&#39;ve been doing and what you are supposed to be doing. You only upgraded because you wanted to use some new feature, now you have to go and fix a ton of errors.</p>

		
				</div>
		</li><!-- #comment-## -->
		<li class="comment byuser comment-author-davebacher odd alt thread-odd thread-alt depth-1" id="comment-1144063">
				<div id="div-comment-1144063" class="comment-body">
				<div class="comment-author vcard">
						<cite class="fn"><a href='https://social.msdn.microsoft.com/profile/Dave+Bacher' rel='external nofollow' class='url'>Dave Bacher</a></cite> <span class="says">says:</span>		</div>
		
		<div class="comment-meta commentmetadata"><a href="https://blogs.msdn.microsoft.com/oldnewthing/20140812-00/?p=263#comment-1144063">
			August 12, 2014 at 9:30 am</a>		</div>

		<p>[Obsolete(&quot;Use DllImportAnsi or DllImportUnicode instead.&quot;)]</p>
<p>public sealed class DllImportAttribute : DllImportBaseAttribute </p>
<p>{ }</p>
<p>public abstract class DllImportBaseAttribute : Attribute</p>
<p>{ }</p>
<p>[Obsolete(&quot;Use the Unicode one or else you&#39;ll regret it. &nbsp;Maybe not today, maybe not tomorrow, but soon. &nbsp;And for the rest of your product&#39;s life.&quot;)]</p>
<p>public class DllImportAnsiAttribute : DllImportBaseAttribute</p>
<p>{ }</p>
<p>public class DllImportUnicodeAttribute : DllImportBaseAttribute</p>
<p>{ }</p>
<p>Reference the changes made to System.Web between 3.5 and 4.0 &#8212; this doesn&#39;t generally break binary backwards compatibility, and also doesn&#39;t break source backwards compatibility.</p>
<p>Does potentially break poorly written reflection code, but generally speaking &#8212; the number of scenarios that would care about that ought to be pretty close to 0. :)</p>

		
				</div>
		</li><!-- #comment-## -->
		<li class="comment even thread-even depth-1" id="comment-1144073">
				<div id="div-comment-1144073" class="comment-body">
				<div class="comment-author vcard">
						<cite class="fn">Eric Wilson</cite> <span class="says">says:</span>		</div>
		
		<div class="comment-meta commentmetadata"><a href="https://blogs.msdn.microsoft.com/oldnewthing/20140812-00/?p=263#comment-1144073">
			August 12, 2014 at 9:41 am</a>		</div>

		<p>The default is especially insane when you consider they have a &#39;CharSet.Auto&#39; value available which would have automatically chosen the correct version based on the OS. &nbsp;How THAT option was not the default is completely beyond me.</p>

		
				</div>
		</li><!-- #comment-## -->
		<li class="comment odd alt thread-odd thread-alt depth-1" id="comment-1144093">
				<div id="div-comment-1144093" class="comment-body">
				<div class="comment-author vcard">
						<cite class="fn">voo</cite> <span class="says">says:</span>		</div>
		
		<div class="comment-meta commentmetadata"><a href="https://blogs.msdn.microsoft.com/oldnewthing/20140812-00/?p=263#comment-1144093">
			August 12, 2014 at 10:56 am</a>		</div>

		<p>Oh gosh I completely missed that Michael got a new blog! Wuhu, great!</p>
<p>@Wear: If the reason why it&#39;s deprecated is due to security problems (hello thread.stop and co) or inherent brokenness (hello Java&#39;s calendar APIs) it&#39;s better to warn developers than to ignore it. If they don&#39;t like the warnings they can always ignore them after all.</p>

		
				</div>
		</li><!-- #comment-## -->
		<li class="comment even thread-even depth-1" id="comment-1144103">
				<div id="div-comment-1144103" class="comment-body">
				<div class="comment-author vcard">
						<cite class="fn">Azarien</cite> <span class="says">says:</span>		</div>
		
		<div class="comment-meta commentmetadata"><a href="https://blogs.msdn.microsoft.com/oldnewthing/20140812-00/?p=263#comment-1144103">
			August 12, 2014 at 12:36 pm</a>		</div>

		<p>It&#39;s never too late for Microsoft to implement DllImportEx or DllImportW with Unicode as default.</p>
<p>And you don&#39;t really need to deprecate anything&#8230;</p>

		
				</div>
		</li><!-- #comment-## -->
		<li class="comment odd alt thread-odd thread-alt depth-1" id="comment-1144113">
				<div id="div-comment-1144113" class="comment-body">
				<div class="comment-author vcard">
						<cite class="fn">JM</cite> <span class="says">says:</span>		</div>
		
		<div class="comment-meta commentmetadata"><a href="https://blogs.msdn.microsoft.com/oldnewthing/20140812-00/?p=263#comment-1144113">
			August 12, 2014 at 12:40 pm</a>		</div>

		<p>I always import the W version of the function with [DllImport(ExactSpelling=true)] for exactly this reason. Accidentally calling SHGetFileInfoW with the wrong character set will get you glaringly obvious problems. Since managed strings are Unicode to begin with, the ability to call ANSI versions of functions has no added value now that Windows 95 and relations have gone the way of the dodo.</p>

		
				</div>
		</li><!-- #comment-## -->
		<li class="comment byuser comment-author-john-ludlow even thread-even depth-1" id="comment-1144123">
				<div id="div-comment-1144123" class="comment-body">
				<div class="comment-author vcard">
						<cite class="fn"><a href='https://social.msdn.microsoft.com/profile/John+Ludlow' rel='external nofollow' class='url'>John Ludlow</a></cite> <span class="says">says:</span>		</div>
		
		<div class="comment-meta commentmetadata"><a href="https://blogs.msdn.microsoft.com/oldnewthing/20140812-00/?p=263#comment-1144123">
			August 12, 2014 at 12:46 pm</a>		</div>

		<p>Since apps compiled for one version of the CLR aren&#39;t compatible with different versions of the CLR* surely they could have changed this when introducing .NET 2.0, or 4.0, since those introduced new CLRs.</p>
<p>Yes, ok, you can put some values in your config file that allow you to be compatible with both .NET 3.5 (v2.0 CLR) and .NET 4.x (v4.0 CLR) but that&#39;s not guaranteed to work.</p>

		
				</div>
		</li><!-- #comment-## -->
		<li class="comment odd alt thread-odd thread-alt depth-1" id="comment-1144133">
				<div id="div-comment-1144133" class="comment-body">
				<div class="comment-author vcard">
						<cite class="fn">sevenacids</cite> <span class="says">says:</span>		</div>
		
		<div class="comment-meta commentmetadata"><a href="https://blogs.msdn.microsoft.com/oldnewthing/20140812-00/?p=263#comment-1144133">
			August 12, 2014 at 12:48 pm</a>		</div>

		<p>@Eric Wilson: I just asked myself the same thing.</p>
<p>Now I&#39;m sure I&#39;m missing something important here, but what would be the issues of changing the default to &#39;Auto&#39; or &#39;Unicode&#39; right now? I mean, since the current versions of the CLR/.NET Framework only run on NT-based operating systems (which have been Unicode ever since) one could simply forget about the ANSI versions of the API, couldn&#39;t you?</p>

		
				</div>
		</li><!-- #comment-## -->
		<li class="comment even thread-even depth-1" id="comment-1144143">
				<div id="div-comment-1144143" class="comment-body">
				<div class="comment-author vcard">
						<cite class="fn">Deduplicator</cite> <span class="says">says:</span>		</div>
		
		<div class="comment-meta commentmetadata"><a href="https://blogs.msdn.microsoft.com/oldnewthing/20140812-00/?p=263#comment-1144143">
			August 12, 2014 at 1:03 pm</a>		</div>

		<p>Might part of the reason it wasn&#39;t changed be that there is another implementation (Mono) and it is standardised?</p>
<p>Or wasn&#39;t that part standardised as well?</p>

		
				</div>
		</li><!-- #comment-## -->
		<li class="comment odd alt thread-odd thread-alt depth-1" id="comment-1144153">
				<div id="div-comment-1144153" class="comment-body">
				<div class="comment-author vcard">
						<cite class="fn">Joshua</cite> <span class="says">says:</span>		</div>
		
		<div class="comment-meta commentmetadata"><a href="https://blogs.msdn.microsoft.com/oldnewthing/20140812-00/?p=263#comment-1144153">
			August 12, 2014 at 2:04 pm</a>		</div>

		<p>&gt; Yes, ok, you can put some values in your config file that allow you to be compatible with both .NET 3.5 (v2.0 CLR) and .NET 4.x (v4.0 CLR) but that&#39;s not guaranteed to work.</p>
<p>It&#39;s not eve that hard to deal with. DLLs know what version of the CLR they target.</p>

		
				</div>
		</li><!-- #comment-## -->
		<li class="comment even thread-even depth-1" id="comment-1144163">
				<div id="div-comment-1144163" class="comment-body">
				<div class="comment-author vcard">
						<cite class="fn">jonwil</cite> <span class="says">says:</span>		</div>
		
		<div class="comment-meta commentmetadata"><a href="https://blogs.msdn.microsoft.com/oldnewthing/20140812-00/?p=263#comment-1144163">
			August 12, 2014 at 3:41 pm</a>		</div>

		<p>Regarding depreciation, Visual C++ added stuff to give warnings/errors/other things for a whole bunch of &quot;insecure&quot; stuff (among other things) that you can turn off with a global compiler flag or #define or something if you need to. No reason the CLR couldn&#39;t do the same (depreciate the use of the dllimport stuff that doesn&#39;t specify a char-set and if you want to keep using it instead of fixing your program you flip the switch to shut off the warnings)</p>

		
				</div>
		</li><!-- #comment-## -->
		<li class="comment byuser comment-author-cheong odd alt thread-odd thread-alt depth-1" id="comment-1144173">
				<div id="div-comment-1144173" class="comment-body">
				<div class="comment-author vcard">
						<cite class="fn"><a href='https://social.msdn.microsoft.com/profile/cheong00' rel='external nofollow' class='url'>cheong00</a></cite> <span class="says">says:</span>		</div>
		
		<div class="comment-meta commentmetadata"><a href="https://blogs.msdn.microsoft.com/oldnewthing/20140812-00/?p=263#comment-1144173">
			August 12, 2014 at 6:37 pm</a>		</div>

		<p>Since the CharSet enum has helpful CharSet.Auto which automatically choose Ansi for Win9X/ME and Unicode for others, I wonder why it&#39;s not chosen as the default value.</p>
<p>Note that CharSet.Auto is the default chosen for CLR itself, just that C#,VB.NET override it with CharSet.Ansi and C++ override it to CharSet.None by default</p>

		
				</div>
		</li><!-- #comment-## -->
		<li class="comment even thread-even depth-1" id="comment-1144183">
				<div id="div-comment-1144183" class="comment-body">
				<div class="comment-author vcard">
						<cite class="fn">Scarlet Manuka</cite> <span class="says">says:</span>		</div>
		
		<div class="comment-meta commentmetadata"><a href="https://blogs.msdn.microsoft.com/oldnewthing/20140812-00/?p=263#comment-1144183">
			August 12, 2014 at 11:45 pm</a>		</div>

		<p>Pet peeve: @Craig and @jonwil, please learn the difference between &#39;deprecate&#39; and &#39;depreciate&#39;.</p>
<p>(On my initial read though the thread it seemed like most people had gotten it wrong. But when I went back and counted, three had it correctly and only two incorrectly. A win for humanity?)</p>

		
				</div>
		</li><!-- #comment-## -->
		<li class="comment odd alt thread-odd thread-alt depth-1" id="comment-1144193">
				<div id="div-comment-1144193" class="comment-body">
				<div class="comment-author vcard">
						<cite class="fn">Neil</cite> <span class="says">says:</span>		</div>
		
		<div class="comment-meta commentmetadata"><a href="https://blogs.msdn.microsoft.com/oldnewthing/20140812-00/?p=263#comment-1144193">
			August 13, 2014 at 3:32 am</a>		</div>

		<p>Bah, he&#39;s switched to blogging software which thinks that a) it&#39;s a good idea to detect page zoom changes b) it&#39;s a good idea to do this by polling c) it&#39;s a good idea to poll every second d) it&#39;s a good idea to use code that takes more than a second to execute.</p>

		
				</div>
		</li><!-- #comment-## -->
		<li class="comment even thread-even depth-1" id="comment-1144283">
				<div id="div-comment-1144283" class="comment-body">
				<div class="comment-author vcard">
						<cite class="fn">Wouter Ballet</cite> <span class="says">says:</span>		</div>
		
		<div class="comment-meta commentmetadata"><a href="https://blogs.msdn.microsoft.com/oldnewthing/20140812-00/?p=263#comment-1144283">
			August 14, 2014 at 2:23 am</a>		</div>

		<p>There&#39;s an even easier solution for this problem. Just put the following attribute in your AssemblyInfo.cs file:</p>
<p>[module: DefaultCharSet(CharSet.Unicode)]</p>
<p>This will change the default CharSet to Unicode for all DllImport attributes.</p>

		
				</div>
		</li><!-- #comment-## -->
		</ol><!-- .comment-list -->

		<div class="navigation pagination">
					</div>

	
			<p class="no-comments">Comments are closed.</p>
<!-- COMMENTS END -->
</div></td></tr></table>