<table class="commenttable" cellspacing="0" cellpadding="0"><tr><td><div class="commentdiv"><div class="commentdivhdr">
<!-- COMMENTS START -->
Comments (6)	</div>

	
			<div class="navigation pagination clear-both">
					</div>

		<ol class="comment-list">
					<li class="comment byuser comment-author-alegrigoriev even thread-even depth-1" id="comment-985673">
				<div id="div-comment-985673" class="comment-body">
				<div class="comment-author vcard">
						<cite class="fn"><a href='https://social.msdn.microsoft.com/profile/alegr1' rel='external nofollow' class='url'>alegr1</a></cite> <span class="says">says:</span>		</div>
		
		<div class="comment-meta commentmetadata"><a href="https://blogs.msdn.microsoft.com/oldnewthing/20120517-00/?p=7603#comment-985673">
			May 17, 2012 at 8:05 am</a>		</div>

		<p>If the threads are terminated (not just suspended, which probably would have made more sense), XP used to keep their stacks still allocated (and probably TEB). Then Vista frees the stacks now.</p>
<p>So is this technique still valid for Vista+?</p>
<div class="post">[<i>I guess in your excitement to be the first comment, you decided to skip the entire second paragraph. -Raymond</i>]</div>

		
				</div>
		</li><!-- #comment-## -->
		<li class="comment odd alt thread-odd thread-alt depth-1" id="comment-985683">
				<div id="div-comment-985683" class="comment-body">
				<div class="comment-author vcard">
						<cite class="fn">KJK::Hyperion</cite> <span class="says">says:</span>		</div>
		
		<div class="comment-meta commentmetadata"><a href="https://blogs.msdn.microsoft.com/oldnewthing/20120517-00/?p=7603#comment-985683">
			May 17, 2012 at 8:12 am</a>		</div>

		<p>alegr1: the TEB has had a field with an address to VirtualFree on thread termination since Windows Server 2003 (5.1 kernel, meaning 64-bit Windows XP counts, too); before then, TerminateThread used to leak stacks (ExitThread didn&#39;t). This applies to regular thread termination, though, not thread termination caused by process termination</p>

		
				</div>
		</li><!-- #comment-## -->
		<li class="comment even thread-even depth-1" id="comment-985693">
				<div id="div-comment-985693" class="comment-body">
				<div class="comment-author vcard">
						<cite class="fn">KJK::Hyperion</cite> <span class="says">says:</span>		</div>
		
		<div class="comment-meta commentmetadata"><a href="https://blogs.msdn.microsoft.com/oldnewthing/20120517-00/?p=7603#comment-985693">
			May 17, 2012 at 8:20 am</a>		</div>

		<p>&#8230; in fact, I&#39;m surprised that it doesn&#39;t even free the TEBs</p>

		
				</div>
		</li><!-- #comment-## -->
		<li class="comment byuser comment-author-alegrigoriev odd alt thread-odd thread-alt depth-1" id="comment-985743">
				<div id="div-comment-985743" class="comment-body">
				<div class="comment-author vcard">
						<cite class="fn"><a href='https://social.msdn.microsoft.com/profile/alegr1' rel='external nofollow' class='url'>alegr1</a></cite> <span class="says">says:</span>		</div>
		
		<div class="comment-meta commentmetadata"><a href="https://blogs.msdn.microsoft.com/oldnewthing/20120517-00/?p=7603#comment-985743">
			May 17, 2012 at 10:01 am</a>		</div>

		<p>@KJK:</p>
<p>I think it doesn&#39;t free TEB because each takes just one page, and it&#39;s not possible to call VirtualFree for that. It&#39;s posible to call VirtualProtect to uncommit them, though, but it may not make much sense, because then you have to keep track of those free pages to reuse that space. It&#39;s possible that the freed TEB during normal ExitThread may be set aside for future started threads.</p>
<p>@Raymond: FRIST!!!!11!!</p>

		
				</div>
		</li><!-- #comment-## -->
		<li class="comment even thread-even depth-1" id="comment-985883">
				<div id="div-comment-985883" class="comment-body">
				<div class="comment-author vcard">
						<cite class="fn">SDL</cite> <span class="says">says:</span>		</div>
		
		<div class="comment-meta commentmetadata"><a href="https://blogs.msdn.microsoft.com/oldnewthing/20120517-00/?p=7603#comment-985883">
			May 18, 2012 at 3:04 am</a>		</div>

		<p>Just writing to say thanks for this post. I tend to find your &quot;most technical&quot; posts the most interesting and it&#39;s content like this that makes me look forward to checking for new posts in my Atom feed at the end of the day. These kind of tips from geniuses in their fields are truly invaluable.</p>

		
				</div>
		</li><!-- #comment-## -->
		<li class="comment odd alt thread-odd thread-alt depth-1" id="comment-986153">
				<div id="div-comment-986153" class="comment-body">
				<div class="comment-author vcard">
						<cite class="fn">Joakim</cite> <span class="says">says:</span>		</div>
		
		<div class="comment-meta commentmetadata"><a href="https://blogs.msdn.microsoft.com/oldnewthing/20120517-00/?p=7603#comment-986153">
			May 19, 2012 at 6:18 pm</a>		</div>

		<p>I&#39;m with SDL. :) I always look forward to reading this blog.</p>

		
				</div>
		</li><!-- #comment-## -->
		</ol><!-- .comment-list -->

		<div class="navigation pagination">
					</div>

	
			<p class="no-comments">Comments are closed.</p>
<!-- COMMENTS END -->
</div></td></tr></table>