<table class="commenttable" cellspacing="0" cellpadding="0"><tr><td><div class="commentdiv"><div class="commentdivhdr">
<!-- COMMENTS START -->
Comments (73)	</div>

	
			<div class="navigation pagination clear-both">
					</div>

		<ol class="comment-list">
					<li class="comment even thread-even depth-1" id="comment-371343">
				<div id="div-comment-371343" class="comment-body">
				<div class="comment-author vcard">
						<cite class="fn">Name required</cite> <span class="says">says:</span>		</div>
		
		<div class="comment-meta commentmetadata"><a href="https://blogs.msdn.microsoft.com/oldnewthing/20060419-14/?p=31473#comment-371343">
			April 19, 2006 at 10:08 am</a>		</div>

		<p>&quot;the capabilities mask would quickly fill up with all these random bits for bugs that were fixed ages ago&quot;</p>
<p>You mean the bugs that you complain are still in place on so many servers and network attached devices all over the world? Do you think they will go away in six months? A year? What? If so then you shouldn&#8217;t worry about this problem at all, because by the time Vista ships the problem won&#8217;t exist any more.</p>

		
				</div>
		</li><!-- #comment-## -->
		<li class="comment odd alt thread-odd thread-alt depth-1" id="comment-371363">
				<div id="div-comment-371363" class="comment-body">
				<div class="comment-author vcard">
						<cite class="fn">vince</cite> <span class="says">says:</span>		</div>
		
		<div class="comment-meta commentmetadata"><a href="https://blogs.msdn.microsoft.com/oldnewthing/20060419-14/?p=31473#comment-371363">
			April 19, 2006 at 10:29 am</a>		</div>

		<p>Well the obvious solution is that Microsoft post the full CIFS and SMB specification, making sure to have Errata for all MS OS&#8217;s ever released.</p>
<p>Giving people incomplete info and then asking them to solve the problem is only going to make both sides look foolish.</p>

		
				</div>
		</li><!-- #comment-## -->
		<li class="comment even thread-even depth-1" id="comment-371393">
				<div id="div-comment-371393" class="comment-body">
				<div class="comment-author vcard">
						<cite class="fn">Rutger</cite> <span class="says">says:</span>		</div>
		
		<div class="comment-meta commentmetadata"><a href="https://blogs.msdn.microsoft.com/oldnewthing/20060419-14/?p=31473#comment-371393">
			April 19, 2006 at 11:01 am</a>		</div>

		<p>I am glad you posted a followup&#8230;</p>
<p>I would be surprised if a solution was found that would satisfy the majority of the readers of this blog (or even the minority for that matter). A lot of people see this as something to rant about.</p>
<p>oh vince, you assume that if the specs are on the street (and they might be I don&#8217;t know) everybody is going to make a perfect implementation. yeah right&#8230;..</p>
<p>I am glad that these kind of problems get attention, it feels like the problem you once described where a video driver would report yeah I can do that on any directx query that was fired at it, unfortunately I don&#8217;t think this one is as &#8216;easy&#8217; solved.</p>

		
				</div>
		</li><!-- #comment-## -->
		<li class="comment odd alt thread-odd thread-alt depth-1" id="comment-371403">
				<div id="div-comment-371403" class="comment-body">
				<div class="comment-author vcard">
						<cite class="fn">Joe Dietz</cite> <span class="says">says:</span>		</div>
		
		<div class="comment-meta commentmetadata"><a href="https://blogs.msdn.microsoft.com/oldnewthing/20060419-14/?p=31473#comment-371403">
			April 19, 2006 at 11:18 am</a>		</div>

		<p>Well in keeping with the law of fixes &quot;do the fix at the lowest possible abstraction layer&quot;, you have to fix this problem at the protocol level (and make the protocol just a bit uglier) or just do nothing. &nbsp;What wasn&#8217;t clear from the original problem description was that XP clients <em>also</em> use fast enumeration if available. &nbsp;In that case XP clients interacting with old Samba servers already have been suffering from this for years. &nbsp;That more or less tips the balance towards &#8216;do nothing&#8217;.</p>

		
				</div>
		</li><!-- #comment-## -->
		<li class="comment even thread-even depth-1" id="comment-371413">
				<div id="div-comment-371413" class="comment-body">
				<div class="comment-author vcard">
						<cite class="fn">vince</cite> <span class="says">says:</span>		</div>
		
		<div class="comment-meta commentmetadata"><a href="https://blogs.msdn.microsoft.com/oldnewthing/20060419-14/?p=31473#comment-371413">
			April 19, 2006 at 11:22 am</a>		</div>

		<blockquote><p>
  you assume that if the specs are on<br />
  <br />&gt; the street (and they might be I don&#8217;t<br />
  <br />&gt; know) everybody is going to make a<br />
  <br />&gt; perfect implementation. yeah right</p>
<p>No, I assume if the specs were on the street, people here could have looked them up and posted intelligent solutions.</p>
<p>As it is, people posted things based on the limited info that Raymond gave, and then he comes and shoots them down for being naive&#8230; well of course everyone is naive, they aren&#8217;t getting the full story.</p>
<p>Then later the actual Samba developers come post, and they post much more useful info than anyone from MS gave, and it turns out even Raymond really didn&#8217;t have a good handle of what was going on. &nbsp;So this whole series turns into a bunch of pointless speculating rather than any sort of good example of how to fix a bug.
</p></blockquote>

		
				</div>
		</li><!-- #comment-## -->
		<li class="comment odd alt thread-odd thread-alt depth-1" id="comment-371423">
				<div id="div-comment-371423" class="comment-body">
				<div class="comment-author vcard">
						<cite class="fn">Dflare</cite> <span class="says">says:</span>		</div>
		
		<div class="comment-meta commentmetadata"><a href="https://blogs.msdn.microsoft.com/oldnewthing/20060419-14/?p=31473#comment-371423">
			April 19, 2006 at 11:28 am</a>		</div>

		<p>Joe, In Win XP, it uses the slow mode by default, &nbsp; ( so basically every one is using it ), that&#8217;s why the problem is not really common. You can turn the fast mode on ( I don&#8217;t really know how to do it, but you can ). With WinVista, they are trying to make the fast mode the default ( so it can benefit from it ) and thats where the problem &nbsp; will show to every one</p>

		
				</div>
		</li><!-- #comment-## -->
		<li class="comment even thread-even depth-1" id="comment-371433">
				<div id="div-comment-371433" class="comment-body">
				<div class="comment-author vcard">
						<cite class="fn">Neal</cite> <span class="says">says:</span>		</div>
		
		<div class="comment-meta commentmetadata"><a href="https://blogs.msdn.microsoft.com/oldnewthing/20060419-14/?p=31473#comment-371433">
			April 19, 2006 at 11:29 am</a>		</div>

		<p>I know zip about networks so I ask, how often do servers get swapped out invisibly (does windows monitor their presence or only see them when you attempt to access, is there some unique identifier that would change with any change)? &nbsp; </p>
<p>Why not add a service that is run whenever this network/protocol/whatever is available. &nbsp;Add a hook to the appropriate network drivers so this service can be notified to do its business on connect or first access.</p>
<p>The first time a connection is made it makes any necessary tests/queries to determine if a problem exists and sets mode accordingly. &nbsp;Any time the connection is dropped the service requeries and resets the mode before next access. &nbsp;</p>
<p>Benefits &#8211; Aside from the hook, the network drivers don&#8217;t change. &nbsp;New/multiple/selectable checks can be added by changing the service and not the network drivers (although the service could only work around bugs that could be fixed by mode or setup changes). &nbsp;Don&#8217;t have to even run the service or checks if you&#8217;re certain of the hardware.</p>
<p>Probs &#8211; several thousand windows machines doing test queries at once when they detect a server or disconnect/reconnect&#8230; lessened if checked only when an attempt to access is made? &nbsp;Wouldn&#8217;t work if servers can be swapped invisibly. &nbsp;Listening to a moron pulling guesses outta his behind?</p>

		
				</div>
		</li><!-- #comment-## -->
		<li class="comment odd alt thread-odd thread-alt depth-1" id="comment-371443">
				<div id="div-comment-371443" class="comment-body">
				<div class="comment-author vcard">
						<cite class="fn">Bart</cite> <span class="says">says:</span>		</div>
		
		<div class="comment-meta commentmetadata"><a href="https://blogs.msdn.microsoft.com/oldnewthing/20060419-14/?p=31473#comment-371443">
			April 19, 2006 at 11:29 am</a>		</div>

		<p>Why i suggested this is that it will keep functioning, altough in a degraded manner.</p>
<p>One alternative way of handling this is for both client and server exchanging capabilities and version/implimentation information, and then handshaking until a set can be found that both agree to support.<br />
<br />Atleast in this way the &#8216;newest&#8217; version can decide the right compatibility mode that both can support correctly.</p>
<p>But you can&#8217;t add signatures and workarounds for yet undiscoverd problems.</p>

		
				</div>
		</li><!-- #comment-## -->
		<li class="comment byuser comment-author-oldnewthing bypostauthor even thread-even depth-1" id="comment-371453">
				<div id="div-comment-371453" class="comment-body">
				<div class="comment-author vcard">
						<cite class="fn"><a href='https://social.msdn.microsoft.com/profile/Raymond+Chen+-+MSFT' rel='external nofollow' class='url'>Raymond Chen - MSFT</a></cite> <span class="says">says:</span>		</div>
		
		<div class="comment-meta commentmetadata"><a href="https://blogs.msdn.microsoft.com/oldnewthing/20060419-14/?p=31473#comment-371453">
			April 19, 2006 at 11:33 am</a>		</div>

		<p>Bart: Whether you do it via a capabilities mask or by negotiation you have the same problem. With negotiation, you&#8217;ll have the client asking the server, &quot;So, do you have that 129-file bug?&quot; and the server will &nbsp;say &quot;Huh? What 129-file bug?&quot;</p>

		
				</div>
		</li><!-- #comment-## -->
		<li class="comment odd alt thread-odd thread-alt depth-1" id="comment-371463">
				<div id="div-comment-371463" class="comment-body">
				<div class="comment-author vcard">
						<cite class="fn">Bart</cite> <span class="says">says:</span>		</div>
		
		<div class="comment-meta commentmetadata"><a href="https://blogs.msdn.microsoft.com/oldnewthing/20060419-14/?p=31473#comment-371463">
			April 19, 2006 at 11:46 am</a>		</div>

		<p>You dont ask it if it has a bug, you ask it what it thinks it can do.<br />
<br />Then you ask it what implementation it is.<br />
<br />If you know about bugs in its implementation you remove those from the set of things it can do.<br />
<br />Things it reports it can do but you don&#8217;t know about, you don&#8217;t support and you can safely drop those.</p>
<p>The server does the reverse with you.</p>
<p>This results in two sets of possible things that both think the other can do correctly, take the intersection of these sets and you have what is usable according to the information available to you.</p>

		
				</div>
		</li><!-- #comment-## -->
		<li class="comment even thread-even depth-1" id="comment-371493">
				<div id="div-comment-371493" class="comment-body">
				<div class="comment-author vcard">
						<cite class="fn">Joe Butler</cite> <span class="says">says:</span>		</div>
		
		<div class="comment-meta commentmetadata"><a href="https://blogs.msdn.microsoft.com/oldnewthing/20060419-14/?p=31473#comment-371493">
			April 19, 2006 at 12:14 pm</a>		</div>

		<p>To Vince:</p>
<p>No one is trying to make anyone look foolish. &nbsp;The point of Raymond&#8217;s post, if I&#8217;ve understood it correctly, was not to obtain a free solution, but to highlight the issues involved in implementing certain fixes. &nbsp;</p>
<p>This obviously generated a lot of interest &#8211; because we like to solve problems. &nbsp;</p>
<p>Some of the suggestions were impractical (due to the negative impact they would have on end users), so this post was presumably made to focus on a smaller point and highlight some of the reasons why.</p>
<p>Believing that everything would be fine if the specs were available is being unrealistic. &nbsp;If I remember the orginal networking thread correctly, the developer of the samba issue admitted that it was an oversight on his part (it was not due to having limited knowledge of the SMB protocol). &nbsp;It was also pointed out by someone else, that the 3 minutes or so end-to-end fix time seemed suspicously fast, if it included testing, etc. &nbsp;Read between the lines of that comment and it might show the real reason such errors creep in.</p>

		
				</div>
		</li><!-- #comment-## -->
		<li class="comment odd alt thread-odd thread-alt depth-1" id="comment-371503">
				<div id="div-comment-371503" class="comment-body">
				<div class="comment-author vcard">
						<cite class="fn">kbiel</cite> <span class="says">says:</span>		</div>
		
		<div class="comment-meta commentmetadata"><a href="https://blogs.msdn.microsoft.com/oldnewthing/20060419-14/?p=31473#comment-371503">
			April 19, 2006 at 12:17 pm</a>		</div>

		<p>Raymond,</p>
<p>Why are you reluctant to put the user in charge of this issue? &nbsp;All that needs to be done to solve it is this:</p>
<p>Vista uses fast mode by default. &nbsp;Everything works great and the user is happy with the faster response in Vista until Vista encounters a samba server with the fast mode bug. &nbsp;Vista pops a dialog saying, &quot;An error occurred while attempting to communicate with \xyz in enhanced mode. &nbsp;Using legacy mode might alleviaate the problem. &nbsp;Would you like to reattempt connecting to \xyz using legacy mode?&quot; &nbsp;Include a check box &quot;Always use legacy mode for \xyz?&quot;.</p>
<p>That seems to solve the problem. &nbsp;You have given a brief and non-scary explanation of the problem and placed the blame where it belongs, on server \xyz. &nbsp;Then you have given a solution to the problem that the user can implement if they choose and permanantly if they prefer to not receive this message in future sessions. &nbsp;Now the list of &quot;bad&quot; servers is controlled by the user, the user is aware of the issue and can possibly report it to the proper people, etc.</p>

		
				</div>
		</li><!-- #comment-## -->
		<li class="comment even thread-even depth-1" id="comment-371533">
				<div id="div-comment-371533" class="comment-body">
				<div class="comment-author vcard">
						<cite class="fn">Joe Butler</cite> <span class="says">says:</span>		</div>
		
		<div class="comment-meta commentmetadata"><a href="https://blogs.msdn.microsoft.com/oldnewthing/20060419-14/?p=31473#comment-371533">
			April 19, 2006 at 12:42 pm</a>		</div>

		<p>To kbiel,</p>
<p>Try this thought experiment:</p>
<p>Remove all compatibility fixes in your OS (the ones that insulate you from bugs in other software/hardware). &nbsp;Replace them all with &#8216;non-scary&#8217; dialogs. &nbsp;Make sure you use words that everyone will understand. &nbsp;E.g. &quot;\xyz&quot;, &quot;enhanced mode&quot;, &quot;legacy mode&quot;, &quot;alleviaate&quot;, and throw in some big bang words like, &quot;problem&quot; just to make it less scary for the user. &nbsp;Make that word &quot;locale RED&quot; so that it stands out even more. &nbsp;Now pop that dialog up everytime an app calls an offending function (let&#8217;s assume it hasn&#8217;t crashed the PC, and that an unatended PC isn&#8217;t brought to its knees &nbsp; &nbsp; while attempting to display the millionth &#8216;non-scary&#8217; dialog. </p>
<p>Now, go about your business and see how long it takes before you scream, &quot;stupid $4it4ead fuc&#163;ing computer!&quot;.</p>

		
				</div>
		</li><!-- #comment-## -->
		<li class="comment odd alt thread-odd thread-alt depth-1" id="comment-371543">
				<div id="div-comment-371543" class="comment-body">
				<div class="comment-author vcard">
						<cite class="fn">Andy Blues</cite> <span class="says">says:</span>		</div>
		
		<div class="comment-meta commentmetadata"><a href="https://blogs.msdn.microsoft.com/oldnewthing/20060419-14/?p=31473#comment-371543">
			April 19, 2006 at 12:50 pm</a>		</div>

		<p>I&#8217;m a little tired of this thread about this problem supposedly caused by the current Samba implementation.<br />
<br />I am pretty sure that, before the moment Vista will be released to the general public, Samba will be already corrected and support FastMode.</p>

		
				</div>
		</li><!-- #comment-## -->
		<li class="comment even thread-even depth-1" id="comment-371573">
				<div id="div-comment-371573" class="comment-body">
				<div class="comment-author vcard">
						<cite class="fn">andy</cite> <span class="says">says:</span>		</div>
		
		<div class="comment-meta commentmetadata"><a href="https://blogs.msdn.microsoft.com/oldnewthing/20060419-14/?p=31473#comment-371573">
			April 19, 2006 at 12:56 pm</a>		</div>

		<p>Andy Blues: The bug is already fixed in Samba (e.g. read KJK:Hyperion&#8217;s and Joe Butler&#8217;s comments just above).</p>
<p>But the big problem is that a version of Samba with this bug is shipped together with lot&#8217;s of NAS, making it hard to fix for home users.</p>
<p>In addition it is really interesting to read, for some people like me, about pros/cons of fixes for bugs. I especially liked the link to the &quot;Spooky action at distance&quot; making me read a little bit of quantum mechanics in the end :)</p>

		
				</div>
		</li><!-- #comment-## -->
		<li class="comment odd alt thread-odd thread-alt depth-1" id="comment-371583">
				<div id="div-comment-371583" class="comment-body">
				<div class="comment-author vcard">
						<cite class="fn"><a href='http://www.crazyontap.com' rel='external nofollow' class='url'>Almost H. Anonymous</a></cite> <span class="says">says:</span>		</div>
		
		<div class="comment-meta commentmetadata"><a href="https://blogs.msdn.microsoft.com/oldnewthing/20060419-14/?p=31473#comment-371583">
			April 19, 2006 at 1:05 pm</a>		</div>

		<p>&quot;oh vince, you assume that if the specs are on the street (and they might be I don&#8217;t know) everybody is going to make a perfect implementation. yeah right&#8230;..&quot;</p>
<p>Oh but how much harder is it to create an implementation when you don&#8217;t have specs at all!! &nbsp;That&#8217;s the point.</p>
<p>&quot;What wasn&#8217;t clear from the original problem description was that XP clients <em>also</em> use fast enumeration if available.&quot;</p>
<p>Yeah, I thought from the original description of the problem that is something newly implemented (or activated) in Vista. &nbsp;<br /></p>

		
				</div>
		</li><!-- #comment-## -->
		<li class="comment even thread-even depth-1" id="comment-371593">
				<div id="div-comment-371593" class="comment-body">
				<div class="comment-author vcard">
						<cite class="fn"><a href='http://jamessummerlin.blogspot.com' rel='external nofollow' class='url'>James Summerlin</a></cite> <span class="says">says:</span>		</div>
		
		<div class="comment-meta commentmetadata"><a href="https://blogs.msdn.microsoft.com/oldnewthing/20060419-14/?p=31473#comment-371593">
			April 19, 2006 at 1:21 pm</a>		</div>

		<p>Hyperion,</p>
<p>Thank you very much for your comment. &nbsp;You said all the things I was afraid to say.</p>
<p>I wish that n00b Jeremy Allison who commented on the original post about this could see what you just said. &nbsp;His response of why this happened in Samba was that it was a failure to communicate by Microsoft.</p>
<p>James</p>

		
				</div>
		</li><!-- #comment-## -->
		<li class="comment odd alt thread-odd thread-alt depth-1" id="comment-371613">
				<div id="div-comment-371613" class="comment-body">
				<div class="comment-author vcard">
						<cite class="fn">vince</cite> <span class="says">says:</span>		</div>
		
		<div class="comment-meta commentmetadata"><a href="https://blogs.msdn.microsoft.com/oldnewthing/20060419-14/?p=31473#comment-371613">
			April 19, 2006 at 1:32 pm</a>		</div>

		<p>Hyperion: &nbsp;I suggest you check out devel.samba.org. &nbsp;I quote:</p>
<p>&gt; Important: In order to avoid any<br />
<br />&gt; potential licensing issues we<br />
<br />&gt; require that anyone who has signed<br />
<br />&gt; the Microsoft CIFS Royalty Free<br />
<br />&gt; Agreement not submit patches to<br />
<br />&gt; Samba, nor base patches on the<br />
<br />&gt; referenced specification.</p>

		
				</div>
		</li><!-- #comment-## -->
		<li class="comment even thread-even depth-1" id="comment-371633">
				<div id="div-comment-371633" class="comment-body">
				<div class="comment-author vcard">
						<cite class="fn">Nate Silva</cite> <span class="says">says:</span>		</div>
		
		<div class="comment-meta commentmetadata"><a href="https://blogs.msdn.microsoft.com/oldnewthing/20060419-14/?p=31473#comment-371633">
			April 19, 2006 at 1:54 pm</a>		</div>

		<p>Does Microsoft have a validation suite that open source implementations can use?</p>
<p>The Samba guys had to reverse engineer the protocol, so it&#8217;s not surprising they got some details wrong. Hiding the details from &quot;competitors&quot; like Samba harms Microsoft, too.</p>

		
				</div>
		</li><!-- #comment-## -->
		<li class="comment odd alt thread-odd thread-alt depth-1" id="comment-371643">
				<div id="div-comment-371643" class="comment-body">
				<div class="comment-author vcard">
						<cite class="fn"><a href='http://informage.net/' rel='external nofollow' class='url'>Sean Legassick</a></cite> <span class="says">says:</span>		</div>
		
		<div class="comment-meta commentmetadata"><a href="https://blogs.msdn.microsoft.com/oldnewthing/20060419-14/?p=31473#comment-371643">
			April 19, 2006 at 2:50 pm</a>		</div>

		<blockquote><p>
  &quot;Hey, don&#8217;t blame me,&quot; you answer. you answer. &quot;It&#8217;s that guy over<br />
  <br />&gt; there. That guy you&#8217;ve never<br />
  <br />&gt; heard of. He made me do it. Blame him!&quot;</p>
<p>It&#8217;s very funny to read you mocking this kind of answer Raymond, given it&#8217;s pretty much exactly what you said to me in a newsgroup posting some years ago. In fact, let me look at what you did say&#8230;</p>
<p>&gt; Because that idiot who wrote broken code shipped first. &nbsp;Certain<br />
  <br />&gt; idiots who write broken code are #1 on the software charts in<br />
  <br />&gt; their area. </p>
<p>Well I don&#8217;t know whether I&#8217;d heard of them, because you wouldn&#8217;t say who it was!</p>
<p>As it happens it&#8217;s precisely this attitude from Microsoft that caused me to give up Windows altogether, both as a developer and a user.<br />
  <br />I just can&#8217;t deal with a platform where API contracts are broken<br />
  <br />willy-nilly in the service of backwards compatibility with nameless software.</p>
<p>(the article was:<br />
  <br /><a rel="nofollow" target="_new" href="http://groups.google.com/group/microsoft.public.platformsdk.ui_shell/msg/f46ba9e9d45c7bd3" rel="nofollow">http://groups.google.com/group/microsoft.public.platformsdk.ui_shell/msg/f46ba9e9d45c7bd3</a><br />
  <br />)<br />
  
</p></blockquote>

		
				</div>
		</li><!-- #comment-## -->
		<li class="comment even thread-even depth-1" id="comment-371653">
				<div id="div-comment-371653" class="comment-body">
				<div class="comment-author vcard">
						<cite class="fn"><a href='http://jamessummerlin.blogspot.com' rel='external nofollow' class='url'>James Summerlin</a></cite> <span class="says">says:</span>		</div>
		
		<div class="comment-meta commentmetadata"><a href="https://blogs.msdn.microsoft.com/oldnewthing/20060419-14/?p=31473#comment-371653">
			April 19, 2006 at 3:14 pm</a>		</div>

		<p>Sean,</p>
<p>Despite how much of a Microsoft fan I am, even I must admit that MS has upset me a time or two. &nbsp;However, I content that MS is still far better than the competition. &nbsp;Would you rather deal with situations like this?</p>
<p><a rel="nofollow" target="_new" href="http://news.zdnet.com/2100-3513_22-6061491.html" rel="nofollow">http://news.zdnet.com/2100-3513_22-6061491.html</a></p>
<p>James</p>

		
				</div>
		</li><!-- #comment-## -->
		<li class="comment odd alt thread-odd thread-alt depth-1" id="comment-371663">
				<div id="div-comment-371663" class="comment-body">
				<div class="comment-author vcard">
						<cite class="fn">peterchen</cite> <span class="says">says:</span>		</div>
		
		<div class="comment-meta commentmetadata"><a href="https://blogs.msdn.microsoft.com/oldnewthing/20060419-14/?p=31473#comment-371663">
			April 19, 2006 at 3:15 pm</a>		</div>

		<p>Did I misunderstand the problem?</p>
<p>As I read the original post, the SERVER is handling the request wrong, and the XP client runs happily in SLOW mode. Or am I mistaken?</p>
<p>In this case, nothing would change for a Vista client, it would use slow mode until the server is updated and indicates &quot;fast is ok (really now)&quot;.</p>
<p>(and a version number could accumulate most of the bits)<br /></p>

		
				</div>
		</li><!-- #comment-## -->
		<li class="comment byuser comment-author-oldnewthing bypostauthor even thread-even depth-1" id="comment-371673">
				<div id="div-comment-371673" class="comment-body">
				<div class="comment-author vcard">
						<cite class="fn"><a href='https://social.msdn.microsoft.com/profile/Raymond+Chen+-+MSFT' rel='external nofollow' class='url'>Raymond Chen - MSFT</a></cite> <span class="says">says:</span>		</div>
		
		<div class="comment-meta commentmetadata"><a href="https://blogs.msdn.microsoft.com/oldnewthing/20060419-14/?p=31473#comment-371673">
			April 19, 2006 at 3:22 pm</a>		</div>

		<p>peterchen: But older servers (that don&#8217;t have the bug) won&#8217;t set the &quot;really now&quot; bit. Result: You upgrade to Vista and your performance drops.</p>

		
				</div>
		</li><!-- #comment-## -->
		<li class="comment odd alt thread-odd thread-alt depth-1" id="comment-371683">
				<div id="div-comment-371683" class="comment-body">
				<div class="comment-author vcard">
						<cite class="fn">Mike</cite> <span class="says">says:</span>		</div>
		
		<div class="comment-meta commentmetadata"><a href="https://blogs.msdn.microsoft.com/oldnewthing/20060419-14/?p=31473#comment-371683">
			April 19, 2006 at 3:52 pm</a>		</div>

		<p>While it is way too late in the game for this comment to have any effect on this particular bug:</p>
<p>This would likely never have happened had Microsoft actually documented SMB/CIFS, and followed up on the &quot;CIFS&quot; thing (namechange, and provably non-honest &quot;attempt&quot; to define and open up the protocol).</p>
<p>I also think this whole spectacle actually serves as fuel for the EU problem MS now faces. Microsoft has proven to be almost completely incompetent in the area of documenting this disaster.</p>
<p>I hope Microsoft (finally) learns from this mistake, that communication protocols (be them over-the-wire, wrapped in RPC, syscalls or just plain function calls within a process) must be documented. Not just that the specific &quot;call&quot; exists and what arguments/parameters it expects, but also preconditions, invariants and postconditions.</p>

		
				</div>
		</li><!-- #comment-## -->
		<li class="comment even thread-even depth-1" id="comment-371693">
				<div id="div-comment-371693" class="comment-body">
				<div class="comment-author vcard">
						<cite class="fn">paul</cite> <span class="says">says:</span>		</div>
		
		<div class="comment-meta commentmetadata"><a href="https://blogs.msdn.microsoft.com/oldnewthing/20060419-14/?p=31473#comment-371693">
			April 19, 2006 at 3:55 pm</a>		</div>

		<p>kbiel: Putting the user in charge only works if there is a user! Displaying a confirmation dialog assumes that if a user existed they would know what decision to take&#8230;</p>
<p>This doesn&#8217;t take into account services without a visible desktop, software running on embedded systems or even &#8216;normal&#8217; software on a pc stuck in a server room and never actually viewed directly &#8211; how would a confirmation dialog help in these scenarios.</p>

		
				</div>
		</li><!-- #comment-## -->
		<li class="comment odd alt thread-odd thread-alt depth-1" id="comment-371703">
				<div id="div-comment-371703" class="comment-body">
				<div class="comment-author vcard">
						<cite class="fn">sayler</cite> <span class="says">says:</span>		</div>
		
		<div class="comment-meta commentmetadata"><a href="https://blogs.msdn.microsoft.com/oldnewthing/20060419-14/?p=31473#comment-371703">
			April 19, 2006 at 3:57 pm</a>		</div>

		<p>peterchen: But older servers (that don&#8217;t have the bug) won&#8217;t set the &quot;really now&quot; bit. Result: You upgrade to Vista and your performance drops.</p>
<p>Just to make sure that I understand, it&#8217;s really &quot;and your performance doesn&#8217;t get any better&quot; &#8212; because current clients use the one-at-a-time mode?</p>

		
				</div>
		</li><!-- #comment-## -->
		<li class="comment byuser comment-author-oldnewthing bypostauthor even thread-even depth-1" id="comment-371733">
				<div id="div-comment-371733" class="comment-body">
				<div class="comment-author vcard">
						<cite class="fn"><a href='https://social.msdn.microsoft.com/profile/Raymond+Chen+-+MSFT' rel='external nofollow' class='url'>Raymond Chen - MSFT</a></cite> <span class="says">says:</span>		</div>
		
		<div class="comment-meta commentmetadata"><a href="https://blogs.msdn.microsoft.com/oldnewthing/20060419-14/?p=31473#comment-371733">
			April 19, 2006 at 5:06 pm</a>		</div>

		<p>sayler: No, your performance actually drops. Please go back and re-read the second paragraph.</p>

		
				</div>
		</li><!-- #comment-## -->
		<li class="comment odd alt thread-odd thread-alt depth-1" id="comment-371743">
				<div id="div-comment-371743" class="comment-body">
				<div class="comment-author vcard">
						<cite class="fn">vince</cite> <span class="says">says:</span>		</div>
		
		<div class="comment-meta commentmetadata"><a href="https://blogs.msdn.microsoft.com/oldnewthing/20060419-14/?p=31473#comment-371743">
			April 19, 2006 at 5:23 pm</a>		</div>

		<blockquote><p>
  No, your performance actually drops.<br />
  <br />&gt; Please go back and re-read the second<br />
  <br />&gt; paragraph.</p>
<p>So, how fast is this &quot;fast&quot; mode. &nbsp;Can we see some numbers? &nbsp;Are we talking a massive (like twice as fast) speed-up? &nbsp;Or is it something like a 10% speedup that might be lost in the noise?
</p></blockquote>

		
				</div>
		</li><!-- #comment-## -->
		<li class="comment even thread-even depth-1" id="comment-371383">
				<div id="div-comment-371383" class="comment-body">
				<div class="comment-author vcard">
						<cite class="fn">BryanK</cite> <span class="says">says:</span>		</div>
		
		<div class="comment-meta commentmetadata"><a href="https://blogs.msdn.microsoft.com/oldnewthing/20060419-14/?p=31473#comment-371383">
			April 19, 2006 at 10:50 am</a>		</div>

		<p>&gt; This server supports fast mode and doesn&#8217;t have the bug where enumerating a directory with more than 128 files fails on the 129th query</p>
<p>I hope people realize by now that this isn&#8217;t a good description of this bug. &nbsp;Yes, it does describe the behavior that a user program would see when running against a server with the bug. &nbsp;But the bug was that the SMBfindfirst packet succeeded, and then the SMBfindnext packet (the second one in the enumeration) returned an error. &nbsp;The 128/129 number is merely an artifact of the redirector&#8217;s batching process &#8212; if the redirector batched 64 files into one SMB packet, then you&#8217;d see the problem on the 65th file coming back from NtQueryDirectoryFile.</p>
<p>(Unless the protocol forces a &quot;count&quot; of 128 in all SMBfindfirst and SMBfindnext packets? &nbsp;That would seem extremely braindead to me.)</p>
<p>That&#8217;s not to say that the right fix is to add a flag that means &quot;I don&#8217;t have this bug&quot;, though. &nbsp;(This is partly because of the reasons you cite, but also partly because requiring a server to turn a flag *on* to get behavior that it *already* does correctly seems completely backwards to me.)</p>

		
				</div>
		</li><!-- #comment-## -->
		<li class="comment byuser comment-author-oldnewthing bypostauthor odd alt thread-odd thread-alt depth-1" id="comment-371773">
				<div id="div-comment-371773" class="comment-body">
				<div class="comment-author vcard">
						<cite class="fn"><a href='https://social.msdn.microsoft.com/profile/Raymond+Chen+-+MSFT' rel='external nofollow' class='url'>Raymond Chen - MSFT</a></cite> <span class="says">says:</span>		</div>
		
		<div class="comment-meta commentmetadata"><a href="https://blogs.msdn.microsoft.com/oldnewthing/20060419-14/?p=31473#comment-371773">
			April 19, 2006 at 5:50 pm</a>		</div>

		<p>vince: I already gave this information in earlier entries in this series. Perhaps I should give up on this series since people just keep asking questions I&#8217;ve already answered.</p>

		
				</div>
		</li><!-- #comment-## -->
		<li class="comment even thread-even depth-1" id="comment-371783">
				<div id="div-comment-371783" class="comment-body">
				<div class="comment-author vcard">
						<cite class="fn">vince</cite> <span class="says">says:</span>		</div>
		
		<div class="comment-meta commentmetadata"><a href="https://blogs.msdn.microsoft.com/oldnewthing/20060419-14/?p=31473#comment-371783">
			April 19, 2006 at 6:04 pm</a>		</div>

		<p>oldenewthing:<br />
<br />&gt; I already gave this information in<br />
<br />&gt; earlier entries in this series.<br />
<br />&gt; Perhaps I should give up on this<br />
<br />&gt; series since people just keep asking<br />
<br />&gt; questions I&#8217;ve already answered.</p>
<p>I meant <em>real</em> numbers. &nbsp;As in, ones measured on an actual system under normal behavior.</p>
<p>Your previous asnwer started with &quot;assume a latency of 500ms&quot;&#8230; &nbsp;do you expect most people to have their NAS servers available over a satelite link or something?</p>

		
				</div>
		</li><!-- #comment-## -->
		<li class="comment byuser comment-author-oldnewthing bypostauthor odd alt thread-odd thread-alt depth-1" id="comment-371793">
				<div id="div-comment-371793" class="comment-body">
				<div class="comment-author vcard">
						<cite class="fn"><a href='https://social.msdn.microsoft.com/profile/Raymond+Chen+-+MSFT' rel='external nofollow' class='url'>Raymond Chen - MSFT</a></cite> <span class="says">says:</span>		</div>
		
		<div class="comment-meta commentmetadata"><a href="https://blogs.msdn.microsoft.com/oldnewthing/20060419-14/?p=31473#comment-371793">
			April 19, 2006 at 6:18 pm</a>		</div>

		<p>Many companies have very high latency links; a half second is not unreasonable. The latency doesn&#8217;t depend on whether you are talking to a Windows XP workstation, a NAS box, a Windows 2000 server, or a Novell server. You don&#8217;t want to lose the benefits of fast mode when talking to a server that supports it.</p>

		
				</div>
		</li><!-- #comment-## -->
		<li class="comment byuser comment-author-maurits even thread-even depth-1" id="comment-371473">
				<div id="div-comment-371473" class="comment-body">
				<div class="comment-author vcard">
						<cite class="fn"><a href='https://social.msdn.microsoft.com/profile/Maurits+%5BMSFT%5D' rel='external nofollow' class='url'>Maurits [MSFT]</a></cite> <span class="says">says:</span>		</div>
		
		<div class="comment-meta commentmetadata"><a href="https://blogs.msdn.microsoft.com/oldnewthing/20060419-14/?p=31473#comment-371473">
			April 19, 2006 at 12:04 pm</a>		</div>

		<p>Have a field that allows the server to identify itself, by vendor name and version. &nbsp;Compare HTTP&#8217;s Server: header.</p>
<p>Build a database of workarounds like:</p>
<p>* Vendor Acme versions 3.4 through 3.9 have the bug where enumerating a directory with more than 128 files fails on the 129th query<br />
<br />* Vendor Bilix versions 12.7 through 12.11 have the bug where the long file name is reported incorrectly in the response packet<br />
<br />* Vendor Colefa versions &#8230;</p>
<p>Apply workarounds for the vendor/version/bugs in the database</p>
<p>Make sure to give the vendor an opportunity to put a cap on the version number with the bug so that future versions of their software are not fighting a permanent workaround</p>

		
				</div>
		</li><!-- #comment-## -->
		<li class="comment byuser comment-author-kjkhyperion odd alt thread-odd thread-alt depth-1" id="comment-371483">
				<div id="div-comment-371483" class="comment-body">
				<div class="comment-author vcard">
						<cite class="fn">KJK::Hyperion</cite> <span class="says">says:</span>		</div>
		
		<div class="comment-meta commentmetadata"><a href="https://blogs.msdn.microsoft.com/oldnewthing/20060419-14/?p=31473#comment-371483">
			April 19, 2006 at 12:07 pm</a>		</div>

		<p>vince, you have absolutely no bloody clue about the issue. The Samba people are kept updated about all such changes to the protocol by none other than Microsoft. They as a project own several copies of the Windows filesystem SDK</p>
<p>=====</p>
<p>&quot;Fast mode&quot; isn&#8217;t even an extension of the protocol, it&#8217;s just a new function code for the &quot;find first&quot; and &quot;find next&quot; operations, with its associated new data structure</p>
<p>Some specifics: the new function code is FileIdBothDirectoryInformation, and the associated structure is FILE_ID_BOTH_DIR_INFORMATION. The former is just a number &#8211; if they knew how to encode FileBothDirectoryInformation, they&#8217;d have no problem with the new one. The latter is FILE_BOTH_DIR_INFORMATION with an extra field, of fixed size. Again, if they supported FILE_BOTH_DIR_INFORMATION, they should have no problem supporting FILE_ID_BOTH_DIR_INFORMATION</p>
<p>(actually the new function codes are two, and the second is FileIdFullDirectoryInformation, but it doesn&#8217;t really matter, because the same considerations apply)</p>
<p>Some background: the new modes return the file inode alongside attributes, name, short name, etc. They were introduced in Windows XP (like anyone who doesn&#8217;t live in the fairytown of &quot;open protocols&quot; knew), I presume to support natively the UNIX readdir() function, following the commitment of Microsoft into Services For UNIX. The alternative to enumerate the files and their inodes had historically been to open each file, query for its inode, and close the file, which is much much much slower and cannot even be batched &#8211; hence &quot;slow mode&quot; and &quot;fast mode&quot;. I also have to assume that the inode is now used in Win32 as well, other than for the purpose of backups (BackupRead allowed you to retrieve the inode. In fact, BackupRead + BackupWrite used to be the only legal &#8211; if a bit roundabout &#8211; way to hard-link files before the official API)</p>
<p>=====</p>
<p>Information about *these* structures and constants is public and has been public for years now. Before it was, you could rely on the work of the likes of Gary Nebbet and Bo Branten, as all non-bigots like me did, proficiently. If you choose to be a &quot;purist&quot;, insisting that those structures are part of the CIFS &quot;protocol&quot; (rather than the mere serialization of Windows I/O constructs they actually are) and should be documented as such, that&#8217;s your own damn choice to be a stubborn idiot</p>
<p>=====</p>
<p>So, what was the bug about? a stupid, stupid oversight. A goddamn typo. The &quot;find next&quot; operation returned an error code (STATUS_INVALID_INFO_CLASS, meaning FileIdBothDirectoryInformation isn&#8217;t supported) that was only legal for &quot;find first&quot; (the &quot;checking the flag&quot; Raymond mentioned)</p>
<p>Whoever implemented FileIdBothDirectoryInformation (which was &#8211; ahem, &quot;open protocols&quot;, ahem &#8211; *inexplicably* implemented to begin with) forgot to add a case: to a switch(). A stupid copy-paste error. A honest mistake</p>
<p>Please stop blowing this out of proportion</p>

		
				</div>
		</li><!-- #comment-## -->
		<li class="comment even thread-even depth-1" id="comment-371823">
				<div id="div-comment-371823" class="comment-body">
				<div class="comment-author vcard">
						<cite class="fn">vince</cite> <span class="says">says:</span>		</div>
		
		<div class="comment-meta commentmetadata"><a href="https://blogs.msdn.microsoft.com/oldnewthing/20060419-14/?p=31473#comment-371823">
			April 19, 2006 at 8:42 pm</a>		</div>

		<blockquote><p>
  Many companies have very high latency links; a half<br />
  <br />&gt; second is not unreasonable. The latency doesn&#8217;t<br />
  <br />&gt; depend on whether you are talking to a Windows XP<br />
  <br />&gt; workstation, a NAS box, a Windows 2000 server, or a<br />
  <br />&gt; Novell server. You don&#8217;t want to lose the benefits<br />
  <br />&gt; of fast mode when talking to a server that supports<br />
  <br />&gt; it.</p>
<p>Well yes, but since it has been years and only now is Vista turning on this mode, it can&#8217;t be that much faster.</p>
<p>I&#8217;m an engineer&#8230; give me real world numbers, not worst case hand-waving estimates.</p>
<p>Say a person is copying 100 power-point files to the Z: drive. &nbsp;Say you run some sort of disk benchmark.<br />
  <br />Say you are doing a large compile of source off on a network drive. &nbsp;Give us numbers for stuff like that.</p>
<p>From your previous example it almsost sounded like the &quot;fast&quot; mode was added as a workaround to poor Explorer behavior, rather than because it really sped up the common case.</p>
<p>The sad point is, probably none of us posting here could post these benchmarks if we wanted to, it would probably void the EULA.
</p></blockquote>

		
				</div>
		</li><!-- #comment-## -->
		<li class="comment odd alt thread-odd thread-alt depth-1" id="comment-371623">
				<div id="div-comment-371623" class="comment-body">
				<div class="comment-author vcard">
						<cite class="fn">PaulJBis</cite> <span class="says">says:</span>		</div>
		
		<div class="comment-meta commentmetadata"><a href="https://blogs.msdn.microsoft.com/oldnewthing/20060419-14/?p=31473#comment-371623">
			April 19, 2006 at 1:45 pm</a>		</div>

		<p>And that quote, vince, would be relevant if the original bug had really been caused by lack of knowledge of CIFS specs, instead of by a Samba developer forgetting to add a case to a &quot;switch&quot;, *as Jeremy Allison himself mentioned*.</p>
<p>Yes, I know, I know, an OSS developer making a mistake on his own. Gosh, is that even possible?</p>

		
				</div>
		</li><!-- #comment-## -->
		<li class="comment byuser comment-author-oldnewthing bypostauthor even thread-even depth-1" id="comment-371833">
				<div id="div-comment-371833" class="comment-body">
				<div class="comment-author vcard">
						<cite class="fn"><a href='https://social.msdn.microsoft.com/profile/Raymond+Chen+-+MSFT' rel='external nofollow' class='url'>Raymond Chen - MSFT</a></cite> <span class="says">says:</span>		</div>
		
		<div class="comment-meta commentmetadata"><a href="https://blogs.msdn.microsoft.com/oldnewthing/20060419-14/?p=31473#comment-371833">
			April 19, 2006 at 9:06 pm</a>		</div>

		<p>vince: There is no real-world data for this specific issue because no beta version of Vista ever had &quot;slow mode inode queries&quot;. When inode queries were added, they were added the fast way.</p>
<p>I spent a half hour looking for something similar (you owe me a half hour of my life). One company computed that the extra Explorer network accesses on their network with 43ms latency was costing them US$35 million/year.<br /></p>

		
				</div>
		</li><!-- #comment-## -->
		<li class="comment odd alt thread-odd thread-alt depth-1" id="comment-371853">
				<div id="div-comment-371853" class="comment-body">
				<div class="comment-author vcard">
						<cite class="fn">Norman Diamond</cite> <span class="says">says:</span>		</div>
		
		<div class="comment-meta commentmetadata"><a href="https://blogs.msdn.microsoft.com/oldnewthing/20060419-14/?p=31473#comment-371853">
			April 19, 2006 at 10:52 pm</a>		</div>

		<p>You don&#8217;t need additional bits in the protocol, or version number, or anything like that.</p>
<p>The registry has enough space for users to use a Control Panel applet to store the usernames and passwords to be used in accessing servers. &nbsp;There is room in the registry to add 2 bits for each of these servers to remember if the user said to enable fast mode or to disable fast mode or didn&#8217;t say, and another 2 bits to remember if you&#8217;ve detected success or detected failure or not detected yet. &nbsp;As for what the default should be when the user didn&#8217;t say and you didn&#8217;t detect yet whether the server has this bug. &nbsp;I just know that there&#8217;s room to store what you need to store.</p>
<p>As for the badness of displaying error message boxes on unattended systems, well, don&#8217;t display an error message box when Windows Explorer isn&#8217;t browsing the affected server. &nbsp;If Windows Explorer is open and browsing then it&#8217;s slightly safer to assume that someone intends to attend.</p>
<p>Now, is it really possible to detect bugs, automatically store information in the registry, and publish articles telling users how to make adjustments? &nbsp;In your favourite version of Windows, how many times did I open regedit and delete a NOIDE flag? &nbsp;How did I know that this was the way to undo a decision that Windows had made when Windows detected something that it didn&#8217;t tell me about, but when I felt I had fixed the problem? &nbsp;The answer is yes it&#8217;s possible, and SOME Knowledge Base articles are properly written and properly findable.</p>

		
				</div>
		</li><!-- #comment-## -->
		<li class="comment even thread-even depth-1" id="comment-371713">
				<div id="div-comment-371713" class="comment-body">
				<div class="comment-author vcard">
						<cite class="fn">Kuwanger</cite> <span class="says">says:</span>		</div>
		
		<div class="comment-meta commentmetadata"><a href="https://blogs.msdn.microsoft.com/oldnewthing/20060419-14/?p=31473#comment-371713">
			April 19, 2006 at 4:10 pm</a>		</div>

		<p>&quot;Would you rather deal with situations like this?</p>
<p><a rel="nofollow" target="_new" href="http://news.zdnet.com/2100-3513_22-6061491.html" rel="nofollow">http://news.zdnet.com/2100-3513_22-6061491.html</a></p>
<p>James&quot;</p>
<p>Although not directed towards me, let me put in my own two cents on the subject of proprietary vs open drivers in an open OS. &nbsp;One can actually draw something of an analogy with the current situation here. &nbsp;The main problem, of course, is that samba had a bug in it. &nbsp;However, to correct this problem is difficult because hardware wasn&#8217;t designed to be upgraded. &nbsp;By analogy, many drivers have problems in them (bugs) and it&#8217;s very difficult to correct them because they&#8217;re proprietary. &nbsp;The end result is that there tends to be no clean solution.</p>
<p>At some point it becomes better to simply ignore the original hardware/drivers and start over with new hardware/drivers. &nbsp;Now, clearly not all hardware/drivers are buggy, but I think it&#8217;d be silly to claim most aren&#8217;t the case. &nbsp;But so long as there&#8217;s a simple means to update and fix those problems, it&#8217;s no longer a huge hurdle to overcome nor much reason to dump the hardware/drivers, that surely you&#8217;ve already invested a good bit of effort into, for something new that you will also have to invest greatly into.</p>
<p>It&#8217;s for this reason that I&#8217;m interested primarily into buying things that are open. &nbsp;While the open version might be buggier now, I won&#8217;t have to give up my investment at any point unless *I* choose to. &nbsp;In the long term, it will probably cost me less to go with more open systems. &nbsp;This is why things like DRMed hardware to only run signed binaries or ROM images that can&#8217;t be upgraded are bad.</p>
<p>Of course, if making drivers and ROMs work well was actually not actually an area that was most prone to cost cutting (as they&#8217;re a necessity, not money drivers), perhaps they&#8217;d be less prone to be buggy and I wouldn&#8217;t have to invest much other than money into them (my time is probably more valuable, considering how much time is truly worth to anyone). &nbsp;Until then, it doesn&#8217;t make sense to me to accept non-open software into things that they&#8217;ve such little vested interest in retaining proprietariness over. &nbsp;After all, I&#8217;m buying the physical 3D video card or the physical NAS; being obsessed enough about the software end to keep it closed ignores that the software is useless without the hardware and people are buying specific products chiefly because of said good hardware.</p>

		
				</div>
		</li><!-- #comment-## -->
		<li class="comment odd alt thread-odd thread-alt depth-1" id="comment-371723">
				<div id="div-comment-371723" class="comment-body">
				<div class="comment-author vcard">
						<cite class="fn"><a href='http://www.winstep.net' rel='external nofollow' class='url'>Jorge Coelho</a></cite> <span class="says">says:</span>		</div>
		
		<div class="comment-meta commentmetadata"><a href="https://blogs.msdn.microsoft.com/oldnewthing/20060419-14/?p=31473#comment-371723">
			April 19, 2006 at 4:33 pm</a>		</div>

		<p>In that Newsgroup post mentioned by Sean, Raymond said: &quot;You can say &#8216;It&#8217;s a bug in the application&#8217; as many times as you like to the customer; the customer won&#8217;t believe you.&quot;</p>
<p>Well, he might believe you, but deep inside he will really be thinking &#8216;So what? It&#8217;s Windows that crashes, not the other app, so _you_ fix it!&#8217;.</p>
<p>I have a similar problem: my applications need to browse file system and virtual folders. Suddenly some customers started complaining that the software was crashing when trying to browse the Windows Control Panel.</p>
<p>This usually indicates a corrupt control panel applet, but, in this particular case, Explorer itself seemed perfectly happy with it, instead of also crashing like it does (used to do?) with corrupt cpl files.</p>
<p>After many hours trying to track down the problem, I finaly found the pattern: every system with the problem was running a Control Panel applet from a very popular vendor of web cams, keyboards, mice, etc&#8230;</p>
<p>From there to figure out what was happening was relatively quick: when enumerating items in the Control Panel using the IShellFolder interface (isfFolder.EnumObjects, isEnumIds.Next, isfFolder.GetDisplayNameOf, etc&#8230;) at *some point* the vendor&#8217;s Control Panel applet corrupts my stack. </p>
<p>Everything runs fine UNTIL my enumeration routine tries to return to it&#8217;s caller &#8211; at that point the application just crashes (it doesn&#8217;t even report an error, just disappears) because the return address in the stack has been blasted to oblivion.</p>
<p>I&#8217;ve tried a couple of other applications (not mine) and they also crash when trying to display the contents of the Control Panel, so I&#8217;m sure it&#8217;s not a problem with my code.</p>
<p>Now the big problem: since Explorer is able to defend itself from this kind of stack corruption and doesn&#8217;t crash, who do you think the user is going to blame? Worse, since Windows is apparently immune to this problem, the vendor has absolutely no incentive to fix this bug in their control panel applet.</p>
<p>Because this is a very popular hardware vendor (which means a lot of my existing and potential customers will be running their buggy Control Panel applet), I tried contacting them through normal support channels, and, needless to say, I got nowhere &#8211; but, even if I had and the vendor fixed the problem, there would still be a lot of buggy old versions of that control panel applet floating around.</p>
<p>With my software being written in Visual Basic, I currently haven&#8217;t got a clue on how to protect my stack from rogue Control Panel DLLs. So at least for the moment, I&#8217;m stuck. </p>
<p>If only Windows, instead of &#8216;pretending&#8217; the problem isn&#8217;t there with some clever hack, crashed as my applications and the others do, then the vendor would have found and fixed the problem long before it started shipping its buggy Control Panel applet!</p>

		
				</div>
		</li><!-- #comment-## -->
		<li class="comment even thread-even depth-1" id="comment-371863">
				<div id="div-comment-371863" class="comment-body">
				<div class="comment-author vcard">
						<cite class="fn">Jonathan Wilson</cite> <span class="says">says:</span>		</div>
		
		<div class="comment-meta commentmetadata"><a href="https://blogs.msdn.microsoft.com/oldnewthing/20060419-14/?p=31473#comment-371863">
			April 20, 2006 at 12:02 am</a>		</div>

		<p>Here is how I would deal with the origonal bug that started this series.</p>
<p>From what I can tell, what happens is this:<br />
<br />1.Some program asks windows to go get the directory listing for a network drive<br />
<br />2.Windows asks the (buggy) server if it supports fast mode and the server says yes.<br />
<br />3.Windows sends a fast mode query to the server.<br />
<br />4.The server returns some records<br />
<br />5.Windows returns something to the application<br />
<br />6.The application iterates through and asks windows for the next record then processes that then asks for the next record then processes it and so on<br />
<br />7.This continues on untill a request is made and windows suddenly says &quot;I have run out of records&quot;. Presumably at this point (before it returns to the caller) windows will be able to detect that it is talking to the buggy server.<br />
<br />Also, I am assuming windows knows how many records it has returned and where in the list it is.</p>
<p>The fix is, once windows detects the buggy server, to request the records again in slow mode. Once it has the records, it can skip past the records it has already returned to the application. Then, it can return the item the application would have been given had the server not had the bug. And then things can continue.<br /></p>

		
				</div>
		</li><!-- #comment-## -->
		<li class="comment odd alt thread-odd thread-alt depth-1" id="comment-371753">
				<div id="div-comment-371753" class="comment-body">
				<div class="comment-author vcard">
						<cite class="fn"><a href='http://samba.org/~jra' rel='external nofollow' class='url'>Jeremy Allison</a></cite> <span class="says">says:</span>		</div>
		
		<div class="comment-meta commentmetadata"><a href="https://blogs.msdn.microsoft.com/oldnewthing/20060419-14/?p=31473#comment-371753">
			April 19, 2006 at 5:31 pm</a>		</div>

		<p>Here we go again&#8230;.</p>
<p>KJK::Hyperion wrote :</p>
<p>&quot;The Samba people are kept updated about all such changes to the protocol by none other than Microsoft.&quot;</p>
<p>Not true anymore. We used to be quite close with SMB development (I still happily have my &quot;Microsoft Confidential&quot; copy of the NT SMB specs here in front of me) but that isn&#8217;t true anymore. Others can speculate as to why this is.</p>
<p>Joe Butler wrote :</p>
<p>&quot;It was also pointed out by someone else, that the 3 minutes or so end-to-end fix time seemed suspicously fast, if it included testing, etc. &nbsp;Read between the lines of that comment and it might show the real reason such errors creep in. &quot;</p>
<p>Oh for heavens sake. Have you never looked at a bug report and realized *exactly* what your cut-and-paste error was ? That was the 3 minutes to closure. It was such an obvious bug reported by a long-time collaborator that I trusted him to re-open the bug if it didn&#8217;t fix his problem. Later an extension to smbtorture was added to prevent regressions.</p>
<p>Here&#8217;s a link to the description of the problem :</p>
<p><a rel="nofollow" target="_new" href="https://bugzilla.samba.org/show_bug.cgi?id=3526" rel="nofollow">https://bugzilla.samba.org/show_bug.cgi?id=3526</a></p>
<p>and here (again) is the fix tridge proposed for Vista. Works fine, just needs someone to implement it.</p>
<p>From tridge:</p>
<p>&quot;If we had run across the error you<br />
<br />described (INVALID_LEVEL from a continue)<br />
<br />then we would have added a bit flag on the<br />
<br />current connection structure to mark this<br />
<br />connection so it won&#8217;t use that level in<br />
<br />future, then repeat the search using a<br />
<br />different level. That means you would get<br />
<br />one useless search on the network with each<br />
<br />connection to a buggy server, but no impact<br />
<br />against non-buggy servers and no user observable<br />
<br />affects. The denial of service attack you<br />
<br />mention with this type of fix doesn&#8217;t happen<br />
<br />as the extra bit is per-connection, not long<br />
<br />lived (trying to remember long lived info<br />
<br />about specific servers is a losing game).&quot; </p>
<p>Jeremy.<br /></p>

		
				</div>
		</li><!-- #comment-## -->
		<li class="comment even thread-even depth-1" id="comment-371883">
				<div id="div-comment-371883" class="comment-body">
				<div class="comment-author vcard">
						<cite class="fn">bramster</cite> <span class="says">says:</span>		</div>
		
		<div class="comment-meta commentmetadata"><a href="https://blogs.msdn.microsoft.com/oldnewthing/20060419-14/?p=31473#comment-371883">
			April 20, 2006 at 1:07 am</a>		</div>

		<p>Raymond. . .</p>
<p>you are one smart dude!</p>

		
				</div>
		</li><!-- #comment-## -->
		<li class="comment odd alt thread-odd thread-alt depth-1" id="comment-371893">
				<div id="div-comment-371893" class="comment-body">
				<div class="comment-author vcard">
						<cite class="fn">AC</cite> <span class="says">says:</span>		</div>
		
		<div class="comment-meta commentmetadata"><a href="https://blogs.msdn.microsoft.com/oldnewthing/20060419-14/?p=31473#comment-371893">
			April 20, 2006 at 2:30 am</a>		</div>

		<p>I think the solution is clear. The automotive industry invented vehicle identification numbers. We just need Software Identification Numbers. Every api from hereon out will take an additional SIN parameter, which can be defined as follows:<br />
<br />struct SoftwareIdentificationNumber<br />
<br />{<br />
<br />GUID guid<br />
<br />int version_major<br />
<br />int version_minor<br />
<br />int version_build<br />
<br />int version_revision<br />
<br />SYSTEMTIME releasedate<br />
<br />SYSTEMTIME builddate<br />
<br />DWORD vendorID<br />
<br />DWORD productID<br />
<br />DWORD revisionID<br />
<br />DWORD reserved1<br />
<br />DWORD reserved2<br />
<br />DWORD reserved3<br />
<br />};<br />
<br />This way, instead of having this discussion we could&#8217;ve simply checked if the vendor/product/revision indicated that it was a particular type of buggy server, verified that the build date was before the bug was fixed, and decide to use the slow mode instead. Or we could decide that buggy implementations of undocumented protocols are not to be supported (doubly so for documented protocols), put out a KB article, and be done with it&#8230;</p>

		
				</div>
		</li><!-- #comment-## -->
		<li class="comment byuser comment-author-dean-harding even thread-even depth-1" id="comment-371813">
				<div id="div-comment-371813" class="comment-body">
				<div class="comment-author vcard">
						<cite class="fn"><a href='https://social.msdn.microsoft.com/profile/Dean+Harding' rel='external nofollow' class='url'>Dean Harding</a></cite> <span class="says">says:</span>		</div>
		
		<div class="comment-meta commentmetadata"><a href="https://blogs.msdn.microsoft.com/oldnewthing/20060419-14/?p=31473#comment-371813">
			April 19, 2006 at 7:56 pm</a>		</div>

		<p>Jorge: It&#8217;s possible that Windows actually isn&#8217;t doing anything specific to work around the problem, but just that their stack *happens* to be set up in such a way that the problem doesn&#8217;t appear. It&#8217;s quite possible, since I presume Logit- uh, the &quot;vendor&quot; only tested with Explorer.</p>

		
				</div>
		</li><!-- #comment-## -->
		<li class="comment odd alt thread-odd thread-alt depth-1" id="comment-371903">
				<div id="div-comment-371903" class="comment-body">
				<div class="comment-author vcard">
						<cite class="fn">Amos Houndsbreath</cite> <span class="says">says:</span>		</div>
		
		<div class="comment-meta commentmetadata"><a href="https://blogs.msdn.microsoft.com/oldnewthing/20060419-14/?p=31473#comment-371903">
			April 20, 2006 at 4:50 am</a>		</div>

		<p>I think SIN&#8217;s are part of the solution, but won&#8217;t SAMBA just claim to be Windows XP or whatever the &#8216;right&#8217; answer?</p>
<p>I think you need to have some cryptographically secure way to see if it&#8217;s a trusted implementation &#8211; i.e. one from inside Microsoft or a licensed implemenation based on MS code and tested in the HQL labs, or an untrusted one. Put the untrusted ones in legacy mode, i.e. slow (XP speed) but reliable. The trusted ones will get the best possible performance based on the version level they report.</p>
<p>It&#8217;s just like drivers need to be signed before they can be run, and the signing is tied to automatic testing. Hell if Microsoft are feeling generous (or scared of lawyers) they could offer to sign third party SMB implementations for a nominal fee after they&#8217;ve been tested.</p>

		
				</div>
		</li><!-- #comment-## -->
		<li class="comment even thread-even depth-1" id="comment-371913">
				<div id="div-comment-371913" class="comment-body">
				<div class="comment-author vcard">
						<cite class="fn">Paul</cite> <span class="says">says:</span>		</div>
		
		<div class="comment-meta commentmetadata"><a href="https://blogs.msdn.microsoft.com/oldnewthing/20060419-14/?p=31473#comment-371913">
			April 20, 2006 at 4:55 am</a>		</div>

		<p>Jonathan Wilson: The problem Raymond is trying to address is that currently there is no way for a server to identify itself as supporting fast mode, therefore no point in asking. If there was a mechanism introduced then none of the existing software, even the ones that did work, would report false until they have been updated. If a bug is present that prevents them working they may still report true anyway&#8230;</p>
<p>Your point 7 is the original problem (as far as I can see) &#8211; the server says it has no more records to return despite the existence of further directory entries. This doesn&#8217;t seem to offer a way for windows to magically detect the existence of a buggy server.</p>

		
				</div>
		</li><!-- #comment-## -->
		<li class="comment byuser comment-author-cheong odd alt thread-odd thread-alt depth-1" id="comment-371923">
				<div id="div-comment-371923" class="comment-body">
				<div class="comment-author vcard">
						<cite class="fn"><a href='https://social.msdn.microsoft.com/profile/cheong00' rel='external nofollow' class='url'>cheong00</a></cite> <span class="says">says:</span>		</div>
		
		<div class="comment-meta commentmetadata"><a href="https://blogs.msdn.microsoft.com/oldnewthing/20060419-14/?p=31473#comment-371923">
			April 20, 2006 at 5:17 am</a>		</div>

		<p>Just some thought: While we do not have any indicator for systems that DON&#8217;T work, we have pretty reliable indicator(The &quot;operating system&quot; information for domain machine account, which Samba server don&#8217;t fill it) for machines that DO work.</p>
<p>Perheps just popup warnings when running fastmode on systems that do not return &quot;operating system&quot; information will do. </p>
<p>And then just tell the Samba developer to add that information (Perheps &quot;samba X.X.XX&quot;) when registering machine account will be sufficient for advertising the &quot;new version which don&#8217;t have this bug&quot;, and it helps to identify the version if other bugs presents too.<br /></p>

		
				</div>
		</li><!-- #comment-## -->
		<li class="comment even thread-even depth-1" id="comment-371953">
				<div id="div-comment-371953" class="comment-body">
				<div class="comment-author vcard">
						<cite class="fn">Ilya</cite> <span class="says">says:</span>		</div>
		
		<div class="comment-meta commentmetadata"><a href="https://blogs.msdn.microsoft.com/oldnewthing/20060419-14/?p=31473#comment-371953">
			April 20, 2006 at 8:03 am</a>		</div>

		<p>From what I understand, while you cannot distinct various versions of SAMBA based on their handshake, you can distinct SAMBA and Windows. If so, why not assume all Windows servers are Fast-Mode compatible and all SAMBA servers are not, until they provide an extended handshake (e.g. identify by the name of &quot;SAMBA-Foobar&quot; or append a version number).</p>
<p>As to the issue of an arrogant programmer passing 0xFFFFFFFF in the compatibility flags field, that&#8217;s the reason why I&#8217;d make it represent versions instead and make the Vista client aware of quirks in certain versions of certain products. It bloats the client a bit, but at least you remain in control.</p>

		
				</div>
		</li><!-- #comment-## -->
		<li class="comment odd alt thread-odd thread-alt depth-1" id="comment-371963">
				<div id="div-comment-371963" class="comment-body">
				<div class="comment-author vcard">
						<cite class="fn">BryanK</cite> <span class="says">says:</span>		</div>
		
		<div class="comment-meta commentmetadata"><a href="https://blogs.msdn.microsoft.com/oldnewthing/20060419-14/?p=31473#comment-371963">
			April 20, 2006 at 8:44 am</a>		</div>

		<p>Paul: No, it doesn&#8217;t say &quot;it has no more records to return despite the existence of further directory entries&quot;. &nbsp;Instead, it returns an error to the second packet that it sees.</p>
<p>From what I can tell, this is how it works (if this isn&#8217;t how it works, it should be how it works; clean separation of code and all that):</p>
<p>User code calls NtQueryDirectoryFile with some set of parameters to indiciate &quot;I just want the first one&quot;. &nbsp;The OS asks the redirector for one file. &nbsp;The redirector asks the server for 128 files in one batch, and sticks them all into a buffer. &nbsp;It then returns the first result out of the buffer. &nbsp;Then the program asks for the next result, and the next, and so on, with the first 128 results in total coming out of the redirector&#8217;s buffer.</p>
<p>When the program asks for the 129th result, the OS asks the redirector, just like always. &nbsp;But instead of returning stuff from the buffer, the redirector goes back to the server with an SMBfindnext packet &#8212; and the response from the server to this second packet is an error.</p>
<p>(The handler in Samba for the SMBfindfirst packet type had support for the information level that Vista is requesting, but the handler for the SMBfindnext packet type did not.)</p>
<p>Ilya, AC: Making a database of &quot;broken versions&quot; has problems other than bloat. &nbsp;What is Windows supposed to do if no fixed version exists when it&#8217;s released? &nbsp;Windows can&#8217;t see into the future; it doesn&#8217;t know that version Y will work when version Y doesn&#8217;t exist yet. &nbsp;Sure, patches may work for that, but do you really want to be patching app-compat databases for the rest of your OS&#8217;s life? &nbsp;And who&#8217;s going to force people to provide a correct SIN structure when calling APIs, versus just copying the SIN structure that worked in the past for some other unrelated program? &nbsp;Or some program made by some other company even?</p>
<p>Rule Number One of JavaScript / DOM programming in the browser: &nbsp;NEVER base your behavior on user-agent strings or other methods of browser detection. &nbsp;JS supports detection of whether certain methods exist; use that type of feature detection instead of browser detection. &nbsp;(Well, whenever possible at least. &nbsp;In some cases, you can&#8217;t tell by the existence of a property or method; the bug you&#8217;re seeing has more to do with the function you&#8217;re calling doesn&#8217;t do what the DOM standard says it should do. &nbsp;But that&#8217;s rare.)</p>
<p>In this case, the redirector can detect the error by sending an SMBfindfirst / SMBfindnext pair on the first request from a program, instead of only sending an SMBfindfirst. &nbsp;(If it can&#8217;t because of the architecture of the OS / redirector interface, then that architecture is bad; there isn&#8217;t a clean-enough separation between components.) &nbsp;Then the redirector would not return anything until the SMBfindnext succeeds. &nbsp;Yes, this is one more round trip (and even one more for broken servers, but they should be rare), but it&#8217;s the only good way to detect this particular bug.</p>

		
				</div>
		</li><!-- #comment-## -->
		<li class="comment even thread-even depth-1" id="comment-371983">
				<div id="div-comment-371983" class="comment-body">
				<div class="comment-author vcard">
						<cite class="fn">vince</cite> <span class="says">says:</span>		</div>
		
		<div class="comment-meta commentmetadata"><a href="https://blogs.msdn.microsoft.com/oldnewthing/20060419-14/?p=31473#comment-371983">
			April 20, 2006 at 9:50 am</a>		</div>

		<blockquote><p>
  I spent a half hour looking for<br />
  <br />&gt; something similar (you owe me a half &gt; hour of my life).</p>
<p>Well considering how many hours of my life have been wasted dealing with MS software, I think you still have the advantage on me&#8230;</p>
<p>&gt; One company computed that the extra<br />
  <br />&gt; Explorer network accesses on their<br />
  <br />&gt; network with 43ms latency was<br />
  <br />&gt; costing them US$35 million/year.</p>
<p>I wonder how much that compares to the cost they had to spend on anti-virus and anti-malware due to other bugs with MS software? &nbsp;Total Cost of Ownership is a complicated equation it seems.</p>
<p>In any case, I re-read the posts making sure I didn&#8217;t miss more detailed bandwidth info, and I&#8217;ve changed my mind and decided this series is useful afterall, if only because it is eye-opening to see how many people posting here have a lot to learn about systems programming.</p>
<p>Problems like this happen often, one example with linux was the ECN bit that helped reduce network congestion&#8230; only to turn out that most CISCO routers couldn&#8217;t handle it and would just throw out packets with the bit set. &nbsp;</p>
<p>It takes a lot of patience and time to get bugs like this fixed properly.<br />
  
</p></blockquote>

		
				</div>
		</li><!-- #comment-## -->
		<li class="comment byuser comment-author-oldnewthing bypostauthor odd alt thread-odd thread-alt depth-1" id="comment-372023">
				<div id="div-comment-372023" class="comment-body">
				<div class="comment-author vcard">
						<cite class="fn"><a href='https://social.msdn.microsoft.com/profile/Raymond+Chen+-+MSFT' rel='external nofollow' class='url'>Raymond Chen - MSFT</a></cite> <span class="says">says:</span>		</div>
		
		<div class="comment-meta commentmetadata"><a href="https://blogs.msdn.microsoft.com/oldnewthing/20060419-14/?p=31473#comment-372023">
			April 20, 2006 at 10:17 am</a>		</div>

		<p>vince: Was it me personally who cost you those hours? If not, then don&#8217;t take it out on me.</p>

		
				</div>
		</li><!-- #comment-## -->
		<li class="comment even thread-even depth-1" id="comment-372053">
				<div id="div-comment-372053" class="comment-body">
				<div class="comment-author vcard">
						<cite class="fn">peterchen</cite> <span class="says">says:</span>		</div>
		
		<div class="comment-meta commentmetadata"><a href="https://blogs.msdn.microsoft.com/oldnewthing/20060419-14/?p=31473#comment-372053">
			April 20, 2006 at 11:05 am</a>		</div>

		<p>raymond: re &quot;You upgrade to Vista and your performance drops.&quot; &#8211;<br />
<br />But the applicaitons that use a fast protocol run &quot;happily&quot; only until it hits a location with &gt;128 files (?!). So these old apps don&#8217;t really work very well &nbsp;&#8211; maybe it&#8217;s this tradeoff (working fast for most users broken for few vs. working slow for all until everything is upgraded) you shun. </p>
<p>(sorry for being so insisting.)</p>
<p>BTW.<br />
<br />I&#8217;ve bookmarked the original post under &quot;Why Windows is so complicated&quot; &#8211; and I think Microsoft desparately needs a few more guys like Raymond. Software problems don&#8217;t end at checkin.</p>

		
				</div>
		</li><!-- #comment-## -->
		<li class="comment byuser comment-author-oldnewthing bypostauthor odd alt thread-odd thread-alt depth-1" id="comment-372073">
				<div id="div-comment-372073" class="comment-body">
				<div class="comment-author vcard">
						<cite class="fn"><a href='https://social.msdn.microsoft.com/profile/Raymond+Chen+-+MSFT' rel='external nofollow' class='url'>Raymond Chen - MSFT</a></cite> <span class="says">says:</span>		</div>
		
		<div class="comment-meta commentmetadata"><a href="https://blogs.msdn.microsoft.com/oldnewthing/20060419-14/?p=31473#comment-372073">
			April 20, 2006 at 11:38 am</a>		</div>

		<p>peterchen: If you change the protocol to require all servers to set the &quot;I am not buggy&quot; bit as proposed here, then when you connect to an old non-buggy server (i.e., one that doesn&#8217;t set the &quot;I am not buggy&quot; bit because it didn&#8217;t need to before), Vista will run in slow mode, whereas XP will run in fast mode.</p>

		
				</div>
		</li><!-- #comment-## -->
		<li class="comment even thread-even depth-1" id="comment-372093">
				<div id="div-comment-372093" class="comment-body">
				<div class="comment-author vcard">
						<cite class="fn"><a href='http://ilyabirman.ru' rel='external nofollow' class='url'>Ilya Birman</a></cite> <span class="says">says:</span>		</div>
		
		<div class="comment-meta commentmetadata"><a href="https://blogs.msdn.microsoft.com/oldnewthing/20060419-14/?p=31473#comment-372093">
			April 20, 2006 at 1:00 pm</a>		</div>

		<blockquote><p>
  I should give up on this series</p>
<p>Raymond, please don&#8217;t, this is very interesting :-) What you could do, however, is give link to previous articles like &quot;make sure you read this, this and this before continueing&quot;.
</p></blockquote>

		
				</div>
		</li><!-- #comment-## -->
		<li class="comment byuser comment-author-oldnewthing bypostauthor odd alt thread-odd thread-alt depth-1" id="comment-372123">
				<div id="div-comment-372123" class="comment-body">
				<div class="comment-author vcard">
						<cite class="fn"><a href='https://social.msdn.microsoft.com/profile/Raymond+Chen+-+MSFT' rel='external nofollow' class='url'>Raymond Chen - MSFT</a></cite> <span class="says">says:</span>		</div>
		
		<div class="comment-meta commentmetadata"><a href="https://blogs.msdn.microsoft.com/oldnewthing/20060419-14/?p=31473#comment-372123">
			April 20, 2006 at 1:51 pm</a>		</div>

		<p>peterchen: Most servers support fast mode fine. That&#8217;s why the problem was found only recently. If no servers supported fast mode, then the bug would&#8217;ve been found as soon as Explorer switched to using fast mode!</p>

		
				</div>
		</li><!-- #comment-## -->
		<li class="comment even thread-even depth-1" id="comment-372143">
				<div id="div-comment-372143" class="comment-body">
				<div class="comment-author vcard">
						<cite class="fn"><a href='http://piffie.net/bog' rel='external nofollow' class='url'>Christoph Richter</a></cite> <span class="says">says:</span>		</div>
		
		<div class="comment-meta commentmetadata"><a href="https://blogs.msdn.microsoft.com/oldnewthing/20060419-14/?p=31473#comment-372143">
			April 20, 2006 at 2:07 pm</a>		</div>

		<p>theres not really a chance to make it best afterwards&#8230;. the only thing you can do at beginning when making an api to externals is passing in an sort of an User agent string at the handshake. and the newer client can, if he want, take care of an &quot;buggy&quot; version or program.</p>

		
				</div>
		</li><!-- #comment-## -->
		<li class="comment odd alt thread-odd thread-alt depth-1" id="comment-372183">
				<div id="div-comment-372183" class="comment-body">
				<div class="comment-author vcard">
						<cite class="fn">vince</cite> <span class="says">says:</span>		</div>
		
		<div class="comment-meta commentmetadata"><a href="https://blogs.msdn.microsoft.com/oldnewthing/20060419-14/?p=31473#comment-372183">
			April 20, 2006 at 6:07 pm</a>		</div>

		<blockquote><p>
  vince: Was it me personally who cost<br />
  <br />&gt; you those hours? If not, then don&#8217;t<br />
  <br />&gt; take it out on me.</p>
<p>Was it my fault you didn&#8217;t have actual numbers on hand for the performance slowdown this causes?</p>
<p>I&#8217;m still curious on the numbers, as I&#8217;m still worried this is a case of premature optimization.</p>
<p>I&#8217;m willing to belive this is a huge problem, I just would like it quantified a bit more. &nbsp;It doesn&#8217;t look like anyone has such numbers available, so I&#8217;ll just leave it at that.<br />
  
</p></blockquote>

		
				</div>
		</li><!-- #comment-## -->
		<li class="comment byuser comment-author-oldnewthing bypostauthor even thread-even depth-1" id="comment-372193">
				<div id="div-comment-372193" class="comment-body">
				<div class="comment-author vcard">
						<cite class="fn"><a href='https://social.msdn.microsoft.com/profile/Raymond+Chen+-+MSFT' rel='external nofollow' class='url'>Raymond Chen - MSFT</a></cite> <span class="says">says:</span>		</div>
		
		<div class="comment-meta commentmetadata"><a href="https://blogs.msdn.microsoft.com/oldnewthing/20060419-14/?p=31473#comment-372193">
			April 20, 2006 at 6:12 pm</a>		</div>

		<p>Vince: I&#8217;m sorry, I didn&#8217;t realize this was a peer-reviewed journal. I thought it was a blog.</p>

		
				</div>
		</li><!-- #comment-## -->
		<li class="comment odd alt thread-odd thread-alt depth-1" id="comment-372063">
				<div id="div-comment-372063" class="comment-body">
				<div class="comment-author vcard">
						<cite class="fn">8</cite> <span class="says">says:</span>		</div>
		
		<div class="comment-meta commentmetadata"><a href="https://blogs.msdn.microsoft.com/oldnewthing/20060419-14/?p=31473#comment-372063">
			April 20, 2006 at 11:12 am</a>		</div>

		<p>James Summerlin: Just running an proprietary operating system is NOT a solution for proprietary drivers. And I do not worry about having a proprietary nVidia driver more then a weekly/monthly couple of minutes or so. There is nothing in the GNU GPL preventing me from using an nVidia or ATi driver also. It also does not prevent mere aggegration of those drivers on a given storage media. It *does* prevent GNU/Linux distributors to ship a kernel and Xorg with those drivers if they wanted to, provided nVidia and ATi agree as well. ZDnet covered an issue in great detail, perhaps that made the problem appear like big thing for all GNU/Linux users and developers to you, but in reality it isn&#8217;t. Eggagerated articles draw more attention, that&#8217;s a simple journalistic fact. The problem exists, sure, but you don&#8217;t have to worry about it. From personal experience, I find Linux better because I don&#8217;t have to install a driver for every PCI card I throw at it, only video acceleration.</p>

		
				</div>
		</li><!-- #comment-## -->
		<li class="comment even thread-even depth-1" id="comment-372113">
				<div id="div-comment-372113" class="comment-body">
				<div class="comment-author vcard">
						<cite class="fn">peterchen</cite> <span class="says">says:</span>		</div>
		
		<div class="comment-meta commentmetadata"><a href="https://blogs.msdn.microsoft.com/oldnewthing/20060419-14/?p=31473#comment-372113">
			April 20, 2006 at 1:41 pm</a>		</div>

		<p>So there *are* servers where fast mode is working correctly? *Now* I understand your problem :) </p>
<p>I simply assumed the broken server was the first time fast mode ever worked (more or less, in which case &quot;now really works&quot; is protocol change enough to warrant a flag/version check). &nbsp;&#8211; &nbsp;Sorry I missed this.</p>
<p>&gt; I should give up on this series<br />
<br />please don&#8217;t. My vote now goes for &quot;Requery in slow mode if the error occurs&quot;, and I&#8217;m looking forward to you picking it apart. </p>

		
				</div>
		</li><!-- #comment-## -->
		<li class="comment odd alt thread-odd thread-alt depth-1" id="comment-372243">
				<div id="div-comment-372243" class="comment-body">
				<div class="comment-author vcard">
						<cite class="fn">Heh?</cite> <span class="says">says:</span>		</div>
		
		<div class="comment-meta commentmetadata"><a href="https://blogs.msdn.microsoft.com/oldnewthing/20060419-14/?p=31473#comment-372243">
			April 21, 2006 at 3:02 am</a>		</div>

		<blockquote><p>
  Vista will run in slow mode, whereas XP will run in fast mode</p>
<p>You mean Vista will get the correct results and XP quite possibly won&#8217;t? Is Samba support so deeply integrated into XP that it couldn&#8217;t be updated through Windows Update?
</p></blockquote>

		
				</div>
		</li><!-- #comment-## -->
		<li class="comment byuser comment-author-oldnewthing bypostauthor even thread-even depth-1" id="comment-372323">
				<div id="div-comment-372323" class="comment-body">
				<div class="comment-author vcard">
						<cite class="fn"><a href='https://social.msdn.microsoft.com/profile/Raymond+Chen+-+MSFT' rel='external nofollow' class='url'>Raymond Chen - MSFT</a></cite> <span class="says">says:</span>		</div>
		
		<div class="comment-meta commentmetadata"><a href="https://blogs.msdn.microsoft.com/oldnewthing/20060419-14/?p=31473#comment-372323">
			April 21, 2006 at 11:38 am</a>		</div>

		<p>&quot;You mean Vista will get the correct results and XP quite possibly won&#8217;t?&quot;</p>
<p>That&#8217;s not what the customer sees. The customer sees their program that worked just fine on XP (because they used a non-buggy server) slow to a crawl on Vista.</p>

		
				</div>
		</li><!-- #comment-## -->
		<li class="comment odd alt thread-odd thread-alt depth-1" id="comment-372343">
				<div id="div-comment-372343" class="comment-body">
				<div class="comment-author vcard">
						<cite class="fn"><a href='http://mailto:blogcomments@biel.us' rel='external nofollow' class='url'>kbiel</a></cite> <span class="says">says:</span>		</div>
		
		<div class="comment-meta commentmetadata"><a href="https://blogs.msdn.microsoft.com/oldnewthing/20060419-14/?p=31473#comment-372343">
			April 21, 2006 at 12:16 pm</a>		</div>

		<p>Joe Butler&gt;&gt; Remove all compatibility fixes in your OS (the ones that insulate you from bugs in other software/hardware). &nbsp;Replace them all with &#8216;non-scary&#8217; dialogs.</p>
<p>Thanks for the strawman, but I&#8217;ll pass. &nbsp;There are obviously bugs that the user never needs to know existed and can silently be corrected. &nbsp;On the other hand, Raymond has set this up as a bug that will effect a user and can not be easily corrected silently.</p>
<p>paul&gt;&gt; Putting the user in charge only works if there is a user! Displaying a confirmation dialog assumes that if a user existed they would know what decision to take&#8230;</p>
<p>You bring up a valid point I hadn&#8217;t considered. &nbsp;Then again MS is not adverse to taking the dialog route and just pumping the dialog message into the event log. &nbsp;Check your application event log and you&#8217;re likely to find something similar:</p>
<p>Event Type: Error<br />
<br />Event Source:   Userenv<br />
<br />Event Category: None<br />
<br />Event ID:   1058<br />
<br />Date:       4/21/2006<br />
<br />Time:       10:42:41 AM<br />
<br />User:       XXXXXXkbiel<br />
<br />Computer:   XXXXXXXXXXXXXX<br />
<br />Description:<br />
<br />Windows cannot access the file gpt.ini for GPO CN={XXXXXXXX-XXXX-XXXX-XXXX-XXXXXXXXXXXX},CN=Policies,CN=System,DC=corp,DC=XXXXXXXXXXXX,DC=XXX. The file must be present at the location &lt;\XXXXXXXXXXXSysVolXXXXXXXXXXXXXPolicies{XXXXXXXX-XXXX-XXXX-XXXX-XXXXXXXXXXXX}gpt.ini&gt;. (The network path was not found. ). Group Policy processing aborted. </p>
<p>For more information, see Help and Support Center at <a rel="nofollow" target="_new" href="http://go.microsoft.com/fwlink/events.asp" rel="nofollow">http://go.microsoft.com/fwlink/events.asp</a>.<br /></p>

		
				</div>
		</li><!-- #comment-## -->
		<li class="comment even thread-even depth-1" id="comment-372393">
				<div id="div-comment-372393" class="comment-body">
				<div class="comment-author vcard">
						<cite class="fn"><a href='http://www.codedazure.com/' rel='external nofollow' class='url'>David Conrad</a></cite> <span class="says">says:</span>		</div>
		
		<div class="comment-meta commentmetadata"><a href="https://blogs.msdn.microsoft.com/oldnewthing/20060419-14/?p=31473#comment-372393">
			April 21, 2006 at 1:37 pm</a>		</div>

		<p>KJK::Hyperion:<br />
<br />&gt; &quot;Fast mode&quot; isn&#8217;t even an extension of the<br />
<br />&gt; protocol, it&#8217;s just a new function code for<br />
<br />&gt; the &quot;find first&quot; and &quot;find next&quot; operations,<br />
<br />&gt; with its associated new data structure</p>
<p>If new features aren&#8217;t an extension of the protocol, what would constitute an extension of the protocol, in your view?</p>
<p>Vince: Raymond did look for some numbers for you. On the other hand, he didn&#8217;t find any, so that&#8217;s not really worth much. I propose the following solution: in payment, you Fedex him a shiny copper penny.</p>
<p>But please don&#8217;t Fedex it in &quot;fast mode&quot;; fast mode is buggy in the current version of Fedex.</p>
<p>Now can we ring down the curtain on this reenactment of The Rape of the Lock?</p>

		
				</div>
		</li><!-- #comment-## -->
		<li class="comment odd alt thread-odd thread-alt depth-1" id="comment-372423">
				<div id="div-comment-372423" class="comment-body">
				<div class="comment-author vcard">
						<cite class="fn">James Risto</cite> <span class="says">says:</span>		</div>
		
		<div class="comment-meta commentmetadata"><a href="https://blogs.msdn.microsoft.com/oldnewthing/20060419-14/?p=31473#comment-372423">
			April 21, 2006 at 2:45 pm</a>		</div>

		<p>Sir, I am confused. Your original article said &quot;XP always used the slow query&quot;. Yet your comments here say &quot;upgrade to Vista and your performance drops&quot;. I don&#8217;t get it.</p>
<p>Anyway, seems like a swamp. If we don&#8217;t want Vista to get blamed for that buggy-fast-mode server, then we do nothing and continue to use slow mode. Maybe a KB article for sysadmins to do something different if they know their environment is ok.</p>

		
				</div>
		</li><!-- #comment-## -->
		<li class="comment byuser comment-author-oldnewthing bypostauthor even thread-even depth-1" id="comment-372443">
				<div id="div-comment-372443" class="comment-body">
				<div class="comment-author vcard">
						<cite class="fn"><a href='https://social.msdn.microsoft.com/profile/Raymond+Chen+-+MSFT' rel='external nofollow' class='url'>Raymond Chen - MSFT</a></cite> <span class="says">says:</span>		</div>
		
		<div class="comment-meta commentmetadata"><a href="https://blogs.msdn.microsoft.com/oldnewthing/20060419-14/?p=31473#comment-372443">
			April 21, 2006 at 2:52 pm</a>		</div>

		<p>James Risto: This article was a hypothetical scenario. &quot;Consider a hypothetical program that uses fast mode on Windows XP.&quot; That program isn&#8217;t Explorer; it&#8217;s some other program that uses fast mode on XP.</p>

		
				</div>
		</li><!-- #comment-## -->
		<li class="comment odd alt thread-odd thread-alt depth-1" id="comment-372483">
				<div id="div-comment-372483" class="comment-body">
				<div class="comment-author vcard">
						<cite class="fn">ender</cite> <span class="says">says:</span>		</div>
		
		<div class="comment-meta commentmetadata"><a href="https://blogs.msdn.microsoft.com/oldnewthing/20060419-14/?p=31473#comment-372483">
			April 21, 2006 at 5:08 pm</a>		</div>

		<p>How does one enable the fast mode on Windows XP/2003? I&#8217;m regularly accessing a fileserver which takes almost half a minute to load certain directories, and wouldn&#8217;t mind trying a speedup :)</p>

		
				</div>
		</li><!-- #comment-## -->
		<li class="comment byuser comment-author-oldnewthing bypostauthor even thread-even depth-1" id="comment-372493">
				<div id="div-comment-372493" class="comment-body">
				<div class="comment-author vcard">
						<cite class="fn"><a href='https://social.msdn.microsoft.com/profile/Raymond+Chen+-+MSFT' rel='external nofollow' class='url'>Raymond Chen - MSFT</a></cite> <span class="says">says:</span>		</div>
		
		<div class="comment-meta commentmetadata"><a href="https://blogs.msdn.microsoft.com/oldnewthing/20060419-14/?p=31473#comment-372493">
			April 21, 2006 at 5:23 pm</a>		</div>

		<p>&quot;Fast mode&quot; is already supported in Windows XP. You can read the Samba bug report for details on how to try it out. But I doubt it&#8217;ll help your scenario since you probably aren&#8217;t asking for the inodes.</p>

		
				</div>
		</li><!-- #comment-## -->
		<li class="comment odd alt thread-odd thread-alt depth-1" id="comment-372513">
				<div id="div-comment-372513" class="comment-body">
				<div class="comment-author vcard">
						<cite class="fn">dorin</cite> <span class="says">says:</span>		</div>
		
		<div class="comment-meta commentmetadata"><a href="https://blogs.msdn.microsoft.com/oldnewthing/20060419-14/?p=31473#comment-372513">
			April 21, 2006 at 6:27 pm</a>		</div>

		<p>I am sorry but isn&#8217;t the standard solution to such problem to fall<br />
<br />backward to previous version when error is detected (In this case for<br />
<br />the time of the session or hopefully just for that unlucky<br />
<br />connection)?</p>
<p>Faulty drivers, hardware and software will be always around there and<br />
<br />idea to deal with them specially hacking original code and putting<br />
<br />such hacks into dis is no smaller mistake than original bugs. For example because it can give not expected results with other software&#8230;</p>
<p>Another question specifically to Hyperion:</p>
<p>Why do you think programers in Samba team should know IFS? Better said<br />
<br />why actually they should read windows documentation?<br />
<br />As I see it:<br />
<br />Samba team boldly declares that they provide SMB/CIFS services. Nothing more and definitely it is behind their scope to emulate CIFS of whatever Vista or XP.</p>
<p>In my opinion it would be wise of MS once to stop this &quot;hacking&quot; attitude (using things that &nbsp;work and slowly &quot;documenting&quot; them somewhere, &nbsp;somehow), and start working as normal engineers do in at least some big companies. For example to think <em>before</em> final design how things can go wrong.</p>

		
				</div>
		</li><!-- #comment-## -->
		<li class="comment byuser comment-author-kjkhyperion even thread-even depth-1" id="comment-372413">
				<div id="div-comment-372413" class="comment-body">
				<div class="comment-author vcard">
						<cite class="fn">KJK::Hyperion</cite> <span class="says">says:</span>		</div>
		
		<div class="comment-meta commentmetadata"><a href="https://blogs.msdn.microsoft.com/oldnewthing/20060419-14/?p=31473#comment-372413">
			April 21, 2006 at 2:33 pm</a>		</div>

		<p>vince: how many times do I have to repeat it? those structures aren&#8217;t part of CIFS, at all. They are part of the Windows IFS (Installable FileSystem) API, which is now officially and 100% public (and used to be mostly public &#8211; through books, websites, Bo Branten&#8217;s ntifs.h project, etc. &#8211; for ages). I have known about the new enumeration types for years now</p>
<p>And somehow, *inexplicably*, *unbelievably*, the Samba team has known about them for quite some time too!</p>
<p>David: it&#8217;s not my fault if you don&#8217;t understand how the CIFS protocol works</p>
<p>Roughly, the protocol has a packet type for each Windows I/O request. Most I/O requests have an unique way of passing parameters, so every new request necessitates a new packet type with an unique encoding. But many many many operations fall under the umbrella of very few requests &#8211; for example, all file enumeration operations (about a dozen) fall under a single request code (which also serves &quot;query attributes&quot; requests) and share the same parameters. CIFS is a file sharing protocol, so the expectation is that such parameters are passed unchanged to the local filesystem underlying a network share</p>
<p>A &quot;change of the protocol&quot; would be the introduction of a new request/packet type, which will have an unique and unseen encoding of inline parameters (notable exceptions are output data and status code, which are returned in the same identical way for all requests). And even in that case, you can fail the request in a standard way (with a STATUS_INVALID_DEVICE_REQUEST error code)</p>
<p>In fact, you have to design a CIFS server as a thin serialization layer over local services and drivers, because that&#8217;s the closest you can get to the real thing; then your underlying &quot;driver&quot; can handle (and fail) the requests like any standard Windows driver, in what is a publically documented behavior. Any other design can only be motivated by delusional concepts of &quot;open protocols&quot;</p>

		
				</div>
		</li><!-- #comment-## -->
		<li class="comment byuser comment-author-kjkhyperion odd alt thread-odd thread-alt depth-1" id="comment-372793">
				<div id="div-comment-372793" class="comment-body">
				<div class="comment-author vcard">
						<cite class="fn">KJK::Hyperion</cite> <span class="says">says:</span>		</div>
		
		<div class="comment-meta commentmetadata"><a href="https://blogs.msdn.microsoft.com/oldnewthing/20060419-14/?p=31473#comment-372793">
			April 24, 2006 at 11:43 am</a>		</div>

		<p>dorin: because. CIFS is designed as a very bare network serialization of Windows security (SSPI) and I/O (IFS) APIs. CIFS is not an open standard, CIFS is a matter of fact</p>
<p>See also the Single UNIX Specification: it purports to be an open standard, and you sure can implement it in a completely naive way, from scratch, clean-room, etc&#8230; but if you follow the original UNIX design, it&#8217;s so much easier</p>
<p>As for the &quot;hacking&quot; attitude, thinking &quot;before&quot;, etc. IFS is probably the one and only I/O API that was designed since the beginning with native network filesystem capabilities in mind &#8211; &quot;networked&quot; attribute for files, &quot;opened from network redirector&quot; flag, &quot;fast network query information&quot; operation, etc. not to mention DMA support in the cache manager, whose entire motivation lies in efficiently transferring data from a filesystem to a NIC</p>

		
				</div>
		</li><!-- #comment-## -->
		<li class="comment even thread-even depth-1" id="comment-427493">
				<div id="div-comment-427493" class="comment-body">
				<div class="comment-author vcard">
						<cite class="fn"><a href='http://blogs.msdn.com/oldnewthing/archive/2006/10/03/785925.aspx' rel='external nofollow' class='url'>The Old New Thing : There's a reason why envelopes have backs</a></cite> <span class="says">says:</span>		</div>
		
		<div class="comment-meta commentmetadata"><a href="https://blogs.msdn.microsoft.com/oldnewthing/20060419-14/?p=31473#comment-427493">
			October 5, 2006 at 2:13 am</a>		</div>

		<p>PingBack from <a rel="nofollow" target="_new" href="http://blogs.msdn.com/oldnewthing/archive/2006/10/03/785925.aspx" rel="nofollow">http://blogs.msdn.com/oldnewthing/archive/2006/10/03/785925.aspx</a></p>

		
				</div>
		</li><!-- #comment-## -->
		</ol><!-- .comment-list -->

		<div class="navigation pagination">
					</div>

	
			<p class="no-comments">Comments are closed.</p>
<!-- COMMENTS END -->
</div></td></tr></table>