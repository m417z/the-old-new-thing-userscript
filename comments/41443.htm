<table class="commenttable" cellspacing="0" cellpadding="0"><tr><td><div class="commentdiv"><div class="commentdivhdr">
<!-- COMMENTS START -->
Comments (21)	</div>

	
			<div class="navigation pagination clear-both">
					</div>

		<ol class="comment-list">
					<li class="comment even thread-even depth-1" id="comment-117073">
				<div id="div-comment-117073" class="comment-body">
				<div class="comment-author vcard">
						<cite class="fn"><a href='http://www.robertmclaws.com' rel='external nofollow' class='url'>Robert McLaws</a></cite> <span class="says">says:</span>		</div>
		
		<div class="comment-meta commentmetadata"><a href="https://blogs.msdn.microsoft.com/oldnewthing/20031218-00/?p=41443#comment-117073">
			December 18, 2003 at 10:59 am</a>		</div>

		<p>There are a high number of .NET newbies that come here looking for information. I&#8217;m not a newbie and I still don;t have any idea what you&#8217;re talking about. Care to elaborate?</p>

		
				</div>
		</li><!-- #comment-## -->
		<li class="comment odd alt thread-odd thread-alt depth-1" id="comment-117083">
				<div id="div-comment-117083" class="comment-body">
				<div class="comment-author vcard">
						<cite class="fn"><a href='http://weblogs.asp.net/oldnewthing/' rel='external nofollow' class='url'>Raymond Chen</a></cite> <span class="says">says:</span>		</div>
		
		<div class="comment-meta commentmetadata"><a href="https://blogs.msdn.microsoft.com/oldnewthing/20031218-00/?p=41443#comment-117083">
			December 18, 2003 at 11:02 am</a>		</div>

		<p>Sorry. This is not a .NET blog. This is a Win32 blog. If you&#8217;re looking for .NET stuff, you should look elsewhere.</p>
<p>My point was that this article explores the internals of how critical sections work (good for debugging your program when its critical sections start acting weird), but it also decides to run around MODIFYING internal data structures, which is bad. The Spare fields are &quot;reserved for future use&quot;. Someday, Windows will use them and your code that modifies an &quot;unused&quot; field is now corrupting a field that contains important information.</p>
<p>The article doesn&#8217;t mention that the internals of critical section behavior can change at any time. In fact, I know for a fact that it has already changed in Longhorn in a manner that will make the provided program crash under certain (rare but legal) conditions.</p>
<p>So any information you get from that article, use it only for diagnostic purposes. Do not ship a program that relies on it, because I already know that it will crash on Longhorn.</p>

		
				</div>
		</li><!-- #comment-## -->
		<li class="comment even thread-even depth-1" id="comment-117093">
				<div id="div-comment-117093" class="comment-body">
				<div class="comment-author vcard">
						<cite class="fn"><a href='http://www.codeproject.com/script/articles/list_articles.asp?userid=152' rel='external nofollow' class='url'>Mike Dunn</a></cite> <span class="says">says:</span>		</div>
		
		<div class="comment-meta commentmetadata"><a href="https://blogs.msdn.microsoft.com/oldnewthing/20031218-00/?p=41443#comment-117093">
			December 18, 2003 at 11:13 am</a>		</div>

		<p>A field marked &quot;reserved&quot; means &quot;This is here because we expect to add features and use this field in the future. Don&#8217;t touch it.&quot;</p>
<p>If you use that field for yourself, but a future version of the OS starts using it, one or the other will break. And when your code breaks, you can&#8217;t claim &quot;M$ put code in Windoze to break my program! waaah!&quot;</p>

		
				</div>
		</li><!-- #comment-## -->
		<li class="comment odd alt thread-odd thread-alt depth-1" id="comment-117103">
				<div id="div-comment-117103" class="comment-body">
				<div class="comment-author vcard">
						<cite class="fn">Curt Hagenlocher</cite> <span class="says">says:</span>		</div>
		
		<div class="comment-meta commentmetadata"><a href="https://blogs.msdn.microsoft.com/oldnewthing/20031218-00/?p=41443#comment-117103">
			December 18, 2003 at 11:21 am</a>		</div>

		<p>Thanks for the pointer to the article.  I don&#8217;t intend to shoot myself in the foot by using reserved data fields, but anything by Matt Pietrek is typically worth reading.</p>

		
				</div>
		</li><!-- #comment-## -->
		<li class="comment even thread-even depth-1" id="comment-117143">
				<div id="div-comment-117143" class="comment-body">
				<div class="comment-author vcard">
						<cite class="fn">Claw</cite> <span class="says">says:</span>		</div>
		
		<div class="comment-meta commentmetadata"><a href="https://blogs.msdn.microsoft.com/oldnewthing/20031218-00/?p=41443#comment-117143">
			December 18, 2003 at 1:59 pm</a>		</div>

		<p>So if this article exists on a Microsoft site, why don&#8217;t you guys correct it?</p>

		
				</div>
		</li><!-- #comment-## -->
		<li class="comment odd alt thread-odd thread-alt depth-1" id="comment-117153">
				<div id="div-comment-117153" class="comment-body">
				<div class="comment-author vcard">
						<cite class="fn">asdf</cite> <span class="says">says:</span>		</div>
		
		<div class="comment-meta commentmetadata"><a href="https://blogs.msdn.microsoft.com/oldnewthing/20031218-00/?p=41443#comment-117153">
			December 18, 2003 at 4:19 pm</a>		</div>

		<p>I think you&#8217;re exaggerating Raymond. Everyone knows that &quot;under the hood&quot; articles like this aren&#8217;t reliable from OS to OS. They just want to see an implementation on a fixed platform and mess around with it, I highly doubt anyone would ship code with this stuff enabled (well except for the Office team).</p>
<p>As for fixing articles on MS&#8217;s site, I&#8217;ve used the links on MSDN to contact MS on many occasions to fix winapi docs to no avail, why would they start changing stuff now? Especially when they want to make it appear that C/C++/winapi is outdated.</p>

		
				</div>
		</li><!-- #comment-## -->
		<li class="comment even thread-even depth-1" id="comment-117163">
				<div id="div-comment-117163" class="comment-body">
				<div class="comment-author vcard">
						<cite class="fn"><a href='http://weblogs.asp.net/oldnewthing/' rel='external nofollow' class='url'>Raymond Chen</a></cite> <span class="says">says:</span>		</div>
		
		<div class="comment-meta commentmetadata"><a href="https://blogs.msdn.microsoft.com/oldnewthing/20031218-00/?p=41443#comment-117163">
			December 18, 2003 at 4:23 pm</a>		</div>

		<p>MSJ is a magazine and they can print what they want. Sometimes they send an article to the product teams for comment or review but at the end of the day, it&#8217;s their magazine and they decide what goes into it.</p>
<p>The article is actually a good one. Like he says in the opening: &quot;A solid understanding of critical sections in Windows can really come in handy when you need to track down multithreading performance issues in your code.&quot;</p>
<p>Just stay away from the part where he recommends modifying the system critical sections or messing with the reserved fields. And remember of course that any implementation details are subject to change, so don&#8217;t write code that relies on them.<br /></p>

		
				</div>
		</li><!-- #comment-## -->
		<li class="comment odd alt thread-odd thread-alt depth-1" id="comment-117173">
				<div id="div-comment-117173" class="comment-body">
				<div class="comment-author vcard">
						<cite class="fn"><a href='http://weblogs.asp.net/oldnewthing/' rel='external nofollow' class='url'>Raymond Chen</a></cite> <span class="says">says:</span>		</div>
		
		<div class="comment-meta commentmetadata"><a href="https://blogs.msdn.microsoft.com/oldnewthing/20031218-00/?p=41443#comment-117173">
			December 18, 2003 at 4:24 pm</a>		</div>

		<p>I&#8217;ve used the links on MSDN to report doc bugs too, and I&#8217;ve gotten replies. Maybe I&#8217;m just more famous.</p>

		
				</div>
		</li><!-- #comment-## -->
		<li class="comment even thread-even depth-1" id="comment-117213">
				<div id="div-comment-117213" class="comment-body">
				<div class="comment-author vcard">
						<cite class="fn">Tom</cite> <span class="says">says:</span>		</div>
		
		<div class="comment-meta commentmetadata"><a href="https://blogs.msdn.microsoft.com/oldnewthing/20031218-00/?p=41443#comment-117213">
			December 18, 2003 at 5:49 pm</a>		</div>

		<p>I had a bad dream involving critical sections two nights ago, but not at Pietrek and Osterlund&#8217;s level of detail. Fortunately vacation is nigh.</p>
<p>asdf, I reported a SDK bug yesterday via the link and got a reply today (&quot;fixed for Jan. &#8217;04&quot;) and I am not as famous, in some circles, as Raymond.</p>

		
				</div>
		</li><!-- #comment-## -->
		<li class="comment odd alt thread-odd thread-alt depth-1" id="comment-117253">
				<div id="div-comment-117253" class="comment-body">
				<div class="comment-author vcard">
						<cite class="fn"><a href='http://www.virtualdub.org/' rel='external nofollow' class='url'>Phaeron</a></cite> <span class="says">says:</span>		</div>
		
		<div class="comment-meta commentmetadata"><a href="https://blogs.msdn.microsoft.com/oldnewthing/20031218-00/?p=41443#comment-117253">
			December 19, 2003 at 12:10 am</a>		</div>

		<p>This is the API team&#8217;s fault, really.  A forward-thinking programmer would have labeled the fields &quot;BOOL ShouldFormatHardDisk&quot; and &quot;DWORD KernelObjectIndexHint&quot; instead of the tempting &quot;DWORD Spare[2].&quot;<br /></p>

		
				</div>
		</li><!-- #comment-## -->
		<li class="comment even thread-even depth-1" id="comment-117283">
				<div id="div-comment-117283" class="comment-body">
				<div class="comment-author vcard">
						<cite class="fn">Seth McCarus</cite> <span class="says">says:</span>		</div>
		
		<div class="comment-meta commentmetadata"><a href="https://blogs.msdn.microsoft.com/oldnewthing/20031218-00/?p=41443#comment-117283">
			December 19, 2003 at 7:37 am</a>		</div>

		<p>Raymond, you said &#8220;And remember of course that any implementation details are subject to change, so don&#8217;t write code that relies on them.&#8221;</p>
<p>After reading this article I wrote some CS code that relies on the fields in the CRITICAL_SECTION struct.  The reason is that I&#8217;m using SEH, and have some __try/__except blocks in which the code enters and leaves critical sections.  If an exception occurs, I don&#8217;t know if I&#8217;m currently in the CS or not.  Even wrapping the code in __try/__finally wouldn&#8217;t solve my problems.</p>
<p>So I was forced to write some code that examines the contents of the CRITICAL_SECTION struct to see if the current thread has ownership of the CS.  If so, I leave.  My question is, is this a bad idea?  Thanks&#8230;</p>
<p>Seth.<br />
</p>
<div class="post"><a href="http://blogs.msdn.com/oldnewthing/archive/2003/12/22/45152.aspx" rel="nofollow">Response</a></div>

		
				</div>
		</li><!-- #comment-## -->
		<li class="comment odd alt thread-odd thread-alt depth-1" id="comment-117293">
				<div id="div-comment-117293" class="comment-body">
				<div class="comment-author vcard">
						<cite class="fn"><a href='http://weblogs.asp.net/oldnewthing/' rel='external nofollow' class='url'>Raymond Chen</a></cite> <span class="says">says:</span>		</div>
		
		<div class="comment-meta commentmetadata"><a href="https://blogs.msdn.microsoft.com/oldnewthing/20031218-00/?p=41443#comment-117293">
			December 19, 2003 at 7:50 am</a>		</div>

		<p>There are so many ways of doing this that don&#8217;t involve relying on undocumented behavior. I&#8217;ll make a separate post on it.</p>

		
				</div>
		</li><!-- #comment-## -->
		<li class="comment even thread-even depth-1" id="comment-117323">
				<div id="div-comment-117323" class="comment-body">
				<div class="comment-author vcard">
						<cite class="fn">James Kew</cite> <span class="says">says:</span>		</div>
		
		<div class="comment-meta commentmetadata"><a href="https://blogs.msdn.microsoft.com/oldnewthing/20031218-00/?p=41443#comment-117323">
			December 19, 2003 at 8:37 am</a>		</div>

		<p>Surely naming the fields &quot;Spare&quot; _invites_ people to co-opt them for their own use. Why  weren&#8217;t they named &quot;Reserved&quot;, which does have the desirable &quot;keep your dirty hands off&quot; implications?<br /></p>

		
				</div>
		</li><!-- #comment-## -->
		<li class="comment odd alt thread-odd thread-alt depth-1" id="comment-117483">
				<div id="div-comment-117483" class="comment-body">
				<div class="comment-author vcard">
						<cite class="fn">Norman Diamond</cite> <span class="says">says:</span>		</div>
		
		<div class="comment-meta commentmetadata"><a href="https://blogs.msdn.microsoft.com/oldnewthing/20031218-00/?p=41443#comment-117483">
			December 21, 2003 at 6:47 pm</a>		</div>

		<p>Thank you for the good observation, and sorry to go off on a tangent, but the title is just asking for it.</p>
<p>&quot;How to void your warranty&quot;?  I thought that the purchase of any Microsoft product was a way to void its warranty.  I first learned this with Windows 95, attaching a new SCSI disk via a new PCMCIA-SCSI adapter and using the fdisk command as documented.  I had problems immediately, and problems continued both within the first 90 days and after the first 90 days.  Microsoft&#8217;s web site said go to the PC&#8217;s vendor for support.  When I&#8217;ve gone to vendors they&#8217;ve sometimes had bug fixes for their own stuff (drivers etc.) but vendors have never supplied fixes for Microsoft&#8217;s stuff.  After several months I figured out that fdisk, used as directed, was creating overlapping logical drives.  The workaround was to not use fdisk.  If the PCMCIA-SCSI card vendor supplied a utility to run under Windows 3.1 to partition hard disks, that would run under Windows 95 and create non-overlapping logical drives, but of course no FAT32.</p>
<p>In addition to the sentences buried in the above paragraph, there has been since been additional refusal of warranty service.  Originally I lost 1 GB of data (which was non-trivial in those days) and spent several months and 11,000 yen in train fares going to vendors and the retail store where I bought the stuff, trying to track down the problem.  Of course after tracking it down, it only takes 10 minutes to reproduce.  One time Microsoft accidentally let me report this bug without charging me the customary US$35 or 4,000 yen fee for reporting bugs.  I explained how to reproduce it in 10 minutes.  Then Microsoft did yet again refuse warranty service.</p>
<p>You say it is possible for a customer to void a Microsoft warranty, meaning that the warranty wasn&#8217;t really void at the time of purchase?  I do not believe you.</p>
<p>Funny that Windows 98&#8217;s fdisk doesn&#8217;t have that bug, but Microsoft has still never fixed Windows 95&#8217;s fdisk.  If a SCSI disk was ever fdisked under Windows 95 but did not subsequently have its MBR zeroed, then it&#8217;s still a time bomb.  It doesn&#8217;t matter what OS you upgrade to, the partitions are still sitting there, still overlapping, and will eventually lose all of their contents.</p>

		
				</div>
		</li><!-- #comment-## -->
		<li class="comment even thread-even depth-1" id="comment-117503">
				<div id="div-comment-117503" class="comment-body">
				<div class="comment-author vcard">
						<cite class="fn"><a href='http://weblogs.asp.net/oldnewthing/' rel='external nofollow' class='url'>Raymond Chen</a></cite> <span class="says">says:</span>		</div>
		
		<div class="comment-meta commentmetadata"><a href="https://blogs.msdn.microsoft.com/oldnewthing/20031218-00/?p=41443#comment-117503">
			December 21, 2003 at 11:18 pm</a>		</div>

		<p>The title was a joke. The point is that messing with internal data structures is a pretty certain way of ensuring that nobody will even try to support your system. If you call developer support because your grovelling into undocumented system data structures isn&#8217;t working, nobody will try to help. And any system instability will be blamed on said grovelling.</p>

		
				</div>
		</li><!-- #comment-## -->
		<li class="comment odd alt thread-odd thread-alt depth-1" id="comment-117543">
				<div id="div-comment-117543" class="comment-body">
				<div class="comment-author vcard">
						<cite class="fn"><a href='http://www.wheaty.net' rel='external nofollow' class='url'>Matt Pietrek</a></cite> <span class="says">says:</span>		</div>
		
		<div class="comment-meta commentmetadata"><a href="https://blogs.msdn.microsoft.com/oldnewthing/20031218-00/?p=41443#comment-117543">
			December 22, 2003 at 7:44 am</a>		</div>

		<p>First off Raymond, I love your blog.  It explains a lot of stuff in Windows over the years that I&#8217;d wondered about.</p>
<p>In any event, as one of the authors of the article, its purposes were twofold:</p>
<p>1) Explain how critical sections work, and give some insight how you might track down issues in the debugger.</p>
<p>2) Provide some sample code that automates some things that are painful to do manually during development process.  No where (and correct me if I&#8217;m wrong) did Russ or I suggest that you ship your code using the critical section library.  It&#8217;s a *development* tool.</p>
<p>It&#8217;s good to know that the &quot;spare&quot; fields will change in future OS builds.  However, there are developers *now* who are having problems debugging code in shipping apps.  Should we never implement a valuable technique simply because it might not work some day?</p>
<p>Truth be told, many innovative products over the years have &quot;broken the rules&quot;.  Anybody remember that TSR&#8217;s originally weren&#8217;t documented?  The whole TSR industry got started because a tiny little company called Borland started using an undocumented OS feature.</p>
<p>Over the years, I&#8217;ve written countless amounts of version specific and/or undocumented code.  I&#8217;ve gone through hell and high water to first make sure there&#8217;s not a documented/supported way first, however.  When people come asking me if some undocumented technique will work, I first grill them to make sure there&#8217;s not a supported way.  </p>
<p>When I have gone the unsupported route, I don&#8217;t think I&#8217;ve ever complained that Microsoft &quot;broke me&quot;.  I simply made whatever changes were necessary to accomodate the newer way of doing things and moved on.  It&#8217;s a fact of live when writing advanced software that lives on the edge.</p>
<p>So there&#8217;s my two cents, and keep up the great posts!</p>

		
				</div>
		</li><!-- #comment-## -->
		<li class="comment even thread-even depth-1" id="comment-117633">
				<div id="div-comment-117633" class="comment-body">
				<div class="comment-author vcard">
						<cite class="fn"><a href='http://weblogs.asp.net/oldnewthing/' rel='external nofollow' class='url'>Raymond Chen</a></cite> <span class="says">says:</span>		</div>
		
		<div class="comment-meta commentmetadata"><a href="https://blogs.msdn.microsoft.com/oldnewthing/20031218-00/?p=41443#comment-117633">
			December 22, 2003 at 5:25 pm</a>		</div>

		<p>If you weren&#8217;t able to find a documented way of doing something, shouldn&#8217;t that that be a clue that you probably shouldn&#8217;t be doing it?  </p>
<p>My concern is that people are going to write code that assumes that critical sections always work as the article describes, since there wasn&#8217;t (in my opinion) a strong enough warning that the information is for diagnostic purposes only. The information is valuable and good to have, but developers need to make sure to use the powers only for good.</p>
<p>If you do something that&#8217;s unsupported, make sure your customers understand it. &quot;This program makes assumptions about Windows that may become invalid at any service pack or security update.&quot; </p>
<p>I&#8217;ll write another blog entry on some of the &quot;grovelling into internal data structures&quot; that apps have done and that the Windows team have had to &quot;accomodate&quot; in one way or another.</p>
<p>Each time an app relies on undocumented behavior, the OS ships a little later as developers are taken off task to hack around yet another app.  To take your example: In the DOS source code there are chunks of &quot;junk DNA&quot; &#8211; code fragments that do absolutely nothing, just sitting around wasting space. They exist because various TSRs do memory scans looking for certain byte sequences, so DOS has to carry these &quot;magic byte sequences&quot; around to keep those TSRs from crashing.</p>

		
				</div>
		</li><!-- #comment-## -->
		<li class="comment odd alt thread-odd thread-alt depth-1" id="comment-117713">
				<div id="div-comment-117713" class="comment-body">
				<div class="comment-author vcard">
						<cite class="fn"><a href='http://www.wheaty.net' rel='external nofollow' class='url'>Matt Pietrek</a></cite> <span class="says">says:</span>		</div>
		
		<div class="comment-meta commentmetadata"><a href="https://blogs.msdn.microsoft.com/oldnewthing/20031218-00/?p=41443#comment-117713">
			December 23, 2003 at 8:34 am</a>		</div>

		<p>&gt; If you weren&#8217;t able to find a documented way of doing something, shouldn&#8217;t that that be a clue that you probably shouldn&#8217;t be doing it?</p>
<p>This is exactly the sentiment that&#8217;s frustrated non-Microsofties for decades.  It&#8217;s an attitude that seems to say &quot;We&#8217;ve provided you developers with everything you could possibly need.&quot;   Obviously, this isn&#8217;t the case as people are still hacking around in the OS.</p>
<p>My favorite story here is when an NT team member told me that it wasn&#8217;t possible to write a single machine kernel debugger.  It was all I could do to not tell him I was using a very early build of SoftIce/NT.  The point is, some really great products were only possible by doing undocumented things.</p>
<p>I&#8217;m not one of those open source zealots at all, but this is one area where they have an advantage.  A good idea can come from anybody, not just within Microsoft.</p>
<p>As for junk DNA, I try to avoid searching for byte strings if at all possible.  When left with no other choice, I&#8217;ve always made my code degrade gracefully.  Developers that don&#8217;t code defensively frustrate the hell out of me as well.</p>
<p>I certainly understand your points about apps hacking around the OS causing problems for MS.  I&#8217;ve heard and seen many examples where the OS goes to great lengths to not break existing apps, and I applaud Microsoft&#8217;s effort in this area.</p>
<p>However, saying that people shouldn&#8217;t innovate because the OS didn&#8217;t plan for it is just wrong.  There&#8217;s a long history of undocumented APIs becoming documented because there was a need that MS didn&#8217;t originally see.</p>
<p>So to sum up, sometimes there&#8217;s no way to avoid &quot;breaking the rules&quot;.  That said, if you&#8217;re going to break the rules, do it responsibly.</p>

		
				</div>
		</li><!-- #comment-## -->
		<li class="comment even thread-even depth-1" id="comment-192413">
				<div id="div-comment-192413" class="comment-body">
				<div class="comment-author vcard">
						<cite class="fn"><a href='http://weblogs.asp.net/matt_pietrek/archive/2004/07/08/177477.aspx' rel='external nofollow' class='url'>Matt Pietrek's WebLog</a></cite> <span class="says">says:</span>		</div>
		
		<div class="comment-meta commentmetadata"><a href="https://blogs.msdn.microsoft.com/oldnewthing/20031218-00/?p=41443#comment-192413">
			July 8, 2004 at 1:13 pm</a>		</div>

		
		
				</div>
		</li><!-- #comment-## -->
		<li class="comment odd alt thread-odd thread-alt depth-1" id="comment-260743">
				<div id="div-comment-260743" class="comment-body">
				<div class="comment-author vcard">
						<cite class="fn"><a href='http://weblogs.asp.net/larryosterman/archive/2005/03/03/384458.aspx' rel='external nofollow' class='url'>Larry Osterman's WebLog</a></cite> <span class="says">says:</span>		</div>
		
		<div class="comment-meta commentmetadata"><a href="https://blogs.msdn.microsoft.com/oldnewthing/20031218-00/?p=41443#comment-260743">
			March 3, 2005 at 2:03 pm</a>		</div>

		
		
				</div>
		</li><!-- #comment-## -->
		<li class="comment even thread-even depth-1" id="comment-260923">
				<div id="div-comment-260923" class="comment-body">
				<div class="comment-author vcard">
						<cite class="fn"><a href='http://blogs.msdn.com/larryosterman/archive/0001/01/01/384458.aspx' rel='external nofollow' class='url'>Larry Osterman's WebLog</a></cite> <span class="says">says:</span>		</div>
		
		<div class="comment-meta commentmetadata"><a href="https://blogs.msdn.microsoft.com/oldnewthing/20031218-00/?p=41443#comment-260923">
			March 4, 2005 at 8:43 am</a>		</div>

		
		
				</div>
		</li><!-- #comment-## -->
		</ol><!-- .comment-list -->

		<div class="navigation pagination">
					</div>

	
			<p class="no-comments">Comments are closed.</p>
<!-- COMMENTS END -->
</div></td></tr></table>